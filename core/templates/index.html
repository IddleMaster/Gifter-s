{% extends "base.html" %}
{% load static %}

{% block title %}Gifter‚Äôs{% endblock %}
{% block body_class %}index-page{% endblock %}

{% block content %}

{% if messages %}
  <div class="container mt-2">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

{% if not user.is_authenticated %}
<section id="hero" class="hero section light-background">
  <div class="container">
    <div class="row gy-4">
      <div class="col-lg-12 d-flex flex-column justify-content-center align-items-center text-center"
        data-aos="zoom-out">
        <h1>
          Bienvenido a <span class="brand">Gifter‚Äôs</span>
          <img src="{% static 'img/Gifters/favicongift.png' %}" alt="Logo Gifter‚Äôs" class="inline-logo">
        </h1>
        <p>‚ÄúConecta, descubre y regala momentos √∫nicos.‚Äù</p>
        <div class="d-flex justify-content-center gap-3 mt-3">
          <a href="#portfolio" class="gift">Empieza a buscar regalos</a>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="featured-services" class="featured-services section">
  <div class="container">
    <div class="row gy-4">

      <div class="col-xl-3 col-md-6 d-flex" data-aos="fade-up" data-aos-delay="100">
        <div class="service-item position-relative">
          <div class="icon"><i class="bi bi-heart-fill icon" style="color:#6c63ff;"></i></div>
          <h4><a href="#portfolio" class="stretched-link">Regala cari√±o</a></h4>
          <p>Un detalle sincero vale m√°s que mil palabras.</p>
        </div>
      </div>

      <div class="col-xl-3 col-md-6 d-flex" data-aos="fade-up" data-aos-delay="200">
        <div class="service-item position-relative">
          <div class="icon"><i class="bi bi-gift-fill icon" style="color:#6c63ff;"></i></div>
          <h4><a href="#portfolio" class="stretched-link">El detalle perfecto</a></h4>
          <p>Encuentra ideas √∫nicas que sorprenden a quienes m√°s quieres.</p>
        </div>
      </div>

      <div class="col-xl-3 col-md-6 d-flex" data-aos="fade-up" data-aos-delay="300">
        <div class="service-item position-relative">
          <div class="icon"><i class="bi bi-stars icon" style="color:#6c63ff;"></i></div>
          <h4><a href="#portfolio" class="stretched-link">Hazlo especial</a></h4>
          <p>No importa el tama√±o del regalo, importa la emoci√≥n que transmite.</p>
        </div>
      </div>

      <div class="col-xl-3 col-md-6 d-flex" data-aos="fade-up" data-aos-delay="400">
        <div class="service-item position-relative">
          <div class="icon"><i class="bi bi-people-fill icon" style="color:#6c63ff;"></i></div>
          <h4><a href="#portfolio" class="stretched-link">Conecta personas</a></h4>
          <p>Regalar es compartir momentos que se quedan para siempre.</p>
        </div>
      </div>

    </div>
  </div>
</section>
{% endif %}




{% if not user.is_authenticated %}
<div class="container section-title" data-aos="fade-up">
  <h2>Categor√≠as</h2>
  <p><span>&nbsp;</span> <span class="description-title">Explora nuestras categor√≠as</span></p>
</div>
{% endif %}

<br><br>

<div class="container section-title" data-aos="fade-up">
  <h2>Bienvenido</h2>
  <p><span>&nbsp;</span> <span class="description-title">¬°</span><span class="brand">Comienza a buscar regalos</span><span class="description-title">!</span></p>
</div>

<!-- Clients Section - CATEGOR√çAS DIN√ÅMICAS CON FLECHAS -->
<section id="clients" class="clients section light-background categorias-carousel">
  <div class="container">

    {% if categorias %}
    <div class="swiper init-swiper">
      <script type="application/json" class="swiper-config">
        {
          "loop": true,
          "speed": 600,
          "autoplay": { "delay": 5000 },
          "slidesPerView": "auto",
          "pagination": { 
            "el": ".swiper-pagination", 
            "type": "bullets", 
            "clickable": true 
          },
          "navigation": {
            "nextEl": ".swiper-button-next",
            "prevEl": ".swiper-button-prev"
          },
          "breakpoints": {
            "320": { 
              "slidesPerView": 2, 
              "spaceBetween": 15 
            },
            "480": { 
              "slidesPerView": 3, 
              "spaceBetween": 20 
            },
            "640": { 
              "slidesPerView": 4, 
              "spaceBetween": 25 
            },
            "768": { 
              "slidesPerView": 5, 
              "spaceBetween": 30 
            },
            "992": { 
              "slidesPerView": 6, 
              "spaceBetween": 35 
            },
            "1200": { 
              "slidesPerView": 7, 
              "spaceBetween": 40 
            }
          }
        }
      </script>

      <!-- Contenedor del carrusel -->
      <div class="swiper-wrapper align-items-center">
        {% for categoria in categorias %}
        <div class="swiper-slide">
          <a href="{% url 'productos_list' %}?categoria={{ categoria.id_categoria }}" class="cat-card">
            <span class="cat-name">{{ categoria.nombre_categoria }}</span>
          </a>
        </div>
        {% endfor %}
      </div>

      <!-- Flechas de navegaci√≥n -->
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>

      <!-- Puntos de paginaci√≥n -->
      <div class="swiper-pagination"></div>
    </div>
    {% else %}
    <div class="text-center py-4">
      <p class="text-muted">No hay categor√≠as disponibles en este momento.</p>
    </div>
    {% endif %}
  </div>
</section>

<section id="portfolio" class="portfolio section">
  <div class="container section-title" data-aos="fade-up">
    <h2>Tendencias</h2>
    <p><span>&nbsp;</span> <span class="description-title">Productos m√°s populares</span></p>
  </div>

  <div class="container">
    <div class="isotope-layout" data-default-filter="*" data-layout="masonry" data-sort="original-order">
      <div class="row gy-4 isotope-container" data-aos="fade-up" data-aos-delay="200">
        {% for producto in productos_destacados %}
        <div class="col-lg-4 col-md-6 portfolio-item isotope-item filter-app">

          <!-- Imagen del producto -->
          <div class="product-image-container" style="height: 250px; overflow: hidden; border-radius: 8px;">
            <!-- Coraz√≥n flotante -->
            <a href="#"
              class="wishlist-badge wishlist-btn {% if producto.id_producto in favoritos_ids %}is-fav{% endif %}"
              data-product-id="{{ producto.id_producto }}"
              title="{% if producto.id_producto in favoritos_ids %}Quitar de wishlist{% else %}Agregar a wishlist{% endif %}"
              aria-pressed="{% if producto.id_producto in favoritos_ids %}true{% else %}false{% endif %}">
              {% if producto.id_producto in favoritos_ids %}
              <i class="bi bi-heart-fill text-danger"></i>
              {% else %}
              <i class="bi bi-heart"></i>
              {% endif %}
            </a>

            {% if producto.imagen and producto.imagen.url %}
            <img src="{{ producto.imagen.url }}" class="img-fluid" alt="{{ producto.nombre_producto }}"
              style="width: 100%; height: 100%; object-fit: cover;">
            {% else %}
            <img src="{% static 'img/Gifters/favicongift.png' %}" class="img-fluid" alt="{{ producto.nombre_producto }}"
              style="width: 100%; height: 100%; object-fit: cover;">
            {% endif %}
          </div>


          <div class="portfolio-info">
            <h4>{{ producto.nombre_producto }}</h4>
            <p class="text-primary">{{ producto.id_marca.nombre_marca }}</p>

            {% if producto.precio %}
            <p class="h5 text-success">${{ producto.precio }}</p>
            {% endif %}

            <!-- Botones -->
            <div class="product-actions">
              {# quita todo el <a> del coraz√≥n aqu√≠ #}
                {% if producto.imagen and producto.imagen.url %}
                <a href="{{ producto.imagen.url }}" class="glightbox preview-link"
                  data-gallery="gal-producto-{{ producto.id_producto }}">
                  <i class="bi bi-zoom-in"></i>
                </a>
                {% else %}
                <a href="{% static 'img/Gifters/favicongift.png' %}" class="glightbox preview-link"
                  data-gallery="gal-producto-{{ producto.id_producto }}">
                  <i class="bi bi-zoom-in"></i>
                </a>
                {% endif %}

                {% with producto.urls_tienda_activas.first as url_tienda %}
                {% if url_tienda %}
                <a href="{{ url_tienda.url }}" target="_blank" rel="noopener" class="details-link">
                  <i class="bi bi-link-45deg"></i>
                </a>
                {% else %}
                <a href="{% url 'producto_detalle' producto.id_producto %}" class="details-link">
                  <i class="bi bi-eye"></i>
                </a>
                {% endif %}
                {% endwith %}
            </div>

          </div>

        </div>
        {% empty %}
        <div class="col-12 text-center">
          <div class="alert alert-info">
            <h4>üì¶ No hay productos destacados</h4>
            <p>Pronto agregaremos nuevos productos interesantes.</p>
            <a href="{% url 'productos_list' %}" class="btn btn-primary mt-2">Explorar todos los productos</a>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>


    <!-- Bot√≥n para ver m√°s productos -->
    {% if productos_destacados %}
    <div class="text-center mt-4">
      <a href="{% url 'productos_list' %}" class="btn btn-primary">Ver todos los productos</a>
    </div>
    {% endif %}
  </div>
</section>


<section id="services" class="services section">
  <div class="container section-title" data-aos="fade-up">
    <h2>Conecta en Gifter‚Äôs</h2>

    {# >>>>>>>>>>> Mantenemos este texto tal cual <<<<<<<<<<< #}
    <p><span>Personas que quiz√°s conozcas</span> <span class="description-title"></span></p>
  </div>

  <div class="container">
    {% if request.user.is_authenticated %}

      {# =================== BLOQUE DE AMIGOS (REMOVIDO) =================== #}
      {# Antes aqu√≠ estaba: {% if amigos %} ... {% endif %} #}

      {# ============== SOLO SUGERENCIAS (lo de abajo) ============== #}
      {% if sugerencias %}
        <div class="row gy-4">
          {% for u in sugerencias %}
          <div class="col-lg-4 col-md-6" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|add:1 }}00">
            <div class="service-item position-relative">
              <div>
                {% if u.perfil and u.perfil.profile_picture %}
                  <img src="{{ u.perfil.profile_picture.url }}" alt="{{ u.nombre }} {{ u.apellido }}" height="100" width="100" style="object-fit:cover;border-radius:50%;">
                {% else %}
                  <img src="{% static 'img/Gifters/favicongift.png' %}" alt="{{ u.nombre }} {{ u.apellido }}" height="100" width="100" style="object-fit:cover;border-radius:50%;">
                {% endif %}
              </div>

              <a href="{% url 'perfil_detalle' u.nombre_usuario %}" class="stretched-link">
                <h3>{{ u.nombre }} {{ u.apellido }}</h3>
              </a>
              <p class="text-muted">@{{ u.nombre_usuario }}</p>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-3">
          <p class="text-muted">No hay sugerencias por ahora. Explora m√°s perfiles para obtener mejores recomendaciones.</p>
        </div>
      {% endif %}

    {% else %}
      <div class="text-center py-3">
        <p class="text-muted">Inicia sesi√≥n para ver a tus amigos y sugerencias de personas que podr√≠as conocer.</p>
      </div>
    {% endif %}
  </div>
</section>

<!-- Tendencias - AHORA CON PRODUCTOS DESTACADOS -->



<!-- Rese√±itas nuevas -->
<!-- Rese√±itas nuevas -->
<!-- Rese√±itas nuevas -->

{# ========= Rese√±as del sitio ========= #}
<div class="container section-title" data-aos="fade-up">
  <h2>Rese√±as de nuestros usuarios</h2>
</div>

<section id="testimonials" class="section" style="padding-top:0;">
  <div class="container" data-aos="fade-up" data-aos-delay="100">

    {# --- Form (crear/editar) solo logueados --- #}
    {% if user.is_authenticated %}
      {% if own_resena %}
        {# ---- EDITAR rese√±a existente ---- #}
        <form action="{% url 'resena_sitio_editar' %}" method="post" class="mb-3" id="form-editar-resena">
          {% csrf_token %}
          <div class="row g-2 align-items-start">
            <div class="col-auto">
              <label for="id_calificacion_edit" class="form-label mb-1">Calificaci√≥n</label>
              <input id="id_calificacion_edit" type="number" name="calificacion"
                     min="1" max="5" value="{{ own_resena.calificacion }}"
                     class="form-control" style="width:90px;" required>
            </div>
            <div class="col">
              <label for="id_comentario_edit" class="form-label mb-1">Comentario</label>
              <textarea id="id_comentario_edit" name="comentario" rows="2"
                        class="form-control"
                        placeholder="Actualiza tu rese√±a...">{{ own_resena.comentario }}</textarea>
            </div>
            <div class="col-auto" style="margin-top:30px;">
              <button class="btn btn-primary" type="submit">Editar rese√±a</button>
            </div>
          </div>
        </form>

        {# ---- ELIMINAR rese√±a ---- #}
        <form action="{% url 'resena_sitio_eliminar' %}" method="post" class="mb-4">
          {% csrf_token %}
          <button class="btn btn-outline-danger btn-sm"
                  onclick="return confirm('¬øEliminar tu rese√±a? Esta acci√≥n no se puede deshacer.')">
            Eliminar rese√±a
          </button>
        </form>
      {% else %}
        {# ---- CREAR rese√±a (si no tienes) ---- #}
        <form action="{% url 'resena_sitio_crear' %}" method="post" class="mb-4" id="form-crear-resena">
          {% csrf_token %}
          <div class="row g-2 align-items-start">
            <div class="col-auto">
              <label for="id_calificacion" class="form-label mb-1">Calificaci√≥n</label>
              <input id="id_calificacion" type="number" name="calificacion"
                     min="1" max="5" value="5"
                     class="form-control" style="width:90px;" required>
            </div>
            <div class="col">
              <label for="id_comentario" class="form-label mb-1">Comentario</label>
              <textarea id="id_comentario" name="comentario" rows="2"
                        class="form-control"
                        placeholder="¬øQu√© te pareci√≥ la p√°gina? (opcional)"></textarea>
            </div>
            <div class="col-auto" style="margin-top:30px;">
              <button class="btn btn-primary" type="submit">Enviar rese√±a</button>
            </div>
          </div>
        </form>
      {% endif %}
    {% else %}
      <p class="text-muted">Inicia sesi√≥n para dejar tu rese√±a.</p>
    {% endif %}

    {# --- Lista de rese√±as reales --- #}
    {% if resenas %}
      <div class="row g-4">
        {% for r in resenas %}
          <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body text-center">
                {% if r.id_usuario.perfil and r.id_usuario.perfil.profile_picture %}
                  <img src="{{ r.id_usuario.perfil.profile_picture.url }}"
                       alt="@{{ r.id_usuario.nombre_usuario|default:r.id_usuario.username }}"
                       width="72" height="72" class="rounded-circle mb-3"
                       style="object-fit:cover;" loading="lazy">
                {% else %}
                  <img src="{% static 'img/Gifters/favicongift.png' %}"
                       alt="@{{ r.id_usuario.nombre_usuario|default:r.id_usuario.username }}"
                       width="72" height="72" class="rounded-circle mb-3"
                       style="object-fit:cover;" loading="lazy">
                {% endif %}

                <h5 class="mb-0">
                  @{{ r.id_usuario.nombre_usuario|default:r.id_usuario.username }}
                </h5>
                <small class="text-muted">{{ r.fecha_resena|date:"d/m/Y" }}</small>

                <div class="mt-2" aria-label="{{ r.calificacion }} de 5">
                  {% for i in "12345"|make_list %}
                    <i class="bi {% if forloop.counter <= r.calificacion %}bi-star-fill{% else %}bi-star{% endif %}"></i>
                  {% endfor %}
                </div>

                <p class="mt-3 mb-0">{{ r.comentario|default:"(Sin comentario)" }}</p>

                {# Botoncitos tambi√©n en la tarjeta (solo si es tu rese√±a) #}
                {% if user.is_authenticated and r.id_usuario_id == user.id %}
                  <div class="mt-2">
                    <a href="#form-editar-resena" class="btn btn-outline-secondary btn-sm">Editar</a>
                    <form action="{% url 'resena_sitio_eliminar' %}" method="post" style="display:inline;">
                      {% csrf_token %}
                      <button class="btn btn-outline-danger btn-sm"
                              onclick="return confirm('¬øEliminar tu rese√±a?')">
                        Eliminar
                      </button>
                    </form>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center text-muted">A√∫n no hay rese√±as. ¬°S√© el primero en opinar!</div>
    {% endif %}
  </div>
</section>


<!-- Fin rese√±itas nuevas-->
<!-- Fin rese√±itas nuevas-->
<!-- Fin rese√±itas nuevas-->



<!-- Contact -->
<section id="contact" class="contact section">
  <div class="container section-title">
    <h2>Contacto</h2>
    <p><span>¬øNecesitas ayuda?</span> <span class="description-title"></span></p>
    <a href="ayuda" class="gift">Contactanos!</a>
  </div>
</section>
<style>
  .wishlist-btn .bi {
    transition: transform .18s ease;
  }

  .wishlist-btn.heart-pop .bi {
    animation: heartPop .28s ease;
  }

  @keyframes heartPop {
    0% {
      transform: scale(1)
    }

    50% {
      transform: scale(1.35)
    }

    100% {
      transform: scale(1)
    }
  }
</style>

<style>
  /* Coraz√≥n flotante en la foto */
  .product-image-container {
    position: relative;
  }

  .wishlist-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 38px;
    height: 38px;
    display: grid;
    place-items: center;
    background: rgba(255, 255, 255, .95);
    border-radius: 9999px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, .12);
    z-index: 2;
    text-decoration: none;
  }

  .wishlist-badge:hover {
    transform: translateY(-1px);
  }

  /* (reutiliza tu anim) */
  .wishlist-badge .bi {
    transition: transform .18s ease;
  }

  .wishlist-badge.heart-pop .bi {
    animation: heartPop .28s ease;
  }

  /* Texto azul para los nombres de categor√≠as */
  .categorias-carousel .cat-name {
    color: #4D6BFF;
    font-weight: 700;
  }

  /* Por si alguna card no usa <span class="cat-name"> (fallback) */
  .categorias-carousel .swiper-slide a {
    color: #4D6BFF !important;
    text-decoration: none;
  }

  .categorias-carousel .swiper-slide a:hover,
  .categorias-carousel .swiper-slide a:focus {
    color: #4D6BFF !important;
    text-decoration: none;
  }


  @keyframes heartPop {
    0% {
      transform: scale(1)
    }

    50% {
      transform: scale(1.35)
    }

    100% {
      transform: scale(1)
    }
  }
</style>



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 1600,
    timerProgressBar: true
  });

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  document.addEventListener('click', async function (e) {
    const btn = e.target.closest('.wishlist-btn');
    if (!btn) return;

    e.preventDefault();
    const id = btn.getAttribute('data-product-id');
    const icon = btn.querySelector('i');
    const wasFav = btn.classList.contains('is-fav');
    const prevTitle = btn.title;

    // Animaci√≥n t√°ctil r√°pida
    btn.classList.add('heart-pop');
    setTimeout(() => btn.classList.remove('heart-pop'), 320);

    try {
      const url = `{% url 'favoritos_toggle' 0 %}`.replace('/0/', `/${id}/`);
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
      });

      if (resp.redirected || resp.url.includes('{% url "login" %}')) {
        window.location.href = "{% url 'login' %}?next={{ request.get_full_path|urlencode }}";
        return;
      }
      if (!resp.ok) throw new Error('HTTP ' + resp.status);

      const data = await resp.json();
      const isFav = data.state === 'added';

      // Actualiza UI del bot√≥n
      btn.classList.toggle('is-fav', isFav);
      btn.setAttribute('aria-pressed', isFav ? 'true' : 'false');
      btn.title = isFav ? 'Quitar de wishlist' : 'Agregar a wishlist';
      if (icon) icon.className = isFav ? 'bi bi-heart-fill text-danger' : 'bi bi-heart';

      // Feedback
      Toast.fire({
        icon: isFav ? 'success' : 'info',
        title: isFav ? 'Agregado a tu wishlist' : 'Quitado de tu wishlist'
      });

    } catch (err) {
      console.error(err);
      // Revertir UI si falla
      btn.classList.toggle('is-fav', wasFav);
      btn.setAttribute('aria-pressed', wasFav ? 'true' : 'false');
      btn.title = prevTitle;
      if (icon) icon.className = wasFav ? 'bi bi-heart-fill text-danger' : 'bi bi-heart';

      Toast.fire({ icon: 'error', title: 'Ups, no pudimos actualizar' });
    }
  });
</script>

{% endblock %}