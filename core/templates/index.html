{% extends "base.html" %}
{% load static %}

{% block title %}Gifter‚Äôs{% endblock %}
{% block body_class %}index-page{% endblock %}

{% block content %}

{# --- ESTILOS EXTRA ESPEC√çFICOS PARA CORREGIR EL INDEX M√ìVIL --- #}
<style>
  /* SOLUCI√ìN GLOBAL AL DESBORDAMIENTO (La franja blanca) */
  html,
  body {
    max-width: 100% !important;
    overflow-x: hidden !important;
    /* Corta cualquier cosa que se salga de la pantalla */
    position: relative;
  }

  /* Ajustes generales para m√≥vil */
  @media (max-width: 768px) {

    /* Reducir espacios verticales exagerados */
    section.section {
      padding-top: 20px !important;
      padding-bottom: 20px !important;
    }

    /* Ajuste de t√≠tulos */
    .section-title {
      padding-bottom: 10px !important;
      margin-bottom: 0 !important;
      padding-left: 15px !important;
      /* Un poco m√°s de aire para que no se pegue */
      padding-right: 15px !important;
    }

    .section-title h2 {
      font-size: 18px !important;
      /* Un poco m√°s grande para legibilidad */
    }

    .section-title p {
      font-size: 1rem !important;
      margin-top: 5px !important;
    }

    /* CONTROL DE ANCHOS Y CONTENEDORES */

    /* Evitar que las .row de Bootstrap rompan el ancho */
    .row {
      margin-left: 0 !important;
      margin-right: 0 !important;
      width: 100% !important;
    }

    /* Contenedores con padding seguro */
    .container {
      padding-left: 15px !important;
      padding-right: 15px !important;
      max-width: 100% !important;
      overflow: hidden;
      /* Seguridad extra */
    }

    /* EXCEPCI√ìN: El carrusel de categor√≠as */
    #clients .container {
      padding-left: 0 !important;
      padding-right: 0 !important;
      overflow: visible !important;
      /* Necesario para que se vea el swiper */
    }

    /* Ajuste del swiper para que fluya desde el borde */
    .categorias-carousel .swiper {
      padding-left: 15px !important;
      padding-right: 0 !important;
      padding-bottom: 30px !important;
    }

    /* Ajuste de tarjetas de productos */
    .portfolio-item .product-image-container {
      height: 200px !important;
    }

    /* Las columnas en m√≥vil deben tener padding para no pegarse entre s√≠ */
    .col-lg-4,
    .col-md-6,
    .col-12 {
      padding-left: 8px !important;
      padding-right: 8px !important;
    }
  }

  .feriado-banner {
    background: #f4f7ff;
    border: 1px solid #d0ddff;
    border-left: 4px solid #2563eb;
    border-radius: 999px;
    padding: 8px 22px;
    margin: 16px auto;
    text-align: center;
    max-width: 960px;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 0.95rem;
    color: #1f2937;
    font-weight: 500;
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.6s ease, transform 0.6s ease;
    box-shadow: 0 3px 10px rgba(37, 99, 235, 0.1);
  }

  @keyframes feriadoPop {
    0% {
      transform: translateY(-8px) scale(0.96);
      opacity: 0;
    }

    60% {
      transform: translateY(0) scale(1.04);
      opacity: 1;
    }

    100% {
      transform: translateY(0) scale(1);
      opacity: 1;
    }
  }

  .feriado-banner.feriado-pop {
    animation: feriadoPop 0.7s ease-out;
  }

  @media (max-width: 576px) {
    .feriado-banner {
      font-size: 0.85rem;
      padding: 6px 14px;
      border-left-width: 3px;
      margin: 10px auto;
      width: calc(100% - 30px);
    }
  }
</style>

<section id="feriado-banner" class="feriado-banner shadow-sm" style="display:none;">
  üéâ <span id="feriado-msg"></span>
</section>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const res = await fetch("/api/feriados/proximo/");
      const data = await res.json();
      if (!data.ok || !data.holiday) return;

      const name = data.holiday.name_es || data.holiday.name;
      const fechaStr = data.holiday.date;
      const hoy = new Date(); hoy.setHours(0, 0, 0, 0);
      const fechaFeriado = new Date(fechaStr); fechaFeriado.setHours(0, 0, 0, 0);

      const diffMs = fechaFeriado - hoy;
      const diffDias = diffMs / (1000 * 60 * 60 * 24);
      const MAX_DIAS = 60;
      if (diffDias < 0 || diffDias > MAX_DIAS) return;

      const fechaBonita = fechaFeriado.toLocaleDateString("es-CL", { weekday: "long", day: "numeric", month: "long" });
      let texto;
      if (diffDias === 0) texto = `Hoy es ${name} (${fechaBonita}) ‚Äî ¬°ideal para sorprender a alguien! üéÅ`;
      else if (diffDias === 1) texto = `Ma√±ana es ${name} (${fechaBonita}) ‚Äî ¬°una buena ocasi√≥n para regalar! üéÅ`;
      else texto = `Se acerca ${name} (${fechaBonita}) ‚Äî ¬°una buena ocasi√≥n para regalar! üéÅ`;

      const banner = document.getElementById("feriado-banner");
      const msg = document.getElementById("feriado-msg");
      msg.textContent = texto;
      banner.style.display = "flex";
      banner.style.opacity = "0";
      banner.style.transform = "translateY(-10px)";
      requestAnimationFrame(() => {
        banner.style.opacity = "1";
        banner.style.transform = "translateY(0)";
        banner.classList.add("feriado-pop");
      });
      setTimeout(() => { banner.classList.remove("feriado-pop"); }, 800);
    } catch (err) { console.warn("No se pudo cargar feriado:", err); }
  });
</script>

{% if not user.is_authenticated %}
<section id="hero" class="hero section light-background">
  <div class="container">
    <div class="row gy-4">
      <div class="col-lg-12 d-flex flex-column justify-content-center align-items-center text-center"
        data-aos="zoom-out">
        <h1>
          Bienvenido a <span class="brand">Gifter‚Äôs</span>
          <img src="{% static 'img/Gifters/favicongift.png' %}" alt="Logo Gifter‚Äôs" class="inline-logo">
        </h1>
        <p>‚ÄúConecta, descubre y regala momentos √∫nicos.‚Äù</p>
        <div class="d-flex justify-content-center gap-3 mt-3">
          <a href="#portfolio" class="gift">Empieza a buscar regalos</a>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="featured-services" class="featured-services section">
  <div class="container">
    <div class="row gy-4">
      <div class="col-xl-3 col-md-6 d-flex" data-aos="fade-up" data-aos-delay="100">
        <div class="service-item position-relative">
          <div class="icon"><i class="bi bi-heart-fill icon" style="color:#6c63ff;"></i></div>
          <h4><a href="#portfolio" class="stretched-link">Regala cari√±o</a></h4>
          <p>Un detalle sincero vale m√°s que mil palabras.</p>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 d-flex" data-aos="fade-up" data-aos-delay="200">
        <div class="service-item position-relative">
          <div class="icon"><i class="bi bi-gift-fill icon" style="color:#6c63ff;"></i></div>
          <h4><a href="#portfolio" class="stretched-link">El detalle perfecto</a></h4>
          <p>Encuentra ideas √∫nicas que sorprenden a quienes m√°s quieres.</p>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 d-flex" data-aos="fade-up" data-aos-delay="300">
        <div class="service-item position-relative">
          <div class="icon"><i class="bi bi-stars icon" style="color:#6c63ff;"></i></div>
          <h4><a href="#portfolio" class="stretched-link">Hazlo especial</a></h4>
          <p>No importa el tama√±o del regalo, importa la emoci√≥n que transmite.</p>
        </div>
      </div>
      <div class="col-xl-3 col-md-6 d-flex" data-aos="fade-up" data-aos-delay="400">
        <div class="service-item position-relative">
          <div class="icon"><i class="bi bi-people-fill icon" style="color:#6c63ff;"></i></div>
          <h4><a href="#portfolio" class="stretched-link">Conecta personas</a></h4>
          <p>Regalar es compartir momentos que se quedan para siempre.</p>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %}

<div class="container section-title" data-aos="fade-up">
  {% if is_admin %}
  <h2>Bienvenido</h2>
  <div class="admin-download-section"
    style="margin-top: 20px; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9;">
    <h4>Descarga para Administradores</h4>
    <p>Descarga la aplicaci√≥n de escritorio para administrar Gifter's:</p>

    <a href="{% static 'downloads/GiftersAdmin-v1.5.rar' %}" download class="btn btn-primary">
      Descargar Gifter's Admin
    </a>
  </div>
  {% endif %}
</div>

{% if user.is_authenticated %}
<div class="container section-title" data-aos="fade-up">
  <h2>Bienvenido</h2>
  <p><span>&nbsp;</span> <span class="description-title">Explora nuestras categor√≠as</span></p>
</div>
{% endif %}

<section id="clients" class="clients section light-background categorias-carousel">
  <div class="container">
    {% if categorias %}
    <div class="swiper init-swiper">
      <script type="application/json" class="swiper-config">
        {
          "loop": true,
          "speed": 600,
          "autoplay": { "delay": 5000 },
          "slidesPerView": "auto",
          "pagination": { 
            "el": ".swiper-pagination", 
            "type": "bullets", 
            "clickable": true 
          },
          "navigation": {
            "nextEl": ".swiper-button-next",
            "prevEl": ".swiper-button-prev"
          },
          "breakpoints": {
            "320": { 
              "slidesPerView": 2.3, 
              "spaceBetween": 12,
              "centeredSlides": false
            },
            "480": { 
              "slidesPerView": 3.3, 
              "spaceBetween": 15 
            },
            "640": { 
              "slidesPerView": 4, 
              "spaceBetween": 25 
            },
            "768": { 
              "slidesPerView": 5, 
              "spaceBetween": 30 
            },
            "992": { 
              "slidesPerView": 6, 
              "spaceBetween": 35 
            },
            "1200": { 
              "slidesPerView": 7, 
              "spaceBetween": 40 
            }
          }
        }
      </script>

      <div class="swiper-wrapper align-items-center">
        {% for categoria in categorias %}
        <div class="swiper-slide">
          <a href="{% url 'productos_list' %}?categoria={{ categoria.id_categoria }}" class="cat-card">
            <span class="cat-name">{{ categoria.nombre_categoria }}</span>
          </a>
        </div>
        {% endfor %}
      </div>

      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-pagination"></div>
    </div>
    {% else %}
    <div class="text-center py-4">
      <p class="text-muted">No hay categor√≠as disponibles en este momento.</p>
    </div>
    {% endif %}
  </div>
</section>

{% if request.user.is_authenticated %}
<section id="ai-reco" class="portfolio section">
  <div class="container section-title" data-aos="fade-up">
    <h2>Recomendado para ti</h2>
    <p><span>&nbsp;</span> <span class="description-title">Basado en tu actividad</span></p>
  </div>

  <div class="container">
    {% if ai_reco and ai_reco|length > 0 %}
    <div class="row gy-4 justify-content-center" data-aos="fade-up" data-aos-delay="100">
      {% for producto in ai_reco %}

      <div class="col-lg-4 col-md-6" id="reco-card-{{ producto.id_producto }}">
        <div class="portfolio-item">
          <div class="product-image-container" style="height: 250px; overflow: hidden; border-radius: 8px;">
            <a href="#"
              class="wishlist-badge wishlist-btn {% if producto.id_producto in favoritos_ids %}is-fav{% endif %}"
              data-product-id="{{ producto.id_producto }}"
              title="{% if producto.id_producto in favoritos_ids %}Quitar de wishlist{% else %}Agregar a wishlist{% endif %}"
              aria-pressed="{% if producto.id_producto in favoritos_ids %}true{% else %}false{% endif %}">

              {% if producto.id_producto in favoritos_ids %}
              <i class="bi bi-heart-fill text-danger"></i>
              {% else %}
              <i class="bi bi-heart"></i>
              {% endif %}
            </a>

            {% if producto.imagen %}
            {% if producto.imagen.url %}
            <img src="{{ producto.imagen.url }}" class="img-fluid" style="width:100%; height:100%; object-fit:cover;">
            {% elif producto.imagen|slice:':4' == 'http' %}
            <img src="{{ producto.imagen }}" class="img-fluid" style="width:100%; height:100%; object-fit:cover;">
            {% else %}
            <img src="/media/{{ producto.imagen }}" class="img-fluid"
              style="width:100%; height:100%; object-fit:cover;">
            {% endif %}
            {% else %}
            <img src="{% static 'img/Gifters/favicongift.png' %}" class="img-fluid"
              style="width:100%; height:100%; object-fit:cover;">
            {% endif %}

          </div>

          <div class="portfolio-info">
            <h4>{{ producto.nombre_producto }}</h4>
            {% if producto.id_marca %}
            <p class="text-primary">{{ producto.id_marca.nombre_marca }}</p>
            {% endif %}

            <div class="product-actions">
              {% if producto.imagen and producto.imagen.url %}
              <a href="{{ producto.imagen.url }}" class="glightbox preview-link"
                data-gallery="gal-reco-{{ producto.id_producto }}">
                <i class="bi bi-zoom-in"></i>
              </a>
              {% else %}
              
              {% endif %}

              <a href="#" class="btn btn-sm reco-dislike-btn" data-product-id="{{ producto.id_producto }}"
                title="No me interesa">
                <i class="bi bi-hand-thumbs-down"></i>
              </a>
              <a href="{% url 'producto_detalle' producto.id_producto %}" class="details-link">
                <i class="bi bi-eye"></i>
              </a>
              {% with producto.urls_tienda_activas.first as url_tienda %}
              {% if url_tienda %}

              {% endif %}
              {% endwith %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center text-muted mt-4">
      <p>
        A√∫n no tengo suficientes se√±ales para recomendarte productos.<br>
        Agrega algunos a tu wishlist o marca recibidos, y vuelve üòâ
      </p>
    </div>
    {% endif %}
  </div>
</section>
{% endif %}

<section id="portfolio" class="portfolio section">
  <div class="container text-center" data-aos="fade-up">
    <span id="pop-pill" class="badge rounded-pill px-4 py-2 mb-2 bg-primary">TENDENCIAS</span>
    <h2 id="pop-title" class="fw-bold">Productos m√°s populares</h2>
    <p id="pop-rationale" class="text-muted mt-1" style="max-width:720px;margin:0 auto;"></p>
  </div>

  <div class="container">
    <div class="row gy-4 justify-content-center" id="pop-grid" data-aos="fade-up" data-aos-delay="120">
      <div class="col-12 text-center text-muted" id="pop-skel">Cargando tendencias‚Ä¶</div>
    </div>

    <div class="text-center mt-4" id="pop-vermas" style="display:none;">
      <a href="{% url 'productos_list' %}" class="btn btn-primary">Ver todos los productos</a>
    </div>
  </div>
</section>

{% if request.user.is_authenticated %}
{{ favoritos_ids|json_script:"fav-ids-json" }}
<script>
  (function () {
    try {
      const arr = JSON.parse(document.getElementById('fav-ids-json').textContent) || [];
      window.FAV_IDS = new Set(arr.map(Number));
    } catch (_) {
      window.FAV_IDS = new Set();
    }
  })();
</script>
{% else %}
<script>window.FAV_IDS = new Set();</script>
{% endif %}

<script>
  (async () => {
    const grid = document.getElementById('pop-grid');
    const pill = document.getElementById('pop-pill');
    const title = document.getElementById('pop-title');
    const ratel = document.getElementById('pop-rationale');
    const btnMore = document.getElementById('pop-vermas');

    try {
      const res = await fetch("{% url 'populares_ai' %}?k=6");
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      pill.textContent = data.pill || 'TENDENCIAS';
      title.textContent = data.title || 'Productos m√°s populares';

      const rationale = (data.rationale || '').trim();
      if (rationale) ratel.textContent = rationale; else ratel.style.display = 'none';

      grid.innerHTML = '';

      const badgeMap = {};
      (data.badges || []).forEach(b => { badgeMap[b.product_id] = b.badge; });

      const items = Array.isArray(data.items) ? data.items : [];
      if (!items.length) {
        grid.innerHTML = `<div class="col-12 text-center text-muted">No hay tendencias por ahora.</div>`;
        return;
      }

      items.forEach(p => {
        const col = document.createElement('div');
        col.className = 'col-lg-4 col-md-6'; // En m√≥vil ser√° col-12 y se centrar√° gracias a justify-content-center

        const img =
          (p.img && p.img.startsWith("http")) ? p.img :
            (p.img_url && p.img_url.startsWith("http")) ? p.img_url :
              (p.img ? `/media/${p.img}` : "{% static 'img/Gifters/favicongift.png' %}");
        const marca = p.marca ? `<p class="text-primary">${p.marca}</p>` : '';
        const productoUrl = "{% url 'producto_detalle' 0 %}".replace('/0/', `/${p.id}/`);
        const tiendaUrl = p.url ? `<a href="${p.url}" target="_blank" rel="noopener" class="details-link"><i class="bi bi-link-45deg"></i></a>` : '';

        const badgeTxt = (badgeMap[p.id] || '').trim();
        const badgeHtml = badgeTxt ? `<span class="badge-ribbon">${badgeTxt}</span>` : '';

        const fav = FAV_IDS.has(Number(p.id));
        const heartClass = fav ? 'wishlist-badge wishlist-btn is-fav' : 'wishlist-badge wishlist-btn';
        const heartTitle = fav ? 'Quitar de wishlist' : 'Agregar a wishlist';
        const heartIcon = fav ? 'bi bi-heart-fill text-danger' : 'bi bi-heart';
        const heartAria = fav ? 'true' : 'false';

        col.innerHTML = `
        <div class="portfolio-item">
          <div class="product-image-container" style="height: 250px; overflow: hidden; border-radius: 8px; position:relative;">
            ${badgeHtml}
            <a href="#" class="${heartClass}" data-product-id="${p.id}" aria-pressed="${heartAria}" title="${heartTitle}">
              <i class="${heartIcon}"></i>
            </a>
            <img src="${img}" class="img-fluid" alt="${p.nombre}" style="width:100%; height:100%; object-fit:cover;">
          </div>

          <div class="portfolio-info">
            <h4>${p.nombre}</h4>
            ${marca}
            <div class="product-actions">
              <a href="${img}" class="glightbox preview-link" data-gallery="gal-tendencias-${p.id}">
                <i class="bi bi-zoom-in"></i>
              </a>
              <a href="${productoUrl}" class="details-link">
                <i class="bi bi-eye"></i>
              </a>
            </div>
          </div>
        </div>
      `;
        grid.appendChild(col);
      });

      btnMore.style.display = 'block';
    } catch (e) {
      console.error(e);
      grid.innerHTML = `<div class="col-12 text-center text-danger">No pudimos cargar las tendencias.</div>`;
    }
  })();
</script>

<section id="services" class="services section" style="background-color: #f5f8ff;">
  <div class="container section-title" data-aos="fade-up">
    <h2>Conecta en Gifter‚Äôs</h2>
    <p><span>Personas que quiz√°s conozcas</span> <span class="description-title"></span></p>
  </div>

  {% if request.user.is_authenticated %}
  <div class="container position-relative" id="amigos-recomendados-container">
    <button id="recs-prev" class="recs-nav recs-prev" aria-label="Anterior">
      <i class="bi bi-chevron-left"></i>
    </button>
    <button id="recs-next" class="recs-nav recs-next" aria-label="Siguiente">
      <i class="bi bi-chevron-right"></i>
    </button>

    <div id="recs-track" class="recs-track">
      <div class="recs-card skeleton"></div>
      <div class="recs-card skeleton d-none d-md-block"></div>
      <div class="recs-card skeleton d-none d-lg-block"></div>
    </div>

    <div id="recs-empty" class="text-muted text-center py-3 d-none">Por ahora no hay sugerencias.</div>
    <div id="recs-error" class="text-danger text-center py-3 d-none">No se pudieron cargar sugerencias.</div>
  </div>

  <style>
    #amigos-recomendados-container {
      background: linear-gradient(180deg, #fff, #fbfcff 50%, #fff);
      border-radius: 20px;
      padding: 6px 8px 10px;
    }

    .recs-track {
      display: flex;
      gap: 18px;
      overflow: hidden;
      padding: 8px 8px 12px;
      scroll-behavior: smooth;
      align-items: stretch;
    }

    .recs-card {
      min-width: 260px;
      max-width: 260px;
      flex: 0 0 auto;
      border-radius: 18px;
      background: #fff;
      border: 1px solid #eef0f4;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
      transition: transform .18s ease, box-shadow .18s ease;
      display: flex;
      flex-direction: column;
    }

    .recs-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 34px rgba(0, 0, 0, .10);
    }

    .recs-body {
      display: flex;
      gap: 12px;
      padding: 14px 14px 10px;
      flex: 1 1 auto;
    }

    .recs-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      flex: 0 0 60px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, .12);
    }

    .recs-name {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      color: #1f2937;
      line-height: 1.2;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      overflow: hidden;
    }

    .recs-username {
      margin-top: 2px;
      font-size: .875rem;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .recs-reason {
      margin-top: 6px;
      font-size: .85rem;
      color: #365cf5;
      display: grid;
      grid-template-columns: 20px 1fr;
      align-items: center;
      gap: 6px;
    }

    .recs-reason-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .recs-footer {
      padding: 0 14px 14px;
      margin-top: auto;
    }

    .recs-btn {
      display: block;
      width: 100%;
      text-align: center;
      font-weight: 600;
      font-size: .9rem;
      padding: .52rem .8rem;
      border-radius: 12px;
      border: 1px solid #dbe2ff;
      background: linear-gradient(180deg, #fff, #f8fbff);
      color: #2b50f5;
      text-decoration: none;
    }

    .recs-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 42px;
      height: 42px;
      border-radius: 9999px;
      border: 1px solid #e8ecf3;
      background: #fff;
      display: grid;
      place-items: center;
      z-index: 5;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0, 0, 0, .08);
    }

    .recs-prev {
      left: -8px;
    }

    .recs-next {
      right: -8px;
    }

    @media (max-width: 576px) {
      .recs-prev {
        left: 4px;
      }

      .recs-next {
        right: 4px;
      }

      .recs-card {
        min-width: 85vw;
        max-width: 85vw;
      }
    }

    .skeleton {
      position: relative;
      height: 112px;
    }

    .skeleton::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 18px;
      background: linear-gradient(90deg, #f3f4f6 25%, #eceff3 37%, #f3f4f6 63%);
      background-size: 400% 100%;
      animation: shimmer 1.1s infinite;
      border: 1px solid #eef0f4;
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }
  </style>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const track = document.getElementById("recs-track");
      const prevBtn = document.getElementById("recs-prev");
      const nextBtn = document.getElementById("recs-next");
      const emptyMsg = document.getElementById("recs-empty");
      const errMsg = document.getElementById("recs-error");

      const hideArrowsIfNoOverflow = () => {
        const canScroll = track.scrollWidth > track.clientWidth + 4;
        prevBtn.style.display = canScroll ? "" : "none";
        nextBtn.style.display = canScroll ? "" : "none";
        track.classList.toggle("centered", !canScroll);
      };
      const syncArrows = () => {
        const max = track.scrollWidth - track.clientWidth - 2;
        prevBtn.style.opacity = track.scrollLeft <= 2 ? .35 : 1;
        nextBtn.style.opacity = track.scrollLeft >= max ? .35 : 1;
      };

      try {
        const res = await fetch("{% url 'api_amigos_recomendados' %}", { credentials: "same-origin" });
        if (!res.ok) throw new Error("network");
        const data = await res.json();
        const list = Array.isArray(data.results) ? data.results : [];

        track.innerHTML = "";
        if (!list.length) {
          emptyMsg.classList.remove("d-none");
          hideArrowsIfNoOverflow();
          return;
        }

        list.forEach(p => {
          const card = document.createElement("article");
          card.className = "recs-card";
          const avatar = p.avatar || "{% static 'img/Gifters/favicongift.png' %}";
          const full = (p.full_name || "").trim() || `@${p.username}`;
          const userUrl = "{% url 'perfil_detalle' 'USERNAME_PLACEHOLDER' %}".replace("USERNAME_PLACEHOLDER", p.username);

          card.innerHTML = `
            <div class="recs-body">
              <img class="recs-avatar" src="${avatar}" alt="${full}">
              <div class="w-100">
                <h3 class="recs-name">${full}</h3>
                <div class="recs-username">@${p.username}</div>
                <div class="recs-reason">
                  <i class="bi bi-people"></i>
                  <span class="recs-reason-text">${p.reason || 'Sugerencia'}</span>
                </div>
              </div>
            </div>
            <div class="recs-footer">
              <a class="recs-btn" href="${userUrl}">Ver perfil</a>
            </div>`;
          track.appendChild(card);
        });
        hideArrowsIfNoOverflow();
        syncArrows();
      } catch (e) {
        console.error("Recs error:", e);
        track.innerHTML = "";
        errMsg.classList.remove("d-none");
        prevBtn.style.display = "none";
        nextBtn.style.display = "none";
      }

      const step = 280;
      prevBtn.addEventListener("click", () => { track.scrollBy({ left: -step, behavior: "smooth" }); setTimeout(syncArrows, 240); });
      nextBtn.addEventListener("click", () => { track.scrollBy({ left: step, behavior: "smooth" }); setTimeout(syncArrows, 240); });
      track.addEventListener("scroll", syncArrows);
      window.addEventListener("resize", () => { hideArrowsIfNoOverflow(); syncArrows(); });
    });
  </script>

  {% else %}
  <div class="text-center py-3">
    <p class="text-muted">Inicia sesi√≥n para ver a tus amigos y sugerencias personalizadas.</p>
  </div>
  {% endif %}
</section>

<br><br>

<div class="container section-title" data-aos="fade-up">
  <h2>Rese√±as de nuestros usuarios</h2>
</div>
<br><br>

<section id="testimonials" class="section" style="padding-top:0;">
  <div class="container" data-aos="fade-up" data-aos-delay="100">
    {% if user.is_authenticated and not own_resena %}
    <form action="{% url 'resena_sitio_crear' %}" method="post" class="mb-4" id="form-crear-resena">
      {% csrf_token %}
      <div class="row g-2 align-items-start">
        <div class="col-auto">
          <label class="form-label mb-1">Calificaci√≥n</label>
          <input type="hidden" name="calificacion" value="5" class="js-rating-input">
          <div class="js-rating-stars" role="radiogroup" aria-label="Calificaci√≥n 1 a 5">
            {% for i in "12345"|make_list %}
            {% with n=forloop.counter %}
            <button type="button" class="btn btn-link p-0 me-1 rating-star" data-value="{{ n }}"
              aria-label="{{ n }} estrellas" aria-pressed="{% if n <= 5 %}true{% else %}false{% endif %}">
              <i class="bi {% if n <= 5 %}bi-star-fill{% else %}bi-star{% endif %} fs-4"></i>
            </button>
            {% endwith %}
            {% endfor %}
          </div>
        </div>
        <div class="col">
          <label for="id_comentario" class="form-label mb-1">Comentario</label>
          <textarea id="id_comentario" name="comentario" rows="2" class="form-control"
            placeholder="¬øQu√© te pareci√≥ la p√°gina? (opcional)"></textarea>
        </div>
        <div class="col-auto" style="margin-top:30px;">
          <button class="btn btn-primary" type="submit">Enviar rese√±a</button>
        </div>
      </div>
    </form>
    {% elif not user.is_authenticated %}
    
    {% endif %}

    {% if resenas %}
    <div id="resenasCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="5000"
      aria-label="Carrusel de rese√±as">
      <div class="carousel-inner">
        {% for r in resenas %}
        {% if forloop.first or forloop.counter0|divisibleby:3 %}
        <div class="carousel-item {% if forloop.first %}active{% endif %}">
          <div class="row justify-content-center g-3 align-items-stretch">
            {% endif %}

            <div class="col-md-6 col-lg-4 d-flex">
              <div class="card shadow-sm border-0 flex-fill" id="resena-{{ r.id }}">
                <div class="card-body text-center d-flex flex-column justify-content-between">
                  <div>
                    <a href="{% url 'perfil_publico' r.id_usuario.nombre_usuario|default:r.id_usuario.get_username|default:'usuario'|slugify %}"
                      class="text-decoration-none">
                      {% if r.id_usuario.perfil.profile_picture %}
                      <img src="{{ r.id_usuario.perfil.profile_picture.url }}"
                        alt="@{{ r.id_usuario.nombre_usuario|default:r.id_usuario.get_username|default:'usuario' }}"
                        class="review-avatar" loading="lazy">
                      {% else %}
                      <img src="{% static 'img/Gifters/favicongift.png' %}"
                        alt="@{{ r.id_usuario.nombre_usuario|default:r.id_usuario.get_username|default:'usuario' }}"
                        class="review-avatar" loading="lazy">
                      {% endif %}
                      <h5 class="mb-0 text-body t-handle">
                        @{{ r.id_usuario.nombre_usuario|default:r.id_usuario.get_username|default:'usuario' }}
                      </h5>
                    </a>
                    <small class="text-muted d-block fecha-resena">{{ r.fecha_resena|date:"d/m/Y" }}</small>
                    <div class="mt-2 estrellas" data-calificacion="{{ r.calificacion }}">
                      {% for i in "12345"|make_list %}
                      <i
                        class="bi {% if forloop.counter <= r.calificacion %}bi-star-fill{% else %}bi-star{% endif %}"></i>
                      {% endfor %}
                    </div>
                    <p class="mt-3 mb-3 comentario">{{ r.comentario|default:"(Sin comentario)" }}</p>
                  </div>
                  {% if user.is_authenticated and r.id_usuario_id == user.id %}
                  <div class="mt-auto">
                    <button type="button" class="btn btn-outline-primary btn-sm me-1 editar-btn" data-bs-toggle="modal"
                      data-bs-target="#editarResenaModal" data-id="{{ r.id }}" data-calificacion="{{ r.calificacion }}"
                      data-comentario="{{ r.comentario|escapejs }}">
                      <i class="bi bi-pencil"></i> Editar
                    </button>
                    <form action="{% url 'resena_sitio_eliminar' %}" method="post" style="display:inline;">
                      {% csrf_token %}
                      <button class="btn btn-outline-danger btn-sm" onclick="return confirm('¬øEliminar tu rese√±a?')">
                        <i class="bi bi-trash"></i> Eliminar
                      </button>
                    </form>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            {% if forloop.counter|divisibleby:3 or forloop.last %}
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>

      {% if resenas|length > 3 %}
      <div class="d-flex justify-content-center gap-2 mt-4">
        <button class="btn btn-primary px-3" type="button" data-bs-target="#resenasCarousel" data-bs-slide="prev"
          aria-label="Anterior">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button class="btn btn-primary px-3" type="button" data-bs-target="#resenasCarousel" data-bs-slide="next"
          aria-label="Siguiente">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      {% endif %}
    </div>
    {% else %}
    <div class="text-center text-muted">A√∫n no hay rese√±as. ¬°S√© el primero en opinar!</div>
    {% endif %}
  </div>
</section>

<div class="modal fade" id="editarResenaModal" tabindex="-1" aria-labelledby="editarResenaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-primary">
        <h5 class="modal-title text-white d-flex align-items-center" id="editarResenaLabel">
          <img src="{% static 'img/Gifters/favicongift.png' %}" alt="Gifter‚Äôs" width="22" height="22" class="me-2">
          Editar tu rese√±a
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <form id="form-editar-modal">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" name="id" id="editar-id">
          <input type="hidden" name="calificacion" id="editar-calificacion" value="5">
          <div class="d-flex justify-content-center mb-3" id="editar-estrellas">
            {% for i in "12345"|make_list %}
            {% with n=forloop.counter %}
            <button type="button" class="btn btn-link p-0 me-1 star-btn" data-value="{{ n }}">
              <i class="bi bi-star fs-4 text-warning"></i>
            </button>
            {% endwith %}
            {% endfor %}
          </div>
          <div class="mb-3">
            <label for="editar-comentario" class="form-label">Comentario</label>
            <textarea id="editar-comentario" name="comentario" rows="3" class="form-control"></textarea>
          </div>
          <div id="editar-success" class="alert alert-success py-2 text-center fade" role="alert">
            ‚úÖ Tu rese√±a fue actualizada
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  #testimonials .card {
    border-radius: 1rem;
    transition: transform .2s ease;
    min-height: 100%;
  }

  #testimonials .card:hover {
    transform: translateY(-4px);
  }

  #testimonials .card .card-body {
    display: flex;
    flex-direction: column;
  }

  #testimonials .card .mt-auto {
    margin-top: auto;
  }

  #testimonials .carousel-item {
    padding: 1rem 0;
    min-height: 420px;
  }

  #testimonials .carousel-inner {
    min-height: 420px;
  }

  #testimonials .btn-primary {
    background-color: #007bff;
    border-color: #007bff;
  }

  #testimonials .btn-primary:hover {
    background-color: #0056d2;
    border-color: #0056d2;
  }

  #editarResenaModal .modal-title {
    color: #fff !important;
  }

  #editarResenaModal .btn-close.btn-close-white {
    filter: none;
    opacity: 1;
  }

  .alert.fade {
    opacity: 0;
    transition: opacity .3s ease-in-out;
  }

  .alert.fade.show {
    opacity: 1;
  }

  #testimonials .t-handle {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  @media (max-width:768px) {
    #testimonials .col-md-6.col-lg-4 {
      flex: 0 0 50%;
      max-width: 50%;
    }
  }

  @media (max-width:576px) {
    #testimonials .col-md-6.col-lg-4 {
      flex: 0 0 100%;
      max-width: 100%;
    }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("editarResenaModal");
    const estrellas = modal.querySelectorAll(".star-btn");
    const inputCalif = document.getElementById("editar-calificacion");
    const inputId = document.getElementById("editar-id");
    const textarea = document.getElementById("editar-comentario");
    const form = document.getElementById("form-editar-modal");
    const Toast = Swal.mixin({ toast: true, position: "top-end", showConfirmButton: false, timer: 1500, timerProgressBar: true, background: "#fff", color: "#111" });

    modal.addEventListener("show.bs.modal", event => {
      const btn = event.relatedTarget;
      inputCalif.value = btn.getAttribute("data-calificacion");
      inputId.value = btn.getAttribute("data-id");
      textarea.value = btn.getAttribute("data-comentario");
      actualizarEstrellas(inputCalif.value);
    });

    estrellas.forEach(btn => {
      btn.addEventListener("click", () => {
        inputCalif.value = btn.getAttribute("data-value");
        actualizarEstrellas(inputCalif.value);
      });
    });

    form.addEventListener("submit", async e => {
      e.preventDefault();
      const fd = new FormData(form);
      const id = fd.get("id");
      try {
        const res = await fetch("{% url 'resena_sitio_editar' %}", {
          method: "POST",
          headers: { "X-CSRFToken": fd.get("csrfmiddlewaretoken"), "X-Requested-With": "XMLHttpRequest", "Accept": "application/json" },
          body: fd
        });
        if (!(res.status >= 200 && res.status < 400)) throw new Error("HTTP " + res.status);
        const ct = (res.headers.get("content-type") || "").toLowerCase();
        if (ct.includes("application/json")) await res.json(); else await res.text();
        const card = document.getElementById(`resena-${id}`);
        if (card) {
          card.querySelector(".comentario").textContent = fd.get("comentario") || "(Sin comentario)";
          actualizarEstrellasCarrusel(card.querySelector(".estrellas"), fd.get("calificacion"));
        }
        Toast.fire({ icon: "success", title: "Rese√±a actualizada correctamente" });
        setTimeout(() => { bootstrap.Modal.getInstance(modal).hide(); }, 800);
      } catch (err) {
        console.error(err);
        Swal.fire({ icon: "error", title: "Error", text: "No se pudo actualizar la rese√±a.", confirmButtonColor: "#007bff" });
      }
    });

    function actualizarEstrellas(val) {
      const v = Number(val) || 5;
      estrellas.forEach(b => {
        const n = b.getAttribute("data-value");
        b.querySelector("i").classList.replace(n <= v ? "bi-star" : "bi-star-fill", n <= v ? "bi-star-fill" : "bi-star");
      });
    }
    function actualizarEstrellasCarrusel(container, val) {
      container.querySelectorAll("i").forEach((i, idx) => {
        i.className = idx < val ? "bi bi-star-fill" : "bi bi-star";
      });
    }
  });
</script>

<style>
  .rating-star {
    text-decoration: none;
  }

  .rating-star:focus-visible {
    outline: 2px solid #6c63ff;
    border-radius: .4rem;
  }

  .rating-star:hover i {
    transform: scale(1.08);
  }
</style>
<script>
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.rating-star'); if (!btn) return;
    const group = btn.closest('.js-rating-stars');
    const hidden = group?.parentElement?.querySelector('.js-rating-input');
    if (!group || !hidden) return;
    const val = Math.max(1, Math.min(5, parseInt(btn.getAttribute('data-value'), 10) || 5));
    hidden.value = val;
    group.querySelectorAll('.rating-star i').forEach((icon, idx) => {
      icon.className = (idx + 1) <= val ? 'bi bi-star-fill fs-4' : 'bi bi-star fs-4';
    });
  });
</script>

<style>
  .wishlist-btn .bi {
    transition: transform .18s ease;
  }

  .wishlist-btn.heart-pop .bi {
    animation: heartPop .28s ease;
  }

  @keyframes heartPop {
    0% {
      transform: scale(1)
    }

    50% {
      transform: scale(1.35)
    }

    100% {
      transform: scale(1)
    }
  }

  .product-image-container {
    position: relative;
  }

  .wishlist-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 38px;
    height: 38px;
    display: grid;
    place-items: center;
    background: rgba(255, 255, 255, .95);
    border-radius: 9999px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, .12);
    z-index: 2;
    text-decoration: none;
  }

  .wishlist-badge:hover {
    transform: translateY(-1px);
  }

  .wishlist-badge .bi {
    transition: transform .18s ease;
  }

  .wishlist-badge.heart-pop .bi {
    animation: heartPop .28s ease;
  }

  .categorias-carousel .cat-name {
    color: #4D6BFF;
    font-weight: 700;
  }

  .categorias-carousel .swiper-slide a {
    color: #4D6BFF !important;
    text-decoration: none;
  }

  .categorias-carousel .swiper-slide a:hover,
  .categorias-carousel .swiper-slide a:focus {
    color: #4D6BFF !important;
    text-decoration: none;
  }

  .badge-ribbon {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 3;
    background: #2563eb;
    color: #fff;
    font-weight: 700;
    font-size: .75rem;
    padding: .28rem .55rem;
    border-radius: 10px;
    box-shadow: 0 6px 16px rgba(37, 99, 235, .18);
  }

  #testimonials .review-avatar {
    width: 72px !important;
    height: 72px !important;
    aspect-ratio: 1 / 1;
    border-radius: 50% !important;
    object-fit: cover;
    object-position: center;
    display: block;
    margin: 0 auto 0.75rem;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1600, timerProgressBar: true });
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  document.addEventListener('click', async function (e) {
    const btn = e.target.closest('.wishlist-btn'); if (!btn) return;
    e.preventDefault();
    const id = btn.getAttribute('data-product-id');
    const icon = btn.querySelector('i');
    const wasFav = btn.classList.contains('is-fav');
    const prevTitle = btn.title;
    btn.classList.add('heart-pop'); setTimeout(() => btn.classList.remove('heart-pop'), 320);

    try {
      const url = `{% url 'favoritos_toggle' 0 %}`.replace('/0/', `/${id}/`);
      const resp = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' } });
      if (resp.redirected || resp.url.includes('{% url "login" %}')) {
        window.location.href = "{% url 'login' %}?next={{ request.get_full_path|urlencode }}"; return;
      }
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();
      const isFav = data.state === 'added';
      btn.classList.toggle('is-fav', isFav);
      btn.setAttribute('aria-pressed', isFav ? 'true' : 'false');
      btn.title = isFav ? 'Quitar de wishlist' : 'Agregar a wishlist';
      if (icon) icon.className = isFav ? 'bi bi-heart-fill text-danger' : 'bi bi-heart';
      Toast.fire({ icon: isFav ? 'success' : 'info', title: isFav ? 'Agregado a tu wishlist' : 'Quitado de tu wishlist' });
    } catch (err) {
      console.error(err);
      btn.classList.toggle('is-fav', wasFav);
      btn.setAttribute('aria-pressed', wasFav ? 'true' : 'false');
      btn.title = prevTitle;
      if (icon) icon.className = wasFav ? 'bi bi-heart-fill text-danger' : 'bi bi-heart';
      Toast.fire({ icon: 'error', title: 'Ups, no pudimos actualizar' });
    }
  });

  document.addEventListener('DOMContentLoaded', function () {
    document.body.addEventListener('click', async function (event) {
      const dislikeButton = event.target.closest('.reco-dislike-btn');
      if (!dislikeButton) return;

      event.preventDefault();

      const productId = dislikeButton.dataset.productId;
      const card = document.getElementById(`reco-card-${productId}`);
      if (!productId || !card) return;

      // Obtener TODOS los productos visibles
      const visibleIds = Array.from(document.querySelectorAll('[id^="reco-card-"]'))
        .map(el => Number(el.id.replace('reco-card-', '')));

      const formData = new FormData();
      formData.append('product_id', productId);
      formData.append('feedback_type', 'dislike');
      formData.append('visible_ids', JSON.stringify(visibleIds));

      try {
        const response = await fetch("{% url 'recommendation_feedback' %}", {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        });

        if (!response.ok) throw new Error('Error del servidor');

        const data = await response.json();

        if (data.status === 'ok') {
          card.style.transition = 'opacity 0.35s ease, transform 0.35s ease';
          card.style.opacity = '0';
          card.style.transform = 'scale(0.9)';

          const row = card.closest('.row');

          setTimeout(() => {
            card.remove();

            const rec = data.new_recommendation;
            if (rec && row) {
              const newCard = document.createElement('div');
              newCard.className = 'col-lg-4 col-md-6';
              newCard.id = `reco-card-${rec.id}`;

              newCard.innerHTML = `
                            <div class="portfolio-item">
                                <div class="product-image-container" 
                                     style="height: 250px; overflow: hidden; border-radius: 8px;">

                                    <a href="#" class="wishlist-badge wishlist-btn" 
                                       data-product-id="${rec.id}">
                                        <i class="bi bi-heart"></i>
                                    </a>

                                    <img src="${rec.imagen_url || '/static/img/Gifters/favicongift.png'}"
                                         class="img-fluid"
                                         style="width:100%; height:100%; object-fit:cover;">
                                </div>

                                <div class="portfolio-info">
                                    <h4>${rec.nombre}</h4>

                                    <div class="product-actions">
                                        <a href="#" class="btn btn-sm reco-dislike-btn"
                                           data-product-id="${rec.id}">
                                           <i class="bi bi-hand-thumbs-down"></i>
                                        </a>

                                        <a href="${rec.url || '#'}" class="details-link" target="_blank">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;

              row.insertBefore(newCard, row.firstChild);

              newCard.style.opacity = '0';
              newCard.style.transform = 'scale(0.9)';
              newCard.style.transition = 'opacity 0.35s ease, transform 0.35s ease';

              requestAnimationFrame(() => {
                newCard.style.opacity = '1';
                newCard.style.transform = 'scale(1)';
              });
            }
          }, 350);
        }
      } catch (error) {
        console.error('Error al registrar feedback:', error);
      }
    });
  });


</script>

<div class="d-block d-md-none" style="height: 80px;"></div>

{% endblock %}