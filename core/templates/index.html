{% extends "base.html" %}
{% load static %}

{% block title %}Gifter‚Äôs{% endblock %}
{% block body_class %}index-page{% endblock %}

{% block content %}


{% if not user.is_authenticated %}
<section id="hero" class="hero section light-background">
  <div class="container">
    <div class="row gy-4">
      <div class="col-lg-12 d-flex flex-column justify-content-center align-items-center text-center"
        data-aos="zoom-out">
        <h1>
          Bienvenido a <span class="brand">Gifter‚Äôs</span>
          <img src="{% static 'img/Gifters/favicongift.png' %}" alt="Logo Gifter‚Äôs" class="inline-logo">
        </h1>
        <p>‚ÄúConecta, descubre y regala momentos √∫nicos.‚Äù</p>
        <div class="d-flex justify-content-center gap-3 mt-3">
          <a href="#portfolio" class="gift">Empieza a buscar regalos</a>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="featured-services" class="featured-services section">
  <div class="container">
    <div class="row gy-4">

      <div class="col-xl-3 col-md-6 d-flex" data-aos="fade-up" data-aos-delay="100">
        <div class="service-item position-relative">
          <div class="icon"><i class="bi bi-heart-fill icon" style="color:#6c63ff;"></i></div>
          <h4><a href="#portfolio" class="stretched-link">Regala cari√±o</a></h4>
          <p>Un detalle sincero vale m√°s que mil palabras.</p>
        </div>
      </div>

      <div class="col-xl-3 col-md-6 d-flex" data-aos="fade-up" data-aos-delay="200">
        <div class="service-item position-relative">
          <div class="icon"><i class="bi bi-gift-fill icon" style="color:#6c63ff;"></i></div>
          <h4><a href="#portfolio" class="stretched-link">El detalle perfecto</a></h4>
          <p>Encuentra ideas √∫nicas que sorprenden a quienes m√°s quieres.</p>
        </div>
      </div>

      <div class="col-xl-3 col-md-6 d-flex" data-aos="fade-up" data-aos-delay="300">
        <div class="service-item position-relative">
          <div class="icon"><i class="bi bi-stars icon" style="color:#6c63ff;"></i></div>
          <h4><a href="#portfolio" class="stretched-link">Hazlo especial</a></h4>
          <p>No importa el tama√±o del regalo, importa la emoci√≥n que transmite.</p>
        </div>
      </div>

      <div class="col-xl-3 col-md-6 d-flex" data-aos="fade-up" data-aos-delay="400">
        <div class="service-item position-relative">
          <div class="icon"><i class="bi bi-people-fill icon" style="color:#6c63ff;"></i></div>
          <h4><a href="#portfolio" class="stretched-link">Conecta personas</a></h4>
          <p>Regalar es compartir momentos que se quedan para siempre.</p>
        </div>
      </div>

    </div>
  </div>
</section>
{% endif %}




{% if not user.is_authenticated %}
<div class="container section-title" data-aos="fade-up">
  <h2>Categor√≠as</h2>
  <p><span>&nbsp;</span> <span class="description-title">Explora nuestras categor√≠as</span></p>
</div>
{% endif %}

<br><br>

<div class="container section-title" data-aos="fade-up">
  <h2>Bienvenido</h2>
  {% if is_admin %}
  <div class="admin-download-section"
    style="margin-top: 20px; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9;">
    <h4>Descarga para Administradores</h4>
    <p>Descarga la aplicaci√≥n de escritorio para administrar Gifter's:</p>
    {% load static %} {# Aseg√∫rate de tener esta l√≠nea al principio del archivo si no la tienes #}
    <a href="{% static 'downloads/main.exe' %}" download class="btn btn-primary">
      Descargar Gifter's Admin
    </a>

  </div>
  {% endif %}
  <p><span>&nbsp;</span> <span class="description-title"></span><span class="brand">Comienza a buscar
      regalos</span><span class="description-title">!</span></p>
</div>

<!-- Clients Section - CATEGOR√çAS DIN√ÅMICAS CON FLECHAS -->
<section id="clients" class="clients section light-background categorias-carousel">
  <div class="container">

    {% if categorias %}
    <div class="swiper init-swiper">
      <script type="application/json" class="swiper-config">
        {
          "loop": true,
          "speed": 600,
          "autoplay": { "delay": 5000 },
          "slidesPerView": "auto",
          "pagination": { 
            "el": ".swiper-pagination", 
            "type": "bullets", 
            "clickable": true 
          },
          "navigation": {
            "nextEl": ".swiper-button-next",
            "prevEl": ".swiper-button-prev"
          },
          "breakpoints": {
            "320": { 
              "slidesPerView": 2, 
              "spaceBetween": 15 
            },
            "480": { 
              "slidesPerView": 3, 
              "spaceBetween": 20 
            },
            "640": { 
              "slidesPerView": 4, 
              "spaceBetween": 25 
            },
            "768": { 
              "slidesPerView": 5, 
              "spaceBetween": 30 
            },
            "992": { 
              "slidesPerView": 6, 
              "spaceBetween": 35 
            },
            "1200": { 
              "slidesPerView": 7, 
              "spaceBetween": 40 
            }
          }
        }
      </script>

      <!-- Contenedor del carrusel -->
      <div class="swiper-wrapper align-items-center">
        {% for categoria in categorias %}
        <div class="swiper-slide">
          <a href="{% url 'productos_list' %}?categoria={{ categoria.id_categoria }}" class="cat-card">
            <span class="cat-name">{{ categoria.nombre_categoria }}</span>
          </a>
        </div>
        {% endfor %}
      </div>

      <!-- Flechas de navegaci√≥n -->
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>

      <!-- Puntos de paginaci√≥n -->
      <div class="swiper-pagination"></div>
    </div>
    {% else %}
    <div class="text-center py-4">
      <p class="text-muted">No hay categor√≠as disponibles en este momento.</p>
    </div>
    {% endif %}
  </div>
</section>

{# === Recomendado para ti (IA sobre cat√°logo) === #}
{% if request.user.is_authenticated %}
<section id="ai-reco" class="portfolio section">
  <div class="container section-title" data-aos="fade-up">
    <h2>Recomendado para ti</h2>
    <p><span>&nbsp;</span> <span class="description-title">Basado en tu actividad</span></p>
  </div>

  <div class="container">
    {% if ai_reco and ai_reco|length > 0 %}
    <div class="row gy-4" data-aos="fade-up" data-aos-delay="100">
      {% for producto in ai_reco %}

      <div class="col-lg-4 col-md-6" id="reco-card-{{ producto.id_producto }}">
        <div class="portfolio-item">
          <div class="product-image-container" style="height: 250px; overflow: hidden; border-radius: 8px;">
            <a href="#"
              class="wishlist-badge wishlist-btn {% if producto.id_producto in favoritos_ids %}is-fav{% endif %}"
              data-product-id="{{ producto.id_producto }}"
              title="{% if producto.id_producto in favoritos_ids %}Quitar de wishlist{% else %}Agregar a wishlist{% endif %}"
              aria-pressed="{% if producto.id_producto in favoritos_ids %}true{% else %}false{% endif %}">
              
              {% if producto.id_producto in favoritos_ids %}
              <i class="bi bi-heart-fill text-danger"></i>
              {% else %}
              <i class="bi bi-heart"></i>
              {% endif %}
            </a>

            {% if producto.imagen and producto.imagen.url %}
            <img src="{{ producto.imagen.url }}" class="img-fluid" alt="{{ producto.nombre_producto }}"
              style="width: 100%; height: 100%; object-fit: cover;">
            {% else %}
            <img src="{% static 'img/Gifters/favicongift.png' %}" class="img-fluid" alt="{{ producto.nombre_producto }}"
              style="width: 100%; height: 100%; object-fit: cover;">
            {% endif %}
          </div>

          <div class="portfolio-info">
            <h4>{{ producto.nombre_producto }}</h4>
            {% if producto.id_marca %}
            <p class="text-primary">{{ producto.id_marca.nombre_marca }}</p>
            {% endif %}

            <div class="product-actions">
              {% if producto.imagen and producto.imagen.url %}
              <a href="{{ producto.imagen.url }}" class="glightbox preview-link"
                data-gallery="gal-reco-{{ producto.id_producto }}">
                <i class="bi bi-zoom-in"></i>
              </a>
              
              {% else %}
              <a href="{% static 'img/Gifters/favicongift.png' %}" class="glightbox preview-link"
                data-gallery="gal-reco-{{ producto.id_producto }}">
                <i class="bi bi-zoom-in"></i>
              </a>
              {% endif %}

              <a href="#" class="btn btn-sm reco-dislike-btn" data-product-id="{{ producto.id_producto }}"
                title="No me interesa">
                <i class="bi bi-hand-thumbs-down"></i>
              </a>
              <a href="{% url 'producto_detalle' producto.id_producto %}" class="details-link">
                <i class="bi bi-eye"></i>
              </a>
              {% with producto.urls_tienda_activas.first as url_tienda %}
              {% if url_tienda %}
              <a href="{{ url_tienda.url }}" target="_blank" rel="noopener" class="details-link">
                <i class="bi bi-link-45deg"></i>
              </a>
              {% endif %}
              {% endwith %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center text-muted mt-4">
      <p>
        A√∫n no tengo suficientes se√±ales para recomendarte productos.<br>
        Agrega algunos a tu wishlist o marca recibidos, y vuelve üòâ
      </p>
    </div>
    {% endif %}
  </div>
</section>
{% endif %}

<section id="portfolio" class="portfolio section">
  <div class="container text-center" data-aos="fade-up">
  <span id="pop-pill" class="badge rounded-pill px-4 py-2 mb-2 bg-primary">TENDENCIAS</span>
  <h2 id="pop-title" class="fw-bold">Productos m√°s populares</h2>
  <p id="pop-rationale" class="text-muted mt-1" style="max-width:720px;margin:0 auto;"></p>
  </div>


  <div class="container">
    <div class="row gy-4" id="pop-grid" data-aos="fade-up" data-aos-delay="120">
      <!-- Las tarjetas se inyectan por JS -->
      <div class="col-12 text-center text-muted" id="pop-skel">Cargando tendencias‚Ä¶</div>
    </div>

    <div class="text-center mt-4" id="pop-vermas" style="display:none;">
      <a href="{% url 'productos_list' %}" class="btn btn-primary">Ver todos los productos</a>
    </div>
  </div>
</section>

<!-- 1) Estado inicial de favoritos para Tendencias -->
<script>
  // ids ya marcados como favoritos (del context Django)
  const FAV_IDS = new Set([
    {% for id in favoritos_ids %}{{ id }}{% if not forloop.last %},{% endif %}{% endfor %}
  ]);
</script>

<!-- 2) Carga de Tendencias (populares_ai) -->
<script>
(async () => {
  const grid  = document.getElementById('pop-grid');
  const pill  = document.getElementById('pop-pill');
  const title = document.getElementById('pop-title');
  const ratel = document.getElementById('pop-rationale');
  const btnMore = document.getElementById('pop-vermas');

  try {
    const res = await fetch("{% url 'populares_ai' %}?k=6");
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    pill.textContent  = data.pill   || 'TENDENCIAS';
    title.textContent = data.title  || 'Productos m√°s populares';

    const rationale = (data.rationale || '').trim();
    if (rationale) ratel.textContent = rationale; else ratel.style.display = 'none';

    grid.innerHTML = '';

    // Mapa de badges por product_id
    const badgeMap = {};
    (data.badges || []).forEach(b => { badgeMap[b.product_id] = b.badge; });

    const items = Array.isArray(data.items) ? data.items : [];
    if (!items.length) {
      grid.innerHTML = `<div class="col-12 text-center text-muted">No hay tendencias por ahora.</div>`;
      return;
    }

    items.forEach(p => {
      const col = document.createElement('div');
      col.className = 'col-lg-4 col-md-6';

      const img = p.img || "{% static 'img/Gifters/favicongift.png' %}";
      const marca = p.marca ? `<p class="text-primary">${p.marca}</p>` : '';
      const productoUrl = "{% url 'producto_detalle' 0 %}".replace('/0/', `/${p.id}/`);
      const tiendaUrl = p.url ? `<a href="${p.url}" target="_blank" rel="noopener" class="details-link"><i class="bi bi-link-45deg"></i></a>` : '';

      const badgeTxt = (badgeMap[p.id] || '').trim();
      const badgeHtml = badgeTxt ? `<span class="badge-ribbon">${badgeTxt}</span>` : '';

      // === Estado inicial del coraz√≥n (igual que en tus otras secciones) ===
      const fav = FAV_IDS.has(Number(p.id));
      const heartClass = fav ? 'wishlist-badge wishlist-btn is-fav' : 'wishlist-badge wishlist-btn';
      const heartTitle = fav ? 'Quitar de wishlist' : 'Agregar a wishlist';
      const heartIcon  = fav ? 'bi bi-heart-fill text-danger' : 'bi bi-heart';
      const heartAria  = fav ? 'true' : 'false';

      col.innerHTML = `
        <div class="portfolio-item">
          <div class="product-image-container" style="height: 250px; overflow: hidden; border-radius: 8px; position:relative;">
            ${badgeHtml}
            <a href="#" class="${heartClass}" data-product-id="${p.id}" aria-pressed="${heartAria}" title="${heartTitle}">
              <i class="${heartIcon}"></i>
            </a>
            <img src="${img}" class="img-fluid" alt="${p.nombre}" style="width:100%; height:100%; object-fit:cover;">
          </div>

          <div class="portfolio-info">
            <h4>${p.nombre}</h4>
            ${marca}
            <div class="product-actions">
              <a href="${img}" class="glightbox preview-link" data-gallery="gal-tendencias-${p.id}">
                <i class="bi bi-zoom-in"></i>
              </a>
              <a href="${productoUrl}" class="details-link">
                <i class="bi bi-eye"></i>
              </a>
              ${tiendaUrl}
            </div>
          </div>
        </div>
      `;
      grid.appendChild(col);
    });

    btnMore.style.display = 'block';
  } catch (e) {
    console.error(e);
    grid.innerHTML = `<div class="col-12 text-center text-danger">No pudimos cargar las tendencias.</div>`;
  }
})();
</script>





<section id="services" class="services section" style="background-color: #f5f8ff;">
  <div class="container section-title" data-aos="fade-up">
    <h2>Conecta en Gifter‚Äôs</h2>
    <p><span>Personas que quiz√°s conozcas</span> <span class="description-title"></span></p>
  </div>

  {% if request.user.is_authenticated %}
  <div class="container position-relative" id="amigos-recomendados-container">
    <!-- Flechas -->
    <button id="recs-prev" class="recs-nav recs-prev" aria-label="Anterior">
      <i class="bi bi-chevron-left"></i>
    </button>
    <button id="recs-next" class="recs-nav recs-next" aria-label="Siguiente">
      <i class="bi bi-chevron-right"></i>
    </button>

    <!-- Carril -->
    <div id="recs-track" class="recs-track">
      <!-- skeletons suaves -->
      <div class="recs-card skeleton"></div>
      <div class="recs-card skeleton d-none d-md-block"></div>
      <div class="recs-card skeleton d-none d-lg-block"></div>
    </div>

    <!-- estados -->
    <div id="recs-empty" class="text-muted text-center py-3 d-none">Por ahora no hay sugerencias.</div>
    <div id="recs-error" class="text-danger text-center py-3 d-none">No se pudieron cargar sugerencias.</div>
  </div>

  <style>
    #amigos-recomendados-container {
      background: linear-gradient(180deg, #fff, #fbfcff 50%, #fff);
      border-radius: 20px;
      padding: 6px 8px 10px;
    }

    /* ‚Äî‚Äî‚Äî Pildita superior ‚Äî‚Äî‚Äî */
    .pill-badge {
      display: inline-block;
      padding: .45rem .9rem;
      border-radius: 9999px;
      background: #0d6efd;
      color: #fff;
      font-weight: 600;
      letter-spacing: .3px;
      box-shadow: 0 6px 18px rgba(13, 110, 253, .18);
    }

    /* ‚Äî‚Äî‚Äî Contenedor scroll ‚Äî‚Äî‚Äî */
    .recs-track {
      display: flex;
      gap: 18px;
      overflow: hidden;
      padding: 8px 8px 12px;
      scroll-behavior: smooth;
    }

    /* ‚Äî‚Äî‚Äî Tarjeta ‚Äî‚Äî‚Äî */
    .recs-card {
      min-width: 260px;
      max-width: 260px;
      flex: 0 0 auto;
      border-radius: 18px;
      background: #fff;
      border: 1px solid #eef0f4;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }

    .recs-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 34px rgba(0, 0, 0, .10);
      border-color: #e4e7ee;
    }

    .recs-body {
      display: flex;
      gap: 12px;
      padding: 14px 14px 10px;
    }

    .recs-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      flex: 0 0 60px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, .12);
    }

    .recs-name {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      color: #1f2937;
    }

    .recs-username {
      margin-top: 2px;
      font-size: .875rem;
      color: #6b7280;
    }

    .recs-reason {
      margin-top: 6px;
      font-size: .85rem;
      color: #365cf5;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .recs-footer {
      padding: 0 14px 14px;
    }

    .recs-btn {
      display: block;
      width: 100%;
      text-align: center;
      font-weight: 600;
      font-size: .9rem;
      padding: .52rem .8rem;
      border-radius: 12px;
      border: 1px solid #dbe2ff;
      background: linear-gradient(180deg, #fff, #f8fbff);
      color: #2b50f5;
      text-decoration: none;
      transition: transform .14s ease, box-shadow .14s ease, background .14s ease;
    }

    .recs-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(43, 80, 245, .15);
      background: #fff;
    }

    /* ‚Äî‚Äî‚Äî Skeleton ‚Äî‚Äî‚Äî */
    .skeleton {
      position: relative;
      height: 112px;
    }

    .skeleton::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 18px;
      background:
        linear-gradient(90deg, #f3f4f6 25%, #eceff3 37%, #f3f4f6 63%);
      background-size: 400% 100%;
      animation: shimmer 1.1s infinite;
      border: 1px solid #eef0f4;
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    /* ‚Äî‚Äî‚Äî Flechas ‚Äî‚Äî‚Äî */
    .recs-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 42px;
      height: 42px;
      border-radius: 9999px;
      border: 1px solid #e8ecf3;
      background: #fff;
      display: grid;
      place-items: center;
      z-index: 5;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0, 0, 0, .08);
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    }

    .recs-nav:hover {
      transform: translateY(-50%) scale(1.03);
      box-shadow: 0 14px 32px rgba(0, 0, 0, .12);
    }

    .recs-prev {
      left: -8px;
    }

    .recs-next {
      right: -8px;
    }

    .recs-nav i {
      font-size: 1.1rem;
      color: #111827;
    }

    @media (max-width: 576px) {
      .recs-prev {
        left: 4px;
      }

      .recs-next {
        right: 4px;
      }

      .recs-card {
        min-width: 85vw;
        max-width: 85vw;
      }
    }
  </style>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const track = document.getElementById("recs-track");
      const prevBtn = document.getElementById("recs-prev");
      const nextBtn = document.getElementById("recs-next");
      const emptyMsg = document.getElementById("recs-empty");
      const errMsg = document.getElementById("recs-error");

      const hideArrowsIfNoOverflow = () => {
        const canScroll = track.scrollWidth > track.clientWidth + 4;
        prevBtn.style.display = canScroll ? "" : "none";
        nextBtn.style.display = canScroll ? "" : "none";
      };
      const syncArrows = () => {
        const max = track.scrollWidth - track.clientWidth - 2;
        prevBtn.style.opacity = track.scrollLeft <= 2 ? .35 : 1;
        nextBtn.style.opacity = track.scrollLeft >= max ? .35 : 1;
      };

      try {
        const res = await fetch("{% url 'api_amigos_recomendados' %}", { credentials: "same-origin" });
        if (!res.ok) throw new Error("network");
        const data = await res.json();
        const list = Array.isArray(data.results) ? data.results : [];

        // limpio skeletons
        track.innerHTML = "";

        if (!list.length) {
          emptyMsg.classList.remove("d-none");
          hideArrowsIfNoOverflow();
          return;
        }

        // render
        list.forEach(p => {
          const card = document.createElement("article");
          card.className = "recs-card";

          const avatar = p.avatar || "{% static 'img/Gifters/favicongift.png' %}";
          const full = (p.full_name || "").trim() || `@${p.username}`;
          const userUrl = "{% url 'perfil_detalle' 'USERNAME_PLACEHOLDER' %}".replace("USERNAME_PLACEHOLDER", p.username);

          card.innerHTML = `
          <div class="recs-body">
            <img class="recs-avatar" src="${avatar}" alt="${full}">
            <div class="w-100">
              <h3 class="recs-name">${full}</h3>
              <div class="recs-username">@${p.username}</div>
              <div class="recs-reason"><i class="bi bi-people"></i> ${p.reason || 'Sugerencia'}</div>
            </div>
          </div>
          <div class="recs-footer">
            <a class="recs-btn" href="${userUrl}">Ver perfil</a>
          </div>
        `;
          track.appendChild(card);
        });

        hideArrowsIfNoOverflow();
        syncArrows();
      } catch (e) {
        console.error("Recs error:", e);
        track.innerHTML = "";
        errMsg.classList.remove("d-none");
        prevBtn.style.display = "none";
        nextBtn.style.display = "none";
      }

      // navegaci√≥n
      const step = 280; // ~ ancho de card + gap
      prevBtn.addEventListener("click", () => { track.scrollBy({ left: -step, behavior: "smooth" }); setTimeout(syncArrows, 240); });
      nextBtn.addEventListener("click", () => { track.scrollBy({ left: step, behavior: "smooth" }); setTimeout(syncArrows, 240); });
      track.addEventListener("scroll", syncArrows);
      window.addEventListener("resize", () => { hideArrowsIfNoOverflow(); syncArrows(); });
    });
  </script>

  {% else %}
  <div class="text-center py-3">
    <p class="text-muted">Inicia sesi√≥n para ver a tus amigos y sugerencias personalizadas.</p>
  </div>
  {% endif %}
</section>





<!-- Tendencias - AHORA CON PRODUCTOS DESTACADOS -->



<!-- Rese√±itas nuevas -->
<!-- Rese√±itas nuevas -->
<!-- Rese√±itas nuevas -->

{# ========= Rese√±as del sitio ========= #}
<div class="container section-title" data-aos="fade-up">
  <h2>Rese√±as de nuestros usuarios</h2>
</div>

<section id="testimonials" class="section" style="padding-top:0;">
  <div class="container" data-aos="fade-up" data-aos-delay="100">

    {# --- Form (crear/editar) solo logueados --- #}
    {% if user.is_authenticated %}
    {% if own_resena %}
    {# ---- EDITAR rese√±a existente ---- #}
    <form action="{% url 'resena_sitio_editar' %}" method="post" class="mb-3" id="form-editar-resena">
      {% csrf_token %}
      <div class="row g-2 align-items-start">
        <div class="col-auto">
          <label class="form-label mb-1">Calificaci√≥n</label>

          {# valor real que se env√≠a 1..5 #}
          <input type="hidden" name="calificacion" value="{{ own_resena.calificacion|default:'5' }}"
            class="js-rating-input">

          {# estrellas clicables #}
          <div class="js-rating-stars" role="radiogroup" aria-label="Calificaci√≥n 1 a 5">
            {% for i in "12345"|make_list %}
            {% with n=forloop.counter %}
            <button type="button" class="btn btn-link p-0 me-1 rating-star" data-value="{{ n }}"
              aria-label="{{ n }} estrellas"
              aria-pressed="{% if n <= own_resena.calificacion %}true{% else %}false{% endif %}">
              <i class="bi {% if n <= own_resena.calificacion %}bi-star-fill{% else %}bi-star{% endif %} fs-4"></i>
            </button>
            {% endwith %}
            {% endfor %}
          </div>
        </div>

        <div class="col">
          <label for="id_comentario_edit" class="form-label mb-1">Comentario</label>
          <textarea id="id_comentario_edit" name="comentario" rows="2" class="form-control"
            placeholder="Actualiza tu rese√±a...">{{ own_resena.comentario }}</textarea>
        </div>
        <div class="col-auto" style="margin-top:30px;">
          <button class="btn btn-primary" type="submit">Editar rese√±a</button>
        </div>
      </div>
    </form>

    {% else %}
    {# ---- CREAR rese√±a (si no tienes) ---- #}
    <form action="{% url 'resena_sitio_crear' %}" method="post" class="mb-4" id="form-crear-resena">
      {% csrf_token %}
      <div class="row g-2 align-items-start">
        <div class="col-auto">
          <label class="form-label mb-1">Calificaci√≥n</label>

          {# valor real que se env√≠a 1..5 #}
          <input type="hidden" name="calificacion" value="5" class="js-rating-input">

          {# estrellas clicables (por defecto 5) #}
          <div class="js-rating-stars" role="radiogroup" aria-label="Calificaci√≥n 1 a 5">
            {% for i in "12345"|make_list %}
            {% with n=forloop.counter %}
            <button type="button" class="btn btn-link p-0 me-1 rating-star" data-value="{{ n }}"
              aria-label="{{ n }} estrellas" aria-pressed="{% if n <= 5 %}true{% else %}false{% endif %}">
              <i class="bi {% if n <= 5 %}bi-star-fill{% else %}bi-star{% endif %} fs-4"></i>
            </button>
            {% endwith %}
            {% endfor %}
          </div>
        </div>

        <div class="col">
          <label for="id_comentario" class="form-label mb-1">Comentario</label>
          <textarea id="id_comentario" name="comentario" rows="2" class="form-control"
            placeholder="¬øQu√© te pareci√≥ la p√°gina? (opcional)"></textarea>
        </div>
        <div class="col-auto" style="margin-top:30px;">
          <button class="btn btn-primary" type="submit">Enviar rese√±a</button>
        </div>
      </div>
    </form>
    {% endif %}
    {% else %}
    <p class="text-muted">Inicia sesi√≥n para dejar tu rese√±a.</p>
    {% endif %}

    {# --- Lista de rese√±as reales --- #}
    {% if resenas %}
    <div class="row g-4">
      {% for r in resenas %}
      <div class="col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body text-center">

            {# Foto de perfil a prueba de faltantes #}
            {% with pf=r.id_usuario.perfil %}
            {% if pf and pf.profile_picture %}
            <img src="{{ pf.profile_picture.url }}"
              alt="@{% firstof r.id_usuario.nombre_usuario r.id_usuario.get_username r.id_usuario.email 'usuario' %}"
              width="72" height="72" class="rounded-circle mb-3" style="object-fit:cover;" loading="lazy">
            {% else %}
            <img src="{% static 'img/Gifters/favicongift.png' %}"
              alt="@{% firstof r.id_usuario.nombre_usuario r.id_usuario.get_username r.id_usuario.email 'usuario' %}"
              width="72" height="72" class="rounded-circle mb-3" style="object-fit:cover;" loading="lazy">
            {% endif %}
            {% endwith %}

            <h5 class="mb-0">
              @{% firstof r.id_usuario.nombre_usuario r.id_usuario.get_username r.id_usuario.email 'usuario' %}
            </h5>
            <small class="text-muted">{{ r.fecha_resena|date:"d/m/Y" }}</small>

            <div class="mt-2" aria-label="{{ r.calificacion }} de 5">
              {% for i in "12345"|make_list %}
              <i class="bi {% if forloop.counter <= r.calificacion %}bi-star-fill{% else %}bi-star{% endif %}"></i>
              {% endfor %}
            </div>

            <p class="mt-3 mb-0">{{ r.comentario|default:"(Sin comentario)" }}</p>

            {# Botones dentro de la tarjeta si es tuya #}
            {% if user.is_authenticated and r.id_usuario_id == user.id %}
            <div class="mt-2">
              <a href="#form-editar-resena" class="btn btn-outline-secondary btn-sm">Editar</a>
              <form action="{% url 'resena_sitio_eliminar' %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button class="btn btn-outline-danger btn-sm" onclick="return confirm('¬øEliminar tu rese√±a?')">
                  Eliminar
                </button>
              </form>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center text-muted">A√∫n no hay rese√±as. ¬°S√© el primero en opinar!</div>
    {% endif %}
  </div>
</section>

{# ====== CSS/JS del widget de estrellas (ligero) ====== #}
<style>
  .rating-star {
    text-decoration: none;
  }

  .rating-star:focus-visible {
    outline: 2px solid #6c63ff;
    border-radius: .4rem;
  }

  .rating-star:hover i {
    transform: scale(1.08);
  }
</style>

<script>
  // Widget de estrellas compartido por ambos formularios
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.rating-star');
    if (!btn) return;

    const group = btn.closest('.js-rating-stars');
    const hidden = group?.parentElement?.querySelector('.js-rating-input');
    if (!group || !hidden) return;

    const val = parseInt(btn.getAttribute('data-value'), 10) || 5;
    const clamped = Math.max(1, Math.min(5, val));
    hidden.value = clamped;

    const stars = group.querySelectorAll('.rating-star i');
    stars.forEach((icon, idx) => {
      icon.className = (idx + 1) <= clamped ? 'bi bi-star-fill fs-4' : 'bi bi-star fs-4';
    });
  });
</script>


<!-- Fin rese√±itas nuevas-->
<!-- Fin rese√±itas nuevas-->
<!-- Fin rese√±itas nuevas-->



<!-- Contact -->
<section id="contact" class="contact section">
  <div class="container section-title">
    <h2>Contacto</h2>
    <p><span>¬øNecesitas ayuda?</span> <span class="description-title"></span></p>
    <a href="ayuda" class="gift">Contactanos!</a>
  </div>
</section>
<style>
  .wishlist-btn .bi {
    transition: transform .18s ease;
  }

  .wishlist-btn.heart-pop .bi {
    animation: heartPop .28s ease;
  }

  @keyframes heartPop {
    0% {
      transform: scale(1)
    }

    50% {
      transform: scale(1.35)
    }

    100% {
      transform: scale(1)
    }
  }
</style>

<style>
  /* Coraz√≥n flotante en la foto */
  .product-image-container {
    position: relative;
  }

  .wishlist-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 38px;
    height: 38px;
    display: grid;
    place-items: center;
    background: rgba(255, 255, 255, .95);
    border-radius: 9999px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, .12);
    z-index: 2;
    text-decoration: none;
  }

  .wishlist-badge:hover {
    transform: translateY(-1px);
  }

  /* (reutiliza tu anim) */
  .wishlist-badge .bi {
    transition: transform .18s ease;
  }

  .wishlist-badge.heart-pop .bi {
    animation: heartPop .28s ease;
  }

  /* Texto azul para los nombres de categor√≠as */
  .categorias-carousel .cat-name {
    color: #4D6BFF;
    font-weight: 700;
  }

  /* Por si alguna card no usa <span class="cat-name"> (fallback) */
  .categorias-carousel .swiper-slide a {
    color: #4D6BFF !important;
    text-decoration: none;
  }

  .categorias-carousel .swiper-slide a:hover,
  .categorias-carousel .swiper-slide a:focus {
    color: #4D6BFF !important;
    text-decoration: none;
  }


  @keyframes heartPop {
    0% {
      transform: scale(1)
    }

    50% {
      transform: scale(1.35)
    }

    100% {
      transform: scale(1)
    }
  }
</style>



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 1600,
    timerProgressBar: true
  });

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  document.addEventListener('click', async function (e) {
    const btn = e.target.closest('.wishlist-btn');
    if (!btn) return;

    e.preventDefault();
    const id = btn.getAttribute('data-product-id');
    const icon = btn.querySelector('i');
    const wasFav = btn.classList.contains('is-fav');
    const prevTitle = btn.title;

    // Animaci√≥n t√°ctil r√°pida
    btn.classList.add('heart-pop');
    setTimeout(() => btn.classList.remove('heart-pop'), 320);

    try {
      const url = `{% url 'favoritos_toggle' 0 %}`.replace('/0/', `/${id}/`);
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
      });

      if (resp.redirected || resp.url.includes('{% url "login" %}')) {
        window.location.href = "{% url 'login' %}?next={{ request.get_full_path|urlencode }}";
        return;
      }
      if (!resp.ok) throw new Error('HTTP ' + resp.status);

      const data = await resp.json();
      const isFav = data.state === 'added';

      // Actualiza UI del bot√≥n
      btn.classList.toggle('is-fav', isFav);
      btn.setAttribute('aria-pressed', isFav ? 'true' : 'false');
      btn.title = isFav ? 'Quitar de wishlist' : 'Agregar a wishlist';
      if (icon) icon.className = isFav ? 'bi bi-heart-fill text-danger' : 'bi bi-heart';

      // Feedback
      Toast.fire({
        icon: isFav ? 'success' : 'info',
        title: isFav ? 'Agregado a tu wishlist' : 'Quitado de tu wishlist'
      });

    } catch (err) {
      console.error(err);
      // Revertir UI si falla
      btn.classList.toggle('is-fav', wasFav);
      btn.setAttribute('aria-pressed', wasFav ? 'true' : 'false');
      btn.title = prevTitle;
      if (icon) icon.className = wasFav ? 'bi bi-heart-fill text-danger' : 'bi bi-heart';

      Toast.fire({ icon: 'error', title: 'Ups, no pudimos actualizar' });
    }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Asumimos que tienes una funci√≥n getCookie para el CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.body.addEventListener('click', async function (event) {
      const dislikeButton = event.target.closest('.reco-dislike-btn');
      if (!dislikeButton) return;

      event.preventDefault();

      const productId = dislikeButton.dataset.productId;
      const card = document.getElementById(`reco-card-${productId}`);
      if (!productId || !card) return;

      const formData = new FormData();
      formData.append('product_id', productId);

      try {
        const response = await fetch("{% url 'recommendation_feedback' %}", {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        });

        if (!response.ok) throw new Error('Error del servidor');
        const data = await response.json();

        if (data.status === 'ok') {
          // Animar y eliminar la tarjeta del producto
          card.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
          card.style.opacity = '0';
          card.style.transform = 'scale(0.9)';
          setTimeout(() => card.remove(), 400);

          if (typeof Toast !== 'undefined') {
            Toast.fire({
              icon: 'info',
              title: 'Entendido. ¬°Afinando tus gustos!'
            });
          }
        }
      } catch (error) {
        console.error('Error al registrar el feedback:', error);
        if (typeof Toast !== 'undefined') {
          Toast.fire({ icon: 'error', title: 'No se pudo registrar tu feedback.' });
        }
      }
    });
  });
</script>

<style>
.badge-ribbon{
  position:absolute;
  top:10px; left:10px;
  z-index:3;
  background:#2563eb;
  color:#fff;
  font-weight:700;
  font-size:.75rem;
  padding:.28rem .55rem;
  border-radius:10px;
  box-shadow:0 6px 16px rgba(37,99,235,.18);
}
</style>



{% endblock %}