{% extends "base.html" %}
{% load static %}

{% block title %}Crear postal | Gifter’s{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
  .max-w { max-width: 780px; margin: 0 auto; }
</style>
{% endblock %}

{% block content %}
<section class="section">
  <div class="container max-w">
    <h1 class="h4 mb-1">
      <i class="bi bi-envelope-paper-heart"></i> Crear postal
    </h1>
    <p class="text-muted">Para <strong>@{{ username_dest }}</strong></p>

    <div class="card shadow-sm mb-4" id="crear-postal">
      <div class="card-body">
        <form id="card-form" onsubmit="return crearPostal(event)">
          {% csrf_token %}
          <div class="mb-2">
            <label class="form-label">Dedicatoria</label>
            <textarea class="form-control" name="prompt" rows="2"
              placeholder="Feliz cumple, {{ destinatario.nombre|default:username_dest }}" required></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">Estilo (opcional)</label>
            <input class="form-control" name="style" placeholder="postal minimalista con borde sutil">
          </div>

          <button class="btn btn-primary" id="btn-generar" type="submit">
            <i class="bi bi-magic"></i> Generar postal
          </button>
          <span class="text-muted ms-2" id="hint"></span>
        </form>

        <div class="mt-3" id="card-result" style="display:none">
          <img id="card-img" class="img-fluid rounded shadow mb-2" alt="Postal generada">

          <div class="d-flex flex-wrap gap-2">
            <a id="card-dl" class="btn btn-primary" download>
              <i class="bi bi-download"></i> Descargar
            </a>
            <a id="card-share" class="btn btn-outline-secondary" target="_blank">
              <i class="bi bi-box-arrow-up-right"></i> Abrir enlace
            </a>
            <button class="btn btn-outline-secondary" id="btn-copy">
              <i class="bi bi-link-45deg"></i> Copiar enlace
            </button>
            <a id="card-wa" class="btn btn-success" target="_blank" rel="noopener">
              <i class="bi bi-whatsapp"></i> WhatsApp
            </a>
          </div>
        </div>
      </div>
    </div>

    <p class="text-muted small">La primera generación del día puede tardar algunos segundos.</p>
  </div>
</section>

<script>
async function crearPostal(e){
  e.preventDefault();
  const form = e.target;
  const btn = document.getElementById('btn-generar');
  const hint = document.getElementById('hint');

  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Generando...';
  hint.textContent = 'Puede tardar unos segundos la primera vez.';

  try {
    const fd = new FormData(form);
    const res = await fetch("{% url 'cards_generar' %}", {
      method: "POST",
      headers: {"X-CSRFToken": "{{ csrf_token }}"},
      body: fd
    });

    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || 'Error inesperado');
    }

    const data = await res.json();

    // Mostrar resultado
    document.getElementById('card-img').src = data.url;

    const dl = document.getElementById('card-dl');
    dl.href = data.url;
    dl.download = "gifters_postal.png";

    const sh = document.getElementById('card-share');
    sh.href = data.share;

    const wa = document.getElementById('card-wa');
    wa.href = "https://wa.me/?text=" + encodeURIComponent("Te hice esta postal: " + data.share);

    document.getElementById('card-result').style.display = '';

    const btnCopy = document.getElementById('btn-copy');
    btnCopy.onclick = async () => {
      try {
        await navigator.clipboard.writeText(data.share);
        btnCopy.innerHTML = '<i class="bi bi-check2-circle"></i> Enlace copiado';
        setTimeout(()=> btnCopy.innerHTML = '<i class="bi bi-link-45deg"></i> Copiar enlace', 1500);
      } catch { alert('No se pudo copiar el enlace'); }
    };

    hint.textContent = '';
  } catch (err){
    alert(err.message || 'No se pudo generar la postal');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-magic"></i> Generar postal';
  }
  return false;
}
</script>
{% endblock %}
