{% extends "base.html" %}
{% load static i18n %}

{% block title %}Perfil de {{ usuario_publico.nombre }}{% endblock %}
{% block body_class %}index-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/perfil.css' %}">
<style>
  /* --- Botones de perfil p√∫blico --- */
  .btn-edit {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border-radius: 30px;
    font-weight: 600;
    padding: 8px 18px;
    transition: all .25s ease;
    text-decoration: none;
    border: none;
  }

  /* Bot√≥n "Chatear" */
  .btn-edit.btn-chat {
    background: #fff;
    color: #1970ea;
    border: 2px solid #1970ea;
  }
  .btn-edit.btn-chat:hover {
    background: #1970ea;
    color: #fff;
  }

  /* Bot√≥n "Enviar postal" */
  .btn-edit.btn-postal {
    background: #1970ea;
    color: #fff;
    border: 2px solid #fff;
  }
  .btn-edit.btn-postal:hover {
    background: #fff;
    color: #1970ea;
  }
  /* --- Botones de perfil p√∫blico --- */
.acciones-amigo {
  display: flex;
  flex-direction: column;
  align-items: flex-end; /* o center si quieres centrarlos */
  gap: 10px;
  margin-top: 8px;
}

.btn-edit {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  border-radius: 30px;
  font-weight: 600;
  padding: 8px 20px;
  transition: all .25s ease;
  text-decoration: none;
  border: none;
}

/* Bot√≥n "Chatear" */
.btn-edit.btn-chat {
  background: #fff;
  color: #1970ea;
  border: 2px solid #1970ea;
}
.btn-edit.btn-chat:hover {
  background: #1970ea;
  color: #fff;
}

/* Bot√≥n "Enviar postal" */
.btn-edit.btn-postal {
  background: #1970ea;
  color: #fff;
  border: 2px solid #fff;
}
.btn-edit.btn-postal:hover {
  background: #fff;
  color: #1970ea;
}
/* --- Contenedor botones --- */
.acciones-amigo {
  display: flex;
  flex-direction: column;
  align-items: flex-end; /* o center si prefieres centrados */
  gap: 10px;
  margin-top: 8px;
}

/* --- Estilos base --- */
.btn-edit {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  border-radius: 30px;
  font-weight: 600;
  padding: 10px 20px;
  width: 180px;             /* <<< asegura mismo ancho */
  text-align: center;
  transition: all .25s ease;
  text-decoration: none;
  border: none;
  box-sizing: border-box;
}

/* Bot√≥n "Chatear" */
.btn-edit.btn-chat {
  background: #fff;
  color: #1970ea;
  border: 2px solid #1970ea;
}
.btn-edit.btn-chat:hover {
  background: #1970ea;
  color: #fff;
}

/* Bot√≥n "Enviar postal" */
.btn-edit.btn-postal {
  background: #1970ea;
  color: #fff;
  border: 2px solid #fff;
}
.btn-edit.btn-postal:hover {
  background: #fff;
  color: #1970ea;
}

</style>

{% endblock %}

{% block content %}
<div class="profile-header">
  <div class="profile-info">

    {# Avatar banner - FIX del static roto #}
    <div class="g-avatar g-avatar--banner"
      style="background-image:url('{% if perfil_publico and perfil_publico.profile_picture %}{{ perfil_publico.profile_picture.url }}{% else %}{% static 'img/avatar-placeholder.png' %}{% endif %}');">
    </div>

    <div class="user-details">
      <h2>{{ usuario_publico.nombre }} {{ usuario_publico.apellido }}</h2>
      <p class="text-muted">@{{ usuario_publico.nombre_usuario }}</p>
      <p class="description">{{ perfil_publico.bio|default:"Sin biograf√≠a a√∫n." }}</p>
    </div>

    <div class="edit-profile">
      {# --- Acciones de relaci√≥n / chat --- #}
      {% if request.user.is_authenticated %}
{% if es_amigo %}
  <div class="acciones-amigo">
    <a href="#" id="btnChatPerfilPublico" class="btn-edit btn-chat" data-username="{{ usuario_publico.nombre_usuario }}">
      <i class="bi bi-chat-dots"></i> Chatear
    </a>

    <a href="{% url 'cards_crear' usuario_publico.nombre_usuario %}" class="btn-edit btn-postal mt-2">
      <i class="bi bi-envelope-paper-heart"></i> Regala una Imagen
    </a>
  </div>



      {% elif pendiente_enviada %}
      <form method="post" action="{% url 'amistad_cancelar' usuario_publico.nombre_usuario %}"
        class="js-amistad-cancelar">
        {% csrf_token %}
        <button class="btn-edit" style="background:#f44336;">Cancelar solicitud</button>
      </form>
      {% elif pendiente_recibida %}
      <div class="d-flex gap-2">
        <form method="post" action="{% url 'amistad_aceptar' usuario_publico.nombre_usuario %}"
          class="js-amistad-aceptar">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-success">Aceptar</button>
        </form>
        <form method="post" action="{% url 'amistad_rechazar' usuario_publico.nombre_usuario %}"
          class="js-amistad-rechazar">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-danger">Rechazar</button>
        </form>
      </div>
      {% else %}
      <form method="post" action="{% url 'amistad_enviar' usuario_publico.nombre_usuario %}" class="js-amistad-enviar">
        {% csrf_token %}
        <button class="btn-edit">‚ûï Agregar amigo</button>
      </form>
      {% endif %}
      {% else %}
      <a href="{% url 'login' %}?next={{ request.path }}" class="btn-edit">Inicia sesi√≥n</a>
      {% endif %}
    </div>

  </div>

  <nav class="profile-nav">
    <ul>
      <li><a href="#" data-tab="wishlist" class="active">Wishlist</a></li>
      <li><a href="#" data-tab="recibidos">Regalos recibidos</a></li>
      <li><a href="#" data-tab="actividad">Actividad p√∫blica</a></li>
      <li><a href="#" data-tab="eventos">Eventos importantes</a></li>
    </ul>
  </nav>

</div>

<div class="profile-content">

  <section id="actividad" class="tab-content">
    <h3>Actividad de ‚Äú{{ usuario_publico.nombre_usuario }}‚Äù</h3>
    <hr class="my-3">
    {% if not es_amigo %}
    <p class="text-muted">Solo los amigos pueden ver la actividad.</p>
    {% else %}
    {% if ultimos_posts %}
    <div class="gift-grid">
      {% for p in ultimos_posts %}
      <div class="gift-card">
        <div class="gift-info">
          <h4>
            {% if p.tipo_post == 'texto' %}Publicaci√≥n{% else %}{{ p.tipo_post|capfirst }}{% endif %}
            ¬∑ <small>{{ p.fecha_publicacion|date:"d/m/Y H:i" }}</small>
          </h4>
          {% if p.tipo_post == 'texto' %}
          <p>{{ p.contenido|default:"(sin contenido)"|truncatechars:160|linebreaksbr }}</p>
          {% else %}
          {% if p.imagen %}
          <img src="{{ p.imagen.url }}" alt="Imagen del post"
            style="max-width: 100%; height: auto; margin-top: 10px; border-radius: 4px;">
          {% endif %}
          {% if p.contenido %}
          <p style="margin-top: 5px;">{{ p.contenido|urlizetrunc:50|linebreaksbr }}</p>
          {% elif not p.imagen %}
          <p class="text-muted">(Contenido multimedia sin descripci√≥n)</p>
          {% endif %}
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">A√∫n no hay actividad.</p>
    {% endif %}
    {% endif %}
  </section>

  <section id="eventos" class="tab-content">
    <div class="events-header">
      <h3>Eventos importantes de ‚Äú{{ usuario_publico.nombre_usuario }}‚Äù</h3>

    </div>
    <hr class="my-3">
    {% if not es_amigo %}
    <p class="text-muted">Solo los amigos pueden ver los eventos.</p>
    {% else %}
    <div class="events-list">
      {% if eventos_publicos %}
      {% for ev in eventos_publicos %}
      <div class="event-item" data-event-id="{{ ev.pk }}">
        <div class="left event-toggle" role="button" tabindex="0" aria-expanded="false"
          aria-controls="desc-{{ ev.pk }}">
          <span class="badge">
            {% language 'es' %}
            {{ ev.fecha_evento|date:"j" }} de {{ ev.fecha_evento|date:"F" }}
            {% endlanguage %}
          </span>
          <div class="name">{{ ev.titulo }}</div>
        </div>
        {% if ev.descripcion %}
        <div id="desc-{{ ev.pk }}" class="event-desc" hidden>
          <p>{{ ev.descripcion|linebreaksbr }}</p>
        </div>
        {% endif %}
      </div>
      {% endfor %}
      {% else %}
      <p class="text-muted">Este usuario a√∫n no registra eventos.</p>
      {% endif %}
    </div>
    {% endif %}
  </section>

  <div class="user-interests mt-3">
    {% if usuario_publico.intereses_categorias.all %}
    <h6 class="small text-uppercase text-muted">Categor√≠as de inter√©s</h6>
    <div class="interest-pills-container">
      {% for categoria in usuario_publico.intereses_categorias.all %}
      <span class="badge rounded-pill bg-primary">{{ categoria.nombre_categoria }}</span>
      {% endfor %}
    </div>
    {% endif %}

    {% if usuario_publico.intereses_marcas.all %}
    <h6 class="small text-uppercase text-muted mt-3">Marcas de inter√©s</h6>
    <div class="interest-pills-container">
      {% for marca in usuario_publico.intereses_marcas.all %}
      <span class="badge rounded-pill bg-secondary">{{ marca.nombre_marca }}</span>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  <section id="wishlist" class="tab-content active">
    <h3>Wishlist de ‚Äú{{ usuario_publico.nombre_usuario }}‚Äù</h3>
    <hr class="my-3">


    {# --- NUEVA L√ìGICA DE PRIVACIDAD --- #}
    {% if usuario_publico.is_private and not es_amigo %}
    <p class="text-muted">üîí Este perfil es privado. Solo los amigos pueden ver la wishlist.</p>
    {% else %}
    
    {# --- Wishlist: SIEMPRE lo no comprado --- #}
    {% if wishlist_items_publicos and wishlist_items_publicos|length > 0 %}
    <div class="gift-grid">
      {% for it in wishlist_items_publicos %}
      {% with p=it.id_producto %}
      <div class="gift-card">
        <img
          src="{% if p.imagen and p.imagen.url %}{{ p.imagen.url }}{% else %}{% static 'img/Gifters/favicongift.png' %}{% endif %}"
          alt="{{ p.nombre_producto }}">
        <div class="gift-info">
          <h4>{{ p.nombre_producto }}</h4>
          <p>{{ p.id_marca.nombre_marca|default:'' }}</p>
        </div>
        <div class="gift-actions">
          <a class="btn btn-sm btn-outline-primary" href="{% url 'producto_detalle' p.id_producto %}">Ver</a>
          {% with url_tienda=p.url_tienda_principal|default:p.urls_tienda.first %}
          {% if url_tienda %}
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_tienda.url }}" target="_blank"
            rel="noopener">Tienda</a>
          {% endif %}
          {% endwith %}
        </div>
      </div>
      {% endwith %}
      {% endfor %}
    </div>
    {% else %}
    <p class="text-muted mt-3">No tiene productos visibles en su wishlist.</p>
    {% endif %}

    {# --- IA 100% (texto): ideas debajo de la wishlist --- #}
    {% if sugerencias_ia and sugerencias_ia|length > 0 %}
    <div class="card mt-4">
      <div class="card-header fw-bold">üí° Ideas de regalo</div>
      <div class="card-body">
        <ul class="mb-0 ps-3">
          {% for sug in sugerencias_ia %}
          <li class="mb-1">
            <strong>{{ sug.idea }}</strong>{% if sug.explicacion %}: {{ sug.explicacion }}{% endif %}
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

    {% endif %}
  </section>



  <section id="recibidos" class="tab-content">
    <h3>Regalos recibidos por ‚Äú{{ usuario_publico.nombre_usuario }}‚Äù</h3>
    <hr class="my-3">

    {% if not recibidos_publicos %}
    <p class="text-muted">A√∫n no registra regalos recibidos.</p>
    {% else %}
    <div class="gift-grid">
      {% for it in recibidos_publicos %}
      {% with p=it.id_producto %}
      <div class="gift-card received-gift" id="recibido-{{ it.id_item }}" data-product-id="{{ p.id_producto }}">
        <img
          src="{% if p.imagen and p.imagen.url %}{{ p.imagen.url }}{% else %}{% static 'img/Gifters/favicongift.png' %}{% endif %}"
          alt="{{ p.nombre_producto }}">
        <div class="gift-info">
          <h4>{{ p.nombre_producto }}</h4>
          <p>{{ p.id_marca.nombre_marca|default:"" }}</p>
          {% if it.fecha_comprado %}
          <div class="text-muted received-date">
            Recibido el {{ it.fecha_comprado|date:"d/m/Y" }}
          </div>
          {% endif %}
        </div>
        <div class="gift-actions">
          <a class="btn btn-sm btn-outline-primary" href="{% url 'producto_detalle' p.id_producto %}"
            title="Ver detalle">Ver</a>
          {% with url_tienda=p.url_tienda_principal|default:p.urls_tienda.first %}
          {% if url_tienda %}
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_tienda.url }}" target="_blank" rel="noopener"
            title="Ver en tienda {{ url_tienda.nombre_tienda }}">Tienda</a>
          {% endif %}
          {% endwith %}
        </div>
      </div>
      {% endwith %}
      {% endfor %}
    </div>
    {% endif %}
  </section>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Tabs ---
    const tabs = document.querySelectorAll(".profile-nav a");
    const sections = document.querySelectorAll(".profile-content .tab-content");
    const initialTab = document.querySelector(".profile-nav a.active") || document.querySelector('.profile-nav a[data-tab="wishlist"]');
    if (initialTab) {
      sections.forEach(s => s.classList.remove("active"));
      const targetId = initialTab.getAttribute("data-tab");
      document.getElementById(targetId)?.classList.add("active");
    }
    tabs.forEach(tab => {
      tab.addEventListener("click", e => {
        e.preventDefault();
        const targetId = tab.getAttribute("data-tab");
        tabs.forEach(t => t.classList.remove("active"));
        sections.forEach(s => s.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(targetId)?.classList.add("active");
      });
    });

    // --- Acorde√≥n de Eventos ---
    const eventItems = document.querySelectorAll(".events-list .event-item");
    const setMaxHeight = (el) => { if (el) el.style.maxHeight = el.scrollHeight + "px"; };
    function openEventDesc(panel, toggle) {
      if (!panel || !toggle) return;
      panel.hidden = false;
      requestAnimationFrame(() => {
        panel.classList.add("open"); setMaxHeight(panel);
        toggle.setAttribute("aria-expanded", "true");
      });
    }
    function closeEventDesc(panel, toggle) {
      if (!panel || !toggle) return;
      if (!panel.style.maxHeight || panel.style.maxHeight === "0px") {
        panel.style.maxHeight = panel.scrollHeight + "px";
      }
      requestAnimationFrame(() => {
        panel.style.maxHeight = "0px"; panel.classList.remove("open");
        toggle.setAttribute("aria-expanded", "false");
      });
    }
    function closeAllOtherEvents(currentPanel) {
      eventItems.forEach(item => {
        const toggle = item.querySelector(".event-toggle");
        const panel = item.querySelector(".event-desc");
        if (panel && panel !== currentPanel && toggle && toggle.getAttribute("aria-expanded") === "true") {
          closeEventDesc(panel, toggle);
        }
      });
    }
    eventItems.forEach(item => {
      const toggle = item.querySelector(".event-toggle");
      const panel = item.querySelector(".event-desc");
      if (!toggle || !panel) return;
      toggle.setAttribute("aria-expanded", "false");
      toggle.setAttribute("aria-controls", panel.id);
      panel.hidden = true;
      const handleToggle = () => {
        const isOpen = toggle.getAttribute("aria-expanded") === "true";
        if (isOpen) closeEventDesc(panel, toggle);
        else { closeAllOtherEvents(panel); openEventDesc(panel, toggle); }
      };
      toggle.addEventListener("click", handleToggle);
      toggle.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); handleToggle(); }
      });
      panel.addEventListener("transitionend", (ev) => {
        if (ev.propertyName === "max-height" && toggle && !panel.classList.contains('open')) { panel.hidden = true; }
        else if (ev.propertyName === "max-height" && panel.classList.contains('open')) { setMaxHeight(panel); }
      });
    });
    window.addEventListener("resize", () => {
      document.querySelectorAll(".event-desc.open").forEach(setMaxHeight);
    });

    // --- Bot√≥n de Chat ---
    const btnChat = document.getElementById('btnChatPerfilPublico');
    function chatButtonClickHandler(ev) {
      ev.preventDefault();
      const u = this.dataset.username;
      if (window.openChatWith) window.openChatWith(u);
      else document.getElementById('chatFab')?.click();
    }
    btnChat?.addEventListener('click', chatButtonClickHandler);

    // --- SweetAlert Toast ---
    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1800, timerProgressBar: true });

    // --- CSRF Token Helper ---
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }
    const csrftoken = getCookie('csrftoken');

    // --- AJAX amistad ---
    async function handleAmistadForm(form, successCallback) {
      if (!csrftoken) { Toast.fire({ icon: 'error', title: 'Error de seguridad (CSRF). Recarga la p√°gina.' }); return; }
      try {
        const response = await fetch(form.action, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded'
          },
        });
        const data = await response.json();
        if (!response.ok || !data.ok) throw new Error(data?.detail || data?.error || 'Error en la respuesta del servidor.');
        successCallback(data, form);
      } catch (err) {
        console.error('Error en formulario de amistad:', err);
        Toast.fire({ icon: 'error', title: err.message || 'Ocurri√≥ un error.' });
      }
    }

    const btnContainer = document.querySelector('.edit-profile');
    const targetUser = "{{ usuario_publico.nombre_usuario|escapejs }}";
    const htmlAgregar = `
      <form method="post" action="{% url 'amistad_enviar' usuario_publico.nombre_usuario %}" class="js-amistad-enviar">
        {% csrf_token %}<button class="btn-edit">‚ûï Agregar amigo</button>
      </form>`;
    const htmlCancelar = `
      <form method="post" action="{% url 'amistad_cancelar' usuario_publico.nombre_usuario %}" class="js-amistad-cancelar">
        {% csrf_token %}<button class="btn-edit" style="background:#f44336;">Cancelar solicitud</button>
      </form>`;
    const htmlChatear = `<a href="#" id="btnChatPerfilPublico" class="btn-edit" data-username="${targetUser}">üí¨ Chatear</a>`;
    const htmlAceptarRechazar = `
      <div class="d-flex gap-2">
        <form method="post" action="{% url 'amistad_aceptar' usuario_publico.nombre_usuario %}" class="js-amistad-aceptar">
          {% csrf_token %}<button type="submit" class="btn btn-sm btn-success">Aceptar</button>
        </form>
        <form method="post" action="{% url 'amistad_rechazar' usuario_publico.nombre_usuario %}" class="js-amistad-rechazar">
          {% csrf_token %}<button type="submit" class="btn btn-sm btn-danger">Rechazar</button>
        </form>
      </div>`;

    btnContainer?.addEventListener('submit', async (e) => {
      if (e.target.matches('.js-amistad-enviar')) {
        e.preventDefault();
        await handleAmistadForm(e.target, (data, form) => {
          if (data.auto_accepted) {
            Toast.fire({ icon: 'success', title: '¬°Ahora son amigos!' });
            form.outerHTML = htmlChatear;
            document.getElementById('btnChatPerfilPublico')?.addEventListener('click', chatButtonClickHandler);
          } else {
            Toast.fire({ icon: 'success', title: data.reused ? 'Solicitud reenviada' : 'Solicitud enviada' });
            form.outerHTML = htmlCancelar;
          }
        });
      } else if (e.target.matches('.js-amistad-cancelar')) {
        e.preventDefault();
        await handleAmistadForm(e.target, (data, form) => {
          Toast.fire({ icon: 'info', title: 'Solicitud cancelada' });
          form.outerHTML = htmlAgregar;
        });
      } else if (e.target.matches('.js-amistad-aceptar')) {
        e.preventDefault();
        await handleAmistadForm(e.target, (data, form) => {
          Toast.fire({ icon: 'success', title: '¬°Solicitud aceptada!' });
          const buttonContainer = form.closest('.d-flex');
          if (buttonContainer) buttonContainer.outerHTML = htmlChatear;
          document.getElementById('btnChatPerfilPublico')?.addEventListener('click', chatButtonClickHandler);
        });
      } else if (e.target.matches('.js-amistad-rechazar')) {
        e.preventDefault();
        await handleAmistadForm(e.target, (data, form) => {
          Toast.fire({ icon: 'info', title: 'Solicitud rechazada' });
          const buttonContainer = form.closest('.d-flex');
          if (buttonContainer) buttonContainer.outerHTML = htmlAgregar;
        });
      }
    });
  });
</script>
{% endblock %}