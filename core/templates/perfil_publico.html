{% extends "base.html" %}
{% load static i18n %}

{% block title %}Perfil de {{ usuario_publico.nombre }}{% endblock %}
{% block body_class %}index-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/perfil.css' %}">
<style>
  /* --- Botones de perfil p√∫blico --- */
  .btn-edit {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border-radius: 30px;
    font-weight: 600;
    padding: 8px 18px;
    transition: all .25s ease;
    text-decoration: none;
    border: none;
  }

  /* Bot√≥n "Chatear" */
  .btn-edit.btn-chat {
    background: #fff;
    color: #1970ea;
    border: 2px solid #1970ea;
  }

  .btn-edit.btn-chat:hover {
    background: #1970ea;
    color: #fff;
  }

  /* Bot√≥n "Enviar postal" */
  .btn-edit.btn-postal {
    background: #1970ea;
    color: #fff;
    border: 2px solid #fff;
  }

  .btn-edit.btn-postal:hover {
    background: #fff;
    color: #1970ea;
  }

  /* --- Botones de perfil p√∫blico --- */
  .acciones-amigo {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    /* o center si quieres centrarlos */
    gap: 10px;
    margin-top: 8px;
  }

  .btn-edit {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    border-radius: 30px;
    font-weight: 600;
    padding: 8px 20px;
    transition: all .25s ease;
    text-decoration: none;
    border: none;
  }

  /* Bot√≥n "Chatear" */
  .btn-edit.btn-chat {
    background: #fff;
    color: #1970ea;
    border: 2px solid #1970ea;
  }

  .btn-edit.btn-chat:hover {
    background: #1970ea;
    color: #fff;
  }

  /* Bot√≥n "Enviar postal" */
  .btn-edit.btn-postal {
    background: #1970ea;
    color: #fff;
    border: 2px solid #fff;
  }

  .btn-edit.btn-postal:hover {
    background: #fff;
    color: #1970ea;
  }

  /* --- Contenedor botones --- */
  .acciones-amigo {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    /* o center si prefieres centrados */
    gap: 10px;
    margin-top: 8px;
  }

  /* --- Estilos base --- */
  .btn-edit {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    border-radius: 30px;
    font-weight: 600;
    padding: 10px 20px;
    width: 180px;
    /* <<< asegura mismo ancho */
    text-align: center;
    transition: all .25s ease;
    text-decoration: none;
    border: none;
    box-sizing: border-box;
  }

  /* Bot√≥n "Chatear" */
  .btn-edit.btn-chat {
    background: #fff;
    color: #1970ea;
    border: 2px solid #1970ea;
  }

  .btn-edit.btn-chat:hover {
    background: #1970ea;
    color: #fff;
  }

  /* Bot√≥n "Enviar postal" */
  .btn-edit.btn-postal {
    background: #1970ea;
    color: #fff;
    border: 2px solid #fff;
  }

  .btn-edit.btn-postal:hover {
    background: #fff;
    color: #1970ea;
  }

  :root {
    --brand: #1970ea;
    --brand-ink: #124fb0;
    --ink: #0f172a;
    --line: #e5e7eb;
    --muted: #64748b;
    --ghost: #f8fafc;
  }

  /* Variantes nuevas para acciones de amistad */
  .btn-edit.btn-brand {
    background: var(--brand);
    color: #fff;
    border: 2px solid var(--brand);
  }

  .btn-edit.btn-brand:hover {
    background: #fff;
    color: var(--brand);
  }

  .btn-edit.btn-ghost {
    background: #fff;
    color: var(--brand);
    border: 2px solid var(--brand);
  }

  .btn-edit.btn-ghost:hover {
    background: var(--brand);
    color: #fff;
  }

  .btn-edit.btn-subtle {
    background: var(--ghost);
    color: var(--ink);
    border: 2px solid var(--line);
  }

  .btn-edit.btn-subtle:hover {
    border-color: #cbd5e1;
    background: #fff;
  }

  /* Alineaci√≥n cuando hay dos botones lado a lado */
  .acciones-inline {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
</style>
<style>
  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }
</style>

{% endblock %}

{% block content %}
<div class="profile-header">
  <div class="profile-info">

    {# Avatar banner - FIX del static roto #}
    <div class="g-avatar g-avatar--banner"
      style="background-image:url('{% if perfil_publico and perfil_publico.profile_picture %}{{ perfil_publico.profile_picture.url }}{% else %}{% static 'img/avatar-placeholder.png' %}{% endif %}');">
    </div>

    <div class="user-details">
      <h2>{{ usuario_publico.nombre }} {{ usuario_publico.apellido }}</h2>
      <p class="text-muted">@{{ usuario_publico.nombre_usuario }}</p>
      <p class="description">{{ perfil_publico.bio|default:"Sin biograf√≠a a√∫n." }}</p>
    </div>

    <div class="edit-profile">
      {# --- Acciones de relaci√≥n / chat --- #}
      {% if request.user.is_authenticated %}
      {% if es_amigo %}
      <div class="acciones-amigo">
        <a href="#" id="btnChatPerfilPublico" class="btn-edit btn-chat"
          data-username="{{ usuario_publico.nombre_usuario }}">
          <i class="bi bi-chat-dots"></i> Chatear
        </a>
      </div>



      {% elif pendiente_enviada %}
      <form method="post" action="{% url 'amistad_cancelar' usuario_publico.nombre_usuario %}"
        class="js-amistad-cancelar">
        {% csrf_token %}
        <button class="btn-edit btn-subtle"><i class="bi bi-x-lg"></i> Cancelar solicitud</button>
      </form>
      {% elif pendiente_recibida %}
      <div class="acciones-inline">
        <form method="post" action="{% url 'amistad_aceptar' usuario_publico.nombre_usuario %}"
          class="js-amistad-aceptar">
          {% csrf_token %}
          <button type="submit" class="btn-edit btn-brand">
            <i class="bi bi-check2-circle"></i> Aceptar
          </button>
        </form>
        <form method="post" action="{% url 'amistad_rechazar' usuario_publico.nombre_usuario %}"
          class="js-amistad-rechazar">
          {% csrf_token %}
          <button type="submit" class="btn-edit btn-subtle">
            <i class="bi bi-x-circle"></i> Rechazar
          </button>
        </form>
      </div>

      {% else %}
      <form method="post" action="{% url 'amistad_enviar' usuario_publico.nombre_usuario %}" class="js-amistad-enviar">
        {% csrf_token %}
        <button class="btn-edit btn-brand"><i class="bi bi-person-plus"></i> Agregar amigo</button>
      </form>
      {% endif %}
      {% else %}
      <a href="{% url 'login' %}?next={{ request.path }}" class="btn-edit">Inicia sesi√≥n</a>
      {% endif %}
    </div>

  </div>

  <nav class="profile-nav">
    <ul>
      <li><a href="#" class="active" data-tab="wishlist">Wishlist</a></li>
      <li><a href="#" data-tab="recibidos">Regalos recibidos</a></li>
      <li><a href="#" data-tab="actividad">Actividad p√∫blica</a></li>
      <li><a href="#" data-tab="eventos">Eventos importantes</a></li>
    </ul>
  </nav>



</div>

<div class="profile-content">

  <section id="actividad" class="tab-content">
    <h3>Actividad de ‚Äú{{ usuario_publico.nombre_usuario }}‚Äù</h3>
    <hr class="my-3">
    {% if not es_amigo %}
    <p class="text-muted">Solo los amigos pueden ver la actividad.</p>
    {% else %}
    {% if ultimos_posts %}
    <div class="gift-grid">
      {% for p in ultimos_posts %}
      <div class="gift-card">
        <div class="gift-info">
          <h4>
            {% if p.tipo_post == 'texto' %}Publicaci√≥n{% else %}{{ p.tipo_post|capfirst }}{% endif %}
            ¬∑ <small>{{ p.fecha_publicacion|date:"d/m/Y H:i" }}</small>
          </h4>
          {% if p.tipo_post == 'texto' %}
          <p>{{ p.contenido|default:"(sin contenido)"|truncatechars:160|linebreaksbr }}</p>
          {% else %}
          {% if p.imagen %}
          <img src="{{ p.imagen.url }}" alt="Imagen del post"
            style="max-width: 100%; height: auto; margin-top: 10px; border-radius: 4px;">
          {% endif %}
          {% if p.contenido %}
          <p style="margin-top: 5px;">{{ p.contenido|urlizetrunc:50|linebreaksbr }}</p>
          {% elif not p.imagen %}
          <p class="text-muted">(Contenido multimedia sin descripci√≥n)</p>
          {% endif %}
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">A√∫n no hay actividad.</p>
    {% endif %}
    {% endif %}
  </section>

  <section id="eventos" class="tab-content">
    <div class="events-header">
      <h3>Eventos importantes de ‚Äú{{ usuario_publico.nombre_usuario }}‚Äù</h3>

    </div>
    <hr class="my-3">
    {% if not es_amigo %}
    <p class="text-muted">Solo los amigos pueden ver los eventos.</p>
    {% else %}
    <div class="events-list">
      {% if eventos_publicos %}
      {% for ev in eventos_publicos %}
      <div class="event-item" data-event-id="{{ ev.pk }}">
        <div class="left event-toggle" role="button" tabindex="0" aria-expanded="false"
          aria-controls="desc-{{ ev.pk }}">
          <span class="badge">
            {% language 'es' %}
            {{ ev.fecha_evento|date:"j" }} de {{ ev.fecha_evento|date:"F" }}
            {% endlanguage %}
          </span>
          <div class="name">{{ ev.titulo }}</div>
        </div>
        {% if ev.descripcion %}
        <div id="desc-{{ ev.pk }}" class="event-desc" hidden>
          <p>{{ ev.descripcion|linebreaksbr }}</p>
        </div>
        {% endif %}
      </div>
      {% endfor %}
      {% else %}
      <p class="text-muted">Este usuario a√∫n no registra eventos.</p>
      {% endif %}
    </div>
    {% endif %}
  </section>



  <section id="wishlist" class="tab-content active">
    <h3>Wishlist de ‚Äú{{ usuario_publico.nombre_usuario }}‚Äù</h3>
    <hr class="my-3">
    

    <div class="user-interests mt-3">
      {% if usuario_publico.intereses_categorias.all %}
      <h6 class="small text-uppercase text-muted">Categor√≠as de inter√©s</h6>
      <div class="interest-pills-container">
        {% for categoria in usuario_publico.intereses_categorias.all %}
        <span class="badge rounded-pill bg-primary">{{ categoria.nombre_categoria }}</span>
        {% endfor %}
      </div>
      {% endif %}
      
      {% if usuario_publico.intereses_marcas.all %}
      <h6 class="small text-uppercase text-muted mt-3">Marcas de inter√©s</h6>
      <div class="interest-pills-container">
        {% for marca in usuario_publico.intereses_marcas.all %}
        <span class="badge rounded-pill bg-secondary">{{ marca.nombre_marca }}</span>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <br><br>
    {# --- NUEVA L√ìGICA DE PRIVACIDAD --- #}
    {% if usuario_publico.is_private and not es_amigo %}
    <p class="text-muted">üîí Este perfil es privado. Solo los amigos pueden ver la wishlist.</p>
    {% else %}

    {# --- Wishlist: SIEMPRE lo no comprado --- #}
    {% if wishlist_items_publicos and wishlist_items_publicos|length > 0 %}
    <div class="gift-grid">
      {% for it in wishlist_items_publicos %}
      {% with p=it.id_producto %}
      <div class="gift-card">
        <img 
  src="
    {% if p.imagen %}
        {% if p.imagen.url %}
            {{ p.imagen.url }}
        {% elif p.imagen|slice:':4' == 'http' %}
            {{ p.imagen }}
        {% else %}
            /media/{{ p.imagen }}
        {% endif %}
    {% else %}
        {% static 'img/Gifters/favicongift.png' %}
    {% endif %}
  "
  alt="{{ p.nombre_producto }}"
>

        <div class="gift-info">
          <h4>{{ p.nombre_producto }}</h4>
          <p>{{ p.id_marca.nombre_marca|default:'' }}</p>
        </div>
        <div class="gift-actions">
          <a class="btn btn-sm btn-outline-primary" href="{% url 'producto_detalle' p.id_producto %}">Ver</a>
          {% with url_tienda=p.url_tienda_principal|default:p.urls_tienda.first %}
          {% if url_tienda %}
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_tienda.url }}" target="_blank"
            rel="noopener">Tienda</a>
          {% endif %}
          {% endwith %}
        </div>
      </div>
      {% endwith %}
      {% endfor %}
    </div>
    {% else %}
    <p class="text-muted mt-3">No tiene productos visibles en su wishlist.</p>
    {% endif %}

    {# --- IA 100% (texto): ideas debajo de la wishlist --- #}
    {% if sugerencias_ia and sugerencias_ia|length > 0 %}

    {% endif %}

    {% endif %}
  </section>



  <section id="recibidos" class="tab-content">
    <h3>Regalos recibidos por ‚Äú{{ usuario_publico.nombre_usuario }}‚Äù</h3>
    <hr class="my-3">

    {% if not recibidos_publicos %}
    <p class="text-muted">A√∫n no registra regalos recibidos.</p>
    {% else %}
    <div class="gift-grid">
      {% for it in recibidos_publicos %}
      {% with p=it.id_producto %}
      <div class="gift-card received-gift" id="recibido-{{ it.id_item }}" data-product-id="{{ p.id_producto }}">
        
  <img 
    src="
      {% if p.imagen %}
          {% if p.imagen.url %}
              {{ p.imagen.url }}
          {% elif p.imagen|slice:':4' == 'http' %}
              {{ p.imagen }}
          {% else %}
              /media/{{ p.imagen }}
          {% endif %}
      {% else %}
          {% static 'img/Gifters/favicongift.png' %}
      {% endif %}
    "
    alt="{{ p.nombre_producto }}"
    style="width: 100%; height: auto; border-radius: 6px;"
  >

  <div class="gift-info">
    <h4>{{ p.nombre_producto }}</h4>
    <p>{{ p.id_marca.nombre_marca|default:"" }}</p>

    {% if it.fecha_comprado %}
    <div class="text-muted received-date">
      Recibido el {{ it.fecha_comprado|date:"d/m/Y" }}
    </div>
    {% endif %}
  </div>

  <div class="gift-actions">
    <a class="btn btn-sm btn-outline-primary" 
       href="{% url 'producto_detalle' p.id_producto %}" title="Ver detalle">Ver</a>

    {% with url_tienda=p.url_tienda_principal|default:p.urls_tienda.first %}
    {% if url_tienda %}
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_tienda.url }}" 
       target="_blank" rel="noopener"
       title="Ver en tienda {{ url_tienda.nombre_tienda }}">Tienda</a>
    {% endif %}
    {% endwith %}
  </div>

</div>

      {% endwith %}
      {% endfor %}
    </div>
    {% endif %}
  </section>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    (function () {
      const tabs = Array.from(document.querySelectorAll(".profile-nav a[data-tab]"));
      const sections = Array.from(document.querySelectorAll(".profile-content .tab-content"));

      // mapa id -> secci√≥n
      const byId = {};
      sections.forEach(s => { if (s.id) byId[s.id] = s; });

      function activateTab(id) {
        if (!id || !byId[id]) return;
        tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab") === id));
        sections.forEach(s => s.classList.toggle("active", s.id === id));
      }

      // Inicial: hash -> link activo -> wishlist
      const initial = (location.hash || "").replace("#", "")
        || (document.querySelector(".profile-nav a.active")?.getAttribute("data-tab"))
        || "wishlist";
      activateTab(initial);

      // Click en tabs
      tabs.forEach(tab => {
        tab.addEventListener("click", (e) => {
          e.preventDefault();
          const id = tab.getAttribute("data-tab");
          if (!id || !byId[id]) return;
          if (location.hash !== `#${id}`) {
            history.pushState({ tab: id }, "", `#${id}`);
          }
          activateTab(id);
        });
      });

      // Soporta back/forward
      window.addEventListener("popstate", () => {
        const id = (location.hash || "").replace("#", "") || "wishlist";
        activateTab(id);
      });
    })();


    /* ACORDE√ìN DE EVENTOS */
    const eventItems = document.querySelectorAll(".events-list .event-item");
    const setMaxHeight = (el) => { if (el) el.style.maxHeight = el.scrollHeight + "px"; };

    function openEventDesc(panel, toggle) {
      if (!panel || !toggle) return;
      panel.hidden = false;
      requestAnimationFrame(() => {
        panel.classList.add("open");
        setMaxHeight(panel);
        toggle.setAttribute("aria-expanded", "true");
      });
    }

    function closeEventDesc(panel, toggle) {
      if (!panel || !toggle) return;
      if (!panel.style.maxHeight || panel.style.maxHeight === "0px") {
        panel.style.maxHeight = panel.scrollHeight + "px";
      }
      requestAnimationFrame(() => {
        panel.style.maxHeight = "0px";
        panel.classList.remove("open");
        toggle.setAttribute("aria-expanded", "false");
      });
    }

    function closeAllOtherEvents(currentPanel) {
      eventItems.forEach(item => {
        const toggle = item.querySelector(".event-toggle");
        const panel = item.querySelector(".event-desc");
        if (panel && panel !== currentPanel && toggle && toggle.getAttribute("aria-expanded") === "true") {
          closeEventDesc(panel, toggle);
        }
      });
    }

    eventItems.forEach(item => {
      const toggle = item.querySelector(".event-toggle");
      const panel = item.querySelector(".event-desc");
      if (!toggle || !panel) return;

      toggle.setAttribute("aria-expanded", "false");
      toggle.setAttribute("aria-controls", panel.id);
      panel.hidden = true;

      const handleToggle = () => {
        const isOpen = toggle.getAttribute("aria-expanded") === "true";
        if (isOpen) closeEventDesc(panel, toggle);
        else { closeAllOtherEvents(panel); openEventDesc(panel, toggle); }
      };

      toggle.addEventListener("click", handleToggle);
      toggle.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); handleToggle(); }
      });

      panel.addEventListener("transitionend", (ev) => {
        if (ev.propertyName !== "max-height") return;
        if (!panel.classList.contains("open")) {
          panel.hidden = true;
        } else {
          setMaxHeight(panel);
        }
      });
    });

    window.addEventListener("resize", () => {
      document.querySelectorAll(".event-desc.open").forEach(setMaxHeight);
    });


    /* BOT√ìN DE CHAT */
    document.addEventListener("click", function (ev) {
      const btn = ev.target.closest("#btnChatPerfilPublico");
      if (!btn) return;
      ev.preventDefault();
      const u = btn.dataset.username;
      if (window.openChatWith) window.openChatWith(u);
      else document.getElementById("chatFab")?.click();
    });


    const Toast = (window.Swal
      ? Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1800, timerProgressBar: true })
      : { fire: ({ title }) => console.log(title) }
    );

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }
    const csrftoken = getCookie('csrftoken');


    async function handleAmistadForm(form, successCallback) {
      if (!csrftoken) {
        Toast.fire({ icon: 'error', title: 'Error de seguridad (CSRF). Recarga la p√°gina.' });
        return;
      }
      try {
        // Enviamos los datos del form
        const body = new URLSearchParams(new FormData(form));
        const response = await fetch(form.action, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok || (data && data.ok === false)) {
          throw new Error(data?.detail || data?.error || `Error ${response.status}`);
        }
        successCallback(data || {}, form);
      } catch (err) {
        console.error('Error en formulario de amistad:', err);
        Toast.fire({ icon: 'error', title: err.message || 'Ocurri√≥ un error.' });
      }
    }

    const btnContainer = document.querySelector('.edit-profile');
    const targetUser = "{{ usuario_publico.nombre_usuario|escapejs }}";

    const htmlAgregar = `
<form method="post" action="{% url 'amistad_enviar' usuario_publico.nombre_usuario %}" class="js-amistad-enviar">
  {% csrf_token %}
  <button class="btn-edit btn-brand"><i class="bi bi-person-plus"></i> Agregar amigo</button>
</form>`;

    const htmlCancelar = `
<form method="post" action="{% url 'amistad_cancelar' usuario_publico.nombre_usuario %}" class="js-amistad-cancelar">
  {% csrf_token %}
  <button class="btn-edit btn-subtle"><i class="bi bi-x-lg"></i> Cancelar solicitud</button>
</form>`;

    const htmlChatear = `
<a href="#" id="btnChatPerfilPublico" class="btn-edit btn-chat" data-username="${targetUser}">
  <i class="bi bi-chat-dots"></i> Chatear
</a>`;

    const htmlAceptarRechazar = `
<div class="acciones-inline">
  <form method="post" action="{% url 'amistad_aceptar' usuario_publico.nombre_usuario %}" class="js-amistad-aceptar">
    {% csrf_token %}
    <button type="submit" class="btn-edit btn-brand">
      <i class="bi bi-check2-circle"></i> Aceptar
    </button>
  </form>
  <form method="post" action="{% url 'amistad_rechazar' usuario_publico.nombre_usuario %}" class="js-amistad-rechazar">
    {% csrf_token %}
    <button type="submit" class="btn-edit btn-subtle">
      <i class="bi bi-x-circle"></i> Rechazar
    </button>
  </form>
</div>`;

    // Redirecci√≥n para refrescar la vista p√∫blica
    const goToPublicProfile = () => {
      window.location.href = "{% url 'perfil_publico' usuario_publico.nombre_usuario %}";
    };

    btnContainer?.addEventListener('submit', async (e) => {
      if (e.target.matches('.js-amistad-enviar')) {
        e.preventDefault();
        await handleAmistadForm(e.target, (data, form) => {
          if (data.auto_accepted) {
            Toast.fire({ icon: 'success', title: '¬°Ahora son amigos!' });
            setTimeout(goToPublicProfile, 650);
          } else {
            Toast.fire({ icon: 'success', title: data.reused ? 'Solicitud reenviada' : 'Solicitud enviada' });
            form.outerHTML = htmlCancelar;
          }
        });

      } else if (e.target.matches('.js-amistad-cancelar')) {
        e.preventDefault();
        await handleAmistadForm(e.target, (_data, _form) => {
          Toast.fire({ icon: 'info', title: 'Solicitud cancelada' });
          setTimeout(goToPublicProfile, 650);
        });

      } else if (e.target.matches('.js-amistad-aceptar')) {
        e.preventDefault();
        await handleAmistadForm(e.target, (_data, _form) => {
          Toast.fire({ icon: 'success', title: '¬°Solicitud aceptada!' });
          setTimeout(goToPublicProfile, 650);
        });

      } else if (e.target.matches('.js-amistad-rechazar')) {
        e.preventDefault();
        await handleAmistadForm(e.target, (_data, _form) => {
          Toast.fire({ icon: 'info', title: 'Solicitud rechazada' });
          setTimeout(goToPublicProfile, 650);
        });
      }
    });

  });
</script>

{% endblock %}