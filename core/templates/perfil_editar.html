{% extends "base.html" %}
{% load static %}

{% block title %}Editar perfil – Gifter’s{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-3">Editar perfil</h2>

  <form method="post" enctype="multipart/form-data" class="row g-4" novalidate>
    {% csrf_token %}

    <div class="col-12 col-lg-6">
      <div class="card p-3 h-100">
        <h4 class="mb-3">Datos de perfil</h4>

        {{ u_form.non_field_errors }}
                {# --- NUEVO APARTADO FOTO DE PERFIL --- #}
        <div class="mb-4">
          <label class="form-label d-block mb-2">Foto de perfil</label>

          <div class="avatar-uploader">
            <div class="avatar-uploader__preview" id="avatarPreview">
              {% if request.user.perfil.profile_picture %}
                <img src="{{ request.user.perfil.profile_picture.url }}" alt="Foto actual" id="avatarImg">
              {% else %}
                <div class="avatar-uploader__placeholder" id="avatarPlaceholder">+</div>
              {% endif %}
              <div class="avatar-uploader__overlay">
                <span class="avatar-uploader__hint">Click para cambiar</span>
              </div>
            </div>

            <div class="avatar-uploader__actions">
              <label for="{{ p_form.profile_picture.id_for_label }}" class="btn btn-sm btn-primary me-2 mb-2">
                Cambiar foto
              </label>
              <button type="button" class="btn btn-sm btn-outline-danger mb-2" id="btnClearAvatar">
                Quitar foto
              </button>
              <div class="form-text mt-1">JPG o PNG. Máx 2&nbsp;MB.</div>
              <div class="text-danger small mt-1 d-none" id="avatarError"></div>
            </div>
          </div>

          <input
            type="file"
            name="{{ p_form.profile_picture.html_name }}"
            id="{{ p_form.profile_picture.id_for_label }}"
            accept="image/*"
            class="d-none"
          />

          {% if request.user.perfil.profile_picture %}
            <input type="checkbox"
                   name="{{ p_form.profile_picture.name }}-clear"
                   id="avatarClear"
                   class="d-none">
          {% endif %}

          {% for e in p_form.profile_picture.errors %}
            <div class="text-danger small">{{ e }}</div>
          {% endfor %}
        </div>

        <div class="mb-3">
          <label class="form-label" for="{{ u_form.nombre.id_for_label }}">Nombre</label>
          {{ u_form.nombre }}
          {% for e in u_form.nombre.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="mb-3">
          <label class="form-label" for="{{ u_form.apellido.id_for_label }}">Apellido</label>
          {{ u_form.apellido }}
          {% for e in u_form.apellido.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="mb-3">
          <label class="form-label" for="{{ u_form.nombre_usuario.id_for_label }}">Usuario</label>
          <div class="input-group">
            <span class="input-group-text">@</span>
            {{ u_form.nombre_usuario }}
          </div>
          {% for e in u_form.nombre_usuario.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          <div class="form-text">Usa letras, números o guiones; se normaliza automáticamente.</div>
        </div>

        <hr class="my-3">

        {{ p_form.non_field_errors }}

        <div class="mb-3">
          <label class="form-label">{{ p_form.bio.label }}</label>
          {{ p_form.bio }}
          {% for e in p_form.bio.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        {# --- FIN APARTADO FOTO DE PERFIL --- #}

        <div class="mb-3">
          <label class="form-label">{{ p_form.birth_date.label }}</label>
          {{ p_form.birth_date }}
          {% for e in p_form.birth_date.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card p-3 h-100">
        <h4 class="mb-3">Configuración de Privacidad</h4>
        <div class="form-check form-switch mb-3">
          <input 
            class="form-check-input" 
            type="checkbox" 
            role="switch" 
            id="isPrivateSwitch" 
            name="is_private" 
            {% if user.is_private %}checked{% endif %}>
          <label class="form-check-label" for="isPrivateSwitch">
            <strong>Hacer mi perfil privado</strong>
          </label>
          <div class="form-text mt-1">
            Si activas esta opción, solo tus amigos podrán ver los detalles de tu perfil, tus eventos y tus listas de regalos.
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 d-flex gap-2 mt-4">
      <a href="{% url 'perfil' %}" class="btn btn-outline-secondary">Cancelar</a>
      <button type="submit" class="btn btn-primary">Guardar cambios</button>
    </div>
  </form>
</div>

<style>
.avatar-uploader {
  display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
}
.avatar-uploader__preview {
  position: relative; width: 104px; height: 104px; border-radius: 50%;
  overflow: hidden; box-shadow: 0 6px 18px rgba(0,0,0,.12);
  cursor: pointer; transition: transform .2s ease;
}
.avatar-uploader__preview:hover { transform: translateY(-2px); }
.avatar-uploader__preview img,
.avatar-uploader__placeholder {
  width: 100%; height: 100%; object-fit: cover; display: block;
}
.avatar-uploader__placeholder {
  display: grid; place-items: center; font-size: 40px; color: #9aa4b2;
  background: linear-gradient(135deg, #f3f6fb, #eef2f7);
}
.avatar-uploader__overlay {
  position: absolute; inset: 0; background: rgba(0,0,0,.35);
  opacity: 0; display: grid; place-items: center; transition: opacity .2s ease;
}
.avatar-uploader__preview:hover .avatar-uploader__overlay { opacity: 1; }
.avatar-uploader__hint { color: #fff; font-size: .85rem; user-select: none; }
.avatar-uploader__actions { min-width: 220px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const fileInput = document.getElementById('{{ p_form.profile_picture.id_for_label }}');
  const avatarPreview = document.getElementById('avatarPreview');
  const avatarImg = document.getElementById('avatarImg');
  const btnClear = document.getElementById('btnClearAvatar');
  const clearCheckbox = document.getElementById('avatarClear');
  const errorBox = document.getElementById('avatarError');

  avatarPreview?.addEventListener('click', () => fileInput?.click());

  fileInput?.addEventListener('change', function () {
    errorBox?.classList.add('d-none');
    if (!this.files || !this.files[0]) return;
    const file = this.files[0];
    if (file.size > 2 * 1024 * 1024) {
      this.value = '';
      errorBox.textContent = 'El archivo supera los 2 MB.';
      errorBox.classList.remove('d-none');
      return;
    }
    const reader = new FileReader();
    reader.onload = e => {
      if (avatarImg) {
        avatarImg.src = e.target.result;
      } else {
        const img = document.createElement('img');
        img.id = 'avatarImg';
        img.alt = 'Vista previa';
        img.src = e.target.result;
        avatarPreview.innerHTML = '';
        avatarPreview.appendChild(img);
        const overlay = document.createElement('div');
        overlay.className = 'avatar-uploader__overlay';
        overlay.innerHTML = '<span class="avatar-uploader__hint">Click para cambiar</span>';
        avatarPreview.appendChild(overlay);
      }
      if (clearCheckbox) clearCheckbox.checked = false;
    };
    reader.readAsDataURL(file);
  });

  btnClear?.addEventListener('click', function () {
    if (fileInput) fileInput.value = '';
    if (clearCheckbox) clearCheckbox.checked = true;
    avatarPreview.innerHTML =
      '<div class="avatar-uploader__placeholder" id="avatarPlaceholder">+</div>' +
      '<div class="avatar-uploader__overlay"><span class="avatar-uploader__hint">Click para cambiar</span></div>';
  });
});
</script>
{% endblock %}
