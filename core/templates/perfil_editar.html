{% extends "base.html" %}
{% load static %}

{% block title %}Editar perfil – Gifter’s{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-3">Editar perfil</h2>

  <form method="post" enctype="multipart/form-data" class="row g-4" novalidate>
    {% csrf_token %}

    <div class="col-12 col-lg-6">
      <div class="card p-3 h-100">
        <h4 class="mb-3">Datos de perfil</h4>
        {{ u_form.non_field_errors }}
        <div class="mb-4">
          <label class="form-label d-block mb-2">Foto de perfil</label>
          <div class="avatar-uploader">
            <div class="avatar-uploader__preview" id="avatarPreview">
              {% if request.user.perfil.profile_picture %}
                <img src="{{ request.user.perfil.profile_picture.url }}" alt="Foto actual" id="avatarImg">
              {% else %}
                <div class="avatar-uploader__placeholder" id="avatarPlaceholder">+</div>
              {% endif %}
              <div class="avatar-uploader__overlay"><span class="avatar-uploader__hint">Click para cambiar</span></div>
            </div>
            <div class="avatar-uploader__actions">
              <label for="{{ p_form.profile_picture.id_for_label }}" class="btn btn-sm btn-primary me-2 mb-2">Cambiar foto</label>
              <button type="button" class="btn btn-sm btn-outline-danger mb-2" id="btnClearAvatar">Quitar foto</button>
              <div class="form-text mt-1">JPG o PNG. Máx 2&nbsp;MB.</div>
              <div class="text-danger small mt-1 d-none" id="avatarError"></div>
            </div>
          </div>
          <input type="file" name="{{ p_form.profile_picture.html_name }}" id="{{ p_form.profile_picture.id_for_label }}" accept="image/*" class="d-none" />
          {% if request.user.perfil.profile_picture %}
            <input type="checkbox" name="{{ p_form.profile_picture.name }}-clear" id="avatarClear" class="d-none">
          {% endif %}
          {% for e in p_form.profile_picture.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="mb-3">
          <label class="form-label" for="{{ u_form.nombre.id_for_label }}">Nombre</label>
          {{ u_form.nombre }}
          {% for e in u_form.nombre.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="mb-3">
          <label class="form-label" for="{{ u_form.apellido.id_for_label }}">Apellido</label>
          {{ u_form.apellido }}
          {% for e in u_form.apellido.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="mb-3">
          <label class="form-label" for="{{ u_form.nombre_usuario.id_for_label }}">Usuario</label>
          <div class="input-group">
            <span class="input-group-text">@</span>
            {{ u_form.nombre_usuario }}
          </div>
          {% for e in u_form.nombre_usuario.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          <div class="form-text">Usa letras, números o guiones; se normaliza automáticamente.</div>
        </div>
        <hr class="my-3">
        {{ p_form.non_field_errors }}
        <div class="mb-3">
          <label class="form-label">{{ p_form.bio.label }}</label>
          {{ p_form.bio }}
          {% for e in p_form.bio.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="mb-3">
          <label class="form-label">{{ p_form.birth_date.label }}</label>
          {{ p_form.birth_date }}
          {% for e in p_form.birth_date.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card p-3 h-100">
        <h4 class="mb-3">Configuración de Privacidad</h4>
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" role="switch" id="isPrivateSwitch" name="is_private" {% if user.is_private %}checked{% endif %}>
          <label class="form-check-label" for="isPrivateSwitch"><strong>Hacer mi perfil privado</strong></label>
          <div class="form-text mt-1">Si activas esta opción, solo tus amigos podrán ver los detalles de tu perfil.</div>
        </div>
        <hr class="my-4">
        
        <h4 class="mb-3">Tus Intereses</h4>
        <p class="text-muted">Selecciona las categorías y marcas que más te gusten.</p>
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#interestsModal">
          Seleccionar mis intereses
        </button>
        <div class="mt-3">
            <h6 class="small text-uppercase">Categorías seleccionadas:</h6>
            <div id="selected-categories-display" class="interest-pills-container"></div>
            <h6 class="small text-uppercase mt-3">Marcas seleccionadas:</h6>
            <div id="selected-brands-display" class="interest-pills-container"></div>
        </div>
      </div>
    </div>

    <div id="hidden-interests-container" class="d-none"></div>
    <div class="col-12 d-flex gap-2 mt-4">
      <a href="{% url 'perfil' %}" class="btn btn-outline-secondary">Cancelar</a>
      <button type="submit" class="btn btn-primary">Guardar cambios</button>
    </div>
  </form>
</div>

<div class="modal fade" id="interestsModal" tabindex="-1" aria-labelledby="interestsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="interestsModalLabel">Selecciona tus Intereses</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Tus selecciones nos ayudarán a darte mejores recomendaciones.</p>
        
        <h5 class="mt-2">Categorías</h5>
        <div class="interest-pills-container">
            {% for categoria in all_categories %}
                <div class="interest-pill">
                    <input type="checkbox" name="modal_intereses_categorias" value="{{ categoria.id_categoria }}" id="modal-cat-{{ categoria.id_categoria }}" {% if categoria.id_categoria in user_category_ids %}checked{% endif %}>
                    <label for="modal-cat-{{ categoria.id_categoria }}">{{ categoria.nombre_categoria }}</label>
                </div>
            {% empty %}
                <p class="text-muted small">No hay categorías disponibles.</p>
            {% endfor %}
        </div>

        <hr class="my-4">

        <h5>Marcas</h5>
        <div class="interest-pills-container">
            {% for marca in all_brands %}
                <div class="interest-pill">
                    <input type="checkbox" name="modal_intereses_marcas" value="{{ marca.id_marca }}" id="modal-marca-{{ marca.id_marca }}" {% if marca.id_marca in user_brand_ids %}checked{% endif %}>
                    <label for="modal-marca-{{ marca.id_marca }}">{{ marca.nombre_marca }}</label>
                </div>
            {% empty %}
                <p class="text-muted small">No hay marcas disponibles.</p>
            {% endfor %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<style>
.avatar-uploader { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
.avatar-uploader__preview { position: relative; width: 104px; height: 104px; border-radius: 50%; overflow: hidden; box-shadow: 0 6px 18px rgba(0,0,0,.12); cursor: pointer; transition: transform .2s ease; }
.avatar-uploader__preview:hover { transform: translateY(-2px); }
.avatar-uploader__preview img, .avatar-uploader__placeholder { width: 100%; height: 100%; object-fit: cover; display: block; }
.avatar-uploader__placeholder { display: grid; place-items: center; font-size: 40px; color: #9aa4b2; background: linear-gradient(135deg, #f3f6fb, #eef2f7); }
.avatar-uploader__overlay { position: absolute; inset: 0; background: rgba(0,0,0,.35); opacity: 0; display: grid; place-items: center; transition: opacity .2s ease; }
.avatar-uploader__preview:hover .avatar-uploader__overlay { opacity: 1; }
.avatar-uploader__hint { color: #fff; font-size: .85rem; user-select: none; }
.avatar-uploader__actions { min-width: 220px; }
.interest-pills-container { display: flex; flex-wrap: wrap; gap: 8px; }
.interest-pill input[type="checkbox"] { display: none; }
.interest-pill label { display: inline-block; padding: 8px 16px; border: 1px solid #dee2e6; border-radius: 999px; cursor: pointer; transition: all 0.2s ease; font-weight: 500; background-color: #f8f9fa; font-size: 0.9rem; }
.interest-pill label:hover { border-color: #0d6efd; color: #0d6efd; }
.interest-pill input[type="checkbox"]:checked + label { background-color: #0d6efd; color: #fff; border-color: #0d6efd; }
#selected-categories-display .badge, #selected-brands-display .badge { padding: 6px 12px; font-size: 0.85rem; font-weight: 500; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Script del avatar 
  const fileInput = document.getElementById('{{ p_form.profile_picture.id_for_label }}');
  const avatarPreview = document.getElementById('avatarPreview');
  let avatarImg = document.getElementById('avatarImg');
  const btnClear = document.getElementById('btnClearAvatar');
  const clearCheckbox = document.getElementById('avatarClear');
  const errorBox = document.getElementById('avatarError');
  avatarPreview?.addEventListener('click', () => fileInput?.click());
  fileInput?.addEventListener('change', function (e) { /* Tu código de avatar */ });
  btnClear?.addEventListener('click', function (e) { /* Tu código de avatar */ });

  // --- SCRIPT DE SINCRONIZACIÓN DE INTERESES (MODIFICADO Y MEJORADO) ---
  const modal = document.getElementById('interestsModal');
  const categoryCheckboxes = modal.querySelectorAll('input[name="modal_intereses_categorias"]');
  const brandCheckboxes = modal.querySelectorAll('input[name="modal_intereses_marcas"]');
  
  const categoryDisplay = document.getElementById('selected-categories-display');
  const brandDisplay = document.getElementById('selected-brands-display');
  const hiddenContainer = document.getElementById('hidden-interests-container');

  function syncAndDisplay() {
      // Limpiar áreas de visualización e inputs ocultos
      categoryDisplay.innerHTML = '';
      brandDisplay.innerHTML = '';
      hiddenContainer.innerHTML = '';

      // Sincronizar y mostrar categorías
      categoryCheckboxes.forEach(checkbox => {
          if (checkbox.checked) {
              const pill = document.createElement('span');
              pill.className = 'badge rounded-pill bg-primary';
              pill.textContent = checkbox.nextElementSibling.textContent.trim();
              categoryDisplay.appendChild(pill);

              // Crear input oculto para el formulario
              const hiddenInput = document.createElement('input');
              hiddenInput.type = 'hidden';
              hiddenInput.name = 'intereses_categorias';
              hiddenInput.value = checkbox.value;
              hiddenContainer.appendChild(hiddenInput);
          }
      });
      if (categoryDisplay.innerHTML === '') {
          categoryDisplay.innerHTML = '<span class="text-muted small">Ninguna seleccionada</span>';
      }

      // Sincronizar y mostrar marcas
      brandCheckboxes.forEach(checkbox => {
          if (checkbox.checked) {
              const pill = document.createElement('span');
              pill.className = 'badge rounded-pill bg-secondary';
              pill.textContent = checkbox.nextElementSibling.textContent.trim();
              brandDisplay.appendChild(pill);

              // Crear input oculto para el formulario
              const hiddenInput = document.createElement('input');
              hiddenInput.type = 'hidden';
              hiddenInput.name = 'intereses_marcas';
              hiddenInput.value = checkbox.value;
              hiddenContainer.appendChild(hiddenInput);
          }
      });
      if (brandDisplay.innerHTML === '') {
          brandDisplay.innerHTML = '<span class="text-muted small">Ninguna seleccionada</span>';
      }
  }

  // Sincronizar cada vez que se cambia un checkbox dentro del modal
  modal.addEventListener('change', syncAndDisplay);

  // Sincronizar al cargar la página por primera vez
  syncAndDisplay();
});
</script>
{% endblock %}