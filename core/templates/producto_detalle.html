{% extends "base.html" %}
{% load static %}

{% block title %}{{ producto.nombre_producto }} — Gifter’s{% endblock %}

{% block content %}

<style>
  .product-detail-image {
      aspect-ratio: 1/1;
      background: #fff;
      overflow: hidden;
      border-radius: 12px;
  }

  .product-detail-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }

  .similar-card {
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      transition: .2s ease;
      border: 1px solid #e5e7eb;
  }

  .similar-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.07);
  }

  .similar-img-wrapper {
      aspect-ratio: 1/1;
      overflow: hidden;
      background: #fff;
  }

  .similar-img-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }
</style>

<div class="container py-4">

  <!-- Breadcrumb -->
  <nav class="mb-3 small">
    <a href="{% url 'home' %}">Inicio</a> /
    {% if producto.id_categoria %}
      <span>{{ producto.id_categoria.nombre_categoria }}</span> /
    {% endif %}
    <strong>{{ producto.nombre_producto }}</strong>
  </nav>

  <!-- Producto -->
  <div class="row g-4">

    <!-- Imagen principal -->
    <div class="col-lg-5">
      <div class="product-detail-image">

        {% if producto.imagen %}
            {% if producto.imagen.url %}
              <img src="{{ producto.imagen.url }}">

            {% elif producto.imagen|slice:":4" == "http" %}
              <img src="{{ producto.imagen }}">

            {% else %}
              <img src="/media/{{ producto.imagen }}">
            {% endif %}
        {% else %}
            <img src="{% static 'img/Gifters/favicongift.png' %}">
        {% endif %}

      </div>
    </div>

    <!-- Información -->
    <div class="col-lg-7">
      <h1 class="h3 mb-2">{{ producto.nombre_producto }}</h1>

      {% if producto.id_marca %}
      <div class="text-primary fw-semibold mb-2">{{ producto.id_marca.nombre_marca }}</div>
      {% endif %}

      {% if producto.descripcion %}
        <p class="text-muted">{{ producto.descripcion }}</p>
      {% endif %}

      <!-- Wishlist + botón tienda -->
      <div class="d-flex gap-2 mt-3">

        <!-- Wishlist -->
        <a href="#"
           class="btn btn-outline-danger wishlist-btn {% if producto.id_producto in favoritos_ids %}is-fav{% endif %}"
           data-product-id="{{ producto.id_producto }}">
           
          {% if producto.id_producto in favoritos_ids %}
            <i class="bi bi-heart-fill"></i> En tu wishlist
          {% else %}
            <i class="bi bi-heart"></i> Agregar a wishlist
          {% endif %}
        </a>

        <!-- Ver en tienda -->
        {% if url_principal %}
          <a href="{{ url_principal }}" target="_blank" rel="noopener"
             class="btn btn-primary">
            <i class="bi bi-box-arrow-up-right"></i> Ver en tienda
          </a>
        {% endif %}
      </div>

      <!-- Otras URLs -->
      {% if producto.urls_tienda_activas_qs %}
        <div class="mt-3">
          <div class="small text-muted mb-1">Otros vendedores:</div>
          <div class="d-flex flex-wrap gap-2">
            {% for u in producto.urls_tienda_activas_qs %}
              <a class="btn btn-sm btn-outline-secondary" href="{{ u.url }}" target="_blank">
                {{ u.nombre_tienda|default:"Ver tienda" }}
              </a>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- SIMILARES -->
  {% if similares %}
    <hr class="my-5">
    <h2 class="h5 mb-3">Te puede interesar</h2>

    <div class="row g-4">

      {% for p in similares %}
      <div class="col-12 col-sm-6 col-lg-4">

        <div class="similar-card">

          <a href="{% url 'producto_detalle' p.id_producto %}">
            <div class="similar-img-wrapper">

              {% if p.imagen %}
                  {% if p.imagen.url %}
                    <img src="{{ p.imagen.url }}">
                  {% elif p.imagen|slice:":4" == "http" %}
                    <img src="{{ p.imagen }}">
                  {% else %}
                    <img src="/media/{{ p.imagen }}">
                  {% endif %}
              {% else %}
                  <img src="{% static 'img/Gifters/favicongift.png' %}">
              {% endif %}

            </div>
          </a>

          <div class="p-3">
            <a href="{% url 'producto_detalle' p.id_producto %}"
               class="fw-semibold text-decoration-none d-block">
              {{ p.nombre_producto }}
            </a>

            {% if p.id_marca %}
              <div class="small text-primary">{{ p.id_marca.nombre_marca }}</div>
            {% endif %}
          </div>

        </div>

      </div>
      {% endfor %}

    </div>
  {% endif %}

</div>

<!-- Wishlist Handler -->
<script>
  function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
  }
  const csrftoken = getCookie("csrftoken");

  document.addEventListener("click", async function(e){
      const btn = e.target.closest(".wishlist-btn");
      if (!btn) return;

      e.preventDefault();

      const id = btn.dataset.productId;

      const resp = await fetch(
          "{% url 'favoritos_toggle' 0 %}".replace("/0/", `/${id}/`),
          { method: "POST", headers: { "X-CSRFToken": csrftoken } }
      );

      if (!resp.ok) return;

      const data = await resp.json();
      const icon = btn.querySelector("i");

      if (data.state === "added") {
          btn.classList.add("is-fav");
          btn.innerHTML = '<i class="bi bi-heart-fill"></i> En tu wishlist';
      } else {
          btn.classList.remove("is-fav");
          btn.innerHTML = '<i class="bi bi-heart"></i> Agregar a wishlist';
      }
  });
</script>

{% endblock %}
