{% extends "base.html" %}
{% load static %}

{% block title %}{{ producto.nombre_producto }} — Gifter’s{% endblock %}

{% block content %}
<div class="container py-4">
  <nav class="mb-3 small">
    <a href="{% url 'home' %}">Inicio</a> /
    {% if producto.id_categoria %}<span>{{ producto.id_categoria.nombre_categoria }}</span> /{% endif %}
    <strong>{{ producto.nombre_producto }}</strong>
  </nav>

  <div class="row g-4">
    <!-- IMAGEN -->
    <div class="col-lg-5">
      <div class="border rounded overflow-hidden" style="aspect-ratio: 1/1; background:#fff">
        {% if producto.imagen and producto.imagen.url %}
          <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre_producto }}"
               style="width:100%;height:100%;object-fit:contain;">
        {% else %}
          <img src="{% static 'img/Gifters/favicongift.png' %}" alt="{{ producto.nombre_producto }}"
               style="width:100%;height:100%;object-fit:contain;">
        {% endif %}
      </div>
    </div>

    <!-- INFO -->
    <div class="col-lg-7">
      <h1 class="h3 mb-2">{{ producto.nombre_producto }}</h1>
      {% if producto.id_marca %}<div class="text-primary fw-semibold mb-2">{{ producto.id_marca.nombre_marca }}</div>{% endif %}

      {% if producto.precio %}
        
      {% endif %}

      {% if producto.descripcion %}
        <p class="text-muted">{{ producto.descripcion }}</p>
      {% endif %}

      <div class="d-flex gap-2 align-items-center mt-3">
        <!-- Corazón / wishlist -->
        <a href="#"
           class="btn btn-outline-danger wishlist-btn {% if producto.id_producto in favoritos_ids %}is-fav{% endif %}"
           title="{% if producto.id_producto in favoritos_ids %}Quitar de wishlist{% else %}Agregar a wishlist{% endif %}"
           data-product-id="{{ producto.id_producto }}"
           aria-pressed="{% if producto.id_producto in favoritos_ids %}true{% else %}false{% endif %}">
          {% if producto.id_producto in favoritos_ids %}
            <i class="bi bi-heart-fill"></i> En tu wishlist
          {% else %}
            <i class="bi bi-heart"></i> Agregar a wishlist
          {% endif %}
        </a>

        {% if url_principal %}
          <a href="{{ url_principal }}" target="_blank" rel="noopener"
             class="btn btn-primary">
            <i class="bi bi-box-arrow-up-right"></i> Ver en tienda
          </a>
        {% endif %}
      </div>

      <!-- Otras URLs de tienda (si existen) -->
      {% if producto.urls_tienda_activas_qs %}
        <div class="mt-3">
          <div class="small text-muted mb-1">Otros vendedores / enlaces:</div>
          <div class="d-flex flex-wrap gap-2">
            {% for u in producto.urls_tienda_activas_qs %}
              <a class="btn btn-sm btn-outline-secondary" href="{{ u.url }}" target="_blank" rel="noopener">
                {{ u.nombre_tienda|default:"Ver tienda" }}
              </a>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- SIMILARES -->
  {% if similares %}
    <hr class="my-5">
    <h2 class="h5 mb-3">Te puede interesar</h2>
    <div class="row g-4">
      {% for p in similares %}
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="border rounded h-100 p-2">
          <a href="{% url 'producto_detalle' p.id_producto %}" class="d-block"
             style="aspect-ratio:4/3; overflow:hidden;">
            {% if p.imagen and p.imagen.url %}
              <img src="{{ p.imagen.url }}" alt="{{ p.nombre_producto }}"
                   style="width:100%;height:100%;object-fit:cover;">
            {% else %}
              <img src="{% static 'img/Gifters/favicongift.png' %}" alt="{{ p.nombre_producto }}"
                   style="width:100%;height:100%;object-fit:cover;">
            {% endif %}
          </a>
          <div class="p-2">
            <a href="{% url 'producto_detalle' p.id_producto %}" class="fw-semibold text-decoration-none">
              {{ p.nombre_producto }}
            </a>
            {% if p.id_marca %}<div class="small text-primary">{{ p.id_marca.nombre_marca }}</div>{% endif %}
            
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% endif %}
</div>

<!-- === Wishlist toggle (igual que en otras vistas) === -->
<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  document.addEventListener('click', async function (e) {
    const btn = e.target.closest('.wishlist-btn');
    if (!btn) return;

    e.preventDefault();
    const id = btn.getAttribute('data-product-id');
    const icon = btn.querySelector('i');
    const wasFav = btn.classList.contains('is-fav');
    const prevTitle = btn.title;

    try {
      const url = "{% url 'favoritos_toggle' 0 %}".replace('/0/', `/${id}/`);
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
      });

      if (resp.redirected || resp.url.includes("{% url 'login' %}")) {
        window.location.href = "{% url 'login' %}?next={{ request.get_full_path|urlencode }}";
        return;
      }
      if (!resp.ok) throw new Error('HTTP ' + resp.status);

      const data = await resp.json();
      const isFav = data.state === 'added';

      btn.classList.toggle('is-fav', isFav);
      btn.setAttribute('aria-pressed', isFav ? 'true' : 'false');
      btn.title = isFav ? 'Quitar de wishlist' : 'Agregar a wishlist';
      icon.className = isFav ? 'bi bi-heart-fill' : 'bi bi-heart';
      btn.innerHTML = isFav ? '<i class="bi bi-heart-fill"></i> En tu wishlist' : '<i class="bi bi-heart"></i> Agregar a wishlist';
    } catch (err) {
      // Revertir si falla
      btn.classList.toggle('is-fav', wasFav);
      btn.setAttribute('aria-pressed', wasFav ? 'true' : 'false');
      btn.title = prevTitle;
      icon.className = wasFav ? 'bi bi-heart-fill' : 'bi bi-heart';
    }
  });
</script>
{% endblock %}
