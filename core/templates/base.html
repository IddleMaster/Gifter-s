{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>{% block title %}Gifter‚Äôs{% endblock %}</title>

  <!-- Favicons -->
  <link rel="icon" href="{% static 'img/Gifters/favicongift.png' %}" type="image/png" />
  <link rel="apple-touch-icon" href="{% static 'img/Gifters/logo-sin-letras.png' %}" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;900&display=swap" rel="stylesheet" />

  <!-- Vendor CSS (via STATIC_URL=/assets/) -->
  <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet" />
  <link href="{% static 'vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet" />
  <link href="{% static 'vendor/aos/aos.css' %}" rel="stylesheet" />
  <link href="{% static 'vendor/glightbox/css/glightbox.min.css' %}" rel="stylesheet" />
  <link href="{% static 'vendor/swiper/swiper-bundle.min.css' %}" rel="stylesheet" />

  <!-- Main CSS -->
  <link href="{% static 'css/main.css' %}" rel="stylesheet" />
  <link href="{% static 'css/gifters.css' %}" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/chat-floating.css' %}" />



  <style>
    body,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p,
    a,
    button {
      font-family: 'Poppins', sans-serif !important;
    }

    .logo-img {
      height: 64px;
      width: auto;
      display: block;
    }

    .login-btn-standalone {
      display: inline-block;
      padding: .55rem 1rem;
      border-radius: 999px;
      background: #1970ea;
      color: #fff;
      text-decoration: none;
      font-weight: 700;
    }

    .login-btn-standalone:hover {
      filter: brightness(.92);
      color: #fff;
    }

    /* Oculta los mensajes Bootstrap cl√°sicos */
    #flash-messages,
    .messages,
    .django-messages,
    .alert[role="alert"][data-django-message] {
      display: none !important;
    }
  </style>

  <style>
    /* ===== Drawer: estilo "tel√©fono" ===== */
    .chat-drawer.phone-ui {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 100%;
      max-width: 920px;
      height: 70vh;
      border-radius: 16px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 12px 32px rgba(0, 0, 0, .18);
      transform: translateY(8px);
      opacity: 0;
      pointer-events: none;
      transition: transform .25s ease, opacity .25s ease;
      display: flex;
      flex-direction: column;
    }

    .chat-drawer.phone-ui.open {
      transform: none;
      opacity: 1;
      pointer-events: auto;
    }

    .phone-header {
      background: #0d6efd;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
    }

    .phone-header .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
    }

    .phone-header .brand img {
      width: 28px;
      height: 28px;
      display: block;
    }

    .phone-tabs {
      display: flex;
      gap: 8px;
      padding: 10px;
      border-bottom: 1px solid #eef1f5;
      background: #f8fafc;
    }

    .phone-tabs .tab-btn {
      appearance: none;
      border: 1px solid #e5e7eb;
      background: #fff;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 600;
      font-size: .95rem;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .phone-tabs .tab-btn.active {
      border-color: #0d6efd;
      color: #0d6efd;
    }

    .phone-body {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 0;
      height: 100%;
      min-height: 0;
      /* para que flexbox/grid permitan scroll interno */
    }

    .phone-list {
      border-right: 1px solid #eef1f5;
      overflow: auto;
    }

    .list-pane {
      display: none;
      height: 100%;
    }

    .list-pane.active {
      display: block;
    }

    .phone-chat {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .chat-head,
    .chat-input {
      border-top: 1px solid #eef1f5;
    }

    .chat-messages {
      flex: 1;
      overflow: auto;
      padding: 16px;
      background: #fbfbfd;
    }

    /* Lista reusando tu markup existente */
    .chat-list {
      padding: 8px;
    }

    .chat-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
    }

    .chat-list-item:hover {
      background: #f4f6fb;
    }

    .chat-list-item.active {
      background: #ecf2ff;
    }

    .chat-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      object-fit: cover;
    }

    .chat-names .line1 {
      font-weight: 700;
    }

    .chat-names .line2 {
      font-size: .9rem;
      color: #6b7280;
    }

    .chat-time {
      margin-left: auto;
      font-size: .8rem;
      color: #9ca3af;
    }


    .msg {
      display: flex;
      gap: 8px;
      margin: 6px 0;
      align-items: flex-end;
    }

    .msg.me {
      justify-content: flex-end;
    }

    .msg-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
    }

    .bubble,
    .msg-bubble {
      max-width: 72%;
      padding: 10px 12px;
      border-radius: 14px;
      background: #fff;
      border: 1px solid #eef1f5;
    }

    .msg.me .bubble,
    .msg.me .msg-bubble {
      background: #e8f0ff;
      border-color: #dae6ff;
    }

    .body,
    .msg-body {
      white-space: pre-wrap;
      word-break: break-word;
    }

    .meta,
    .msg-meta {
      font-size: .75rem;
      color: #9ca3af;
      margin-top: 4px;
      text-align: right;
    }

    .chat-input {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: #fff;
    }

    #chatText {
      flex: 1;
      resize: none;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }

    #chatForm button {
      padding: 10px 14px;
      border-radius: 12px;
      border: none;
      background: #0d6efd;
      color: #fff;
      font-weight: 700;
    }


    .phone-bottom-nav {
      display: none;
      border-top: 1px solid #eef1f5;
      background: #fff;
      padding: 6px 10px;
      gap: 10px;
    }

    .phone-bottom-nav .tab-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      border: none;
      background: transparent;
      padding: 6px 8px;
      font-weight: 600;
      color: #6b7280;
    }

    .phone-bottom-nav .tab-btn.active {
      color: #0d6efd;
    }

    /* Responsivo: en pantallas chicas, lista arriba y chat abajo (tipo app) */
    @media (max-width: 860px) {
      .chat-drawer.phone-ui {
        right: 10px;
        left: 10px;
        height: 80vh;
      }

      .phone-body {
        grid-template-columns: 1fr;
      }

      .phone-bottom-nav {
        display: flex;
      }

      .phone-list {
        height: 45%;
      }

      .phone-chat {
        height: 55%;
        border-top: 1px solid #eef1f5;
      }
    }

    /* Avatar arriba para ambos lados */
    .msg {
      align-items: flex-start;
    }

    .msg.me {
      flex-direction: row-reverse;
      align-items: flex-start;
    }

    .msg .msg-avatar {
      align-self: flex-start;
    }

    /* Cuando NO mostramos avatar, damos margen para que la burbuja no ‚Äúsalte‚Äù */
    .msg.other.compact .bubble {
      margin-left: 36px;
    }

    /* 28px avatar + 8px gap */
    .msg.me.compact .bubble {
      margin-right: 36px;
    }

    /* Separador de d√≠a */
    .day-sep {
      text-align: center;
      font-size: .85rem;
      font-style: italic;
      color: #6b7280;
      margin: 14px 0;
    }


    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      margin: 0 12px 6px;
      border-radius: 12px;
      background: #f5f7ff;
      color: #4b5563;
      font-size: .9rem;
    }

    .typing-indicator .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #9aa7ff;
      display: inline-block;
      animation: blink 1.2s infinite ease-in-out;
    }

    .typing-indicator .dot:nth-child(1) {
      animation-delay: 0s
    }

    .typing-indicator .dot:nth-child(2) {
      animation-delay: .2s
    }

    .typing-indicator .dot:nth-child(3) {
      animation-delay: .4s
    }

    @keyframes blink {

      0%,
      80%,
      100% {
        opacity: .2
      }

      40% {
        opacity: 1
      }
    }

    /* Asegura que el √°rea derecha sea una columna con el input al final */
    .chat-pane {
      display: flex;
      flex-direction: column;
    }

    /* El listado scrollea, el resto queda debajo */
    .chat-messages {
      flex: 1;
      overflow: auto;
    }

    /* El indicador queda justo encima del input, sin scrollearse */
    #typingIndicator {
      position: sticky;
      /* queda ‚Äúpegado‚Äù dentro de su contenedor */
      bottom: 0;
      /* pegado abajo */
      z-index: 1;
      /* por encima del fondo */
      margin-top: 0;
      margin-bottom: 6px;
    }

    .bubble img.msg-image {
      max-width: 100%;
      height: auto;
      display: block;
      border-radius: 10px;
    }

    /* ‚Äî‚Äî‚Äî Sugerencias (dropdown) ‚Äî‚Äî‚Äî */
    .sugerencias-container {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 4000;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .08);
      margin-top: 6px;
      display: none;
      overflow: hidden;
      max-height: 360px;
      overflow-y: auto;
    }

    /* Portal que pintas en <body> (pegado al buscador) */
    #sugerenciasPortal {
      position: fixed;
      /* ya lo usas para evitar recortes */
      border: 1.5px solid #0d6efd;
      /* mismo color que el pill */
      border-top: none;
      /* se ‚Äúfunde‚Äù con el borde inferior del pill */
      background: #fff;
      border-bottom-left-radius: 14px;
      border-bottom-right-radius: 14px;
      margin-top: -2px !important;
      /* elimina la grieta de 1‚Äì2px */
      box-shadow: 0 12px 22px rgba(0, 0, 0, .08);
      max-height: 360px;
      overflow-y: auto;
    }

    /* √çtems de sugerencia */
    .sug-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      cursor: pointer;
    }

    .sug-item:hover,
    .sug-item.active {
      background: #f5f7ff;
    }

    .sug-type {
      font-size: .75rem;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: .03em;
    }

    .sug-text {
      font-weight: 600;
    }

    .sug-meta {
      font-size: .85rem;
      color: #6b7280;
      margin-left: auto;
    }

    /* Evita que contenedores recorten el dropdown */
    .branding,
    .brand-left,
    .search-pill {
      overflow: visible !important;
    }

    /* ‚Äî‚Äî‚Äî Pill del buscador ‚Äî‚Äî‚Äî */
    .site-search {
      position: relative;
    }

    .site-search *:focus,
    .site-search *:focus-visible {
      outline: none !important;
    }

    /* mata halos nativos dentro del form */

    .search-pill {
      display: flex;
      align-items: center;
      height: 44px;
      /* altura consistente */
      border: 1.5px solid #0d6efd;
      border-radius: 999px;
      overflow: hidden;
      /* recorta cualquier ‚Äúdesfase‚Äù interior */
      background: #fff;
      box-sizing: border-box;
    }

    /* Input sin bordes/sombras/ornamentos nativos */
    .search-pill .search-input {
      flex: 1;
      height: 100%;
      padding: 0 .95rem;
      font-size: 1rem;
      line-height: 1;
      border: 0;
      outline: 0;
      background: #fff;
      box-shadow: none !important;
      appearance: none;
      -webkit-appearance: none;
    }

    .search-pill .search-input::-webkit-search-decoration,
    .search-pill .search-input::-webkit-search-cancel-button,
    .search-pill .search-input::-webkit-search-results-button,
    .search-pill .search-input::-webkit-search-results-decoration {
      display: none;
    }

    /* Bot√≥n de lupa */
    .search-pill .btn-search {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 100%;
      border: 0;
      background: #fff;
      border-left: 1px solid rgba(13, 110, 253, .22);
      /* divisor sutil */
      cursor: pointer;
      outline: none;
      box-shadow: none !important;
    }

    .search-pill .btn-search:focus,
    .search-pill .btn-search:focus-visible {
      outline: none;
      box-shadow: none !important;
    }

    .search-pill .btn-search i {
      font-size: 1rem;
      line-height: 1;
    }

    /* Halo de focus bonito aplicado al contenedor (no al hijo) */
    .search-pill:focus-within {
      box-shadow: none !important;
    }

    /* Estado cuando el dropdown est√° abierto: quita radios inferiores para encajar */
    .search-pill.sug-open {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }

    .dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ff3b30;
      vertical-align: middle;
      margin-left: 6px;
    }

    .dot.hidden {
      display: none;
    }
  </style>




  <style>
    /* Scrollbar minimalista */
    /* Scrollbar minimalista */
    /* ================== Notificaciones ‚Äì estilo limpio ================== */
    /* siempre sobre la barra de b√∫squeda */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] {
      z-index: 1100;
      /* sube la capa */
      min-width: min(92vw, 360px) !important;
      /* que no se pase en m√≥vil */
      max-height: 70vh;
      /* ya lo usas inline: lo traigo ac√° */
      overflow: auto;
      /* ya lo usas inline: lo traigo ac√° */
      margin-top: .35rem;
      /* separa un poco de la campanita */
    }

    /* header ‚ÄúNotificaciones | acciones‚Äù en varias l√≠neas si no cabe */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] li.px-3.py-2 .d-flex {
      flex-wrap: wrap;
      row-gap: .35rem;
    }

    /* coloca el men√∫ bien pegado a la derecha en pantallas peque√±as */
    @media (max-width: 576px) {
      ul.dropdown-menu[aria-labelledby="notifDropdown"] {
        inset: auto .75rem auto auto !important;
        /* right: 12px */
        transform: none !important;
        /* evita correcciones de Popper raras */
      }
    }

    /* Contenedor del men√∫ (tu <ul> actual) */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] {
      --g-blue: #377dff;
      --g-border: #e6eaf2;
      --g-shadow: 0 12px 28px rgba(16, 24, 40, .12);
      border: 1px solid var(--g-border);
      border-radius: 14px;
      box-shadow: var(--g-shadow);
      padding: .25rem 0 .5rem;
      backdrop-filter: saturate(140%) blur(2px);
    }

    /* Header fijo (primer <li>) */
    ul.dropdown-menu[aria-labelledby="notifDropdown"]>li:first-child {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #fff;
      border-bottom: 1px solid var(--g-border);
    }

    /* Divider m√°s sutil */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .dropdown-divider {
      margin: 0;
      border-color: var(--g-border);
    }

    /* Cada <li> que contiene una notificaci√≥n */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] li.px-2 {
      padding: .2rem .5rem;
    }

    /* Tarjeta de notificaci√≥n (tu .dropdown-item.notif-item) */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item {
      gap: .65rem;
      padding: .65rem .75rem;
      border-radius: 12px;
      transition: background .18s ease, box-shadow .18s ease;
    }

    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item:hover {
      background: #f9fbff;
      box-shadow: 0 1px 0 rgba(16, 24, 40, .06) inset;
    }

    /* No le√≠da (ya tienes fw-semibold) */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item.fw-semibold {
      background: #eef5ff;
      box-shadow: inset 0 0 0 1px rgba(55, 125, 255, .12);
    }

    /* Icono izquierdo (tu <span class="mt-1"> ‚Ä¶ </span>) */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item>span.mt-1 {
      display: grid;
      place-items: center;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: rgba(55, 125, 255, .10);
      color: var(--g-blue);
      font-size: 1rem;
      margin-top: 2px;
    }

    /* Bloque de texto principal (link o span con .flex-grow-1) */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .flex-grow-1 {
      min-width: 0;
      /* para que el truncado funcione */
      text-decoration: none;
      color: #1c1f23;
      line-height: 1.28;
    }

    /* T√≠tulo (primer .d-block) */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .flex-grow-1>.d-block:first-child {
      font-weight: 600;
      margin-bottom: .05rem;
    }

    /* Mensaje */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .flex-grow-1 small.text-muted {
      color: #6b7280 !important;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Meta (la √∫ltima l√≠nea ‚Äúhace X tiempo‚Äù) */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .flex-grow-1 small.text-muted:last-child {
      color: #98a2b3 !important;
      font-size: .8rem;
      margin-top: .15rem;
    }

    /* Bot√≥n ‚úì (js-notif-mark-one) */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .js-notif-mark-one {
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 9px;
      border: 1px solid transparent;
      background: transparent;
      color: #97a1b2;
      font-weight: 700;
      transition: all .15s ease;
    }

    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .js-notif-mark-one:hover {
      color: var(--g-blue);
      background: rgba(55, 125, 255, .10);
      border-color: rgba(55, 125, 255, .18);
    }

    /* Badge ‚Äúnuevo‚Äù en azul del tema */
    #notifBadge {
      background: var(--g-blue) !important;
      box-shadow: 0 1px 0 rgba(0, 0, 0, .06);
      font-weight: 700;
    }

    /* Bot√≥n ‚Äúx‚Äù (js-notif-dismiss) */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .js-notif-dismiss {
      color: #b3bac6;
      padding: 0 .25rem;
      border-radius: 6px;
    }

    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .js-notif-dismiss:hover {
      color: #7a869a;
      background: #eef1f6;
    }

    /* Scrollbar discreto (WebKit) */
    ul.dropdown-menu[aria-labelledby="notifDropdown"]::-webkit-scrollbar {
      width: 6px;
    }

    ul.dropdown-menu[aria-labelledby="notifDropdown"]::-webkit-scrollbar-thumb {
      background: #d1d8e6;
      border-radius: 8px;
    }

    ul.dropdown-menu[aria-labelledby="notifDropdown"]::-webkit-scrollbar-thumb:hover {
      background: #bec8db;
    }
  </style>

  <style>
    /* ======= Ajustes finos de estilo (sobre lo ya pegado) ======= */

    /* M√°s espacio bajo el header y apertura m√°s suave */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] {
      margin-top: .55rem;
      border-radius: 16px;
    }

    /* Header: botones menos ‚Äúduros‚Äù */
    #markAllBtn,
    #hideReadBtn,
    #hideAllBtn {
      border-color: rgba(55, 125, 255, .18) !important;
      color: #3f4a5a !important;
      background: transparent !important;
    }

    #markAllBtn:hover,
    #hideReadBtn:hover,
    #hideAllBtn:hover {
      background: rgba(55, 125, 255, .10) !important;
      color: #2b6bff !important;
    }

    /* Cada item: tipograf√≠a y respiraci√≥n */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item {
      padding: .6rem .75rem;
      line-height: 1.28;
    }

    /* T√≠tulo semibold, resto normal (evita ‚Äúgritar‚Äù) */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .flex-grow-1>.d-block:first-child {
      font-weight: 600;
    }

    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item {
      font-weight: 400;
      /* base normal */
    }

    /* ‚ÄúNo le√≠da‚Äù: barra lateral azul en vez de bloque pesado */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item.fw-semibold {
      background: #ffffff;
      /* quita fondo azulazo */
      box-shadow: none;
      /* sin borde interno */
      position: relative;
    }

    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item.fw-semibold::before {
      content: "";
      position: absolute;
      left: 6px;
      top: 8px;
      bottom: 8px;
      width: 3px;
      border-radius: 3px;
      background: #377dff;
      /* acento azul */
    }

    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item.fw-semibold .notif-icon {
      background: rgba(55, 125, 255, .12);
      color: #2b6bff;
    }

    /* Texto: jerarqu√≠a m√°s clara */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .flex-grow-1 small.text-muted {
      color: #667085 !important;
    }

    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .flex-grow-1 small.text-muted:last-child {
      color: #98a2b3 !important;
      letter-spacing: .1px;
    }

    /* Acciones: alineaci√≥n y sutileza */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .js-notif-mark-one,
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .js-notif-dismiss {
      width: 28px;
      height: 28px;
      padding: 0;
      border-radius: 8px;
      border: 1px solid transparent;
      color: #a0a8b7;
      opacity: .9;
    }

    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .js-notif-dismiss {
      font-weight: 700;
      line-height: 1;
    }

    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .js-notif-mark-one:hover,
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item .js-notif-dismiss:hover {
      color: #2b6bff;
      background: rgba(55, 125, 255, .10);
      border-color: rgba(55, 125, 255, .18);
    }

    /* Icono burbuja igualado a la nueva escala */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] .notif-item>span.mt-1 {
      width: 26px;
      height: 26px;
      font-size: .95rem;
      background: rgba(55, 125, 255, .10);
      color: #2b6bff;
    }

    /* Badge del contador: un poco m√°s compacto y elegante */
    #notifBadge {
      padding: .28rem .44rem;
      font-weight: 700;
      filter: saturate(115%);
    }

    /* Peque√±os ajustes de spacing entre items */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] li.px-2+li.px-2 {
      margin-top: .1rem;
    }
  </style>

  <style>
    /* Fade + slide para el men√∫ de notificaciones */
    ul.dropdown-menu[aria-labelledby="notifDropdown"] {
      opacity: 0;
      transform: translateY(-4px);
      transition: opacity .18s ease, transform .18s ease;
    }

    ul.dropdown-menu[aria-labelledby="notifDropdown"].show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>









  <style>
    /* que nada de la cadena recorte el badge */
    .navbar,
    .navbar * {
      overflow: visible !important;
    }

    .nav-item.dropdown,
    .nav-item.dropdown * {
      overflow: visible !important;
    }

    /* la campanita ser√° el ancla */
    #notifDropdown {
      position: relative !important;
      z-index: 4000 !important;
    }

    /* el badge por encima de todo */
    #notifBadge {
      position: absolute !important;
      top: -6px !important;
      right: -8px !important;
      left: auto !important;
      transform: none !important;
      display: inline-block !important;
      z-index: 5000 !important;
      min-width: 16px;
      line-height: 16px;
      padding: 0 5px;
      border-radius: 999px;
      font-size: .70rem;
      text-align: center;
      background: #dc3545;
      color: #fff;
      box-shadow: 0 0 0 2px #fff;
      /* halo para que no lo tape el fondo */
    }

    /* Layout del header: deja al centro ceder ancho, lados fijos */
    .header .brand,
    .header .right {
      flex: 0 0 auto;
    }

    .header .center {
      flex: 1 1 auto;
      min-width: 0;
    }

    /* Buscador grande: ancho fluido y l√≠mite superior */
    .g-search {
      width: 100%;
      max-width: 720px;
    }

    /* ajusta si quieres 680/720 */
    .g-search .g-search__box {
      width: 100%;
    }

    /* Evita que el placeholder empuje el ancho */
    .g-search input {
      text-overflow: ellipsis;
    }

    /* Rango conflictivo: el punto donde se te rompe (ajusta n√∫meros si hace falta) */
    @media (min-width: 992px) and (max-width: 1240px) {

      /* que el buscador ceda ancho en ese rango */
      .g-search {
        max-width: 52vw;
      }

      /* prueba 50‚Äì58vw seg√∫n tu caso */
      .g-search input {
        padding-right: 40px;
      }

      /* deja espacio al bot√≥n de lupa */
    }
  </style>

  <style>
    /* la campana es el ancla y no recorta */
    #notifDropdown,
    #notifDropdown i.bi-bell {
      position: relative !important;
      overflow: visible !important;
      z-index: 4000 !important;
    }

    /* badge NUM√âRICO, por encima de todo y con borde blanco para que no ‚Äúse coma‚Äù un trocito */
    
    /* modo puntito (opcional) */
    #notifBadge.badge-dot {
      width: 10px;
      height: 10px;
      min-width: 10px;
      line-height: 10px;
      padding: 0;
      text-indent: -9999px;
      /* oculta el texto/n√∫mero */
    }
  </style>


  {% block extra_css %}{% endblock %}
</head>

<body class="{% block body_class %}{% endblock %}">
  <!-- HEADER -->
  <header id="header" class="header sticky-top">
    <!-- Topbar -->
    <div class="topbar d-flex align-items-center">
      <div class="container d-flex justify-content-center justify-content-md-between">
        <div class="w-100 text-center py-1 bg-primary text-white">
          <i><span>Gifter's¬Æ 2025</span></i>
        </div>
        <div class="social-links d-none d-md-flex align-items-center">
          <a href="#" class="twitter"><i class="bi bi-twitter-x"></i></a>
          <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
          <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
          <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></a>
        </div>
      </div>
    </div>

    <!-- Barra principal -->
    <div class="branding d-flex align-items-center">
      <div class="container position-relative d-flex align-items-center" style="min-height:84px;">
        <!-- IZQUIERDA: Marca + buscador (desktop) -->
        <div class="brand-left d-flex align-items-center gap-3 flex-shrink-0">
          <a href="{% url 'home' %}" class="logo brand d-flex align-items-center" style="z-index:2;">
            <span class="brand-text">Gifter‚Äôs</span>
            <img src="{% static 'img/Gifters/favicongift.png' %}" alt="Isotipo Gifter‚Äôs" class="brand-mark" />
          </a>

          <form class="g-search" action="{% url 'buscar_router' %}" method="get" autocomplete="off">
            <div class="g-search__box" id="gSearchBox">
              <input id="gSearchInput" name="q" type="text" placeholder="B√∫squeda: regalos, categor√≠as, amigos..."
                value="{{ request.GET.q }}">
              <button class="g-search__btn" type="submit" aria-label="Buscar">
                <i class="bi bi-search"></i>
              </button>
            </div>
            <div id="gSug" class="g-search__sugs" role="listbox" hidden></div>
          </form>



        </div>

        <!-- CENTRO: Nav (solo desktop) -->
        <nav id="navmenu" class="navmenu d-none d-lg-block mx-auto">
          <ul>
            <li><a href="{% url 'home' %}#clients">Categor√≠as</a></li>
            <li>
              {% if user.is_authenticated %}
              <a href="{% url 'perfil' %}?tab=amigos">Amigos</a>
              {% else %}
              <a href="{% url 'account_login' %}?next={% url 'perfil' %}%3Ftab%3Damigos">Amigos</a>
              {% endif %}
            </li>
            <li><a href="{% url 'home' %}#portfolio">Productos</a></li>
            <li><a href="{% url 'home' %}feed">Feed</a></li>
          </ul>
          <i class="mobile-nav-toggle d-none"></i>
        </nav>





        {% if user.is_authenticated %}
        <!-- üîî Campanita de notificaciones -->
        <div class="nav-item dropdown me-2">
          <a class="nav-link position-relative" href="#" id="notifDropdown" role="button" data-bs-toggle="dropdown"
            data-bs-auto-close="outside" aria-expanded="false" aria-label="Notificaciones">
            <i class="bi bi-bell" style="font-size:1.3rem;"></i>
            {% if notif_count and notif_count > 0 %}
            <span id="notifBadge"
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger {% if not notif_count %}d-none{% endif %}"
              style="font-size:.7rem;">
              {{ notif_count|default:0 }}
              <span class="visually-hidden">unread</span>
            </span>
            {% endif %}
          </a>

          <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="notifDropdown"
            style="min-width:320px;max-height:70vh;overflow:auto;" data-bs-auto-close="outside">
            <li class="px-3 py-2 d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Notificaciones</span>

              <div class="d-flex align-items-center gap-1">
                <button class="btn btn-sm btn-outline-secondary" id="markAllBtn">Marcar todo le√≠do</button>
                <button class="btn btn-sm btn-outline-secondary" id="hideReadBtn" title="Ocultar solo le√≠das">Ocultar
                  le√≠das</button>
                <button class="btn btn-sm btn-outline-secondary" id="hideAllBtn" title="Ocultar todas (vista)">Limpiar
                  lista</button>
                <button class="btn btn-sm btn-link" id="restoreHiddenBtn" title="Mostrar ocultas">Restaurar</button>
              </div>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>

            {% if notif_items %}
            {% for n in notif_items %}
            <li class="px-2">
              <div
                class="dropdown-item d-flex align-items-center gap-2 notif-item {% if not n.leida %}fw-semibold{% endif %}"
                data-id="{{ n.notificacion_id|default:n.id }}">
                <span class="mt-1">
                  {% if n.tipo == 'alerta' %}<i class="bi bi-exclamation-triangle"></i>
                  {% elif n.tipo == 'evento' %}<i class="bi bi-calendar-event"></i>
                  {% else %}<i class="bi bi-info-circle"></i>
                  {% endif %}
                </span>

                {% if n.notificacion_id %}
                <a class="flex-grow-1 text-decoration-none" href="{% url 'notificacion_click' n.notificacion_id %}">
                  <span class="d-block">{{ n.titulo }}</span>
                  {% if n.mensaje %}<small class="text-muted">{{ n.mensaje|truncatechars:90 }}</small>{% endif %}
                  <small class="d-block text-muted">{{ n.creada_en|timesince }} atr√°s</small>
                </a>
                {% else %}
                <span class="flex-grow-1">
                  <span class="d-block">{{ n.titulo }}</span>
                  {% if n.mensaje %}<small class="text-muted">{{ n.mensaje|truncatechars:90 }}</small>{% endif %}
                  <small class="d-block text-muted">{{ n.creada_en|timesince }} atr√°s</small>
                </span>
                {% endif %}

                {# Bot√≥n siempre visible por ahora #}
                <button class="btn btn-sm btn-outline-secondary js-notif-mark-one ms-2 flex-shrink-0"
                  data-id="{{ n.notificacion_id|default:n.id }}" type="button">‚úì</button>

                {% if not n.leida %}
                <span class="badge bg-primary rounded-pill ms-1 flex-shrink-0">nuevo</span>
                {% endif %}

                <button type="button" class="btn btn-sm btn-link text-muted js-notif-dismiss ms-1 flex-shrink-0"
                  title="Ocultar esta notificaci√≥n" aria-label="Ocultar" data-id="{{ n.notificacion_id|default:n.id }}">
                  &times;
                </button>

              </div>
            </li>
            {% endfor %}
            {% else %}
            <li><span class="dropdown-item text-muted">Sin notificaciones</span></li>
            {% endif %}
          </ul>
        </div>



        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" role="button"
            data-bs-toggle="dropdown" aria-expanded="false">
            <span>Hola, {{ user.nombre }}</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end shadow">
            <li><a class="dropdown-item" href="{% url 'perfil' %}">Mi perfil</a></li>
            <li>
              <hr class="dropdown-divider" />
            </li>
            <li>
              <form method="post" action="{% url 'account_logout' %}">
                {% csrf_token %}
                <button type="submit" class="dropdown-item logout-item">Cerrar sesi√≥n</button>
              </form>
            </li>
          </ul>
        </div>
        {% else %}
        <a href="{% url 'account_login' %}" class="btn btn-primary btn-login ms-3">
          Iniciar Sesi√≥n
        </a>
        {% endif %}


        <!-- Toggle buscador m√≥vil -->
        <button id="btnMobileSearch" class="btn btn-link p-0 ms-2 d-lg-none" type="button" data-bs-toggle="collapse"
          data-bs-target="#mobileSearch" aria-expanded="false" aria-controls="mobileSearch" aria-label="Buscar">
          <i class="bi bi-search" style="font-size:1.35rem;"></i>
        </button>

        <button id="btnMobileNav" class="btn btn-link p-0 ms-2 d-lg-none" type="button" data-bs-toggle="collapse"
          data-bs-target="#mobileNav" aria-expanded="false" aria-controls="mobileNav" aria-label="Men√∫">
          <i class="bi bi-list" style="font-size:1.6rem;"></i>
        </button>
      </div>
    </div>

    <!-- Agrupador de colapsables m√≥viles -->
    <div id="mobileCollapses" class="d-lg-none">
      <!-- Men√∫ m√≥vil colapsable -->
      <div id="mobileNav" class="collapse border-top bg-white" data-bs-parent="#mobileCollapses">
        <div class="container py-2">
          <nav aria-label="Navegaci√≥n principal m√≥vil">
            <ul class="nav flex-column mobile-nav">
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#hero">Inicio</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#clients">Categor√≠as</a></li>
              <li class="nav-item">
                {% if user.is_authenticated %}
                <a class="nav-link" href="{% url 'perfil' %}?tab=amigos">Amigos</a>
                {% else %}
                <a class="nav-link" href="{% url 'account_login' %}?next={% url 'perfil' %}%3Ftab%3Damigos">Amigos</a>
                {% endif %}
              </li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#portfolio">Regalos</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}feed">Feed</a></li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
    <!-- /OPCIONAL -->
  </header>

  {% block flash_messages %}
  {% if messages %}
  <div id="flash-messages" class="container my-2">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-2" role="alert" data-django-message>
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endblock %}

  <main class="main">
    {% block content %}{% endblock %}
  </main>

  <footer id="footer" class="footer">
    <div class="container footer-top">
      <div class="row gy-4">
        <!-- Columna 1 -->
        <div class="col-lg-3 col-md-6 footer-about">
          <a href="{% url 'home' %}" class="d-flex align-items-center">
            <span class="sitename">Gifter's</span>
          </a>
          <div class="footer-contact pt-3">
            <p>Viena 998</p>
            <p>New York, NY 535022</p>
            <p class="mt-3"><strong>Tel√©fono:</strong> <span>+1 234 567 8900</span></p>
            <p><strong>Email:</strong> <span>giftersg4@gmail.com</span></p>
          </div>
        </div>

        <!-- Columna 2 -->
        <div class="col-lg-3 col-md-3 footer-links">
          <h4>Enlaces √∫tiles</h4>
          <ul>
            <li><i class="bi bi-chevron-right"></i> <a href="{% url 'home' %}">Inicio</a></li>
          </ul>
        </div>

        <!-- Columna 3 -->
        <div class="col-lg-3 col-md-12">
          <h4>S√≠guenos</h4>
          <div class="social-links d-flex">
            <a href=""><i class="bi bi-twitter-x"></i></a>
            <a href=""><i class="bi bi-facebook"></i></a>
            <a href=""><i class="bi bi-instagram"></i></a>
            <a href=""><i class="bi bi-linkedin"></i></a>
          </div>
        </div>

        <!-- NUEVA COLUMNA DE CONTACTO -->
        <div class="col-lg-3 col-md-6 footer-contact text-center">
          <h4>¬øNecesitas ayuda?</h4>
          <p>Estamos aqu√≠ para ayudarte.</p>
          <a href="{% url 'ayuda' %}" class="gift mt-2 d-inline-block">¬°Cont√°ctanos!</a>
        </div>
      </div>
    </div>

    <div class="container text-center mt-4">
      <p class="mb-0">&copy; 2025 <strong>Gifter‚Äôs</strong>. Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- Scroll Top -->
  <a href="#" id="" class="scroll-top d-flex align-items-center justify-content-center">

  </a>

  <!-- Vendor JS -->
  <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'vendor/php-email-form/validate.js' %}"></script>
  <script src="{% static 'vendor/aos/aos.js' %}"></script>
  <script src="{% static 'vendor/glightbox/js/glightbox.min.js' %}"></script>
  <script src="{% static 'vendor/waypoints/noframework.waypoints.js' %}"></script>
  <script src="{% static 'vendor/purecounter/purecounter_vanilla.js' %}"></script>
  <script src="{% static 'vendor/swiper/swiper-bundle.min.js' %}"></script>
  <script src="{% static 'vendor/imagesloaded/imagesloaded.pkgd.min.js' %}"></script>
  <script src="{% static 'vendor/isotope-layout/isotope.pkgd.min.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Main JS -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        document.querySelectorAll('.alert').forEach(a => {
          const bsAlert = bootstrap.Alert.getOrCreateInstance(a);
          bsAlert.close();
        });
      }, 4000);
    });
  </script>
  <script src="{% static 'js/main.js' %}"></script>

  <script>
    // Control de colapsables m√≥viles
    document.addEventListener('DOMContentLoaded', function () {
      const msEl = document.getElementById('mobileSearch');
      const mnEl = document.getElementById('mobileNav');
      const bSearch = document.getElementById('btnMobileSearch');
      const bMenu = document.getElementById('btnMobileNav');

      if (!window.bootstrap || !msEl || !mnEl || !bSearch || !bMenu) return;

      const ms = new bootstrap.Collapse(msEl, { toggle: false });
      const mn = new bootstrap.Collapse(mnEl, { toggle: false });

      function stop(e) { e.preventDefault(); e.stopPropagation(); }

      bSearch.addEventListener('click', function (e) { stop(e); mn.hide(); ms.toggle(); });
      bMenu.addEventListener('click', function (e) { stop(e); ms.hide(); mn.toggle(); });

      msEl.addEventListener('show.bs.collapse', function () { mn.hide(); });
      mnEl.addEventListener('show.bs.collapse', function () { ms.hide(); });

      document.querySelectorAll('#mobileNav .nav-link').forEach(function (a) {
        a.addEventListener('click', function () { mn.hide(); });
      });
    });
  </script>

  {% if user.is_authenticated %}
  <!-- Floating launcher -->
  <!-- <style>

  </style>-->
  <button id="chatFab" class="chat-fab btn btn-primary" type="button">
    <i class="bi bi-chat-dots-fill"></i>
  </button>

  <!-- Drawer (interfaz cl√°sica simple) -->
  <div id="chatDrawer" class="chat-drawer phone-ui" aria-hidden="true">
    <div class="phone-header">
      <div class="brand">
        <img src="{% static 'img/Gifters/favicongift.png' %}" alt="Gifter‚Äôs" />
        <span>Gifter‚Äôs</span>
      </div>

      <!-- Acciones a la derecha -->
      <div class="d-flex align-items-center gap-2">
        <!-- Men√∫ kebab de grupo (solo autor) -->
        <div class="dropdown" id="groupKebab" style="display:none;">
          <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" data-bs-display="static"
            aria-expanded="false" title="Opciones del grupo">‚ãÆ</button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><button class="dropdown-item" data-action="add-members">Agregar miembros‚Ä¶</button></li>
            <li><button class="dropdown-item" data-action="remove-member">Quitar miembro‚Ä¶</button></li>
            <!-- üëá NUEVO bot√≥n -->
            <li><button class="dropdown-item" data-action="view-members">Ver miembros</button></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><button class="dropdown-item text-danger" data-action="delete-group">Eliminar grupo</button></li>
          </ul>
        </div>
        <!-- Men√∫ kebab de grupo (solo miembro NO autor) -->
        <div class="dropdown" id="memberKebab" style="display:none;">
          <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" data-bs-display="static"
            aria-expanded="false" title="Opciones del grupo">‚ãÆ</button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><button class="dropdown-item" data-action="view-members">Ver miembros</button></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><button class="dropdown-item text-danger" data-action="leave-group">Abandonar grupo</button></li>
          </ul>
        </div>

        <button id="chatClose" class="btn btn-sm btn-light">‚úï</button>
        <span id="eventActionsHook"></span>
      </div>
    </div>

    <div class="phone-tabs" role="tablist">
      <button class="tab-btn" data-tab="amigos"><i class="bi bi-people"></i> Amigos</button>
      <button class="tab-btn active" data-tab="chats">
        <i class="bi bi-chat-left-dots"></i> Chats
        <span class="dot hidden" id="tabDotChats"></span>
      </button>
      <button class="tab-btn" data-tab="grupos">
        <i class="bi bi-collection"></i> Grupos
        <span class="dot hidden" id="tabDotGrupos"></span>
      </button>
      <button class="tab-btn" data-tab="eventos">
        <i class="bi bi-calendar-event"></i> Eventos
      </button>
    </div>

    <div class="chat-head" hidden></div>




    <!-- OJO: todo dentro de .chat-body -->
    <div class="chat-body" style="display:flex; height:100%;">

      <!-- Columna izquierda (lista) con position:relative -->
      <div style="position:relative; width:340px; border-right:1px solid #eee; overflow:auto;">
        <div class="chat-list" id="chatList"></div>

        <!-- Lista de amigos superpuesta -->
        <div id="friendsList" class="chat-list"
          style="display:none; position:absolute; inset:0; overflow:auto; background:#fff;"></div>

        <!-- ‚úÖ Mueve groupsList aqu√≠ adentro para que ‚Äúinset:0‚Äù funcione -->
        <div id="groupsList" class="chat-list"
          style="display:none; position:absolute; inset:0; overflow:auto; background:#fff;"></div>

        <div id="eventsList" class="chat-list"
          style="display:none; position:absolute; inset:0; overflow:auto; background:#fff;"></div>
      </div>

      <style>
        .event-actions {
          position: sticky;
          top: 0;
          z-index: 11;
          display: none;
          /* se muestra solo en eventos */
          justify-content: center;
          align-items: center;
          padding: 8px 0;
          background: transparent;
        }

        .event-actions .btn-sortear {
          font-weight: 600;
        }
      </style>
      <div class="event-actions" id="eventActions"
        style="display:none; justify-content:center; align-items:center; padding:8px 0; background:transparent;">
        <button class="btn btn-warning btn-sortear" data-action="draw-event">Sortear</button>
      </div>

      <!-- Columna derecha (mensajes) -->
      <div class="chat-pane" style="flex:1; display:flex; flex-direction:column;">
        <div id="chatEmpty" class="p-3 text-muted">Selecciona un chat para empezar</div>
        <div id="chatMessages" class="chat-messages" hidden></div>
        <div id="typingIndicator" class="typing-indicator" hidden>
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          <em class="who"></em> est√° escribiendo‚Ä¶
        </div>
        <form id="chatForm" class="chat-input" hidden>
          <input id="chatImage" type="file" accept="image/*" hidden>
          <button type="button" id="btnAttach" class="btn btn-outline-secondary" title="Adjuntar imagen"
            style="border-radius:12px;">
            <i class="bi bi-image"></i>
          </button>
          {% csrf_token %}
          <textarea id="chatText" rows="1" placeholder="Escribe un mensaje‚Ä¶"></textarea>
          <button type="submit">Enviar</button>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
  <script>
    window.URLS = {
      amigos: "{% url 'amistad_amigos' %}",
      conversaciones: "{% url 'conversaciones_list' %}",
      mensajesBase: "{% url 'mensajes_list_create' 0 %}", // luego se reemplaza el /0/
      convConUsuarioId: "{% url 'chat_con_usuario_id' '__USER__' %}",
      typing: "{% url 'chat_typing' 0 %}",  // ‚Üê nuevo (placeholder /0/) // placeholder literal
      typingSummary: "{% url 'chat_typing_summary' %}",
      gruposCreate: "{% url 'grupos_create' %}",
      conversacionDetalleBase: "{% url 'conversacion_detalle' 0 %}",
      grupoMiembros: "{% url 'grupos_members' 0 %}",
      grupoAgregarMiembros: "{% url 'grupos_add_members' 0 %}",
      grupoQuitarMiembro: "{% url 'grupos_remove_member' 0 %}",
      grupoEliminar: "{% url 'grupos_delete' 0 %}",
      grupoSalir: "{% url 'grupos_leave' 0 %}",
      eventosListCreate: "{% url 'events_list_create' 0 %}",     // .replace('/0/', `/${convId}/`)
      eventoDetail: "{% url 'event_detail' 0 %}",
      eventoDraw: '/api/events/0/draw/',
      eventoLock: "{% url 'event_lock' 0 %}",
      eventoMine: "{% url 'event_my_assignment' 0 %}",
      /* NUEVO: crea evento con su propio chat */
      eventCreateWithChat: "{% url 'event_create_with_chat' %}",
    };
  </script>
  {% if user.is_authenticated %}
  <script>
    (function () {

      window.unreadLightPoll ??= null;
      const MEDIA_PREFIX = ("{% get_media_prefix %}" || "/media/");
      const fab = document.getElementById('chatFab');
      const drawer = document.getElementById('chatDrawer');
      const closeBtn = document.getElementById('chatClose');
      const listEl = document.getElementById('chatList');
      const msgsEl = document.getElementById('chatMessages');
      const emptyEl = document.getElementById('chatEmpty');
      const formEl = document.getElementById('chatForm');
      const textEl = document.getElementById('chatText');
      const fileEl = document.getElementById('chatImage');
      const attachBtn = document.getElementById('btnAttach');

      // Usuario actual
      const ME = {
        id: Number('{{ user.id|default:"0"|escapejs }}'),
        username: ("{{ user.nombre_usuario|default:''|escapejs }}").trim()
      };
      // Cache liviana del preview por conversaci√≥n
      const previewCache = new Map();

      function setPreview(convId, text, timeISO, lastId = null, opts = {}) {
        const { noReorderOnSeed = false } = opts;

        const key = String(convId);
        const next = { text: text || '', time: timeISO || null, id: lastId ?? null };
        const prev = previewCache.get(key);

        // ‚ö†Ô∏è Semilla inicial (no hab√≠a cache)
        if (!prev) {
          previewCache.set(key, next);
          // Si venimos de un click (seed), NO reordenar
          if (noReorderOnSeed) return;
          // Comportamiento anterior: en otros casos s√≠ puede reordenar
          patchAnyRow(convId);
          return;
        }

        // --- Tu misma l√≥gica de cambio (prioriza id) ---
        let changed;
        if ((prev && prev.id != null) || (next.id != null)) {
          changed = String(prev?.id ?? '') !== String(next.id ?? '');
        } else {
          changed = (
            prev.text !== next.text ||
            String(prev.time || '') !== String(next.time || '')
          );
        }

        previewCache.set(key, next);

        // Solo reordenar si cambi√≥
        if (changed) patchAnyRow(convId);
      }
      function getPreview(convId) {
        return previewCache.get(String(convId)) || { text: '', time: null };
      }
      function slicePreview(t) { return (t || '').toString().slice(0, 72); }
      // === Typing: estado previo por conversaci√≥n (para detectar flanco "dej√≥ de escribir")
      const wasTypingMap = new Map(); // convId -> boolean

      window.CHAT_INDEX = window.CHAT_INDEX || { direct: new Set(), groups: new Set() };

      function patchAnyRow(convId) {
        const prev = getPreview(convId);

        // contenedores ‚Äúexternos‚Äù
        const containers = [
          document.getElementById('chatList'),
          document.getElementById('groupsList')
        ];

        containers.forEach(container => {
          if (!container) return;

          // En grupos, las filas viven dentro del ‚Äúinner‚Äù
          const list = (container.id === 'groupsList')
            ? (container.querySelector('[data-role="groups-inner"], .px-2') || container)
            : container;

          // OJO: buscamos en los hijos reales (las filas)
          let row = Array.from(list.children).find(
            el => String(el?.dataset?.convId) === String(convId)
          );
          if (!row) return; // No inventamos filas: si no existe, salimos.

          // parcheo de texto/hora
          const l2 = row.querySelector('.line2'); if (l2) l2.textContent = prev.text || '';
          const t = row.querySelector('.chat-time'); if (t && prev.time) t.textContent = formatTime(prev.time);

          // mover al tope si no lo est√°
          if (list.firstElementChild !== row) list.prepend(row);
        });
      }

      // Pide s√≥lo el √∫ltimo mensaje del hilo, hidrata cache y parcha la fila
      async function hydratePreview(convId) {
        const url = "{% url 'mensajes_list_create' 0 %}".replace('/0/', `/${convId}/`);
        const r = await fetch(url + "?limit=1", { credentials: 'same-origin' });
        if (!r.ok) return;
        const j = await r.json();
        const arr = Array.isArray(j) ? j : (j.results || []);
        if (!arr.length) return;
        const m = arr[0];
        const isImg = (m.tipo === 'imagen') || !!m.archivo_url || !!(m.metadatos && m.metadatos.archivo_url);
        const prevText = isImg ? 'üì∑ Imagen' : slicePreview(m.contenido);
        setPreview(convId, prevText, m.creado_en, m.id || m.pk || null);
        patchAnyRow(convId);
      }

      window.currentConvId = null;
      window.currentConvIsGroup = false;
      let pollTimer = null;
      let currentConvTitle = null;

      async function fetchConvMeta(convId) {
        const url = window.URLS.conversacionDetalleBase.replace('/0/', `/${convId}/`);
        try {
          const r = await fetch(url, { credentials: 'same-origin' });
          if (!r.ok) return { is_group: false };
          return await r.json();
        } catch { return { is_group: false }; }
      }


      // FIX: esta funci√≥n estaba rota en tu c√≥digo (comillas/plantillas)
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      }
      const CSRFTOKEN = getCookie('csrftoken');
      window.CSRF_TOKEN = CSRFTOKEN;

      function openDrawer() {
        drawer.classList.add('open');
        drawer.setAttribute('aria-hidden', 'false');
        fab.style.display = 'none';
        Promise.resolve(loadConversations()).finally(() => {
          try { refreshGlobalUnreadDot(); } catch { }
        });

        if (typeof loadGroups === 'function') {
          // solo la primera vez
          window.__groupsPreloaded ||= false;
          if (!window.__groupsPreloaded) {
            loadGroups().finally(() => { window.__groupsPreloaded = true; });
          }
        }
        if (window.unreadLightPoll) { clearInterval(window.unreadLightPoll); window.unreadLightPoll = null; }
      }
      function closeDrawer() {
        drawer.classList.remove('open');
        drawer.setAttribute('aria-hidden', 'true');
        fab.style.display = '';
        stopPolling();
        if (!unreadLightPoll) {
          unreadLightPoll = setInterval(() => {
            try { refreshGlobalUnreadDot(); } catch { }
          }, 30000); // 30s
        }

      }
      const __openDrawer = openDrawer;
      openDrawer = function () {
        __openDrawer();
        startTypingSummaryPoll();
        startGroupPreviewPoll();   // üëà NUEVO (s√≥lo grupos)
      };

      const __closeDrawer = closeDrawer;
      closeDrawer = function () {
        __closeDrawer();
        stopTypingSummaryPoll();
        stopGroupPreviewPoll();    // üëà NUEVO
      };
      fab?.addEventListener('click', openDrawer);
      closeBtn?.addEventListener('click', closeDrawer);
      async function fetchTypingSummary() {
        try {
          const r = await fetch(window.URLS.typingSummary, { credentials: 'same-origin' });
          if (!r.ok) return {};
          const j = await r.json();
          return (j && j.typing) || {};
        } catch {
          return {};
        }
      }

      function prettyTyping(users) {
        if (!users || !users.length) return "";
        return (users.length === 1) ? "1 escribiendo‚Ä¶" : "Varios escribiendo‚Ä¶";
      }

      async function loadConversations() {
        listEl.innerHTML = '<div class="p-3 text-muted">Cargando‚Ä¶</div>';
        const apiURL = window.URLS.conversaciones;

        try {
          // Pedimos en paralelo: conversaciones + resumen de "escribiendo"
          const [res, typingMap] = await Promise.all([
            fetch(apiURL, {
              credentials: 'same-origin',
              headers: { 'Accept': 'application/json' }
            }),
            fetchTypingSummary()
          ]);

          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          // refresca √≠ndice de directos con data real
          (function updateDirectIndex(list) {
            try {
              const direct = (list || []).filter(c => !(c.is_group || String(c.tipo || '').toLowerCase() === 'grupo'));
              window.CHAT_INDEX.direct = new Set(direct.map(c => String(c.conversacion_id)));
            } catch { }
          })(data);

          // NEW: llenar/actualizar cache con el √∫ltimo mensaje de cada conversaci√≥n
          (data || []).forEach(c => {
            const last = c.ultimo_mensaje || {};
            const prevText = (last.tipo === 'imagen') ? 'üì∑ Imagen' : slicePreview(last.contenido);
            setPreview(c.conversacion_id, prevText, last.creado_en, last.id || last.pk || null);
          });

          renderConversationList(data, typingMap);  // ‚Üê pasamos typingMap al renderer
          try { refreshGlobalUnreadDot(); } catch { }
        } catch (e) {
          listEl.innerHTML = '<div class="p-3 text-danger">No se pudieron cargar tus chats.</div>';
          console.error('[chats] Error cargando conversaciones:', e);
          try { refreshGlobalUnreadDot(); } catch { }
        }
      }
      // Rellena/actualiza cache con el √∫ltimo mensaje de cada conversaci√≥n


      const AVATAR_FALLBACK = "{% static 'img/Gifters/favicongift.png' %}";

      function toAbsoluteMedia(u) {
        if (!u || typeof u !== 'string') return AVATAR_FALLBACK;
        try {
          u = u.trim();
          if (u === "[object Object]") return AVATAR_FALLBACK;
          if (/^https?:\/\//i.test(u) || u.startsWith('//') || u.startsWith('/')) {
            if (location.protocol === 'https:' && u.startsWith('http://')) return 'https://' + u.slice(7);
            return u;
          }
          if (/^(media|uploads|files)\//i.test(u)) return '/' + u;
          return (MEDIA_PREFIX.replace(/\/+$/, '') + '/' + u.replace(/^\/+/, '')).replace(/\/{2,}/g, '/');
        } catch {
          return AVATAR_FALLBACK;
        }
      }

      function partnerFrom(conv) {
        const ps = Array.isArray(conv.participantes) ? conv.participantes : [];
        let other = ps.find(p => Number(p.id) && Number(p.id) !== ME.id);
        if (!other && ME.username) {
          other = ps.find(p => (p.username || p.nombre_usuario) && (p.username || p.nombre_usuario) !== ME.username);
        }
        if (!other) other = ps[0] || {};

        const username = other.username || other.nombre_usuario || '';
        const fullName =
          other.nombre_completo ||
          [other.nombre, other.apellido].filter(Boolean).join(' ') ||
          other.display_name ||
          username || 'Chat';

        const rawAvatar =
          other.avatar_url || other.avatar || other.foto || other.foto_url || other.image || other.image_url ||
          other.profile_image || other.profile_image_url || other.photo || other.photo_url ||
          other.profile_picture || other.profile_picture_url ||
          (other.perfil && (
            other.perfil.avatar_url || other.perfil.avatar || other.perfil.foto || other.perfil.foto_url ||
            other.perfil.image || other.perfil.image_url || other.perfil.profile_image ||
            other.perfil.profile_image_url || other.perfil.profile_picture || other.perfil.profile_picture_url
          )) || null;

        const avatar = toAbsoluteMedia(rawAvatar);
        return { name: fullName, username, avatar };
      }

      function renderConversationList(items, typingMap = {}) {
        if (!Array.isArray(items) || !items.length) {
          listEl.innerHTML = '<div class="p-3 text-muted">A√∫n no tienes conversaciones.</div>';
          return;
        }

        // üö´ fuera los grupos en la pesta√±a "Chats"
        const chatsOnly = items.filter(c => {
          const t = String(c.tipo || '').toLowerCase();
          const isGroup = c.is_group || t === 'grupo';
          const isEvent = t === 'evento';
          return !(isGroup || isEvent);
        });

        const filtered = chatsOnly.filter(conv => {
          if (Number(conv.conversacion_id) === Number(window.currentConvId)) return true;
          return !!conv.ultimo_mensaje;
        });

        if (!filtered.length) {
          listEl.innerHTML = '<div class="p-3 text-muted">A√∫n no tienes conversaciones con mensajes.</div>';
          return;
        }

        listEl.innerHTML = '';

        filtered.forEach(conv => {
          const p = partnerFrom(conv);
          const last = conv.ultimo_mensaje || {};

          // ‚úÖ Detecta imagen y guarda en cache el texto correcto
          const isImg = (last.tipo === 'imagen') || !!last.archivo_url || !!(last.metadatos && last.metadatos.archivo_url);
          const prevText = isImg ? 'üì∑ Imagen' : slicePreview(last.contenido);
          setPreview(conv.conversacion_id, prevText, last.creado_en, last.id || last.pk || null);

          const row = document.createElement('div');
          row.className = 'chat-list-item' + (conv.conversacion_id === window.currentConvId ? ' active' : '');
          row.dataset.convId = conv.conversacion_id;      // data-conv-id
          row.setAttribute('data-conv', conv.conversacion_id); // data-conv 

          // ‚úÖ Si hay typing mu√©stralo; si no, usa SIEMPRE el cache (no last.contenido)
          const tUsers = typingMap[String(conv.conversacion_id)] || [];
          const line2 = tUsers.length ? prettyTyping(tUsers) : getPreview(conv.conversacion_id).text;

          row.innerHTML = `
              <img class="chat-avatar" src="${p.avatar}" alt=""
                  onerror="this.onerror=null;this.src='{{ STATIC_URL }}img/Gifters/favicongift.png'">
              <div class="chat-names">
                <div class="line1">
                  ${p.name}
                  <span class="dot hidden" data-dot></span>
                </div>
                <div class="line2">${line2}</div>
              </div>
              <div class="chat-time">${last.creado_en ? formatTime(last.creado_en) : ''}</div>
            `;
          row.addEventListener('click', () => window.openConversation && window.openConversation(conv.conversacion_id));
          listEl.appendChild(row);
        });
      }
      function formatTime(ts) {
        try { return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
        catch { return ''; }
      }
      let typingSummaryTimer = null;

      function startTypingSummaryPoll() {
        stopTypingSummaryPoll();
        typingSummaryTimer = setInterval(async () => {
          try {
            const typingMap = await fetchTypingSummary();

            Array.from(listEl.children).forEach(row => {
              const convId = row.dataset.convId;
              const tUsers = typingMap[String(convId)] || [];
              const line2El = row.querySelector('.line2');
              if (!line2El) return;

              const isTyping = tUsers.length > 0;
              const wasTyping = wasTypingMap.get(convId) === true;
              wasTypingMap.set(convId, isTyping);

              if (isTyping) {
                // Mostrar "est√° escribiendo‚Ä¶"
                line2El.textContent = prettyTyping(tUsers);
                line2El.classList.add('text-primary');
              } else {
                if (wasTyping) {
                  // ‚ö° Flanco: antes estaba escribiendo y ahora no ‚Üí probablemente envi√≥ mensaje
                  hydratePreview(convId)
                    .then(() => { try { refreshGlobalUnreadDot(); } catch { } })
                    .catch(() => { });
                } else {
                  // Restaurar desde cache sin pegar a red
                  const prev = getPreview(convId);
                  line2El.textContent = prev.text || '';
                  line2El.classList.remove('text-primary');
                }
              }
            });
          } catch { /* noop */ }
        }, 1500);
      }

      function stopTypingSummaryPoll() {
        if (typingSummaryTimer) { clearInterval(typingSummaryTimer); typingSummaryTimer = null; }
      }
      // ====== Poll s√≥lo de GRUPOS: trae /conversaciones y parchea filas de #groupsList ======
      let groupsPreviewTimer = null;

      async function pollGroupPreviews() {
        try {
          const res = await fetch(window.URLS.conversaciones, {
            credentials: 'same-origin',
            headers: { 'Accept': 'application/json' }
          });
          if (!res.ok) return;

          const data = await res.json();
          const onlyGroups = (data || [])
            .filter(c => c.is_group || String(c.tipo || '').toLowerCase() === 'grupo')
          window.CHAT_INDEX.groups = new Set(onlyGroups.map(c => String(c.conversacion_id)));
          onlyGroups.forEach(c => {
            const last = c.ultimo_mensaje || {};
            const isImg = (last.tipo === 'imagen') || !!last.archivo_url || !!(last.metadatos && last.metadatos.archivo_url);
            const prevText = isImg ? 'üì∑ Imagen' : slicePreview(last.contenido);
            // üëâ esto actualiza cache + texto/tiempo y mueve la fila al tope en #groupsList si ya existe
            setPreview(c.conversacion_id, prevText, last.creado_en, last.id || last.pk || null);
          });
        } catch { /* noop */ }
      }

      function startGroupPreviewPoll() {
        stopGroupPreviewPoll();
        groupsPreviewTimer = setInterval(async () => {
          await pollGroupPreviews();
          try { refreshGlobalUnreadDot(); } catch { }
        }, 2500);
      }
      function stopGroupPreviewPoll() {
        if (groupsPreviewTimer) { clearInterval(groupsPreviewTimer); groupsPreviewTimer = null; }
      }


      async function loadMessagesOnce() {
        if (!window.currentConvId) return;

        const url = "{% url 'mensajes_list_create' 0 %}".replace('/0/', `/${window.currentConvId}/`);

        // Declarar fuera del try para poder usarlo luego sin romper
        let arr = [];
        try {
          const nearBottom = (() => {
            const delta = msgsEl.scrollHeight - msgsEl.scrollTop - msgsEl.clientHeight;
            return delta < 120;
          })();

          const prevLastId = msgsEl.dataset.lastMsgId || '';

          const res = await fetch(url, { credentials: 'same-origin' });
          if (!res.ok) throw new Error('Error cargando mensajes');

          const data = await res.json();
          arr = Array.isArray(data) ? data : (data.results || []);

          // Render
          renderMessages(arr);

          // El m√°s nuevo
          const newest = arr[0] || {};
          const newLastId = String(newest.id || newest.pk || newest.uuid || '');
          msgsEl.dataset.lastMsgId = newLastId;

          // Actualiza preview/horario en ambas listas (chats y grupos)
          if (newest) {
            const prevText = (newest.tipo === 'imagen') ? 'üì∑ Imagen' : slicePreview(newest.contenido);
            setPreview(
              window.currentConvId,
              prevText,
              newest.creado_en,
              newest.id || newest.pk || null,
              { noReorderOnSeed: true }   // üëà evita subir solo por click
            );
          }

          // Auto-scroll si hay mensajes nuevos o ya estabas abajo
          const gotNew = newLastId && newLastId !== prevLastId;
          if (gotNew || nearBottom) {
            requestAnimationFrame(() => { msgsEl.scrollTop = msgsEl.scrollHeight; });
          }
        } catch (e) {
          msgsEl.innerHTML = '<div class="p-2 text-danger">No se pudieron cargar los mensajes.</div>';
          console.error(e);
        }
      }

      function renderMessages(msgs) {
        msgsEl.innerHTML = '';
        const meId = Number('{{ user.id|default:"0"|escapejs }}');

        // Orden cronol√≥gico en pantalla
        const ordered = msgs.slice().reverse();

        let prevAuthorId = null;
        let prevWhenMs = 0;
        let prevDayKey = null;

        const GAP_MS = 5 * 60 * 1000; // 5 minutos

        function parseMs(iso) {
          try { return new Date(iso).getTime(); } catch { return 0; }
        }
        function dayKeyFromMs(ms) {
          const d = new Date(ms);
          return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
        }
        function formatDayLabel(ms) {
          const d = new Date(ms);
          const today = new Date(); today.setHours(0, 0, 0, 0);
          const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
          const diff = Math.round((dd - today) / 86400000);
          if (diff === 0) return 'Hoy';
          if (diff === -1) return 'Ayer';
          return new Intl.DateTimeFormat('es', { day: '2-digit', month: 'short', year: 'numeric' }).format(d);
        }
        function isBlockStart(authorId, whenMs) {
          if (authorId !== prevAuthorId) return true;
          if (!prevWhenMs) return true;
          return (whenMs - prevWhenMs) > GAP_MS;
        }

        ordered.forEach(m => {
          const authorId = Number(m.remitente && m.remitente.id);
          const isMe = authorId === meId;
          const whenMs = parseMs(m.creado_en);
          const showAvatar = window.currentConvIsGroup ? true : isBlockStart(authorId, whenMs);

          // ‚Äî‚Äî Separador de d√≠a si cambi√≥
          const dayKey = dayKeyFromMs(whenMs || Date.now());
          if (dayKey !== prevDayKey) {
            const sep = document.createElement('div');
            sep.className = 'day-sep';
            sep.textContent = formatDayLabel(whenMs || Date.now());
            msgsEl.appendChild(sep);
            prevDayKey = dayKey;
          }

          const row = document.createElement('div');
          row.className = 'msg ' + (isMe ? 'me' : 'other') + (showAvatar ? '' : ' compact');

          const avatarUrl =
            toAbsoluteMedia((m.remitente && (m.remitente.avatar || m.remitente.avatar_url)) || null) ||
            "{% static 'img/Gifters/favicongift.png' %}";

          const when = m.creado_en ? new Date(m.creado_en).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

          const isImage = (m.tipo === 'imagen') || !!m.archivo_url || !!(m.metadatos && m.metadatos.archivo_url);
          const safeText = String(m.contenido || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const bodyHTML = isImage
            ? (() => {
              const imgUrl = toAbsoluteMedia(m.archivo_url || (m.metadatos && m.metadatos.archivo_url));
              return `<a href="${imgUrl}" target="_blank" rel="noopener">
                      <img class="msg-image" src="${imgUrl}" alt="imagen">
                    </a>${safeText ? `<div style="margin-top:6px;">${safeText}</div>` : ''}`;
            })()
            : safeText;

          const senderName =
            (m.remitente && (m.remitente.nombre_completo ||
              [m.remitente.nombre, m.remitente.apellido].filter(Boolean).join(' ') ||
              m.remitente.display_name ||
              m.remitente.username ||
              m.remitente.nombre_usuario)) || 'Usuario';

          row.innerHTML = `
            ${showAvatar ? `
              <img class="msg-avatar" src="${avatarUrl}" alt=""
                  onerror="this.onerror=null;this.src='${AVATAR_FALLBACK}'">` : ''
            }
            <div class="bubble">
              ${window.currentConvIsGroup ? `<div style="font-weight:700; font-size:.9rem; margin-bottom:4px;">${senderName}</div>` : ''}
              <div class="body">${bodyHTML}</div>
              <div class="meta">${when}</div>
            </div>
          `;

          msgsEl.appendChild(row);

          // actualizar punteros para el siguiente mensaje
          prevAuthorId = authorId;
          prevWhenMs = whenMs;
        });
      }

      function scrollToBottom() { msgsEl.scrollTop = msgsEl.scrollHeight; }

      formEl.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const text = (textEl.value || '').trim();
        if (!text || !window.currentConvId) return;

        const url = "{% url 'mensajes_list_create' 0 %}".replace('/0/', `/${window.currentConvId}/`);
        try {
          const res = await fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFTOKEN },
            body: JSON.stringify({ contenido: text, tipo: 'texto' })
          });
          if (!res.ok) throw new Error('No se pudo enviar el mensaje');

          textEl.value = '';
          await loadMessagesOnce();
          requestAnimationFrame(() => { msgsEl.scrollTop = msgsEl.scrollHeight; });

          // ‚úÖ esto actualiza preview + reordena en ambas listas SIN repintar todo
          setPreview(window.currentConvId, slicePreview(text), new Date().toISOString());

          // ‚ùå NO llames loadConversations() ac√°
        } catch (e) {
          console.error(e);
          alert('No se pudo enviar el mensaje.');
        }
      });

      textEl.addEventListener('keydown', function (e) {
        if (e.isComposing) return;
        const isEnter = e.key === 'Enter';
        const onlyEnter = isEnter && !e.shiftKey && !e.ctrlKey && !e.altKey && !e.metaKey;
        if (onlyEnter) {
          e.preventDefault();
          const txt = (textEl.value || '').trim();
          if (!txt) return;
          if (formEl.requestSubmit) formEl.requestSubmit();
          else formEl.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
        }
      });
      textEl.setAttribute('title', 'Enter: enviar ‚Ä¢ Shift+Enter: salto de l√≠nea');
      attachBtn?.addEventListener('click', () => fileEl?.click());

      fileEl?.addEventListener('change', async () => {
        if (!fileEl.files || !fileEl.files.length || !window.currentConvId) return;
        const file = fileEl.files[0];
        if (!/^image\//i.test(file.type)) { alert('Solo im√°genes'); fileEl.value = ''; return; }
        if (file.size > 8 * 1024 * 1024) { alert('Imagen demasiado grande (m√°x 8MB)'); fileEl.value = ''; return; }

        try {
          const url = "{% url 'mensajes_list_create' 0 %}".replace('/0/', `/${window.currentConvId}/`);
          const fd = new FormData();
          fd.append('tipo', 'imagen');
          fd.append('archivo', file);

          const res = await fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'X-CSRFToken': CSRFTOKEN },
            body: fd
          });
          if (!res.ok) throw new Error('Upload failed');

          await loadMessagesOnce();
          scrollToBottom();

          // üëâ Esto actualiza texto/tiempo y adem√°s mueve la fila al tope en ambas listas
          setPreview(window.currentConvId, 'üì∑ Imagen', new Date().toISOString());
          patchAnyRow(window.currentConvId);
        } catch (e) {
          console.error(e);
          alert('No se pudo enviar la imagen.');
        } finally {
          fileEl.value = '';
        }
      });

      function startPolling() { stopPolling(); pollTimer = setInterval(loadMessagesOnce, 3000); }
      function stopPolling() { if (pollTimer) { clearInterval(pollTimer); pollTimer = null; } }

      window.openChatWith = async function (username) {
        if (!username) return;

        // abre el caj√≥n
        if (typeof openDrawer === 'function') openDrawer();
        else document.getElementById('chatFab')?.click();

        // 1) buscar una conversaci√≥n 1:1 existente (no grupos)
        try {
          const res = await fetch(window.URLS.conversaciones, { credentials: 'same-origin' });
          const data = await res.json();

          const conv = (data || []).find(c => {
            const isGroup = c.is_group || String(c.tipo || '').toLowerCase() === 'grupo';
            if (isGroup) return false;                            // ‚Üê fuera grupos
            const ps = Array.isArray(c.participantes) ? c.participantes : [];
            const looksOneToOne = ps.length === 2;               // ‚Üê estrictamente 1:1
            const matchesUser = ps.some(p => (p.username || p.nombre_usuario) === username);
            return looksOneToOne && matchesUser;
          });

          if (conv) {
            await openConversation(conv.conversacion_id);        // abre el 1:1
            return;
          }
        } catch (e) {
          console.warn('No se pudo listar conversaciones', e);
        }

        // 2) si no existe, pedir/crear la 1:1 con ese usuario
        try {
          const url = window.URLS.convConUsuarioId.replace('__USER__', encodeURIComponent(username));
          const r = await fetch(url, { credentials: 'same-origin' });
          if (!r.ok) throw new Error('HTTP ' + r.status);
          const j = await r.json();
          if (j && j.conversacion_id) {
            await openConversation(j.conversacion_id);
            if (typeof window.loadConversations === 'function') window.loadConversations();
            return;
          }
        } catch (e) {
          console.error('No se pudo obtener/crear conversacion_id', e);
        }

        alert('No se pudo abrir el chat con ' + username);
      };

      window.addEventListener('beforeunload', stopPolling);

      let typingPingTimer = null;     // throttle para enviar pings
      let typingStopTimer = null;     // timer para ‚Äúdej√≥ de escribir‚Äù
      let typingPollTimer = null;     // polling para ver si el otro escribe

      const typingEl = document.getElementById('typingIndicator');
      const typingWhoEl = typingEl?.querySelector('.who');

      function typingUrl() {
        return window.URLS.typing.replace('/0/', `/${window.currentConvId}/`);
      }

      async function sendTyping(isTyping) {
        if (!window.currentConvId) return;
        try {
          await fetch(typingUrl(), {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFTOKEN },
            body: JSON.stringify({ typing: !!isTyping })
          });
        } catch (e) { /* silencioso */ }
      }

      function scheduleTypingPing() {
        // limita a 1 ping cada ~2s
        if (typingPingTimer) return;
        sendTyping(true);
        typingPingTimer = setTimeout(() => { typingPingTimer = null; }, 2000);

        // si no hay nuevos inputs por 2.5s, marca stop
        clearTimeout(typingStopTimer);
        typingStopTimer = setTimeout(() => sendTyping(false), 2500);
      }

      async function pollTyping() {
        if (!window.currentConvId) return;
        try {
          const r = await fetch(typingUrl(), { credentials: 'same-origin' });
          if (!r.ok) return;
          const j = await r.json();
          const typing = (j && j.typing) || [];
          renderTyping(typing);
        } catch (e) { /* noop */ }
      }

      function renderTyping(list) {
        if (!typingEl) return;
        if (!list.length) {
          typingEl.hidden = true;
          return;
        }
        // si hay uno, mostramos nombre; si >1, ‚ÄúVarios‚Äù
        const first = list[0];
        const nombre = (first.nombre || '').trim() || (first.username || '').trim() || 'Alguien';
        typingWhoEl.textContent = (list.length === 1) ? nombre : 'Varios';
        typingEl.hidden = false;
      }

      // engancha eventos del textarea
      if (textEl) {
        textEl.addEventListener('input', scheduleTypingPing);
        textEl.addEventListener('blur', () => sendTyping(false));
      }

      // integra con tu ciclo de polling existente
      const _startPollingOriginal = startPolling;
      startPolling = function () {
        _startPollingOriginal();
        // adem√°s del polling de mensajes, hacemos uno para typing algo m√°s frecuente
        clearInterval(typingPollTimer);
        typingPollTimer = setInterval(pollTyping, 1500);
      };

      const _stopPollingOriginal = stopPolling;
      stopPolling = function () {
        _stopPollingOriginal();
        clearInterval(typingPollTimer); typingPollTimer = null;
        clearTimeout(typingPingTimer); typingPingTimer = null;
        clearTimeout(typingStopTimer); typingStopTimer = null;
        sendTyping(false);
        if (typingEl) typingEl.hidden = true;
      };

      Object.assign(window, {
        loadMessagesOnce,
        renderMessages,
        startPolling,
        stopPolling,
        loadConversations,
        pollTyping,
        hydratePreview,
      });
    })();
  </script>
  <script>
    (function () {
      const drawer = document.getElementById('chatDrawer');
      const groupsListEl = drawer.querySelector('#chat-groups-list');   // UL/Div de la pesta√±a "Grupos"
      const chatsListEl = drawer.querySelector('#chat-chats-list');    // UL/Div de la pesta√±a "Chats"
      const msgsEl = drawer.querySelector('#chat-messages');      // panel derecho mensajes
      const emptyEl = drawer.querySelector('#chat-empty');         // ‚ÄúSelecciona un chat‚Ä¶‚Äù
      const formEl = drawer.querySelector('#chat-form');          // form enviar mensaje
      const headerTitleEl = drawer.querySelector('#chat-header-title');  // t√≠tulo/Nombre del chat/grupo
      const inputMsgEl = drawer.querySelector('#chat-input');         // textarea/input mensaje

      // estado global
      window.currentConvId = null;

      /* === 1) delegaci√≥n de eventos (robusto para contenido din√°mico) === */
      drawer.addEventListener('click', (ev) => {
        const row = ev.target.closest('.chat-list-item');
        if (!row) return;

        const id = Number(row.dataset.convId || row.dataset.cid);
        if (!id) return;

        ev.preventDefault();
        openConversation(id);
      });

      document.addEventListener('click', (ev) => {
        const { drawer } = getChatRefs();
        if (!drawer) return;
        if (!drawer.contains(ev.target)) return;

        const row = ev.target.closest('.chat-list-item');
        if (!row) return;

        const id = Number(row.dataset.convId || row.dataset.cid);
        if (!id) return;

        ev.preventDefault();
        openConversation(id);
      });
      /* === 2) marcar activo en ambas listas === */
      function markActive(convId) {
        const { drawer } = getChatRefs();
        if (!drawer) return;
        const rows = drawer.querySelectorAll('.chat-list-item');
        rows.forEach(li => {
          const id = Number(li.dataset.convId || li.dataset.cid);
          li.classList.toggle('active', id === Number(convId));
        });
      }

      /* === 3) abrir conversaci√≥n (meta + mensajes) === */
      window.currentConvId = null;

      async function openConversation(convId) {


        const { msgsEl, emptyEl, formEl, headerTitleEl, inputMsgEl } = getChatRefs();
        if (!msgsEl || !emptyEl || !formEl) {
          console.error('[openConversation] No est√°n los contenedores necesarios (msgsEl/emptyEl/formEl). Revisa los IDs/clases del drawer.');
          return;
        }

        try {
          if (!convId) return;
          if (window.currentConvId === convId) { inputMsgEl?.focus(); return; }

          window.currentConvId = convId;

          // === NUEVO: marcar como le√≠do de inmediato al entrar ===
          if (window.Chat?.markConversationAsRead) {
            window.Chat.markConversationAsRead(convId);
          }
          markActive(convId);

          // Estado UI inmediato (asegura que existen antes de setear)
          emptyEl.hidden = true;
          msgsEl.hidden = false;
          formEl.hidden = false;
          msgsEl.innerHTML = '<div class="p-2 text-muted">Cargando mensajes‚Ä¶</div>';
          if (headerTitleEl) headerTitleEl.textContent = 'Cargando‚Ä¶';

          // 1) META
          const metaUrl = window.URLS.conversacionDetalleBase.replace('/0/', `/${convId}/`);
          const rMeta = await fetch(metaUrl, { credentials: 'same-origin' });
          if (rMeta.status === 403) { msgsEl.innerHTML = '<div class="p-2 text-danger">No perteneces a este grupo.</div>'; return; }
          if (!rMeta.ok) { msgsEl.innerHTML = '<div class="p-2 text-danger">No fue posible abrir la conversaci√≥n.</div>'; return; }
          const meta = await rMeta.json();
          const isGroup = !!meta?.is_group;
          window.currentConvIsGroup = isGroup;      // ‚Üê sincroniza 1:1 vs grupo (restaura tu estilo)
          if (typeof startPolling === 'function') startPolling();  // ‚Üê empieza el polling de mensajes
          if (typeof pollTyping === 'function') pollTyping();      // ‚Üê primer fetch de ‚Äúescribiendo‚Ä¶‚Äù
          const titulo = meta?.titulo || 'Chat';
          if (headerTitleEl) {
            // En pesta√±a ‚Äúgrupos‚Äù mantenemos el t√≠tulo fijo; si no, mostramos el nombre
            headerTitleEl.textContent = (typeof currentTab !== 'undefined' && currentTab === 'grupos')
              ? 'Grupos'
              : titulo;
          }
          const esEvento = String(meta?.tipo || '').toLowerCase() === 'evento';

          // zona de acciones a la derecha de la barra (ya existe en tu HTML)
          const actionsRight = document.querySelector('.phone-header .d-flex.align-items-center.gap-2');

          // limpia bot√≥n previo si hubiera
          let oldBtn = document.getElementById('btnEventDraw');
          if (oldBtn) oldBtn.remove();

          // si es evento y NO est√° sorteado, inyecta el bot√≥n
          if (esEvento && meta?.evento && meta.evento.estado !== 'sorteado') {
            const drawBtn = document.createElement('button');
            drawBtn.id = 'btnEventDraw';
            drawBtn.className = 'btn btn-sm btn-warning';
            drawBtn.textContent = 'Sortear';

            drawBtn.addEventListener('click', async () => {
              const id = Number(meta?.evento?.id);
              if (!id) {
                console.warn('‚ö†Ô∏è Sin id de evento en meta.evento');
                return;
              }
              if (!confirm('¬øConfirmas realizar el sorteo?')) return;

              // Construye URL can√≥nica: usa window.URLS.eventoDraw si existe, si no fallback
              const base = window.URLS?.eventoDraw || '/api/events/0/draw/';
              const url = base.replace(/\/0\/$/, `/${id}/`);

              drawBtn.disabled = true;
              const oldTxt = drawBtn.textContent;
              drawBtn.textContent = 'Sorteando‚Ä¶';

              try {
                const r = await fetch(url, {
                  method: 'POST',
                  credentials: 'same-origin',
                  headers: {
                    'X-CSRFToken': (window.CSRF_TOKEN || ''),
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({})
                });

                // intenta leer JSON (para capturar msg del backend)
                const data = await r.json().catch(() => ({}));
                if (!r.ok) {
                  const msg = data?.msg || data?.error || `Error ${r.status}`;
                  throw new Error(msg);
                }

                // √©xito: refresca, marca estado y quita bot√≥n
                if (typeof window.loadMessagesOnce === 'function') await window.loadMessagesOnce();
                meta.evento.estado = 'sorteado';
                drawBtn.remove();
              } catch (err) {
                console.error('‚ùå Sorteo fall√≥:', err);
                alert(typeof err?.message === 'string' ? err.message : 'No fue posible sortear.');
              } finally {
                if (document.body.contains(drawBtn)) {
                  drawBtn.disabled = false;
                  drawBtn.textContent = oldTxt;
                }
              }
            });

            actionsRight?.prepend(drawBtn);
          }
          // === Mostrar/ocultar men√∫ kebab ‚Äújunto a la bandeja‚Äù ===
          // === Mostrar/ocultar men√∫s kebab (autor vs miembro) ===
          const kebabAutor = document.getElementById('groupKebab');
          const kebabMiembro = document.getElementById('memberKebab');

          const esGrupo = !!meta?.is_group;
          const esAutor = !!meta?.es_autor;
          const enTabGrupos = (typeof currentTab !== 'undefined' && currentTab === 'grupos');

          if (kebabAutor) {
            kebabAutor.dataset.convId = String(meta?.conversacion_id || '');
            kebabAutor.style.display = (enTabGrupos && esGrupo && esAutor) ? 'block' : 'none';
          }
          if (kebabMiembro) {
            kebabMiembro.dataset.convId = String(meta?.conversacion_id || '');
            kebabMiembro.style.display = (enTabGrupos && esGrupo && !esAutor) ? 'block' : 'none';
          }

          // === Wire del men√∫ (SIN capturar "meta"; lee el id en cada click) ===
          const kebab = esAutor ? kebabAutor : kebabMiembro;
          const menuEl = kebab ? kebab.querySelector('.dropdown-menu') : null;
          if (menuEl) {
            menuEl.onclick = async (ev) => {
              const btn = ev.target.closest('[data-action]');
              if (!btn) return;
              const action = btn.dataset.action;
              const convId = Number(kebab.dataset.convId || window.currentConvId || 0);
              if (!convId) return;

              if (action === 'add-members') {
                // si tus funciones necesitan meta, puedes reconsultar:
                const detalle = await fetch(window.URLS.conversacionDetalleBase.replace('/0/', `/${convId}/`), { credentials: 'same-origin' }).then(r => r.ok ? r.json() : {});
                await uiOpenAddMembers(detalle);
              } else if (action === 'remove-member') {
                const detalle = await fetch(window.URLS.conversacionDetalleBase.replace('/0/', `/${convId}/`), { credentials: 'same-origin' }).then(r => r.ok ? r.json() : {});
                await uiOpenRemoveMember(detalle);
              } else if (action === 'delete-group') {
                uiOpenDeleteGroup(convId); // üëà ahora pasamos SOLO el id
              }

            };
          }
          const memberMenu = document.querySelector('#memberKebab .dropdown-menu');
          if (memberMenu) {
            memberMenu.onclick = async (ev) => {
              const btn = ev.target.closest('[data-action]');
              if (!btn) return;
              const action = btn.dataset.action;
              const convId = Number(document.getElementById('memberKebab')?.dataset.convId || window.currentConvId || 0);
              if (!convId) return;

              if (action === 'view-members') {
                try {
                  const url = window.URLS.grupoMiembros.replace('/0/', `/${convId}/`);
                  const resp = await fetch(url, { credentials: 'same-origin' });
                  if (!resp.ok) throw new Error('HTTP ' + resp.status);
                  const data = await resp.json();
                  showMembersModal(data.miembros || [], data.creador_id);
                } catch (err) {
                  console.error(err);
                  alert('No se pudieron cargar los miembros del grupo.');
                }
              } else if (action === 'leave-group') {
                uiOpenLeaveGroup(convId);
              }
            };
          }
          function showMembersModal(miembros, creadorId) {
            const id = 'groupMembersModal';
            let modalEl = document.getElementById(id);
            if (!modalEl) {
              modalEl = document.createElement('div');
              modalEl.className = 'modal fade';
              modalEl.id = id;
              modalEl.tabIndex = -1;
              modalEl.innerHTML = `
        <div class="modal-dialog modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Miembros del grupo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body"><div class="list-group" id="${id}-list"></div></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>`;
              document.body.appendChild(modalEl);
            }

            const list = modalEl.querySelector(`#${id}-list`);
            list.innerHTML = miembros.map(m => {
              const isAdmin = m.rol && m.rol.toLowerCase() === 'admin' || m.id === creadorId;
              const badge = isAdmin ? '<span class="badge bg-primary ms-2">Admin</span>' : '';
              const avatar = m.avatar_url ? `<img src="${m.avatar_url}" alt="" class="rounded-circle me-2" style="width:28px;height:28px;object-fit:cover;">` : '';
              const nombre = (m.nombre || '') + ' ' + (m.apellido || '');
              const user = m.username ? `<small class="text-muted">@${m.username}</small>` : '';
              return `<div class="list-group-item d-flex align-items-center">
                ${avatar}
                <div class="flex-grow-1">
                  <div class="fw-semibold">${nombre || '(Sin nombre)'} ${badge}</div>
                  ${user}
                </div>
              </div>`;
            }).join('');

            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
          }

          (function () {
            const actionsBar = document.getElementById('eventActionsBar');
            const btnDraw = document.getElementById('btnEventDraw');

            window.renderEventActions = function (meta) {
              const isEvento = String(meta?.tipo || '').toLowerCase() === 'evento';
              // visible s√≥lo si: es evento, no est√° sorteado y soy autor
              const puedeSortear = !!(isEvento && meta?.evento && meta.evento.estado !== 'sorteado' && meta.es_autor);

              if (!actionsBar || !btnDraw) return;

              if (puedeSortear) {
                actionsBar.style.display = 'flex';
                btnDraw.onclick = async () => {
                  if (!confirm('¬øConfirmas realizar el sorteo?')) return;
                  try {
                    const url = `/api/events/${id}/draw/`;
                    const r = await fetch(url, {
                      method: 'POST',
                      credentials: 'same-origin',
                      headers: { 'X-CSRFToken': (window.CSRF_TOKEN || '') }
                    });
                    const j = await r.json().catch(() => ({}));
                    if (!r.ok || j?.ok === false) {
                      throw new Error(j?.msg || `HTTP ${r.status}`);
                    }
                    // √©xito
                    actionsBar.style.display = 'none';
                    if (typeof window.loadMessagesOnce === 'function') await window.loadMessagesOnce();
                    alert('Sorteo realizado. Revisa los mensajes privados.');
                  } catch (err) {
                    alert('No fue posible sortear. ' + (err?.message || ''));
                  }
                };
              } else {
                actionsBar.style.display = 'none';
                btnDraw.onclick = null;
              }
            };
          })();
          // Handler del bot√≥n "Ver miembros"
          document.addEventListener('click', async (e) => {
            const btn = e.target.closest('[data-action="view-members"]');
            if (!btn) return;

            // Necesitamos el ID de la conversaci√≥n/grupo actualmente abierto.
            // Asumimos que lo tienes guardado en window.CURRENT_CONV_ID (igual que para enviar mensajes).
            const convId = window.currentConvId;
            if (!convId || !window.URLS || !window.URLS.grupoMiembros) {
              console.error('Falta CURRENT_CONV_ID o URLS.grupoMiembros');
              return;
            }

            try {
              const url = window.URLS.grupoMiembros.replace('/0/', `/${convId}/`);
              const resp = await fetch(url, { credentials: 'same-origin' });
              if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
              const data = await resp.json();

              // data: { conversacion_id, creador_id, miembros:[{id,username,nombre,apellido,rol,avatar_url}], soy_admin }
              showMembersModal(data.miembros || [], data.creador_id);
            } catch (err) {
              console.error('Error cargando miembros:', err);
              // fallback simple
              alert('No se pudieron cargar los miembros del grupo.');
            }

            window.renderEventActions(meta);
          });


          // 2) MENSAJES
          // 2) MENSAJES ‚Äî usa SIEMPRE el renderer ‚Äúbueno‚Äù del primer script
          if (typeof loadMessagesOnce === 'function') {
            await loadMessagesOnce();           // pinta con burbujas con estilos
            msgsEl.scrollTop = msgsEl.scrollHeight;
          }
          inputMsgEl?.focus();

          inputMsgEl?.focus();

        } catch (err) {
          console.error('[openConversation] error:', err);
          const { msgsEl } = getChatRefs();
          if (msgsEl) msgsEl.innerHTML = '<div class="p-2 text-danger">Error inesperado al abrir el chat.</div>';
        }
      }


      window.openConversation = openConversation;
      if (!drawer) return;

      // Columna izquierda
      const chatsEl = drawer.querySelector('#chatList');
      const friendsEl = drawer.querySelector('#friendsList');
      const groupsEl = drawer.querySelector('#groupsList');
      const eventsEl = drawer.querySelector('#eventsList');
      const leftCol = chatsEl?.parentElement;
      if (leftCol && getComputedStyle(leftCol).position === 'static') {
        leftCol.style.position = 'relative';
      }

      // Tabs
      const tabBtns = drawer.querySelectorAll('.phone-tabs .tab-btn');
      const btnChats = drawer.querySelector('.phone-tabs .tab-btn[data-tab="chats"]');
      const btnAmigos = drawer.querySelector('.phone-tabs .tab-btn[data-tab="amigos"]');
      const btnGrupos = drawer.querySelector('.phone-tabs .tab-btn[data-tab="grupos"]');

      // Modal crear grupo
      const gm = document.getElementById('groupModal');
      const gmName = document.getElementById('gmName');
      const gmFriends = document.getElementById('gmFriends');
      const gmCreate = document.getElementById('gmCreate');

      // Helpers
      const AVATAR_FALLBACK = "{% static 'img/Gifters/favicongift.png' %}";
      const CSRFTOKEN = (function getCookie(name) {
        const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      })('csrftoken');

      // Estado
      let friendsLoaded = false; // del tab amigos
      let friendsCache = [];     // para el modal
      let groupsLoaded = false;

      // ------- AMIGOS (reutiliza tu loader existente si quieres) -------
      async function loadFriends() {
        if (friendsLoaded) return;
        friendsEl.innerHTML = '<div class="p-3 text-muted">Cargando amigos‚Ä¶</div>';
        try {
          const res = await fetch(window.URLS.amigos, {
            credentials: 'same-origin',
            headers: { 'Accept': 'application/json' }
          });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          friendsCache = Array.isArray(data) ? data : [];
          renderFriends(friendsCache);
          friendsLoaded = true;
        } catch (e) {
          console.error('Error cargando amigos:', e);
          friendsEl.innerHTML = '<div class="p-3 text-danger">No se pudieron cargar tus amigos.</div>';
        }
      }

      function friendUsername(u) {
        return u.nombre_usuario || u.username || '';
      }
      function friendName(u) {
        return u.nombre_completo ||
          [u.nombre, u.apellido].filter(Boolean).join(' ') ||
          u.display_name ||
          friendUsername(u) || 'Amigo';
      }
      function friendAvatar(u) {
        const raw =
          u.avatar_url || u.avatar || u.foto_url || u.foto ||
          (u.perfil && (u.perfil.profile_picture_url || u.perfil.foto_url || u.perfil.profile_picture)) ||
          u.profile_image_url || u.profile_picture_url || null;
        return raw || AVATAR_FALLBACK;
      }

      function renderFriends(list) {
        friendsEl.innerHTML = '';
        if (!Array.isArray(list) || list.length === 0) {
          friendsEl.innerHTML = '<div class="p-3 text-muted">A√∫n no tienes amigos.</div>';
          return;
        }
        list.forEach(u => {
          const row = document.createElement('div');
          row.className = 'chat-list-item';
          row.innerHTML = `
        <img class="chat-avatar" src="${friendAvatar(u)}" alt="">
        <div class="chat-names">
          <div class="line1">${friendName(u)}</div>
          <div class="line2">@${friendUsername(u)}</div>
        </div>
        <div class="chat-time"></div>
      `;
          row.addEventListener('click', () => {
            const uname = friendUsername(u);
            if (uname && typeof window.openChatWith === 'function') {
              window.openChatWith(uname);
            }
          });
          friendsEl.appendChild(row);
        });
      }

      // ------- MODAL CREAR GRUPO -------
      (() => {
        const AVATAR_FALLBACK = "{% static 'img/Gifters/favicongift.png' %}";
        const CSRFTOKEN = (function getCookie(name) {
          const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        })('csrftoken');

        // Reutilizamos tus caches si existen; si no, los creamos.
        window.friendsLoaded ??= false;
        window.friendsCache ??= [];

        function friendUsername(u) { return u.nombre_usuario || u.username || ''; }
        function friendName(u) {
          return u.nombre_completo ||
            [u.nombre, u.apellido].filter(Boolean).join(' ') ||
            u.display_name || friendUsername(u) || 'Amigo';
        }
        function friendAvatar(u) {
          const raw = u?.perfil?.profile_picture_url || u?.avatar_url || u?.avatar || u?.foto_url || u?.foto || null;
          return raw || AVATAR_FALLBACK;
        }

        async function ensureFriends() {
          if (window.friendsLoaded) return;
          try {
            const res = await fetch(window.URLS.amigos, { credentials: 'same-origin', headers: { Accept: 'application/json' } });
            const data = await res.json();
            window.friendsCache = Array.isArray(data) ? data : [];
            window.friendsLoaded = true;
          } catch (e) { console.error('[modal grupos] No se pudieron cargar amigos', e); }
        }

        async function openGroupModal() {
          await ensureFriends();
          const gm = document.getElementById('groupModal');
          const gmName = document.getElementById('gmName');
          const gmFriends = document.getElementById('gmFriends');
          const btnCreate = document.getElementById('gmCreate');
          if (!gm || !gmFriends || !btnCreate) return;

          gmFriends.innerHTML = window.friendsCache.map(f => `
      <label class="d-flex align-items-center gap-2">
        <input type="checkbox" value="${f.id}">
        <img src="${friendAvatar(f)}" class="rounded-circle"
             style="width:28px;height:28px;object-fit:cover"
             onerror="this.src='${AVATAR_FALLBACK}'">
        <span>${friendName(f)}</span>
      </label>
    `).join('');

          btnCreate.onclick = createGroup;           // una sola vez por apertura
          gm.style.display = 'block';
          document.body.style.overflow = 'hidden';   // bloqueo scroll fondo
          gmName?.focus();
        }

        function closeGroupModal() {
          const gm = document.getElementById('groupModal');
          const gmName = document.getElementById('gmName');
          if (!gm) return;
          gm.style.display = 'none';
          if (gmName) gmName.value = '';
          document.body.style.overflow = '';
        }

        // Delegaci√≥n global: X, Cancelar, backdrop, Escape y bot√≥n "+ Nuevo"
        document.addEventListener('click', (e) => {
          if (e.target.closest('#btnNewGroup')) { e.preventDefault(); openGroupModal(); return; }
          if (e.target.closest('#groupModal [data-close], #groupModal .btn-close')) { e.preventDefault(); closeGroupModal(); return; }
          const modal = document.getElementById('groupModal');
          if (modal && e.target === modal) closeGroupModal();
        });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeGroupModal(); });

        async function createGroup() {
          const gm = document.getElementById('groupModal');
          const gmName = document.getElementById('gmName');
          const gmFriends = document.getElementById('gmFriends');

          const titulo = (gmName?.value || '').trim();
          const ids = Array.from(gmFriends?.querySelectorAll('input[type=checkbox]:checked') || [])
            .map(i => Number(i.value));

          if (!titulo) { gmName?.focus(); return; }
          if (!ids.length) { alert('Selecciona al menos 1 amigo.'); return; }

          try {
            const r = await fetch(window.URLS.gruposCreate, {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFTOKEN },
              body: JSON.stringify({ titulo, miembros: ids })
            });
            if (!r.ok) throw new Error('HTTP ' + r.status);
            const j = await r.json();

            closeGroupModal();

            // Refresca bandejas
            if (typeof window.loadConversations === 'function') window.loadConversations();
            if (typeof window.refreshGroups === 'function') await window.refreshGroups();

            // Abre el grupo reci√©n creado
            if (j?.conversacion_id && typeof window.openConversation === 'function') {
              document.querySelector('.phone-tabs .tab-btn[data-tab="grupos"]')?.click();
              await window.openConversation(j.conversacion_id);
            }
          } catch (e) {
            console.error('[modal grupos] No se pudo crear el grupo', e);
            alert('No se pudo crear el grupo.');
          }
        }

        // por si lo necesitas en otro lado
        Object.assign(window, { openGroupModal, closeGroupModal });
      })();


      function closeGroupModal() {
        gm.style.display = 'none';
        gmName.value = '';
      }
      gm?.addEventListener('click', (e) => {
        if (e.target.matches('.btn-close,[data-close],.modal')) closeGroupModal();
      });

      async function loadFriendsForModal() {
        if (!friendsLoaded) await loadFriends();
        openGroupModal();
      }

      async function createGroup() {
        const gm = document.getElementById('groupModal');
        const gmName = document.getElementById('gmName');
        const gmFriends = document.getElementById('gmFriends');

        const titulo = (gmName?.value || '').trim();
        const ids = Array.from(gmFriends?.querySelectorAll('input[type=checkbox]:checked') || [])
          .map(i => Number(i.value));

        if (!titulo) { gmName?.focus(); return; }
        if (!ids.length) { alert('Selecciona al menos 1 amigo.'); return; }

        try {
          const r = await fetch(window.URLS.gruposCreate, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFTOKEN },
            body: JSON.stringify({ titulo, miembros: ids })
          });
          if (!r.ok) throw new Error('HTTP ' + r.status);
          const j = await r.json();

          // abrir el chat del grupo reci√©n creado
          if (j && j.conversacion_id && window.openConversation) {
            window.openConversation(j.conversacion_id);
          }
          // refrescar listado de conversaciones/grupos
          if (typeof window.loadConversations === 'function') window.loadConversations();

          // cerrar modal
          if (gm) gm.style.display = 'none';
          if (gmName) gmName.value = '';
        } catch (e) {
          console.error(e);
          alert('No se pudo crear el grupo.');
        }
      }
      document.getElementById('gmCreate')?.addEventListener('click', createGroup);

      // ------- LISTAR GRUPOS -------
      async function loadGroups() {
        if (groupsLoaded) return;
        groupsEl.innerHTML = `
          <div class="d-flex align-items-center justify-content-between p-2" id="groupsHeader">
            <div class="d-flex align-items-center gap-2">
              <span class="fw-semibold">Tus grupos</span>
            </div>
            <div class="d-flex align-items-center gap-2" id="groupsHeaderActions">
              <!-- aqu√≠ colocaremos el kebab por JS -->
              <button class="btn btn-sm btn-primary" id="btnNewGroup">
                <i class="bi bi-plus-lg"></i> Nuevo
              </button>
            </div>
          </div>`;


        try {
          const res = await fetch(window.URLS.conversaciones, { credentials: 'same-origin' });
          const data = await res.json();
          const grupos = (data || []).filter(c => {
            const t = String(c.tipo || '').toLowerCase();
            return (t === 'grupo') || (c.is_group && t !== 'evento');
          });

          const list = document.createElement('div');
          list.className = 'px-2';
          list.setAttribute('data-role', 'groups-inner');
          if (!grupos.length) {
            list.innerHTML = '<div class="p-3 text-muted">A√∫n no tienes grupos.</div>';
          } else {
            list.innerHTML = grupos.map(g => {
              const ps = (g.participantes || []).slice(0, 3);
              const imgs = ps.map(p => `<img src="${(p.avatar_url || p.avatar) || AVATAR_FALLBACK}" onerror="this.src='${AVATAR_FALLBACK}'" style="width:24px;height:24px;border-radius:50%;object-fit:cover;border:2px solid #fff;margin-left:-8px;">`).join('');
              const prev = g.ultimo_mensaje
                ? ((g.ultimo_mensaje.tipo === 'imagen' || g.ultimo_mensaje.archivo_url) ? 'üì∑ Imagen' : String(g.ultimo_mensaje.contenido || '').slice(0, 72))
                : '';
              const when = g.ultimo_mensaje?.creado_en ? new Date(g.ultimo_mensaje.creado_en).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
              return `
            <div class="chat-list-item" data-conv-id="${g.conversacion_id}" data-conv="${g.conversacion_id}">
              <div class="d-flex align-items-center">
                <div class="d-flex align-items-center" style="width:50px">${imgs}</div>
                <div class="chat-names">
                  <div class="line1">
                    ${g.titulo || 'Grupo'}
                    <span class="dot hidden" data-dot></span>
                    </div>
                  <div class="line2">${prev}</div>
                </div>
                <div class="chat-time">${when}</div>
              </div>
            </div>`;
            }).join('');
          }
          groupsEl.innerHTML = `
        <div class="d-flex justify-content-between align-items-center p-2">
          <span class="text-muted">Tus grupos</span>
          <button class="btn btn-sm btn-primary" id="btnNewGroup"><i class="bi bi-plus-lg"></i> Nuevo</button>
        </div>`;
          groupsEl.appendChild(list);
          groupsEl.querySelector('#btnNewGroup')?.addEventListener('click', loadFriendsForModal);
          groupsEl.querySelectorAll('.chat-list-item').forEach(row => {
            row.addEventListener('click', () => {
              const cid = Number(row.dataset.convId);
              if (window.openConversation) window.openConversation(cid);
            });
          });

          window.CHAT_INDEX.groups = new Set(grupos.map(g => String(g.conversacion_id)));
          groupsLoaded = true;
          try { refreshGlobalUnreadDot(); } catch { }
        } catch (e) {
          console.error(e);
          groupsEl.innerHTML = '<div class="p-3 text-danger">No se pudieron cargar tus grupos.</div>';
          try { refreshGlobalUnreadDot(); } catch { }
        }
        // Forzar refresco externo (lo usa el modal al crear un grupo)
        window.refreshGroups = async function () {
          try {
            // resetea el flag y repinta
            groupsLoaded = false;
            await loadGroups();
          } catch (e) {
            console.error('[groups] refreshGroups error:', e);
          }
        };
      }

      // ------- Tabs -------
      /* üëá NUEVO: recuerda la pesta√±a actual */
      let currentTab = 'chats';

      function setActiveTab(tab) {
        currentTab = tab;

        tabBtns.forEach(b => b.classList.toggle('active', b.dataset.tab === tab));

        const headerTitleEl = document.querySelector('.phone-header .brand');
        const topKebab = document.getElementById('groupKebab');

        if (tab === 'amigos') {
          friendsEl.style.display = 'block';
          chatsEl.style.visibility = 'hidden';
          groupsEl.style.display = 'none';
          eventsEl.style.display = 'none';
          if (headerTitleEl) headerTitleEl.textContent = "Gifter‚Äôs";
          if (topKebab) topKebab.style.display = 'none';  // el kebab ya no va en la barra azul
          loadFriends();
        } else if (tab === 'chats') {
          friendsEl.style.display = 'none';
          groupsEl.style.display = 'none';
          eventsEl.style.display = 'none';
          chatsEl.style.visibility = 'visible';
          if (headerTitleEl) headerTitleEl.textContent = "Gifter‚Äôs";
          if (topKebab) topKebab.style.display = 'none';
          if (typeof loadConversations === 'function') {
            loadConversations().finally(() => { try { refreshGlobalUnreadDot(); } catch { } });
          }

        } else if (tab === 'eventos') {
          friendsEl.style.display = 'none';
          chatsEl.style.visibility = 'hidden';
          groupsEl.style.display = 'none';
          eventsEl.style.display = 'none';
          eventsEl.style.display = 'block';
          if (headerTitleEl) headerTitleEl.textContent = "Eventos";

          if (typeof window.renderEventsTabHeader === 'function') window.renderEventsTabHeader();
          if (typeof window.loadEventsInbox === 'function') window.loadEventsInbox();
          if (typeof window.loadEventsForCurrentGroup === 'function') window.loadEventsForCurrentGroup();
        } else { // grupos
          friendsEl.style.display = 'none';
          chatsEl.style.visibility = 'hidden';
          eventsEl.style.display = 'none';
          groupsEl.style.display = 'block';
          if (headerTitleEl) headerTitleEl.textContent = "Grupos"; // üëà t√≠tulo fijo
          if (topKebab) topKebab.style.display = 'none';           // en la barra azul nunca
          loadGroups().finally(() => { try { refreshGlobalUnreadDot(); } catch { } });
        }
      }

      drawer.addEventListener('click', (e) => {
        const btn = e.target.closest('.tab-btn');
        if (!btn || !btn.dataset.tab) return;
        setActiveTab(btn.dataset.tab);
      });

      // Estado inicial
      setActiveTab('chats');
    })();
  </script>

  {% endif %}

  <script>
    // Bot√≥n de chat en perfil p√∫blico (si aparece en alguna vista)
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btnChatPerfilPublico');
      btn?.addEventListener('click', (e) => {
        e.preventDefault();
        const u = btn.dataset.username;
        if (window.openChatWith) {
          window.openChatWith(u);
        } else {
          document.getElementById('chatFab')?.click();
        }
      });
    });
  </script>



  <script>
    (() => {
      const ENDPOINT = "{% url 'buscar_sugerencias' %}";

      const form = document.querySelector('.g-search');
      const box = document.getElementById('gSearchBox');
      const input = document.getElementById('gSearchInput');
      const sugs = document.getElementById('gSug');
      if (!form || !box || !input || !sugs) return;

      let active = -1, controller = null;

      const esc = s => String(s || '').replace(/[<>&]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;' }[c]));
      const tpl = (s, i) => `
      <div class="g-sug" data-i="${i}" data-url="${s.url || '#'}">
        <span class="type">${esc(s.tipo || '')}</span>
        <span class="text">${esc(s.texto || s.title || '')}</span>
        ${(s.marca || s.categoria) ? `<span class="meta">${esc([s.marca, s.categoria].filter(Boolean).join(' ‚Ä¢ '))}</span>` : ''}
      </div>`;

      /* === NUEVO: animaciones === */
      function openSugs(animate = true) {
        sugs.hidden = false;
        form.classList.add('is-open');
        if (animate) {
          sugs.classList.remove('anim-out');
          void sugs.offsetWidth;            // reflow para reiniciar anim
          sugs.classList.add('anim-in');
        }
        active = -1;
      }

      function closeSugs() {
        if (sugs.hidden) {                  // ya est√° cerrado
          form.classList.remove('is-open');
          active = -1;
          return;
        }
        sugs.classList.remove('anim-in');
        sugs.classList.add('anim-out');
        const onEnd = (e) => {
          if (e.target !== sugs) return;
          sugs.removeEventListener('animationend', onEnd);
          sugs.hidden = true;
          sugs.classList.remove('anim-out');
          sugs.innerHTML = '';
          form.classList.remove('is-open');
          active = -1;
        };
        sugs.addEventListener('animationend', onEnd);
      }

      function show(list) {
        if (!list?.length) return closeSugs();
        const wasHidden = sugs.hidden;      // solo animar si estaba oculto
        sugs.innerHTML = list.map(tpl).join('');
        openSugs(wasHidden);
      }

      const debounce = (fn, ms = 220) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

      const search = debounce(async q => {
        if (!q || q.trim().length < 2) return closeSugs();
        try {
          controller?.abort(); controller = new AbortController();
          const r = await fetch(`${ENDPOINT}?q=${encodeURIComponent(q)}`, { credentials: 'same-origin', signal: controller.signal });
          if (!r.ok) throw 0;
          const j = await r.json();
          show(j.sugerencias || j.hits || []);
        } catch {/* noop */ }
      }, 220);

      input.addEventListener('input', e => search(e.target.value));
      input.addEventListener('focus', () => { if (sugs.innerHTML) openSugs(true); });

      function items() { return Array.from(sugs.querySelectorAll('.g-sug')); }
      function setActive(i) {
        const els = items(); els.forEach(el => el.classList.remove('is-active'));
        if (!els.length) { active = -1; return; }
        active = (i + els.length) % els.length;
        const el = els[active]; el.classList.add('is-active');
        const r = el.getBoundingClientRect(), cr = sugs.getBoundingClientRect();
        if (r.top < cr.top) sugs.scrollTop -= (cr.top - r.top);
        if (r.bottom > cr.bottom) sugs.scrollTop += (r.bottom - cr.bottom);
      }

      input.addEventListener('keydown', e => {
        if (sugs.hidden) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); setActive(active + 1); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); setActive(active - 1); }
        else if (e.key === 'Enter') {
          const els = items();
          if (active >= 0 && els[active]) {
            e.preventDefault();
            window.location.href = els[active].dataset.url || (form.action + '?q=' + encodeURIComponent(input.value));
          }
        } else if (e.key === 'Escape') { closeSugs(); input.blur(); }
      });

      sugs.addEventListener('mousedown', e => {
        const el = e.target.closest('.g-sug'); if (!el) return;
        e.preventDefault();
        window.location.href = el.dataset.url || (form.action + '?q=' + encodeURIComponent(input.value));
      });

      document.addEventListener('click', e => { if (!form.contains(e.target)) closeSugs(); });
    })();


    // ===== helpers de refs (tolerantes a distintos IDs/clases) =====
    function qOne(root, selectors) {
      for (const sel of selectors) {
        const el = root.querySelector(sel);
        if (el) return el;
      }
      return null;
    }

    function getChatRefs() {
      const drawer = document.getElementById('chatDrawer') || document.querySelector('.chat-drawer');

      // Listas
      const groupsListEl = qOne(drawer, ['#groupsList', '#chat-groups-list', '.chat-groups-list', '[data-chat="groups-list"]']);
      const chatsListEl = qOne(drawer, ['#chatList', '#chat-chats-list', '.chat-chats-list', '[data-chat="chats-list"]']);

      // Panel derecho
      const msgsEl = qOne(drawer, ['#chatMessages', '#chat-messages', '.chat-messages', '[data-chat="messages"]', '.chat-pane-messages']);
      const emptyEl = qOne(drawer, ['#chatEmpty', '#chat-empty', '.chat-empty', '[data-chat="empty"]']);
      const formEl = qOne(drawer, ['#chatForm', '#chat-form', 'form.chat-input', 'form.chat-form', '[data-chat="form"]']);
      const headerTitleEl = qOne(drawer, ['#chat-header-title', '.chat-header-title', '[data-chat="header-title"]', '.phone-header .brand span']);
      const inputMsgEl = qOne(drawer, ['#chatText', '#chat-input', 'textarea#chatText', 'textarea[name="message"]', 'input[name="message"]', '[data-chat="input"]']);

      const missing = [];
      if (!drawer) missing.push('drawer (#chatDrawer / .chat-drawer)');
      if (!groupsListEl) missing.push('groupsListEl (#groupsList / #chat-groups-list / ‚Ä¶)');
      if (!chatsListEl) missing.push('chatsListEl (#chatList / #chat-chats-list / ‚Ä¶)');
      if (!msgsEl) missing.push('msgsEl (#chatMessages / #chat-messages / ‚Ä¶)');
      if (!emptyEl) missing.push('emptyEl (#chatEmpty / #chat-empty / ‚Ä¶)');
      if (!formEl) missing.push('formEl (#chatForm / #chat-form / ‚Ä¶)');
      // headerTitleEl es opcional
      if (!inputMsgEl) missing.push('inputMsgEl (#chatText / #chat-input / ‚Ä¶)');

      if (missing.length) console.warn('[chat] Faltan nodos en el DOM:', missing);

      return { drawer, groupsListEl, chatsListEl, msgsEl, emptyEl, formEl, headerTitleEl, inputMsgEl };
    }
  </script>

  <script>
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        try { refreshGlobalUnreadDot(); } catch { }
      }
    });
    window.addEventListener("focus", () => {
      try { refreshGlobalUnreadDot(); } catch { }
    });
  </script>





  <!-- Modal crear grupo -->
  <div id="groupModal" class="modal" tabindex="-1" style="display:none;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Crear grupo</h5>
          <button type="button" class="btn-close" data-close></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Nombre del grupo</label>
            <input id="gmName" class="form-control" maxlength="60" placeholder="Ej: Asado del viernes">
          </div>
          <div class="mb-2">
            <label class="form-label">Miembros</label>
            <div id="gmFriends" class="d-grid gap-2" style="max-height: 260px; overflow:auto;"></div>
            <small class="text-muted">Puedes elegir varios.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-close>Cancelar</button>
          <button id="gmCreate" class="btn btn-primary">Crear</button>
        </div>
      </div>
    </div>
  </div>




  {% block extra_js %}{% endblock %}

  <div id="modalAddMembers" class="modal" tabindex="-1" style="display:none;">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Agregar miembros al grupo</h5>
          <button type="button" class="btn-close" data-close></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <small class="text-muted">Selecciona amigos para agregar.</small>
          </div>
          <div id="addMembersList" class="d-grid gap-2" style="max-height: 320px; overflow:auto;"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-close>Cancelar</button>
          <button id="btnConfirmAddMembers" class="btn btn-primary">Agregar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Quitar miembro -->
  <div id="modalRemoveMember" class="modal" tabindex="-1" style="display:none;">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Quitar un miembro</h5>
          <button type="button" class="btn-close" data-close></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <small class="text-muted">Elige a qui√©n quitar (no puedes quitarte a ti ni al autor).</small>
          </div>
          <div id="removeMembersList" class="d-grid gap-2" style="max-height: 320px; overflow:auto;"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-close>Cancelar</button>
          <button id="btnConfirmRemoveMember" class="btn btn-warning">Quitar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Confirmar eliminaci√≥n -->
  <div id="modalDeleteGroup" class="modal" tabindex="-1" style="display:none;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">Eliminar grupo</h5>
          <button type="button" class="btn-close" data-close></button>
        </div>
        <div class="modal-body">
          <p>¬øSeguro que deseas <strong>eliminar este grupo</strong>? Esta acci√≥n no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-close>Cancelar</button>
          <button id="btnConfirmDeleteGroup" class="btn btn-danger">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalLeaveGroup" class="modal" tabindex="-1" style="display:none;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">Abandonar grupo</h5>
          <button type="button" class="btn-close" data-close></button>
        </div>
        <div class="modal-body">
          <p>¬øSeguro que deseas <strong>abandonar este grupo</strong>? Podr√°s volver a unirte si te agregan nuevamente.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-close>Cancelar</button>
          <button id="btnConfirmLeaveGroup" class="btn btn-danger">Abandonar</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // ====== Helpers de modal ======
    function openBasicModal(id) {
      const m = document.getElementById(id);
      if (!m) return;
      m.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    function closeBasicModal(id) {
      const m = document.getElementById(id);
      if (!m) return;
      m.style.display = 'none';
      document.body.style.overflow = '';
    }
    document.addEventListener('click', (e) => {
      const m = e.target.closest('.modal');
      if (!m) return;
      if (e.target.matches('.btn-close,[data-close]') || e.target === m) {
        m.style.display = 'none';
        document.body.style.overflow = '';
      }
    });

    // ====== Cache de amigos (para agregar miembros) ======
    window.friendsLoaded = false;
    window.friendsCache = [];

    // ====== UI: Agregar miembros ======
    async function uiOpenAddMembers(meta) {
      const AVATAR_FALLBACK = "{% static 'img/Gifters/favicongift.png' %}";
      const convId = Number(meta?.conversacion_id || window.currentConvId || 0);
      if (!convId) return;

      // 1) Asegura/recarga amigos UNA sola vez por fetch.json()
      if (!window.friendsLoaded) {
        try {
          const res = await fetch(window.URLS.amigos, {
            credentials: 'same-origin',
            headers: { Accept: 'application/json' }
          });
          if (!res.ok) throw 0;
          const data = await res.json();                     // ‚Üê leer SOLO una vez
          window.friendsCache = Array.isArray(data) ? data : [];
          window.friendsLoaded = true;
        } catch {
          window.friendsCache = [];
          window.friendsLoaded = true;
        }
      }

      // 2) Normalizador (por si el endpoint cambia de forma)
      const normalizeMembers = (x) => {
        if (Array.isArray(x)) return x;
        if (x && Array.isArray(x.participantes)) return x.participantes;
        if (x && Array.isArray(x.miembros)) return x.miembros;
        if (x && Array.isArray(x.members)) return x.members;
        return [];
      };

      // 3) Trae miembros FRESCOS desde el endpoint (si existe)
      let miembrosIds = [];
      try {
        if (window.URLS.grupoMiembros) {
          const r = await fetch(window.URLS.grupoMiembros.replace('/0/', `/${convId}/`), {
            credentials: 'same-origin'
          });
          if (r.ok) {
            const payload = await r.json();
            miembrosIds = normalizeMembers(payload).map(p => Number(p.id));
          } else {
            // fallback a meta
            miembrosIds = normalizeMembers(meta?.participantes).map(p => Number(p.id));
          }
        } else {
          miembrosIds = normalizeMembers(meta?.participantes).map(p => Number(p.id));
        }
      } catch {
        miembrosIds = normalizeMembers(meta?.participantes).map(p => Number(p.id));
      }

      // 4) Candidatos = amigos que NO est√°n en el grupo
      const candidates = (window.friendsCache || []).filter(f => !miembrosIds.includes(Number(f.id)));

      // 5) Pintar lista
      const list = document.getElementById('addMembersList');
      list.innerHTML = candidates.length
        ? candidates.map(f => {
          const name = f.nombre_completo ||
            [f.nombre, f.apellido].filter(Boolean).join(' ') ||
            f.display_name || f.username || f.nombre_usuario || 'Amigo';
          const avatar = f.avatar_url || f.avatar || f.foto_url || f.foto || AVATAR_FALLBACK;
          return `
          <label class="d-flex align-items-center gap-2">
            <input type="checkbox" value="${Number(f.id)}">
            <img src="${avatar}" class="rounded-circle" style="width:28px;height:28px;object-fit:cover"
                 onerror="this.src='${AVATAR_FALLBACK}'">
            <span>${name}</span>
          </label>`;
        }).join('')
        : '<div class="text-muted">No hay amigos disponibles para agregar.</div>';

      // 6) Confirmar agregar
      const btn = document.getElementById('btnConfirmAddMembers');
      btn.onclick = async () => {
        const ids = Array.from(list.querySelectorAll('input[type=checkbox]:checked')).map(i => Number(i.value));
        if (!ids.length) { closeBasicModal('modalAddMembers'); return; }
        try {
          const url = window.URLS.grupoAgregarMiembros.replace('/0/', `/${convId}/`);
          const csrf = (document.cookie.match(/csrftoken=([^;]+)/) || [])[1] || '';
          const r = await fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
            body: JSON.stringify({ miembros: ids })
          });
          if (!r.ok) throw 0;

          closeBasicModal('modalAddMembers');
          if (typeof window.refreshGroups === 'function') await window.refreshGroups();
          if (typeof window.loadMessagesOnce === 'function') await window.loadMessagesOnce();
        } catch {
          alert('No se pudieron agregar miembros.');
        }
      };

      openBasicModal('modalAddMembers');
    }

    // ====== UI: Quitar miembro ======
    // Reemplaza COMPLETO tu uiOpenRemoveMember(meta) por este:
    async function uiOpenRemoveMember(metaOrConv) {
      // 1) Resolver convId aunque pase meta incompleto
      const convId = Number(
        (metaOrConv && metaOrConv.conversacion_id) ||
        (window.currentConvId) || 0
      );
      if (!convId) return;

      // 2) Helpers
      const AVATAR_FALLBACK = "{% static 'img/Gifters/favicongift.png' %}";
      const meId = Number('{{ user.id|default:"0"|escapejs }}');

      // Autor: intenta varios nombres posibles
      const authorId = Number(
        (metaOrConv && (metaOrConv.author_id ||
          (metaOrConv.autor && metaOrConv.autor.id) ||
          (metaOrConv.creado_por && metaOrConv.creado_por.id))) || 0
      );

      // 3) Normalizador robusto
      function normalizeMembers(x) {
        // ya es array
        if (Array.isArray(x)) return x;
        // objetos conocidos
        if (x && Array.isArray(x.participantes)) return x.participantes;
        if (x && Array.isArray(x.miembros)) return x.miembros;
        if (x && Array.isArray(x.members)) return x.members;
        // nada usable
        return [];
      }

      // 4) Trae lista de miembros fresca (si existe endpoint)
      let participantes = normalizeMembers(metaOrConv && metaOrConv.participantes);
      try {
        if (window.URLS.grupoMiembros) {
          const r = await fetch(window.URLS.grupoMiembros.replace('/0/', `/${convId}/`), { credentials: 'same-origin' });
          if (r.ok) {
            const payload = await r.json();
            participantes = normalizeMembers(payload);
          }
        }
      } catch (e) {
        // si falla, seguimos con lo que tengamos
      }

      // 5) Filtra: no me dejes quitar al autor ni a m√≠ mismo
      const candidates = normalizeMembers(participantes).filter(p => {
        const id = Number(p.id);
        return id && id !== meId && id !== authorId;
      });

      // 6) Pinta modal
      const list = document.getElementById('removeMembersList');
      list.innerHTML = candidates.length
        ? candidates.map(p => {
          const name = p.nombre_completo ||
            [p.nombre, p.apellido].filter(Boolean).join(' ') ||
            p.display_name || p.username || p.nombre_usuario || 'Miembro';
          const avatar = p.avatar_url || p.avatar || p.foto_url || p.foto || AVATAR_FALLBACK;
          return `
          <label class="d-flex align-items-center gap-2">
            <input type="radio" name="rmMember" value="${Number(p.id)}">
            <img src="${avatar}" class="rounded-circle" style="width:28px;height:28px;object-fit:cover"
                 onerror="this.src='${AVATAR_FALLBACK}'">
            <span>${name}</span>
          </label>`;
        }).join('')
        : '<div class="text-muted">No hay miembros a quitar.</div>';

      // 7) Confirmar
      const btn = document.getElementById('btnConfirmRemoveMember');
      btn.onclick = async () => {
        const sel = list.querySelector('input[name=rmMember]:checked');
        if (!sel) { closeBasicModal('modalRemoveMember'); return; }

        try {
          const url = window.URLS.grupoQuitarMiembro.replace('/0/', `/${convId}/`);
          const csrf = (document.cookie.match(/csrftoken=([^;]+)/) || [])[1] || '';
          const r = await fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
            body: JSON.stringify({ miembro_id: Number(sel.value) })
          });
          if (!r.ok) throw 0;

          closeBasicModal('modalRemoveMember');

          // refrescos opcionales
          if (typeof window.refreshGroups === 'function') await window.refreshGroups();
          if (typeof window.loadMessagesOnce === 'function') await window.loadMessagesOnce();
        } catch {
          alert('No se pudo quitar al miembro.');
        }
      };

      openBasicModal('modalRemoveMember');
    }

    function showMembersModal(miembros, creadorId) {
      const id = 'groupMembersModal';
      let modalEl = document.getElementById(id);
      if (!modalEl) {
        modalEl = document.createElement('div');
        modalEl.className = 'modal fade';
        modalEl.id = id;
        modalEl.tabIndex = -1;
        modalEl.innerHTML = `
        <div class="modal-dialog modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Miembros del grupo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body"><div class="list-group" id="${id}-list"></div></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>`;
        document.body.appendChild(modalEl);
      }

      const list = modalEl.querySelector(`#${id}-list`);
      list.innerHTML = miembros.map(m => {
        const isAdmin = m.rol && m.rol.toLowerCase() === 'admin' || m.id === creadorId;
        const badge = isAdmin ? '<span class="badge bg-primary ms-2">Admin</span>' : '';
        const avatar = m.avatar_url ? `<img src="${m.avatar_url}" alt="" class="rounded-circle me-2" style="width:28px;height:28px;object-fit:cover;">` : '';
        const nombre = (m.nombre || '') + ' ' + (m.apellido || '');
        const user = m.username ? `<small class="text-muted">@${m.username}</small>` : '';
        return `<div class="list-group-item d-flex align-items-center">
                ${avatar}
                <div class="flex-grow-1">
                  <div class="fw-semibold">${nombre || '(Sin nombre)'} ${badge}</div>
                  ${user}
                </div>
              </div>`;
      }).join('');

      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();
    }

    // Handler del bot√≥n "Ver miembros"
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-action="view-members"]');
      if (!btn) return;

      // Necesitamos el ID de la conversaci√≥n/grupo actualmente abierto.
      const convId = window.currentConvId;
      if (!convId || !window.URLS || !window.URLS.grupoMiembros) {
        console.error('Falta CURRENT_CONV_ID o URLS.grupoMiembros');
        return;
      }

      try {
        const url = window.URLS.grupoMiembros.replace('/0/', `/${convId}/`);
        const resp = await fetch(url, { credentials: 'same-origin' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        // data: { conversacion_id, creador_id, miembros:[{id,username,nombre,apellido,rol,avatar_url}], soy_admin }
        showMembersModal(data.miembros || [], data.creador_id);
      } catch (err) {
        console.error('Error cargando miembros:', err);
        alert('No se pudieron cargar los miembros del grupo.');
      }
    });

    // ====== UI: Eliminar grupo ======
    function uiOpenDeleteGroup(convId) {
      const btn = document.getElementById('btnConfirmDeleteGroup');
      btn.onclick = async () => {
        try {
          const url = window.URLS.grupoEliminar.replace('/0/', `/${convId}/`);
          const csrf = (document.cookie.match(/csrftoken=([^;]+)/) || [])[1] || '';
          const r = await fetch(url, {
            method: 'POST', // o 'DELETE' si tu view lo permite (con CSRF igual)
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf }
          });
          if (!r.ok) throw 0;

          closeBasicModal('modalDeleteGroup');

          // Limpia la UI del chat abierto si era este grupo
          if (Number(window.currentConvId) === Number(convId)) {
            window.currentConvId = null;
            document.getElementById('chatMessages')?.setAttribute('hidden', '');
            document.getElementById('chatForm')?.setAttribute('hidden', '');
            const empty = document.getElementById('chatEmpty'); if (empty) empty.hidden = false;
          }

          // Refresca listas sin recargar la p√°gina
          if (typeof window.loadConversations === 'function') window.loadConversations();
          if (typeof window.refreshGroups === 'function') await window.refreshGroups();
        } catch {
          alert('No se pudo eliminar el grupo.');
        }
      };
      openBasicModal('modalDeleteGroup');
    }

    function uiOpenLeaveGroup(convId) {
      const btn = document.getElementById('btnConfirmLeaveGroup');
      btn.onclick = async () => {
        try {
          const url = window.URLS.grupoSalir.replace('/0/', `/${convId}/`);
          const csrf = (document.cookie.match(/csrftoken=([^;]+)/) || [])[1] || '';
          const r = await fetch(url, {
            method: 'POST',                // o 'DELETE' si tu view lo usa
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
            body: JSON.stringify({})       // üëà body JSON v√°lido
          });

          if (!r.ok) {
            // intenta leer mensaje del backend
            let msg = 'No se pudo abandonar el grupo.';
            try { const j = await r.json(); if (j?.error) msg = j.error; } catch { }
            throw new Error(msg + ` (HTTP ${r.status})`);
          }

          closeBasicModal('modalLeaveGroup');

          if (Number(window.currentConvId) === Number(convId)) {
            window.currentConvId = null;
            document.getElementById('chatMessages')?.setAttribute('hidden', '');
            document.getElementById('chatForm')?.setAttribute('hidden', '');
            const empty = document.getElementById('chatEmpty'); if (empty) empty.hidden = false;
          }

          if (typeof window.loadConversations === 'function') window.loadConversations();
          if (typeof window.refreshGroups === 'function') await window.refreshGroups();
        } catch (e) {
          alert(e.message || 'No se pudo abandonar el grupo.');
        }
      };
      openBasicModal('modalLeaveGroup');
    }

    async function refreshInboxList(reason) {
      try {
        // TODO: reemplaza por tu fetch real de conversaciones y re-render
        if (window.Chat && typeof window.Chat.reloadInbox === "function") {
          window.Chat.reloadInbox({ reason });
        } else if (typeof window.reloadInbox === "function") {
          window.reloadInbox({ reason });
        }
        // como fallback, podr√≠as disparar un CustomEvent que tu widget ya escuche
        window.dispatchEvent(new CustomEvent("gifters:inbox:refresh", { detail: { reason } }));
      } catch (e) { console.error("refreshInboxList failed", e); }
    }

    // Mensajes desde el Service Worker
    navigator.serviceWorker && navigator.serviceWorker.addEventListener("message", (event) => {
      const msg = event.data || {};
      if (msg.__kind !== "inbox_push") return;
      const payload = msg.payload || {};

      switch (payload.kind) {
        case "new_message": {
          if (Number(payload.conversacion_id) === Number(window.currentConvId)) {
            if (typeof window.loadMessagesOnce === "function") {
              window.loadMessagesOnce().then(() => {
                const el = document.getElementById("chatMessages");
                if (el) el.scrollTop = el.scrollHeight;
              });
            }
          } else {
            if (typeof window.hydratePreview === "function") {
              window.hydratePreview(payload.conversacion_id);
            }
          }
          refreshGlobalUnreadDot();
          break;
        }
        case "inbox_refresh":
        case "group_member_added":
        case "group_member_removed":
        case "group_left":
        case "group_removed":
        case "group_deleted":
          // Refresca la bandeja y/o la lista de miembros si la vista del grupo est√° abierta
          refreshInboxList(payload.kind);
          // Si est√°s parado en la sala de ese grupo, avisa para refrescar miembros:
          if (payload.conversacion_id && window.location.href.includes(`/chat/${payload.conversacion_id}`)) {
            window.dispatchEvent(new CustomEvent("gifters:group:members:refresh", {
              detail: { conversacion_id: payload.conversacion_id, reason: payload.kind }
            }));
          }
          break;
        // otros tipos: new_dm, new_group_msg, typing, etc.
        default:
          // noop
          break;
      }
    });



    // === Puntitos ===
    async function refreshGlobalUnreadDot() {
      try {
        const r = await fetch("/chat/unread-summary/", { credentials: "same-origin" });
        if (!r.ok) return;
        const { total, per_conversation } = await r.json();

        // Puntito del bot√≥n
        const dot = document.getElementById("chatGlobalDot");
        if (dot) dot.classList.toggle("hidden", !(total > 0));

        // Puntitos por conversaci√≥n
        if (window.Chat?.applyUnreadToInbox) {
          window.Chat.applyUnreadToInbox(per_conversation || {});
        }
        // üëâ NUEVO: puntitos por pesta√±a (Chats vs Grupos)
        const map = per_conversation || {};
        let unreadChats = 0, unreadGroups = 0;
        for (const [id, cnt] of Object.entries(map)) {
          if (!(cnt > 0)) continue;
          const sid = String(id);
          // si est√° en el √≠ndice de grupos => cuenta para grupos; si no, va a chats
          if (window.CHAT_INDEX?.groups?.has(sid)) unreadGroups += cnt;
          else unreadChats += cnt;
        }
        // Apagar/encender dots de tabs
        const tabChatsDot = document.getElementById("tabDotChats");
        const tabGroupsDot = document.getElementById("tabDotGrupos");
        if (tabChatsDot) tabChatsDot.classList.toggle("hidden", unreadChats === 0);
        if (tabGroupsDot) tabGroupsDot.classList.toggle("hidden", unreadGroups === 0);
      } catch (e) { console.error("unread-summary failed", e); }
    }
    // üîî Poll ligero global para el FAB (corre aunque nunca abras el caj√≥n)
    window.unreadLightPoll ??= null;
    document.addEventListener("DOMContentLoaded", () => {
      try { refreshGlobalUnreadDot(); } catch { }
      if (!window.unreadLightPoll) {
        window.unreadLightPoll = setInterval(() => {
          try { refreshGlobalUnreadDot(); } catch { }
        }, 3000); // 8s: r√°pido pero liviano
      }
    });

    window.Chat = window.Chat || {};

    // Aplica { conv_id: count } a cada √≠tem
    window.Chat.applyUnreadToInbox = function (perMap) {
      document.querySelectorAll(".chat-list-item").forEach(li => {
        const id =
          li.getAttribute("data-conv") ||
          li.getAttribute("data-conv-id") ||
          li.dataset.convId ||
          li.dataset.cid ||
          null;

        const dot = li.querySelector("[data-dot]");
        const cnt = id ? (perMap?.[String(id)] || 0) : 0;
        if (dot) dot.classList.toggle("hidden", !(cnt > 0));
      });
    };

    // Y actualiza clearUnreadDot para que funcione con ambos atributos
    window.Chat.clearUnreadDot = function (convId) {
      document
        .querySelectorAll(
          `.chat-list-item[data-conv="${convId}"], .chat-list-item[data-conv-id="${convId}"]`
        )
        .forEach(li => li.querySelector("[data-dot]")?.classList.add("hidden"));
    };
    // Marca como le√≠do al ENTRAR a la sala
    window.Chat.markConversationAsRead = async function (convId) {
      try {
        const r = await fetch(`/chat/${convId}/mark-read/`, {
          method: "POST",
          headers: { "X-CSRFToken": (window.CSRF_TOKEN || "") },
          credentials: "same-origin"
        });
        if (!r.ok) { console.warn("mark-read failed", r.status); return; }
        window.Chat.clearUnreadDot(convId);
        refreshGlobalUnreadDot();
      } catch (e) { console.error("mark-read failed", e); }
    };


    // Estado inicial
    document.addEventListener("DOMContentLoaded", refreshGlobalUnreadDot);
  </script>
  <script>
    (function () {
      const eventsEl = document.getElementById('eventsList');
      const actionsEl = document.getElementById('eventActions');
      const sortBtnBig = actionsEl ? actionsEl.querySelector('[data-action="draw-event"]') : null; // bot√≥n grande
      if (!eventsEl) return;

      function headerHTML() {
        return `
      <div class="d-flex justify-content-between align-items-center p-2">
        <span class="fw-semibold">Eventos</span>
        <button class="btn btn-sm btn-primary" id="btnCreateEvent"><i class="bi bi-plus-lg"></i> Crear evento</button>
      </div>`;
      }

      function renderEventsTabHeader() {
        // solo header; la lista se pinta abajo seg√∫n contexto (grupo abierto)
        if (!eventsEl) return;
        const existingHeader = eventsEl.querySelector('[data-role="events-header"]');
        if (existingHeader) existingHeader.remove();
        const hdr = document.createElement('div');
        hdr.setAttribute('data-role', 'events-header');
        hdr.innerHTML = headerHTML();
        eventsEl.prepend(hdr);
        eventsEl.querySelector('#btnCreateEvent')?.addEventListener('click', openCreateEventModal);
      }

      async function loadEventsInbox() {
        if (!eventsEl) return;
        // pide todas las conversaciones
        const r = await fetch(window.URLS.conversaciones, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
        if (!r.ok) { eventsEl.innerHTML = headerHTML() + '<div class="p-3 text-danger">No se pudieron cargar eventos.</div>'; return; }
        const data = await r.json();

        const eventos = (data || []).filter(c => String(c.tipo || '').toLowerCase() === 'evento');
        const rows = eventos.map(c => {
          const last = c.ultimo_mensaje || {};
          const prev = (last.tipo === 'imagen' || last.archivo_url) ? 'üì∑ Imagen' : String(last.contenido || '').slice(0, 72);
          const when = last.creado_en ? new Date(last.creado_en).toLocaleDateString() : '';
          const eventId = c.evento_id || c.id;
          return `
      <div class="chat-list-item d-flex justify-content-between align-items-center" 
           data-event-id="${eventId}" 
           data-conv-id="${c.conversacion_id}">
        <div class="chat-names">
          <div class="line1">${c.titulo || 'Amigo Secreto'}</div>
          <div class="line2">${c.estado || prev}</div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <div class="chat-time">${when}</div>
          ${c.estado !== 'sorteado' ? `<button class="btn btn-sm btn-warning" data-draw="${eventId}">Sortear</button>` : ''}
        </div>
      </div>`;
        }).join('');

        eventsEl.innerHTML = headerHTML() + `<div class="px-2">${rows || '<div class="p-3 text-muted">Sin eventos</div>'}</div>`;

        // Engancha los manejadores de eventos
        eventsEl.querySelector('#btnCreateEvent')?.addEventListener('click', openCreateEventModal);

        // Maneja clics en filas de eventos
        eventsEl.querySelectorAll('.chat-list-item[data-event-id]').forEach(row => {
          // Maneja el clic en la fila para abrir la conversaci√≥n
          row.addEventListener('click', () => {
            const cid = Number(row.dataset.convId);
            if (cid && typeof window.openConversation === 'function') window.openConversation(cid);
          });

          // Maneja el clic en el bot√≥n de sorteo
          const sortBtn = row.querySelector('[data-draw]');
          if (sortBtn) {
            sortBtn.addEventListener('click', async (e) => {
              e.stopPropagation(); // Evita que el clic se propague a la fila
              const eventId = Number(sortBtn.dataset.draw);
              if (!eventId) {
                alert('Error: event_id inv√°lido');
                return;
              }
              if (!confirm('¬øConfirmas realizar el sorteo?')) return;

              try {
                const url = window.URLS.eventoDraw.replace('/0/', `/${eventId}/`);
                const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                  document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
                const r = await fetch(url, {
                  method: 'POST',
                  credentials: 'same-origin',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf
                  }
                });

                if (!r.ok) {
                  const error = await r.json();
                  throw new Error(error.msg || 'Error al realizar el sorteo');
                }

                await loadEventsInbox(); // Recarga la lista de eventos
                if (typeof window.loadMessagesOnce === 'function') await window.loadMessagesOnce();
              } catch (error) {
                alert('Sorteo fall√≥: ' + error.message);
              }
            });
          }
        });

      }
      async function loadEventsForCurrentGroup() {
        // Si hay grupo abierto, listamos sus events (para ofrecer "Sortear" ah√≠).
        if (!window.currentConvId) {
          eventsEl.innerHTML = headerHTML() + '<div class="p-3 text-muted">Abre un grupo para ver sus eventos.</div>';
          eventsEl.querySelector('#btnCreateEvent')?.addEventListener('click', openCreateEventModal);
          return;
        }
        try {
          const url = window.URLS.eventosListCreate.replace('/0/', `/${window.currentConvId}/`);
          const r = await fetch(url, { credentials: 'same-origin' });
          if (!r.ok) throw 0;
          const j = await r.json();
          const list = Array.isArray(j.results) ? j.results : [];

          const rows = list.map(e => `
        <div class="chat-list-item d-flex justify-content-between align-items-center" data-event-id="${e.id}">
          <div class="chat-names">
            <div class="line1">${e.titulo || 'Amigo Secreto'}</div>
            <div class="line2">${e.estado}${e.presupuesto ? ' ‚Ä¢ $' + e.presupuesto : ''}</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <div class="chat-time">${new Date(e.creado_en).toLocaleDateString()}</div>
            ${e.estado !== 'sorteado' ? `<button class="btn btn-sm btn-warning" data-draw="${e.id}">Sortear</button>` : ''}
          </div>
        </div>
      `).join('');

          eventsEl.innerHTML = headerHTML() + `<div class="px-2">${rows || '<div class="p-3 text-muted">Sin eventos</div>'}</div>`;
          eventsEl.querySelector('#btnCreateEvent')?.addEventListener('click', openCreateEventModal);

          // üîπ Vincula filas ‚Üí bot√≥n grande
          if (typeof window.__wireEventRows === 'function') window.__wireEventRows();

          // üîπ Autoselecciona la primera fila para precargar el id en el bot√≥n grande
          const first = eventsEl.querySelector('.chat-list-item[data-event-id]');
          if (first) first.click();

          // Sorteo por fila
          eventsEl.querySelectorAll('[data-draw]')?.forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = Number(btn.dataset.draw);
              if (!id) {
                alert('Error: event_id inv√°lido');
                return;
              }
              if (!confirm('¬øConfirmas realizar el sorteo?')) return;
              try {
                const url = window.URLS.eventoDraw.replace('/0/', `/${id}/`);
                const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                  document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
                const r = await fetch(url, {
                  method: 'POST',
                  credentials: 'same-origin',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf
                  }
                });
                if (!r.ok) {
                  const error = await r.json();
                  throw new Error(error.msg || 'Error al realizar el sorteo');
                }
                await loadEventsForCurrentGroup();
                if (typeof window.loadMessagesOnce === 'function') await window.loadMessagesOnce();
              } catch (error) {
                alert('Sorteo fall√≥: ' + error.message);
              }
            });
          });
          // üîπ NUEVO: vincula las filas con el bot√≥n grande de la barra amarilla
          if (typeof window.__wireEventRows === 'function') window.__wireEventRows();
        } catch {
          eventsEl.innerHTML = headerHTML() + '<div class="p-3 text-danger">No se pudieron cargar eventos.</div>';
          eventsEl.querySelector('#btnCreateEvent')?.addEventListener('click', openCreateEventModal);
        }

      }

      Object.assign(window, {
        renderEventsTabHeader,
        loadEventsInbox,
        loadEventsForCurrentGroup
      });

      // ===== Modal Crear Evento (con amigos) =====
      function ensureCreateEventModal() {
        let m = document.getElementById('modalCrearEvento');
        if (m) return m;
        m = document.createElement('div');
        m.className = 'modal';
        m.id = 'modalCrearEvento';
        m.tabIndex = -1;
        m.innerHTML = `
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="formCrearEvento" autocomplete="off">
            <div class="modal-header">
              <h5 class="modal-title">Crear evento (Amigo Secreto)</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">
                <label class="form-label">T√≠tulo</label>
                <input type="text" class="form-control" name="titulo" placeholder="Ej: Amigo Secreto fin de a√±o" required>
              </div>
              <div class="mb-2">
                <label class="form-label">Monto estimado</label>
                <input type="number" class="form-control" name="monto" min="0" step="1" placeholder="Ej: 10000">
              </div>

              <hr class="my-2">
              <label class="form-label d-block">Participantes</label>
              <!-- Aqu√≠ se inyecta el picker -->
              <div id="eventFriendPicker"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Crear evento</button>
            </div>
          </form>
        </div>
      </div>`;
        document.body.appendChild(m);
        return m;
      }

      async function openCreateEventModal() {
        const modalEl = ensureCreateEventModal();

        // 1) Cargar amigos una sola vez y dibujar el picker
        try {
          await fetchFriendsForPicker();
          renderEventFriendPicker('eventFriendPicker');
        } catch (e) {
          console.error(e);
          alert('No pude cargar tus amigos.');
          return;
        }

        // 2) Abrir modal (Bootstrap o fallback)
        if (window.bootstrap?.Modal) {
          const bs = bootstrap.Modal.getOrCreateInstance(modalEl);
          bs.show();
        } else {
          modalEl.style.display = 'block';
          document.body.style.overflow = 'hidden';
        }

        // 3) Submit
        // dentro del mismo IIFE de Eventos
        const form = modalEl.querySelector('#formCrearEvento');
        form.onsubmit = async (ev) => {
          ev.preventDefault();

          const titulo = form.querySelector('[name="titulo"]').value.trim();
          const montoStr = form.querySelector('[name="monto"]').value.trim();
          const presupuesto_fijo = montoStr ? Number(montoStr) : null;

          const miembros = getSelectedFriendIds('eventFriendPicker'); // IDs de usuario
          if (!titulo) return alert('Escribe un t√≠tulo.');
          if (!miembros.length) return alert('Selecciona al menos 1 amigo.');

          try {
            const r = await fetch(window.URLS.eventCreateWithChat, {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'Content-Type': 'application/json', 'X-CSRFToken': (window.CSRF_TOKEN || '') },
              body: JSON.stringify({ titulo, presupuesto_fijo, miembros })
            });
            if (!r.ok) throw new Error('HTTP ' + r.status);
            const j = await r.json();

            // cierra el modal
            if (window.bootstrap?.Modal) bootstrap.Modal.getOrCreateInstance(modalEl).hide();
            else { modalEl.style.display = 'none'; document.body.style.overflow = ''; }

            // üëâ Abre la conversaci√≥n del evento y activa la pesta√±a "Eventos"
            if (j?.conversacion_id && typeof window.openConversation === 'function') {
              await window.openConversation(j.conversacion_id);
            }
            const btnEventos = document.querySelector('.phone-tabs .tab-btn[data-tab="eventos"]');
            btnEventos?.click();
          } catch (e) {
            console.error(e);
            alert('Error al crear el evento.');
          }
        };
      }

      // Exponer helpers al √°mbito del drawer
      Object.assign(window, {
        renderEventsTabHeader,
        loadEventsForCurrentGroup,
        openCreateEventModal
      });
    })();

  </script>



  <script>
    // Cache de amigos para reusar
    window._friendsCache = window._friendsCache || null;

    async function fetchFriendsForPicker() {
      if (Array.isArray(window._friendsCache) && window._friendsCache.length) return window._friendsCache;
      const r = await fetch(window.URLS.amigos, { credentials: 'same-origin', headers: { Accept: 'application/json' } });
      if (!r.ok) throw new Error('No pude cargar amigos (HTTP ' + r.status + ')');
      const data = await r.json();
      const list = (data?.amigos || data || []).map(a => ({
        id: Number(a.id ?? a.user_id ?? a.pk),
        nombre: a.nombre_completo
          ?? [a.nombre, a.apellido].filter(Boolean).join(' ')
          ?? a.display_name ?? a.username ?? a.nombre_usuario ?? 'Amigo',
        avatar: a.avatar_url || a.avatar || a.foto_url || a.foto || null,
      })).filter(x => Number.isFinite(x.id));
      window._friendsCache = list;
      return list;
    }

    function renderEventFriendPicker(containerId, preselected = []) {
      const cont = document.getElementById(containerId);
      if (!cont) return;
      cont.innerHTML = '';

      const friends = window._friendsCache || [];
      if (!friends.length) { cont.innerHTML = '<div class="text-muted small">Sin amigos.</div>'; return; }

      const search = document.createElement('input');
      search.type = 'search';
      search.className = 'form-control form-control-sm mb-2';
      search.placeholder = 'Buscar amigo‚Ä¶';
      cont.appendChild(search);

      const list = document.createElement('div');
      list.className = 'list-group list-group-flush';
      cont.appendChild(list);

      const draw = (term = '') => {
        list.innerHTML = '';
        const t = term.trim().toLowerCase();
        friends
          .filter(f => !t || (f.nombre || '').toLowerCase().includes(t))
          .forEach(f => {
            const row = document.createElement('label');
            row.className = 'list-group-item d-flex align-items-center gap-2';
            row.style.cursor = 'pointer';

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'form-check-input me-2';
            cb.value = String(f.id);
            if (preselected.includes(f.id)) cb.checked = true;

            const avatar = document.createElement('img');
            avatar.src = f.avatar || '{% static "img/Gifters/user-default.png" %}';
            avatar.width = 24; avatar.height = 24;
            avatar.className = 'rounded-circle';

            const name = document.createElement('span');
            name.textContent = f.nombre;

            row.append(cb, avatar, name);
            list.appendChild(row);
          });
      };
      search.addEventListener('input', () => draw(search.value));
      draw();
    }

    function getSelectedFriendIds(containerId) {
      const cont = document.getElementById(containerId);
      if (!cont) return [];
      return Array.from(cont.querySelectorAll('input[type="checkbox"]:checked'))
        .map(i => Number(i.value))
        .filter(Number.isFinite);
    }
  </script>

















  <!-- 1) BADGE √öNICO ‚Äî crea/actualiza y observa cambios -->
  <script>
    /* ===== BADGE √öNICO ‚Äî crea/actualiza y observa cambios ===== */
    (function () {
      const TOGGLE_ID = 'notifDropdown';
      const BADGE_ID = 'notifBadge';
      const MENU = document.querySelector('ul.dropdown-menu[aria-labelledby="notifDropdown"]');
      const MARK_ALL_BTN = document.getElementById('markAllBtn');

      function ensureBadge() {
        let badge = document.getElementById(BADGE_ID);
        if (badge) return badge;

        const toggle = document.getElementById(TOGGLE_ID);
        if (!toggle) return null;

        badge = document.createElement('span');
        badge.id = BADGE_ID;
        badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none';
        badge.style.fontSize = '.7rem';
        // n√∫mero (texto) + etiqueta sr
        badge.appendChild(document.createTextNode('0'));
        const sr = document.createElement('span');
        sr.className = 'visually-hidden';
        sr.textContent = 'unread';
        badge.appendChild(sr);

        toggle.appendChild(badge);
        return badge;
      }

      function setMarkAllVisibility(n) {
        if (!MARK_ALL_BTN) return;
        MARK_ALL_BTN.classList.toggle('d-none', n <= 0);
      }

      // expone API global: tambi√©n crea badge si falta
      window.setBadge = function (count) {
        const badge = ensureBadge();
        if (!badge) return;
        const n = Math.max(0, parseInt(count || 0, 10));

        // actualiza el n√∫mero (primer nodo de texto del badge)
        if (badge.firstChild && badge.firstChild.nodeType === Node.TEXT_NODE) {
          badge.firstChild.nodeValue = String(n);
        } else {
          badge.insertBefore(document.createTextNode(String(n)), badge.firstChild || null);
        }

        if (n > 0) badge.classList.remove('d-none');
        else badge.classList.add('d-none');

        setMarkAllVisibility(n);
      };

      // contar no le√≠das visibles desde el DOM
      function countUnreadVisible() {
        if (!MENU) return 0;
        const items = MENU.querySelectorAll('.notif-item.fw-semibold');
        let total = 0;
        items.forEach(it => {
          const li = it.closest('li');
          if (!(li && li.classList.contains('d-none')) && !it.classList.contains('d-none')) total++;
        });
        return total;
      }

      // recalcula desde el DOM (para cuando no hay respuesta del server)
      function refreshFromDom() {
        window.setBadge(countUnreadVisible());
      }

      // inicial: crea/oculta badge si falta y calcula desde DOM
      document.addEventListener('DOMContentLoaded', function () {
        ensureBadge();            // crea si no exist√≠a (cuando notif_count==0)
        refreshFromDom();         // sincroniza con lo que se ve
      });

      // tambi√©n al abrir el dropdown (por si el contenido cambi√≥)
      document.getElementById(TOGGLE_ID)?.addEventListener('click', () => {
        setTimeout(refreshFromDom, 0);
      });

      // observa cambios en la lista/clases
      if (MENU) {
        const mo = new MutationObserver(refreshFromDom);
        mo.observe(MENU, { childList: true, subtree: true, attributes: true, attributeFilter: ['class'] });
      }

      // clicks que cambian estado ‚Üí refresco peque√±o
      document.addEventListener('click', (e) => {
        if (e.target.closest('.js-notif-mark-one') ||
          e.target.closest('.js-notif-dismiss') ||
          e.target.closest('#hideReadBtn') ||
          e.target.closest('#hideAllBtn') ||
          e.target.closest('#restoreHiddenBtn') ||
          e.target.closest('#markAllBtn')) {
          setTimeout(refreshFromDom, 40);
        }
      });
    })();
  </script>

  <!-- 2) Helper global para el spinner del bot√≥n ‚úì -->
  <script>
    // Helper global para el spinner del bot√≥n ‚úì
    function showLoading(btn, on) {
      if (!btn) return;
      if (on) {
        btn.dataset._html = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
      } else {
        btn.disabled = false;
        if (btn.dataset._html) btn.innerHTML = btn.dataset._html;
      }
    }
  </script>

  <!-- 3) helpers/fallbacks globales + handler "marcar una (‚úì)" -->
  <script>
    (function () {
      // --- helpers/fallbacks globales (no duplican si ya existen) ---
      if (typeof window.getCookie !== 'function') {
        window.getCookie = function (name) {
          const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
          return m ? m.pop() : '';
        };
      }
      if (typeof window.csrftoken === 'undefined') {
        window.csrftoken = window.getCookie('csrftoken');
      }
      if (typeof window.showLoading !== 'function') {
        window.showLoading = function (btn, on) {
          if (!btn) return;
          if (on) {
            btn.dataset._html = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
          } else {
            btn.disabled = false;
            if (btn.dataset._html) btn.innerHTML = btn.dataset._html;
          }
        };
      }

      // --- plantilla de URL con placeholder ENTERO (evita NoReverseMatch) ---
      const markOneTpl = "{% url 'notificacion_mark_one' 0 %}";

      // --- handler √∫nico: marcar UNA (‚úì) ---
      document.addEventListener('click', function (e) {
        const btn = e.target.closest('.js-notif-mark-one');
        if (!btn) return;

        e.preventDefault();
        const id = btn.getAttribute('data-id') || btn.closest('.dropdown-item')?.getAttribute('data-id');
        if (!id || btn.disabled) return;

        // construye la URL reemplazando /0/ por el id real
        const url = markOneTpl.replace('/0/', '/' + encodeURIComponent(id) + '/');
        console.log('[notif] POST mark-one', { id, url });

        showLoading(btn, true);

        fetch(url, {
          method: 'POST',
          headers: { 'X-CSRFToken': window.csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
          credentials: 'same-origin',
          keepalive: true
        })
          .then(async (r) => {
            console.log('[notif] response', r.status, r.statusText);
            if (!r.ok) {
              const text = await r.text().catch(() => '');
              console.warn('[notif] body(non-OK)=', text.slice(0, 300));
              throw new Error('non-ok');
            }
            return r.json();
          })
          .then((data) => {
            console.log('[notif] json', data);

            // si tienes setBadge y el server env√≠a unread_count, actualiza el badge
            if (typeof window.setBadge === 'function' && typeof data.unread_count !== 'undefined') {
              window.setBadge(data.unread_count);
            }

            // limpia UI del item
            const item = btn.closest('.dropdown-item');
            if (item) item.classList.remove('fw-semibold');
            const pill = item ? item.querySelector('.badge.bg-primary') : null;
            if (pill) pill.remove();
            btn.remove();

            // mostrar/ocultar "Marcar todo" si tienes toggleMarkAll
            if (typeof window.toggleMarkAll === 'function') {
              window.toggleMarkAll();
            }
          })
          .catch((err) => {
            console.error('[notif] FAIL mark-one', err);
            showLoading(btn, false); // no tocamos el DOM si falla
          });
      });
    })();
  </script>

  <!-- 4) Marcar TODO le√≠do (CSRF + badge + toggleMarkAll) -->
  <script>
    (function () {
      // === CSRF (√∫nico) ===
      function getCookie(name) {
        const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return m ? m.pop() : '';
      }
      const csrftoken = getCookie('csrftoken');
      const badgeEl = document.getElementById('notifBadge'); // ‚úÖ NECESARIO

      // === Mostrar/Ocultar "Marcar todo le√≠do" seg√∫n el badge ===
      const markAllBtn = document.getElementById('markAllBtn');
      function currentUnread() {
        if (!badgeEl) return 0;
        const n = parseInt((badgeEl.textContent || '0').trim(), 10);
        return isNaN(n) ? 0 : Math.max(0, n);
      }
      function toggleMarkAll() {
        if (!markAllBtn) return;
        markAllBtn.classList.toggle('d-none', currentUnread() === 0);
      }
      // Estado inicial + observar cambios de badge
      toggleMarkAll();
      if (badgeEl) {
        const mo = new MutationObserver(toggleMarkAll);
        mo.observe(badgeEl, { childList: true, characterData: true, subtree: true });
      }

      // === UX helpers ===
      function showLoading(btn, on) {
        if (!btn) return;
        if (on) {
          btn.dataset._html = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        } else {
          btn.disabled = false;
          if (btn.dataset._html) btn.innerHTML = btn.dataset._html;
        }
      }

      // === Marcar TODO ‚Äî robusto ===
      if (markAllBtn) {
        markAllBtn.addEventListener('click', function (e) {
          e.preventDefault();
          if (markAllBtn.disabled) return;

          const original = markAllBtn.innerHTML;
          markAllBtn.disabled = true;
          markAllBtn.innerHTML = 'Marcando‚Ä¶';

          fetch("{% url 'notificaciones_mark_all' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
            keepalive: true
          })
            .then(r => r.ok ? r.json() : Promise.reject())
            .then(data => {
              // Preferimos el valor del servidor; si no llega, 0
              window.setBadge && window.setBadge(typeof data.unread_count !== 'undefined' ? data.unread_count : 0);

              // Limpieza visual
              document.querySelectorAll('.dropdown-item.fw-semibold').forEach(el => el.classList.remove('fw-semibold'));
              document.querySelectorAll('.js-notif-mark-one').forEach(b => b.remove());
              document.querySelectorAll('.badge.bg-primary').forEach(p => p.remove());

              toggleMarkAll();
            })
            .catch(() => {
              // Si falla, no cambiamos el DOM
            })
            .finally(() => {
              markAllBtn.disabled = false;
              markAllBtn.innerHTML = original;
            });
        });
      }
    })();
  </script>

  <!-- 5) IIFE showLoading (deja igual, usa la global si existe) -->
  <script>
    (function () {
      function showLoading(btn, on) {
        if (!btn) return;
        if (on) {
          btn.dataset._html = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        } else {
          btn.disabled = false;
          if (btn.dataset._html) btn.innerHTML = btn.dataset._html;
        }
      }
      // (deja el resto de tu script tal cual, usando showLoading)
    })();
  </script>

  <!-- 6) NOTIFICACIONES ‚Äî Ocultar en vista (sin borrar BD) -->
  <script>
    /* =========================================================
       NOTIFICACIONES ‚Äî Ocultar en vista (sin borrar BD)
       Guarda IDs ocultos en localStorage y los aplica al abrir.
       Controles:
         - ‚Äú√ó‚Äù en cada item => oculta uno
         - ‚ÄúOcultar le√≠das‚Äù => oculta los que no est√°n en negrita
         - ‚ÄúLimpiar lista‚Äù  => oculta todos
         - ‚ÄúRestaurar‚Äù      => muestra todo de nuevo
       ========================================================= */
    (function () {
      const STORAGE_KEY = 'notif_hidden_ids_v1';

      function loadHidden() {
        try { return new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]')); }
        catch { return new Set(); }
      }
      function saveHidden(set) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify([...set]));
      }

      function hideItemEl(li) {
        if (!li) return;
        li.classList.add('d-none');
      }
      function showItemEl(li) {
        if (!li) return;
        li.classList.remove('d-none');
      }

      // Aplica ocultos actuales al DOM
      function applyHiddenToDOM() {
        const hidden = loadHidden();
        document.querySelectorAll('.dropdown-menu .notif-item').forEach(item => {
          const id = item.getAttribute('data-id') || item.querySelector('[data-id]')?.getAttribute('data-id');
          if (!id) return;
          if (hidden.has(String(id))) hideItemEl(item.closest('li') || item);
          else showItemEl(item.closest('li') || item);
        });
      }

      // Oculta UNA por id (y guarda)
      function hideOneById(id, li) {
        if (!id) return;
        const hidden = loadHidden();
        hidden.add(String(id));
        saveHidden(hidden);
        hideItemEl(li);
      }

      // Handlers de los botones del header
      const hideReadBtn = document.getElementById('hideReadBtn');
      const hideAllBtn = document.getElementById('hideAllBtn');
      const restoreBtn = document.getElementById('restoreHiddenBtn');

      if (hideReadBtn) {
        hideReadBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const hidden = loadHidden();
          document.querySelectorAll('.dropdown-menu .notif-item').forEach(item => {
            const li = item.closest('li') || item;
            const id = item.getAttribute('data-id') || item.querySelector('[data-id]')?.getAttribute('data-id');
            const isUnread = item.classList.contains('fw-semibold') || !!item.querySelector('.badge.bg-primary');
            if (!id || isUnread) return;   // solo le√≠das
            hidden.add(String(id));
            hideItemEl(li);
          });
          saveHidden(hidden);
        });
      }

      if (hideAllBtn) {
        hideAllBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const hidden = loadHidden();
          document.querySelectorAll('.dropdown-menu .notif-item').forEach(item => {
            const li = item.closest('li') || item;
            const id = item.getAttribute('data-id') || item.querySelector('[data-id]')?.getAttribute('data-id');
            if (!id) return;
            hidden.add(String(id));
            hideItemEl(li);
          });
          saveHidden(hidden);
        });
      }

      if (restoreBtn) {
        restoreBtn.addEventListener('click', (e) => {
          e.preventDefault();
          localStorage.removeItem(STORAGE_KEY);
          document.querySelectorAll('.dropdown-menu .notif-item').forEach(item => {
            showItemEl(item.closest('li') || item);
          });
        });
      }

      // Bot√≥n ‚Äú√ó‚Äù en cada item
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.js-notif-dismiss');
        if (!btn) return;

        e.preventDefault();
        const id = btn.getAttribute('data-id')
          || btn.closest('.notif-item')?.getAttribute('data-id');
        const li = btn.closest('li') || btn.closest('.notif-item');

        // Si la que ocultas est√° NO le√≠da, intenta marcarla le√≠da primero para mantener el badge coherente.
        const item = btn.closest('.notif-item');
        const isUnread = item && (item.classList.contains('fw-semibold') || item.querySelector('.badge.bg-primary'));
        const markBtn = item && item.querySelector('.js-notif-mark-one');

        if (isUnread && markBtn) {
          // Reutiliza el flujo de ‚Äúmarcar una‚Äù: dispara el click al ‚úì
          markBtn.click();
          // (El badge se actualizar√° con tu l√≥gica actual)
          // Oculta visualmente ya:
          hideOneById(id, li);
        } else {
          hideOneById(id, li);
        }
      });

      // Ejecuta cuando el men√∫ exista en DOM (por si se renderiza luego)
      document.addEventListener('DOMContentLoaded', applyHiddenToDOM);
      // Y tambi√©n al abrir el dropdown (por si cambi√≥ el contenido)
      document.getElementById('notifDropdown')?.addEventListener('click', () => {
        // peque√±o delay para asegurar que el men√∫ est√© en el DOM
        setTimeout(applyHiddenToDOM, 0);
      });
    })();
  </script>












  <!-- -->
  <!-- -->
  <!-- -->
  <!-- -->








  <script>
    (function () {
      // === Helper para obtener el token CSRF desde las cookies ===
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      // === Funci√≥n que realiza el POST del sorteo ===
      async function drawEvent(eventId) {
        const url = `/api/events/${eventId}/draw/`; // aseg√∫rate que coincida con tu urls.py
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({}) // no enviamos nada, solo usamos el ID
        });

        let data = null;
        try {
          data = await response.json();
        } catch (e) { }

        if (!response.ok) {
          const msg = (data && data.error) ? data.error : `Error ${response.status} al sortear`;
          throw new Error(msg);
        }
        return data;
      }

      // === Vinculamos el bot√≥n Sortear ===
      document.addEventListener('click', async (ev) => {
        const btn = ev.target.closest('[data-action="draw-event"]');
        if (!btn) return;

        const eventId = btn.getAttribute('data-event-id');
        // Validaci√≥n m√°s estricta: evita enviar 'undefined' o valores no num√©ricos
        if (!eventId || eventId === 'undefined' || isNaN(Number(eventId))) {
          console.warn('‚ö†Ô∏è data-event-id inv√°lido en el bot√≥n Sortear:', eventId);
          // Mostrar una advertencia amigable al usuario y evitar la petici√≥n
          alert('ID de evento inv√°lido en el cliente. Por favor recarga la p√°gina e intenta nuevamente.');
          return;
        }

        btn.disabled = true;
        const oldText = btn.textContent;
        btn.textContent = 'Sorteando...';

        try {
          const result = await drawEvent(eventId);
          console.log('‚úÖ Sorteo realizado:', result);
          alert(`Sorteo completado correctamente con ${result.count} participantes.`);
          // Aqu√≠ puedes actualizar tu lista de eventos o emitir un evento DOM si lo necesitas:
          document.dispatchEvent(new CustomEvent('gifters:event-sorteado', { detail: result }));
        } catch (err) {
          console.error(err);
          alert(err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = oldText;
        }
      });
    })();

    (function () {
      const drawer = document.getElementById('globalChatDrawer');
      if (!drawer) return;

      const eventsEl = drawer.querySelector('#eventsList');      // lista izquierda
      const actionsEl = drawer.querySelector('#eventActions');    // barra amarilla
      const sortBtnBig = actionsEl ? actionsEl.querySelector('[data-action="draw-event"]') : null;

      // 1) Cuando se renderiza la lista de eventos, enganchamos el click de cada fila
      //    para cargar el id en el bot√≥n grande y mostrar la barra amarilla.
      function wireEventRows() {
        if (!eventsEl) return;
        // filas con data-event-id (las renderizas en tu map(...))
        eventsEl.querySelectorAll('.chat-list-item[data-event-id]').forEach(row => {
          row.addEventListener('click', () => {
            const id = row.getAttribute('data-event-id');
            if (!id || !sortBtnBig || !actionsEl) return;
            sortBtnBig.setAttribute('data-event-id', id);
            actionsEl.style.display = 'flex'; // muestra la barra amarilla
          });
        });

        // Si hay al menos una fila, precarga el id en el bot√≥n grande para evitar
        // que el usuario tenga que hacer click en la fila antes de poder sortear.
        // Esto tambi√©n cubre escenarios donde la lista se renderiza pero no se
        // dispara un `click` en la fila (p. ej. navegaci√≥n r√°pida).
        try {
          const firstRow = eventsEl.querySelector('.chat-list-item[data-event-id]');
          if (firstRow && sortBtnBig && actionsEl) {
            const firstId = firstRow.getAttribute('data-event-id');
            if (firstId) {
              sortBtnBig.setAttribute('data-event-id', firstId);
              // no forzamos mostrar la barra amarilla aqu√≠, solo pre-cargamos el id
            }
          }
        } catch (err) {
          // no rompemos la UI por este paso adicional
          console.warn('wireEventRows: no pude precargar id en bot√≥n grande', err);
        }
      }

      // 2) Llama a wireEventRows() justo DESPU√âS de que termines de inyectar
      //    el HTML de la lista de eventos (tras tu `eventsEl.innerHTML = ...`).
      //    Ejemplo: al final de loadEventsInbox() y/o loadEventsForCurrentGroup():
      //      wireEventRows();

      sortBtnBig?.addEventListener('click', async (ev) => {
        const btn = ev.currentTarget;
        const rawId = btn.getAttribute('data-event-id');
        const eventIdNum = parseInt(rawId, 10);
        if (!Number.isInteger(eventIdNum) || eventIdNum <= 0) {
          console.warn('‚ö†Ô∏è data-event-id inv√°lido en el bot√≥n Sortear:', rawId);
          alert('Selecciona un evento v√°lido antes de sortear.');
          return;
        }

        btn.disabled = true;
        const oldText = btn.textContent;
        btn.textContent = 'Sorteando...';

        try {
          const url = `/api/events/${eventIdNum}/draw/`;
          const r = await fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'X-CSRFToken': (window.CSRF_TOKEN || '') }
          });
          if (!r.ok) throw new Error('draw-failed');

          if (typeof window.loadEventsForCurrentGroup === 'function') {
            await window.loadEventsForCurrentGroup();
          }
          if (typeof window.loadMessagesOnce === 'function') {
            await window.loadMessagesOnce();
          }
        } catch (e) {
          console.error('‚ùå Error al sortear', e);
          alert('No se pudo realizar el sorteo.');
        } finally {
          btn.disabled = false;
          btn.textContent = oldText;
        }
      });
      drawer.addEventListener('click', async (ev) => {
        const btn = ev.target.closest('[data-action="draw-event"]');
        if (!btn) return;

        const rawId = btn.getAttribute('data-event-id');
        const eventIdNum = parseInt(rawId, 10);
        if (!Number.isInteger(eventIdNum) || eventIdNum <= 0) {
          console.warn('‚ö†Ô∏è data-event-id inv√°lido en el bot√≥n Sortear:', rawId);
          alert('Selecciona un evento v√°lido antes de sortear.');
          return;
        }

        btn.disabled = true;
        const oldText = btn.textContent;
        btn.textContent = 'Sorteando...';

        try {
          // URL can√≥nica sin depender de /0/
          const url = `/api/events/${eventIdNum}/draw/`;

          const r = await fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'X-CSRFToken': (window.CSRF_TOKEN || '')
            }
          });

          if (!r.ok) throw new Error('draw-failed');

          if (typeof window.loadEventsForCurrentGroup === 'function') {
            await window.loadEventsForCurrentGroup();
          }
          if (typeof window.loadMessagesOnce === 'function') {
            await window.loadMessagesOnce();
          }
        } catch (e) {
          console.error('‚ùå Error al sortear', e);
          alert('No se pudo realizar el sorteo.');
        } finally {
          btn.disabled = false;
          btn.textContent = oldText;
        }
      });

      // Exp√≥n la funci√≥n para que la llames despu√©s de pintar la lista:
      window.__wireEventRows = wireEventRows;
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

</html>