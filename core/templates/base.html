{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>{% block title %}Gifter’s{% endblock %}</title>

  <!-- Favicons -->
  <link rel="icon" href="{% static 'img/Gifters/favicongift.png' %}" type="image/png" />
  <link rel="apple-touch-icon" href="{% static 'img/Gifters/logo-sin-letras.png' %}" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;900&display=swap" rel="stylesheet" />

  <!-- Vendor CSS (via STATIC_URL=/assets/) -->
  <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet" />
  <link href="{% static 'vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet" />
  <link href="{% static 'vendor/aos/aos.css' %}" rel="stylesheet" />
  <link href="{% static 'vendor/glightbox/css/glightbox.min.css' %}" rel="stylesheet" />
  <link href="{% static 'vendor/swiper/swiper-bundle.min.css' %}" rel="stylesheet" />

  <!-- Main CSS -->
  <link href="{% static 'css/main.css' %}" rel="stylesheet" />
  <link href="{% static 'css/gifters.css' %}" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/chat-floating.css' %}" />

  <style>
    /* Poppins global */
    body,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p,
    a,
    button {
      font-family: 'Poppins', sans-serif !important;
    }

    .logo-img {
      height: 64px;
      width: auto;
      display: block;
    }

    .login-btn-standalone {
      display: inline-block;
      padding: .55rem 1rem;
      border-radius: 999px;
      background: #1970ea;
      color: #fff;
      text-decoration: none;
      font-weight: 700;
    }

    .login-btn-standalone:hover {
      filter: brightness(.92);
      color: #fff;
    }

    /* Oculta los mensajes Bootstrap clásicos */
    #flash-messages,
    .messages,
    .django-messages,
    .alert[role="alert"][data-django-message] {
      display: none !important;
    }
  </style>

  <style>
    /* ===== Drawer: estilo "teléfono" ===== */
    .chat-drawer.phone-ui {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 100%;
      max-width: 920px;
      height: 70vh;
      border-radius: 16px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 12px 32px rgba(0, 0, 0, .18);
      transform: translateY(8px);
      opacity: 0;
      pointer-events: none;
      transition: transform .25s ease, opacity .25s ease;
      display: flex;
      flex-direction: column;
    }

    .chat-drawer.phone-ui.open {
      transform: none;
      opacity: 1;
      pointer-events: auto;
    }

    .phone-header {
      background: #0d6efd;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
    }

    .phone-header .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
    }

    .phone-header .brand img {
      width: 28px;
      height: 28px;
      display: block;
    }

    .phone-tabs {
      display: flex;
      gap: 8px;
      padding: 10px;
      border-bottom: 1px solid #eef1f5;
      background: #f8fafc;
    }

    .phone-tabs .tab-btn {
      appearance: none;
      border: 1px solid #e5e7eb;
      background: #fff;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 600;
      font-size: .95rem;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .phone-tabs .tab-btn.active {
      border-color: #0d6efd;
      color: #0d6efd;
    }

    .phone-body {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 0;
      height: 100%;
      min-height: 0;
      /* para que flexbox/grid permitan scroll interno */
    }

    .phone-list {
      border-right: 1px solid #eef1f5;
      overflow: auto;
    }

    .list-pane {
      display: none;
      height: 100%;
    }

    .list-pane.active {
      display: block;
    }

    .phone-chat {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .chat-head,
    .chat-input {
      border-top: 1px solid #eef1f5;
    }

    .chat-messages {
      flex: 1;
      overflow: auto;
      padding: 16px;
      background: #fbfbfd;
    }

    /* Lista reusando tu markup existente */
    .chat-list {
      padding: 8px;
    }

    .chat-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
    }

    .chat-list-item:hover {
      background: #f4f6fb;
    }

    .chat-list-item.active {
      background: #ecf2ff;
    }

    .chat-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      object-fit: cover;
    }

    .chat-names .line1 {
      font-weight: 700;
    }

    .chat-names .line2 {
      font-size: .9rem;
      color: #6b7280;
    }

    .chat-time {
      margin-left: auto;
      font-size: .8rem;
      color: #9ca3af;
    }

    /* Burbujas (respetando tus IDs/estructura) */
    .msg {
      display: flex;
      gap: 8px;
      margin: 6px 0;
      align-items: flex-end;
    }

    .msg.me {
      justify-content: flex-end;
    }

    .msg-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
    }

    .bubble,
    .msg-bubble {
      max-width: 72%;
      padding: 10px 12px;
      border-radius: 14px;
      background: #fff;
      border: 1px solid #eef1f5;
    }

    .msg.me .bubble,
    .msg.me .msg-bubble {
      background: #e8f0ff;
      border-color: #dae6ff;
    }

    .body,
    .msg-body {
      white-space: pre-wrap;
      word-break: break-word;
    }

    .meta,
    .msg-meta {
      font-size: .75rem;
      color: #9ca3af;
      margin-top: 4px;
      text-align: right;
    }

    .chat-input {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: #fff;
    }

    #chatText {
      flex: 1;
      resize: none;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }

    #chatForm button {
      padding: 10px 14px;
      border-radius: 12px;
      border: none;
      background: #0d6efd;
      color: #fff;
      font-weight: 700;
    }

    /* Bottom nav (móvil) */
    .phone-bottom-nav {
      display: none;
      border-top: 1px solid #eef1f5;
      background: #fff;
      padding: 6px 10px;
      gap: 10px;
    }

    .phone-bottom-nav .tab-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      border: none;
      background: transparent;
      padding: 6px 8px;
      font-weight: 600;
      color: #6b7280;
    }

    .phone-bottom-nav .tab-btn.active {
      color: #0d6efd;
    }

    /* Responsivo: en pantallas chicas, lista arriba y chat abajo (tipo app) */
    @media (max-width: 860px) {
      .chat-drawer.phone-ui {
        right: 10px;
        left: 10px;
        height: 80vh;
      }

      .phone-body {
        grid-template-columns: 1fr;
      }

      .phone-bottom-nav {
        display: flex;
      }

      .phone-list {
        height: 45%;
      }

      .phone-chat {
        height: 55%;
        border-top: 1px solid #eef1f5;
      }
    }

    /* Avatar arriba para ambos lados */
    .msg {
      align-items: flex-start;
    }

    .msg.me {
      flex-direction: row-reverse;
      align-items: flex-start;
    }

    .msg .msg-avatar {
      align-self: flex-start;
    }

    /* Cuando NO mostramos avatar, damos margen para que la burbuja no “salte” */
    .msg.other.compact .bubble {
      margin-left: 36px;
    }

    /* 28px avatar + 8px gap */
    .msg.me.compact .bubble {
      margin-right: 36px;
    }

    /* Separador de día */
    .day-sep {
      text-align: center;
      font-size: .85rem;
      font-style: italic;
      color: #6b7280;
      margin: 14px 0;
    }


    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      margin: 0 12px 6px;
      border-radius: 12px;
      background: #f5f7ff;
      color: #4b5563;
      font-size: .9rem;
    }

    .typing-indicator .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #9aa7ff;
      display: inline-block;
      animation: blink 1.2s infinite ease-in-out;
    }

    .typing-indicator .dot:nth-child(1) {
      animation-delay: 0s
    }

    .typing-indicator .dot:nth-child(2) {
      animation-delay: .2s
    }

    .typing-indicator .dot:nth-child(3) {
      animation-delay: .4s
    }

    @keyframes blink {

      0%,
      80%,
      100% {
        opacity: .2
      }

      40% {
        opacity: 1
      }
    }

    /* Asegura que el área derecha sea una columna con el input al final */
    .chat-pane {
      display: flex;
      flex-direction: column;
    }

    /* El listado scrollea, el resto queda debajo */
    .chat-messages {
      flex: 1;
      overflow: auto;
    }

    /* El indicador queda justo encima del input, sin scrollearse */
    #typingIndicator {
      position: sticky;
      /* queda “pegado” dentro de su contenedor */
      bottom: 0;
      /* pegado abajo */
      z-index: 1;
      /* por encima del fondo */
      margin-top: 0;
      margin-bottom: 6px;
    }

    .bubble img.msg-image {
      max-width: 100%;
      height: auto;
      display: block;
      border-radius: 10px;
    }

    /* ——— Sugerencias (dropdown) ——— */
    .sugerencias-container {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 4000;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .08);
      margin-top: 6px;
      display: none;
      overflow: hidden;
      max-height: 360px;
      overflow-y: auto;
    }

    /* Portal que pintas en <body> (pegado al buscador) */
    #sugerenciasPortal {
      position: fixed;
      /* ya lo usas para evitar recortes */
      border: 1.5px solid #0d6efd;
      /* mismo color que el pill */
      border-top: none;
      /* se “funde” con el borde inferior del pill */
      background: #fff;
      border-bottom-left-radius: 14px;
      border-bottom-right-radius: 14px;
      margin-top: -2px !important;
      /* elimina la grieta de 1–2px */
      box-shadow: 0 12px 22px rgba(0, 0, 0, .08);
      max-height: 360px;
      overflow-y: auto;
    }

    /* Ítems de sugerencia */
    .sug-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      cursor: pointer;
    }

    .sug-item:hover,
    .sug-item.active {
      background: #f5f7ff;
    }

    .sug-type {
      font-size: .75rem;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: .03em;
    }

    .sug-text {
      font-weight: 600;
    }

    .sug-meta {
      font-size: .85rem;
      color: #6b7280;
      margin-left: auto;
    }

    /* Evita que contenedores recorten el dropdown */
    .branding,
    .brand-left,
    .search-pill {
      overflow: visible !important;
    }

    /* ——— Pill del buscador ——— */
    .site-search {
      position: relative;
    }

    .site-search *:focus,
    .site-search *:focus-visible {
      outline: none !important;
    }

    /* mata halos nativos dentro del form */

    .search-pill {
      display: flex;
      align-items: center;
      height: 44px;
      /* altura consistente */
      border: 1.5px solid #0d6efd;
      border-radius: 999px;
      overflow: hidden;
      /* recorta cualquier “desfase” interior */
      background: #fff;
      box-sizing: border-box;
    }

    /* Input sin bordes/sombras/ornamentos nativos */
    .search-pill .search-input {
      flex: 1;
      height: 100%;
      padding: 0 .95rem;
      font-size: 1rem;
      line-height: 1;
      border: 0;
      outline: 0;
      background: #fff;
      box-shadow: none !important;
      appearance: none;
      -webkit-appearance: none;
    }

    .search-pill .search-input::-webkit-search-decoration,
    .search-pill .search-input::-webkit-search-cancel-button,
    .search-pill .search-input::-webkit-search-results-button,
    .search-pill .search-input::-webkit-search-results-decoration {
      display: none;
    }

    /* Botón de lupa */
    .search-pill .btn-search {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 100%;
      border: 0;
      background: #fff;
      border-left: 1px solid rgba(13, 110, 253, .22);
      /* divisor sutil */
      cursor: pointer;
      outline: none;
      box-shadow: none !important;
    }

    .search-pill .btn-search:focus,
    .search-pill .btn-search:focus-visible {
      outline: none;
      box-shadow: none !important;
    }

    .search-pill .btn-search i {
      font-size: 1rem;
      line-height: 1;
    }

    /* Halo de focus bonito aplicado al contenedor (no al hijo) */
    .search-pill:focus-within {
      box-shadow: none !important;
    }

    /* Estado cuando el dropdown está abierto: quita radios inferiores para encajar */
    .search-pill.sug-open {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }
  </style>



  {% block extra_css %}{% endblock %}
</head>

<body class="{% block body_class %}{% endblock %}">
  <!-- HEADER -->
  <header id="header" class="header sticky-top">
    <!-- Topbar -->
    <div class="topbar d-flex align-items-center">
      <div class="container d-flex justify-content-center justify-content-md-between">
        <div class="w-100 text-center py-1 bg-primary text-white">
          <i><span>Gifter's® 2025</span></i>
        </div>
        <div class="social-links d-none d-md-flex align-items-center">
          <a href="#" class="twitter"><i class="bi bi-twitter-x"></i></a>
          <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
          <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
          <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></a>
        </div>
      </div>
    </div>

    <!-- Barra principal -->
    <div class="branding d-flex align-items-center">
      <div class="container position-relative d-flex align-items-center" style="min-height:84px;">
        <!-- IZQUIERDA: Marca + buscador (desktop) -->
        <div class="brand-left d-flex align-items-center gap-3 flex-shrink-0">
          <a href="{% url 'home' %}" class="logo brand d-flex align-items-center" style="z-index:2;">
            <span class="brand-text">Gifter’s</span>
            <img src="{% static 'img/Gifters/favicongift.png' %}" alt="Isotipo Gifter’s" class="brand-mark" />
          </a>

          <form class="g-search" action="{% url 'buscar_router' %}" method="get" autocomplete="off">
            <div class="g-search__box" id="gSearchBox">
              <input id="gSearchInput" name="q" type="text" placeholder="Búsqueda: regalos, categorías, amigos..."
                value="{{ request.GET.q }}">
              <button class="g-search__btn" type="submit" aria-label="Buscar">
                <i class="bi bi-search"></i>
              </button>
            </div>
            <div id="gSug" class="g-search__sugs" role="listbox" hidden></div>
          </form>



        </div>

        <!-- CENTRO: Nav (solo desktop) -->
        <nav id="navmenu" class="navmenu d-none d-lg-block mx-auto">
          <ul>
            <li><a href="{% url 'home' %}#clients">Categorías</a></li>
            <li><a href="{% url 'home' %}#services">Amigos</a></li>
            <li><a href="{% url 'home' %}#portfolio">Regalos</a></li>
            <li><a href="{% url 'home' %}feed">Feed</a></li>
          </ul>
          <i class="mobile-nav-toggle d-none"></i>
        </nav>


        {% if user.is_authenticated %}
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" role="button"
            data-bs-toggle="dropdown" aria-expanded="false">
            <span>Hola, {{ user.nombre }}</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end shadow">
            <li><a class="dropdown-item" href="{% url 'perfil' %}">Mi perfil</a></li>
            <li>
              <hr class="dropdown-divider" />
            </li>
            <li>
              <form method="post" action="{% url 'account_logout' %}">
                {% csrf_token %}
                <button type="submit" class="dropdown-item logout-item">Cerrar sesión</button>
              </form>
            </li>
          </ul>
        </div>
        {% else %}
        <a href="{% url 'account_login' %}" class="btn btn-primary">Iniciar Sesión</a>
        {% endif %}

        <!-- Toggle buscador móvil -->
        <button id="btnMobileSearch" class="btn btn-link p-0 ms-2 d-lg-none" type="button" data-bs-toggle="collapse"
          data-bs-target="#mobileSearch" aria-expanded="false" aria-controls="mobileSearch" aria-label="Buscar">
          <i class="bi bi-search" style="font-size:1.35rem;"></i>
        </button>

        <button id="btnMobileNav" class="btn btn-link p-0 ms-2 d-lg-none" type="button" data-bs-toggle="collapse"
          data-bs-target="#mobileNav" aria-expanded="false" aria-controls="mobileNav" aria-label="Menú">
          <i class="bi bi-list" style="font-size:1.6rem;"></i>
        </button>
      </div>
    </div>

    <!-- Agrupador de colapsables móviles -->
    <div id="mobileCollapses" class="d-lg-none">
      <!-- Menú móvil colapsable -->
      <div id="mobileNav" class="collapse border-top bg-white" data-bs-parent="#mobileCollapses">
        <div class="container py-2">
          <nav aria-label="Navegación principal móvil">
            <ul class="nav flex-column mobile-nav">
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#hero">Inicio</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#clients">Categorías</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#services">Amigos</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#portfolio">Regalos</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}feed">Feed</a></li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
    <!-- /OPCIONAL -->
  </header>

  {% block flash_messages %}
  {% if messages %}
  <div id="flash-messages" class="container my-2">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-2" role="alert" data-django-message>
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endblock %}

  <main class="main">
    {% block content %}{% endblock %}
  </main>

  <!-- FOOTER -->
  <footer id="footer" class="footer">
    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-4 col-md-6 footer-about">
          <a href="{% url 'home' %}" class="d-flex align-items-center">
            <span class="sitename">Gifter's</span>
          </a>
          <div class="footer-contact pt-3">
            <p>Viena 998</p>
            <p>New York, NY 535022</p>
            <p class="mt-3"><strong>Teléfono:</strong> <span>+1 234 567 8900</span></p>
            <p><strong>Email:</strong> <span>info@gifters.com</span></p>
          </div>
        </div>

        <div class="col-lg-2 col-md-3 footer-links">
          <h4>Enlaces útiles</h4>
          <ul>
            <li><i class="bi bi-chevron-right"></i> <a href="{% url 'home' %}">Inicio</a></li>
            <li><i class="bi bi-chevron-right"></i> <a href="#">Acerca de</a></li>
            <li><i class="bi bi-chevron-right"></i> <a href="{% url 'ayuda' %}">Contáctanos</a></li>
          </ul>
        </div>

        <div class="col-lg-4 col-md-12">
          <h4>Síguenos</h4>
          <div class="social-links d-flex">
            <a href=""><i class="bi bi-twitter-x"></i></a>
            <a href=""><i class="bi bi-facebook"></i></a>
            <a href=""><i class="bi bi-instagram"></i></a>
            <a href=""><i class="bi bi-linkedin"></i></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Scroll Top -->
  <a href="#" id="" class="scroll-top d-flex align-items-center justify-content-center">

  </a>

  <!-- Vendor JS -->
  <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'vendor/php-email-form/validate.js' %}"></script>
  <script src="{% static 'vendor/aos/aos.js' %}"></script>
  <script src="{% static 'vendor/glightbox/js/glightbox.min.js' %}"></script>
  <script src="{% static 'vendor/waypoints/noframework.waypoints.js' %}"></script>
  <script src="{% static 'vendor/purecounter/purecounter_vanilla.js' %}"></script>
  <script src="{% static 'vendor/swiper/swiper-bundle.min.js' %}"></script>
  <script src="{% static 'vendor/imagesloaded/imagesloaded.pkgd.min.js' %}"></script>
  <script src="{% static 'vendor/isotope-layout/isotope.pkgd.min.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Main JS -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        document.querySelectorAll('.alert').forEach(a => {
          const bsAlert = bootstrap.Alert.getOrCreateInstance(a);
          bsAlert.close();
        });
      }, 4000);
    });
  </script>
  <script src="{% static 'js/main.js' %}"></script>

  <script>
    // Control de colapsables móviles
    document.addEventListener('DOMContentLoaded', function () {
      const msEl = document.getElementById('mobileSearch');
      const mnEl = document.getElementById('mobileNav');
      const bSearch = document.getElementById('btnMobileSearch');
      const bMenu = document.getElementById('btnMobileNav');

      if (!window.bootstrap || !msEl || !mnEl || !bSearch || !bMenu) return;

      const ms = new bootstrap.Collapse(msEl, { toggle: false });
      const mn = new bootstrap.Collapse(mnEl, { toggle: false });

      function stop(e) { e.preventDefault(); e.stopPropagation(); }

      bSearch.addEventListener('click', function (e) { stop(e); mn.hide(); ms.toggle(); });
      bMenu.addEventListener('click', function (e) { stop(e); ms.hide(); mn.toggle(); });

      msEl.addEventListener('show.bs.collapse', function () { mn.hide(); });
      mnEl.addEventListener('show.bs.collapse', function () { ms.hide(); });

      document.querySelectorAll('#mobileNav .nav-link').forEach(function (a) {
        a.addEventListener('click', function () { mn.hide(); });
      });
    });
  </script>

  {% if user.is_authenticated %}
  <!-- Floating launcher -->
  <button id="chatFab" class="chat-fab" title="Mensajes">💬</button>

  <!-- Drawer (interfaz clásica simple) -->
  <div id="chatDrawer" class="chat-drawer phone-ui" aria-hidden="true">
    <div class="phone-header">
      <div class="brand">
        <img src="{% static 'img/Gifters/favicongift.png' %}" alt="Gifter’s" />
        <span>Gifter’s</span>
      </div>
      <button id="chatClose" class="btn btn-sm btn-light">✕</button>
    </div>

    <div class="phone-tabs" role="tablist">
      <button class="tab-btn" data-tab="amigos"><i class="bi bi-people"></i> Amigos</button>
      <button class="tab-btn active" data-tab="chats"><i class="bi bi-chat-left-dots"></i> Chats</button>
      <button class="tab-btn" data-tab="grupos"><i class="bi bi-collection"></i> Grupos</button>
    </div>

    <div class="chat-head" hidden></div>

    <!-- OJO: todo dentro de .chat-body -->
    <div class="chat-body" style="display:flex; height:100%;">

      <!-- Columna izquierda (lista) con position:relative -->
      <div style="position:relative; width:340px; border-right:1px solid #eee; overflow:auto;">
        <div class="chat-list" id="chatList"></div>

        <!-- Lista de amigos superpuesta -->
        <div id="friendsList" class="chat-list"
          style="display:none; position:absolute; inset:0; overflow:auto; background:#fff;"></div>

        <!-- ✅ Mueve groupsList aquí adentro para que “inset:0” funcione -->
        <div id="groupsList" class="chat-list"
          style="display:none; position:absolute; inset:0; overflow:auto; background:#fff;"></div>
      </div>


      <!-- Columna derecha (mensajes) -->
      <div class="chat-pane" style="flex:1; display:flex; flex-direction:column;">
        <div id="chatEmpty" class="p-3 text-muted">Selecciona un chat para empezar</div>
        <div id="chatMessages" class="chat-messages" hidden></div>
        <div id="typingIndicator" class="typing-indicator" hidden>
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          <em class="who"></em> está escribiendo…
        </div>
        <form id="chatForm" class="chat-input" hidden>
          <input id="chatImage" type="file" accept="image/*" hidden>
          <button type="button" id="btnAttach" class="btn btn-outline-secondary" title="Adjuntar imagen"
            style="border-radius:12px;">
            <i class="bi bi-image"></i>
          </button>
          {% csrf_token %}
          <textarea id="chatText" rows="1" placeholder="Escribe un mensaje…"></textarea>
          <button type="submit">Enviar</button>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
  <script>
    window.URLS = {
      amigos: "{% url 'amistad_amigos' %}",
      conversaciones: "{% url 'conversaciones_list' %}",
      mensajesBase: "{% url 'mensajes_list_create' 0 %}", // luego se reemplaza el /0/
      convConUsuarioId: "{% url 'chat_con_usuario_id' '__USER__' %}",
      typing: "{% url 'chat_typing' 0 %}",  // ← nuevo (placeholder /0/) // placeholder literal
      typingSummary: "{% url 'chat_typing_summary' %}",
      gruposCreate: "{% url 'grupos_create' %}",
      conversacionDetalleBase: "{% url 'conversacion_detalle' 0 %}"
    };
  </script>
  {% if user.is_authenticated %}
  <script>
    (function () {
      const MEDIA_PREFIX = ("{% get_media_prefix %}" || "/media/");
      const fab = document.getElementById('chatFab');
      const drawer = document.getElementById('chatDrawer');
      const closeBtn = document.getElementById('chatClose');
      const listEl = document.getElementById('chatList');
      const msgsEl = document.getElementById('chatMessages');
      const emptyEl = document.getElementById('chatEmpty');
      const formEl = document.getElementById('chatForm');
      const textEl = document.getElementById('chatText');
      const fileEl = document.getElementById('chatImage');
      const attachBtn = document.getElementById('btnAttach');

      // Usuario actual
      const ME = {
        id: Number('{{ user.id|default:"0"|escapejs }}'),
        username: ("{{ user.nombre_usuario|default:''|escapejs }}").trim()
      };
      // Cache liviana del preview por conversación
      const previewCache = new Map(); // convId -> {text, time}
      function setPreview(convId, text, timeISO) {
        previewCache.set(String(convId), { text: text || '', time: timeISO || null });
      }
      function getPreview(convId) {
        return previewCache.get(String(convId)) || { text: '', time: null };
      }
      function slicePreview(t) { return (t || '').toString().slice(0, 72); }
      // === Typing: estado previo por conversación (para detectar flanco "dejó de escribir")
      const wasTypingMap = new Map(); // convId -> boolean

      // Actualiza visualmente una fila de la lista usando lo que tengamos en cache
      function patchRow(convId) {
        const row = Array.from(listEl.children).find(x => String(x.dataset.convId) === String(convId));
        if (!row) return;
        const prev = getPreview(convId);
        const l2 = row.querySelector('.line2');
        if (l2) { l2.textContent = prev.text || ''; l2.classList.remove('text-primary'); }
        const t = row.querySelector('.chat-time');
        if (t && prev.time) t.textContent = formatTime(prev.time);
      }

      // Pide sólo el último mensaje del hilo, hidrata cache y parcha la fila
      async function hydratePreview(convId) {
        const url = "{% url 'mensajes_list_create' 0 %}".replace('/0/', `/${convId}/`);
        const r = await fetch(url + "?limit=1", { credentials: 'same-origin' });
        if (!r.ok) return;
        const j = await r.json();
        const arr = Array.isArray(j) ? j : (j.results || []);
        if (!arr.length) return;
        const m = arr[0];
        const isImg = (m.tipo === 'imagen') || !!m.archivo_url || !!(m.metadatos && m.metadatos.archivo_url);
        const prevText = isImg ? '📷 Imagen' : slicePreview(m.contenido);
        setPreview(convId, prevText, m.creado_en);
        patchRow(convId);
      }

      let currentConvId = null;
      let pollTimer = null;
      let currentConvIsGroup = false;
      let currentConvTitle = null;

      async function fetchConvMeta(convId) {
        const url = window.URLS.conversacionDetalleBase.replace('/0/', `/${convId}/`);
        try {
          const r = await fetch(url, { credentials: 'same-origin' });
          if (!r.ok) return { is_group: false };
          return await r.json();
        } catch { return { is_group: false }; }
      }


      // FIX: esta función estaba rota en tu código (comillas/plantillas)
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      }
      const CSRFTOKEN = getCookie('csrftoken');

      function openDrawer() {
        drawer.classList.add('open');
        drawer.setAttribute('aria-hidden', 'false');
        fab.style.display = 'none';
        loadConversations();
      }
      function closeDrawer() {
        drawer.classList.remove('open');
        drawer.setAttribute('aria-hidden', 'true');
        fab.style.display = '';
        stopPolling();
      }
      const __openDrawer = openDrawer;
      openDrawer = function () {
        __openDrawer();
        startTypingSummaryPoll();
      };

      const __closeDrawer = closeDrawer;
      closeDrawer = function () {
        __closeDrawer();
        stopTypingSummaryPoll();
      };
      fab?.addEventListener('click', openDrawer);
      closeBtn?.addEventListener('click', closeDrawer);
      async function fetchTypingSummary() {
        try {
          const r = await fetch(window.URLS.typingSummary, { credentials: 'same-origin' });
          if (!r.ok) return {};
          const j = await r.json();
          return (j && j.typing) || {};
        } catch {
          return {};
        }
      }

      function prettyTyping(users) {
        if (!users || !users.length) return "";
        return (users.length === 1) ? "1 escribiendo…" : "Varios escribiendo…";
      }

      async function loadConversations() {
        listEl.innerHTML = '<div class="p-3 text-muted">Cargando…</div>';
        const apiURL = window.URLS.conversaciones;

        try {
          // Pedimos en paralelo: conversaciones + resumen de "escribiendo"
          const [res, typingMap] = await Promise.all([
            fetch(apiURL, {
              credentials: 'same-origin',
              headers: { 'Accept': 'application/json' }
            }),
            fetchTypingSummary()
          ]);

          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();

          // NEW: llenar/actualizar cache con el último mensaje de cada conversación
          (data || []).forEach(c => {
            const last = c.ultimo_mensaje || {};
            const prevText = (last.tipo === 'imagen') ? '📷 Imagen' : slicePreview(last.contenido);
            setPreview(c.conversacion_id, prevText, last.creado_en);
          });

          renderConversationList(data, typingMap);  // ← pasamos typingMap al renderer
        } catch (e) {
          listEl.innerHTML = '<div class="p-3 text-danger">No se pudieron cargar tus chats.</div>';
          console.error('[chats] Error cargando conversaciones:', e);
        }
      }
      // Rellena/actualiza cache con el último mensaje de cada conversación


      const AVATAR_FALLBACK = "{% static 'img/Gifters/favicongift.png' %}";

      function toAbsoluteMedia(u) {
        if (!u || typeof u !== 'string') return AVATAR_FALLBACK;
        try {
          u = u.trim();
          if (u === "[object Object]") return AVATAR_FALLBACK;
          if (/^https?:\/\//i.test(u) || u.startsWith('//') || u.startsWith('/')) {
            if (location.protocol === 'https:' && u.startsWith('http://')) return 'https://' + u.slice(7);
            return u;
          }
          if (/^(media|uploads|files)\//i.test(u)) return '/' + u;
          return (MEDIA_PREFIX.replace(/\/+$/, '') + '/' + u.replace(/^\/+/, '')).replace(/\/{2,}/g, '/');
        } catch {
          return AVATAR_FALLBACK;
        }
      }

      function partnerFrom(conv) {
        const ps = Array.isArray(conv.participantes) ? conv.participantes : [];
        let other = ps.find(p => Number(p.id) && Number(p.id) !== ME.id);
        if (!other && ME.username) {
          other = ps.find(p => (p.username || p.nombre_usuario) && (p.username || p.nombre_usuario) !== ME.username);
        }
        if (!other) other = ps[0] || {};

        const username = other.username || other.nombre_usuario || '';
        const fullName =
          other.nombre_completo ||
          [other.nombre, other.apellido].filter(Boolean).join(' ') ||
          other.display_name ||
          username || 'Chat';

        const rawAvatar =
          other.avatar_url || other.avatar || other.foto || other.foto_url || other.image || other.image_url ||
          other.profile_image || other.profile_image_url || other.photo || other.photo_url ||
          other.profile_picture || other.profile_picture_url ||
          (other.perfil && (
            other.perfil.avatar_url || other.perfil.avatar || other.perfil.foto || other.perfil.foto_url ||
            other.perfil.image || other.perfil.image_url || other.perfil.profile_image ||
            other.perfil.profile_image_url || other.perfil.profile_picture || other.perfil.profile_picture_url
          )) || null;

        const avatar = toAbsoluteMedia(rawAvatar);
        return { name: fullName, username, avatar };
      }

      function renderConversationList(items, typingMap = {}) {
        if (!Array.isArray(items) || !items.length) {
          listEl.innerHTML = '<div class="p-3 text-muted">Aún no tienes conversaciones.</div>';
          return;
        }

        const filtered = items.filter(conv => {
          if (Number(conv.conversacion_id) === Number(currentConvId)) return true;
          return !!conv.ultimo_mensaje;
        });

        if (!filtered.length) {
          listEl.innerHTML = '<div class="p-3 text-muted">Aún no tienes conversaciones con mensajes.</div>';
          return;
        }

        listEl.innerHTML = '';

        filtered.forEach(conv => {
          const p = partnerFrom(conv);
          const last = conv.ultimo_mensaje || {};

          // ✅ Detecta imagen y guarda en cache el texto correcto
          const isImg = (last.tipo === 'imagen') || !!last.archivo_url || !!(last.metadatos && last.metadatos.archivo_url);
          const prevText = isImg ? '📷 Imagen' : slicePreview(last.contenido);
          setPreview(conv.conversacion_id, prevText, last.creado_en);

          const row = document.createElement('div');
          row.className = 'chat-list-item' + (conv.conversacion_id === currentConvId ? ' active' : '');
          row.dataset.convId = conv.conversacion_id;

          // ✅ Si hay typing muéstralo; si no, usa SIEMPRE el cache (no last.contenido)
          const tUsers = typingMap[String(conv.conversacion_id)] || [];
          const line2 = tUsers.length ? prettyTyping(tUsers) : getPreview(conv.conversacion_id).text;

          row.innerHTML = `
      <img class="chat-avatar" src="${p.avatar}" alt=""
           onerror="this.onerror=null;this.src='{{ STATIC_URL }}img/Gifters/favicongift.png'">
      <div class="chat-names">
        <div class="line1">${p.name}</div>
        <div class="line2">${line2}</div>
      </div>
      <div class="chat-time">${last.creado_en ? formatTime(last.creado_en) : ''}</div>
    `;
          row.addEventListener('click', () => openConversation(conv.conversacion_id));
          listEl.appendChild(row);
        });
      }
      function formatTime(ts) {
        try { return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
        catch { return ''; }
      }
      let typingSummaryTimer = null;

      function startTypingSummaryPoll() {
        stopTypingSummaryPoll();
        typingSummaryTimer = setInterval(async () => {
          try {
            const typingMap = await fetchTypingSummary();

            Array.from(listEl.children).forEach(row => {
              const convId = row.dataset.convId;
              const tUsers = typingMap[String(convId)] || [];
              const line2El = row.querySelector('.line2');
              if (!line2El) return;

              const isTyping = tUsers.length > 0;
              const wasTyping = wasTypingMap.get(convId) === true;
              wasTypingMap.set(convId, isTyping);

              if (isTyping) {
                // Mostrar "está escribiendo…"
                line2El.textContent = prettyTyping(tUsers);
                line2El.classList.add('text-primary');
              } else {
                if (wasTyping) {
                  // ⚡ Flanco: antes estaba escribiendo y ahora no → probablemente envió mensaje
                  hydratePreview(convId).catch(() => { });
                } else {
                  // Restaurar desde cache sin pegar a red
                  const prev = getPreview(convId);
                  line2El.textContent = prev.text || '';
                  line2El.classList.remove('text-primary');
                }
              }
            });
          } catch { /* noop */ }
        }, 1500);
      }

      function stopTypingSummaryPoll() {
        if (typingSummaryTimer) { clearInterval(typingSummaryTimer); typingSummaryTimer = null; }
      }

      async function openConversation(convId) {
        currentConvId = convId;
        const meta = await fetchConvMeta(convId);
        currentConvIsGroup = !!meta.is_group;
        currentConvTitle = meta.titulo || null;
        Array.from(listEl.children).forEach(li => {
          li.classList.toggle('active', Number(li.dataset.convId) === Number(convId));
        });

        emptyEl.hidden = true;
        msgsEl.hidden = false;
        formEl.hidden = false;

        msgsEl.innerHTML = '<div class="p-2 text-muted">Cargando mensajes…</div>';
        await loadMessagesOnce();
        scrollToBottom();
        startPolling();
      }

      async function loadMessagesOnce() {
        if (!currentConvId) return;
        // FIX: el replace tenía una RegExp mal formada; usar template string
        const url = "{% url 'mensajes_list_create' 0 %}".replace('/0/', `/${currentConvId}/`);
        try {
          const res = await fetch(url, { credentials: 'same-origin' });
          if (!res.ok) throw new Error('Error cargando mensajes');
          const data = await res.json();
          const arr = Array.isArray(data) ? data : (data.results || []);
          renderMessages(arr);

          // El más reciente suele estar en arr[0]
          if (arr.length) {
            const newest = arr[0];
            const prevText = (newest.tipo === 'imagen') ? '📷 Imagen' : slicePreview(newest.contenido);
            setPreview(currentConvId, prevText, newest.creado_en);
            // Parchea la fila visible sin reconstruir toda la lista
            const row = Array.from(listEl.children).find(x => String(x.dataset.convId) === String(currentConvId));
            if (row) {
              const l2 = row.querySelector('.line2'); if (l2) l2.textContent = getPreview(currentConvId).text;
              const t = row.querySelector('.chat-time'); if (t) t.textContent = formatTime(getPreview(currentConvId).time);
            }
          }


        } catch (e) {
          msgsEl.innerHTML = '<div class="p-2 text-danger">No se pudieron cargar los mensajes.</div>';
          console.error(e);
        }
      }

      function renderMessages(msgs) {
        msgsEl.innerHTML = '';
        const meId = Number('{{ user.id|default:"0"|escapejs }}');

        // Orden cronológico en pantalla
        const ordered = msgs.slice().reverse();

        let prevAuthorId = null;
        let prevWhenMs = 0;
        let prevDayKey = null;

        const GAP_MS = 5 * 60 * 1000; // 5 minutos

        function parseMs(iso) {
          try { return new Date(iso).getTime(); } catch { return 0; }
        }
        function dayKeyFromMs(ms) {
          const d = new Date(ms);
          return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
        }
        function formatDayLabel(ms) {
          const d = new Date(ms);
          const today = new Date(); today.setHours(0, 0, 0, 0);
          const dd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
          const diff = Math.round((dd - today) / 86400000);
          if (diff === 0) return 'Hoy';
          if (diff === -1) return 'Ayer';
          return new Intl.DateTimeFormat('es', { day: '2-digit', month: 'short', year: 'numeric' }).format(d);
        }
        function isBlockStart(authorId, whenMs) {
          if (authorId !== prevAuthorId) return true;
          if (!prevWhenMs) return true;
          return (whenMs - prevWhenMs) > GAP_MS;
        }

        ordered.forEach(m => {
          const authorId = Number(m.remitente && m.remitente.id);
          const isMe = authorId === meId;
          const whenMs = parseMs(m.creado_en);
          const showAvatar = currentConvIsGroup ? true : isBlockStart(authorId, whenMs);

          // —— Separador de día si cambió
          const dayKey = dayKeyFromMs(whenMs || Date.now());
          if (dayKey !== prevDayKey) {
            const sep = document.createElement('div');
            sep.className = 'day-sep';
            sep.textContent = formatDayLabel(whenMs || Date.now());
            msgsEl.appendChild(sep);
            prevDayKey = dayKey;
          }

          const row = document.createElement('div');
          row.className = 'msg ' + (isMe ? 'me' : 'other') + (showAvatar ? '' : ' compact');

          const avatarUrl =
            toAbsoluteMedia((m.remitente && (m.remitente.avatar || m.remitente.avatar_url)) || null) ||
            "{% static 'img/Gifters/favicongift.png' %}";

          const when = m.creado_en ? new Date(m.creado_en).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

          const isImage = (m.tipo === 'imagen') || !!m.archivo_url || !!(m.metadatos && m.metadatos.archivo_url);
          const safeText = String(m.contenido || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          const bodyHTML = isImage
            ? (() => {
              const imgUrl = toAbsoluteMedia(m.archivo_url || (m.metadatos && m.metadatos.archivo_url));
              return `<a href="${imgUrl}" target="_blank" rel="noopener">
                      <img class="msg-image" src="${imgUrl}" alt="imagen">
                    </a>${safeText ? `<div style="margin-top:6px;">${safeText}</div>` : ''}`;
            })()
            : safeText;

          const senderName =
            (m.remitente && (m.remitente.nombre_completo ||
              [m.remitente.nombre, m.remitente.apellido].filter(Boolean).join(' ') ||
              m.remitente.display_name ||
              m.remitente.username ||
              m.remitente.nombre_usuario)) || 'Usuario';

          row.innerHTML = `
            ${showAvatar ? `
              <img class="msg-avatar" src="${avatarUrl}" alt=""
                  onerror="this.onerror=null;this.src='${AVATAR_FALLBACK}'">` : ''
            }
            <div class="bubble">
              ${currentConvIsGroup ? `<div style="font-weight:700; font-size:.9rem; margin-bottom:4px;">${senderName}</div>` : ''}
              <div class="body">${bodyHTML}</div>
              <div class="meta">${when}</div>
            </div>
          `;

          msgsEl.appendChild(row);

          // actualizar punteros para el siguiente mensaje
          prevAuthorId = authorId;
          prevWhenMs = whenMs;
        });
      }

      function scrollToBottom() { msgsEl.scrollTop = msgsEl.scrollHeight; }

      formEl.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const text = (textEl.value || '').trim();
        if (!text || !currentConvId) return;

        // FIX: igual que arriba con el replace
        const url = "{% url 'mensajes_list_create' 0 %}".replace('/0/', `/${currentConvId}/`);
        try {
          const res = await fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFTOKEN },
            body: JSON.stringify({ contenido: text, tipo: 'texto' })
          });
          if (!res.ok) throw new Error('No se pudo enviar el mensaje');
          textEl.value = '';
          await loadMessagesOnce();
          scrollToBottom();
          // Pre-actualiza preview del hilo actual
          setPreview(currentConvId, slicePreview(text), new Date().toISOString());
          const row = Array.from(listEl.children).find(x => String(x.dataset.convId) === String(currentConvId));
          if (row) {
            const l2 = row.querySelector('.line2'); if (l2) l2.textContent = getPreview(currentConvId).text;
            const t = row.querySelector('.chat-time'); if (t) t.textContent = formatTime(getPreview(currentConvId).time);
          }
          loadConversations(); // refresca preview del último mensaje
        } catch (e) {
          console.error(e);
          alert('No se pudo enviar el mensaje.');
        }
      });

      textEl.addEventListener('keydown', function (e) {
        if (e.isComposing) return;
        const isEnter = e.key === 'Enter';
        const onlyEnter = isEnter && !e.shiftKey && !e.ctrlKey && !e.altKey && !e.metaKey;
        if (onlyEnter) {
          e.preventDefault();
          const txt = (textEl.value || '').trim();
          if (!txt) return;
          if (formEl.requestSubmit) formEl.requestSubmit();
          else formEl.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
        }
      });
      textEl.setAttribute('title', 'Enter: enviar • Shift+Enter: salto de línea');
      attachBtn?.addEventListener('click', () => fileEl?.click());

      fileEl?.addEventListener('change', async () => {
        if (!fileEl.files || !fileEl.files.length || !currentConvId) return;
        const file = fileEl.files[0];

        // Validaciones rápidas
        if (!/^image\//i.test(file.type)) {
          alert('Solo imágenes, por favor.');
          fileEl.value = '';
          return;
        }
        if (file.size > 8 * 1024 * 1024) { // 8 MB
          alert('Imagen demasiado grande (máx 8MB).');
          fileEl.value = '';
          return;
        }

        try {
          const url = "{% url 'mensajes_list_create' 0 %}".replace('/0/', `/${currentConvId}/`);
          const fd = new FormData();
          fd.append('tipo', 'imagen');
          fd.append('archivo', file);
          // opcional: un pie de foto
          // fd.append('contenido', '');

          const res = await fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'X-CSRFToken': CSRFTOKEN }, // ¡no pongas Content-Type aquí!
            body: fd
          });
          if (!res.ok) throw new Error('Upload failed');

          // refresca mensajes y preview
          await loadMessagesOnce();
          scrollToBottom();
          setPreview(currentConvId, '📷 Imagen', new Date().toISOString());
          const row = Array.from(listEl.children).find(x => String(x.dataset.convId) === String(currentConvId));
          if (row) {
            const l2 = row.querySelector('.line2'); if (l2) l2.textContent = getPreview(currentConvId).text;
            const t = row.querySelector('.chat-time'); if (t) t.textContent = formatTime(getPreview(currentConvId).time);
          }
          loadConversations();
        } catch (e) {
          console.error(e);
          alert('No se pudo enviar la imagen.');
        } finally {
          fileEl.value = '';
        }
      });

      function startPolling() { stopPolling(); pollTimer = setInterval(loadMessagesOnce, 3000); }
      function stopPolling() { if (pollTimer) { clearInterval(pollTimer); pollTimer = null; } }

      window.openChatWith = async function (username) {
        if (!username) return;

        // abre el cajón
        if (typeof openDrawer === 'function') openDrawer();
        else document.getElementById('chatFab')?.click();

        // 1) intenta encontrar una conversación con mensajes
        try {
          const res = await fetch(window.URLS.conversaciones, { credentials: 'same-origin' });
          const data = await res.json();
          const conv = (data || []).find(c => (c.participantes || []).some(p =>
            (p.username || p.nombre_usuario) === username
          ));
          if (conv && conv.ultimo_mensaje) {
            await openConversation(conv.conversacion_id);
            return;
          }
        } catch (e) {
          console.warn('No se pudo listar conversaciones', e);
        }

        // 2) pide/crea la conversación (usa el placeholder __USER__)
        try {
          const url = window.URLS.convConUsuarioId.replace('__USER__', encodeURIComponent(username));
          const r = await fetch(url, { credentials: 'same-origin' });
          if (!r.ok) throw new Error('HTTP ' + r.status);
          const j = await r.json();
          if (j && j.conversacion_id) {
            await openConversation(j.conversacion_id);
            if (typeof window.loadConversations === 'function') window.loadConversations();
            return;
          }
        } catch (e) {
          console.error('No se pudo obtener/crear conversacion_id', e);
        }

        alert('No se pudo abrir el chat con ' + username);
      };

      window.addEventListener('beforeunload', stopPolling);

      let typingPingTimer = null;     // throttle para enviar pings
      let typingStopTimer = null;     // timer para “dejó de escribir”
      let typingPollTimer = null;     // polling para ver si el otro escribe

      const typingEl = document.getElementById('typingIndicator');
      const typingWhoEl = typingEl?.querySelector('.who');

      function typingUrl() {
        // usa el placeholder /0/
        return window.URLS.typing.replace('/0/', `/${currentConvId}/`);
      }

      async function sendTyping(isTyping) {
        if (!currentConvId) return;
        try {
          await fetch(typingUrl(), {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFTOKEN },
            body: JSON.stringify({ typing: !!isTyping })
          });
        } catch (e) { /* silencioso */ }
      }

      function scheduleTypingPing() {
        // limita a 1 ping cada ~2s
        if (typingPingTimer) return;
        sendTyping(true);
        typingPingTimer = setTimeout(() => { typingPingTimer = null; }, 2000);

        // si no hay nuevos inputs por 2.5s, marca stop
        clearTimeout(typingStopTimer);
        typingStopTimer = setTimeout(() => sendTyping(false), 2500);
      }

      async function pollTyping() {
        if (!currentConvId) return;
        try {
          const r = await fetch(typingUrl(), { credentials: 'same-origin' });
          if (!r.ok) return;
          const j = await r.json();
          const typing = (j && j.typing) || [];
          renderTyping(typing);
        } catch (e) { /* noop */ }
      }

      function renderTyping(list) {
        if (!typingEl) return;
        if (!list.length) {
          typingEl.hidden = true;
          return;
        }
        // si hay uno, mostramos nombre; si >1, “Varios”
        const first = list[0];
        const nombre = (first.nombre || '').trim() || (first.username || '').trim() || 'Alguien';
        typingWhoEl.textContent = (list.length === 1) ? nombre : 'Varios';
        typingEl.hidden = false;
      }

      // engancha eventos del textarea
      if (textEl) {
        textEl.addEventListener('input', scheduleTypingPing);
        textEl.addEventListener('blur', () => sendTyping(false));
      }

      // integra con tu ciclo de polling existente
      const _startPollingOriginal = startPolling;
      startPolling = function () {
        _startPollingOriginal();
        // además del polling de mensajes, hacemos uno para typing algo más frecuente
        clearInterval(typingPollTimer);
        typingPollTimer = setInterval(pollTyping, 1500);
      };

      const _stopPollingOriginal = stopPolling;
      stopPolling = function () {
        _stopPollingOriginal();
        clearInterval(typingPollTimer); typingPollTimer = null;
        clearTimeout(typingPingTimer); typingPingTimer = null;
        clearTimeout(typingStopTimer); typingStopTimer = null;
        sendTyping(false);
        if (typingEl) typingEl.hidden = true;
      };

      // cuando cambies de conversación:
      const _openConversationOriginal = openConversation;
      openConversation = async function (convId) {
        await _openConversationOriginal(convId);
        wasTypingMap.set(String(convId), false); // limpia estado para esa fila
        pollTyping(); // primer fetch inmediato
      };
    })();
  </script>
  <script>
    (function () {
      const drawer = document.getElementById('chatDrawer');
      if (!drawer) return;

      // Columna izquierda
      const chatsEl = drawer.querySelector('#chatList');
      const friendsEl = drawer.querySelector('#friendsList');
      const groupsEl = drawer.querySelector('#groupsList');
      const leftCol = chatsEl?.parentElement;
      if (leftCol && getComputedStyle(leftCol).position === 'static') {
        leftCol.style.position = 'relative';
      }

      // Tabs
      const tabBtns = drawer.querySelectorAll('.phone-tabs .tab-btn');
      const btnChats = drawer.querySelector('.phone-tabs .tab-btn[data-tab="chats"]');
      const btnAmigos = drawer.querySelector('.phone-tabs .tab-btn[data-tab="amigos"]');
      const btnGrupos = drawer.querySelector('.phone-tabs .tab-btn[data-tab="grupos"]');

      // Modal crear grupo
      const gm = document.getElementById('groupModal');
      const gmName = document.getElementById('gmName');
      const gmFriends = document.getElementById('gmFriends');
      const gmCreate = document.getElementById('gmCreate');

      // Helpers
      const AVATAR_FALLBACK = "{% static 'img/Gifters/favicongift.png' %}";
      const CSRFTOKEN = (function getCookie(name) {
        const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      })('csrftoken');

      // Estado
      let friendsLoaded = false; // del tab amigos
      let friendsCache = [];     // para el modal
      let groupsLoaded = false;

      // ------- AMIGOS (reutiliza tu loader existente si quieres) -------
      async function loadFriends() {
        if (friendsLoaded) return;
        friendsEl.innerHTML = '<div class="p-3 text-muted">Cargando amigos…</div>';
        try {
          const res = await fetch(window.URLS.amigos, {
            credentials: 'same-origin',
            headers: { 'Accept': 'application/json' }
          });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          friendsCache = Array.isArray(data) ? data : [];
          renderFriends(friendsCache);
          friendsLoaded = true;
        } catch (e) {
          console.error('Error cargando amigos:', e);
          friendsEl.innerHTML = '<div class="p-3 text-danger">No se pudieron cargar tus amigos.</div>';
        }
      }

      function friendUsername(u) {
        return u.nombre_usuario || u.username || '';
      }
      function friendName(u) {
        return u.nombre_completo ||
          [u.nombre, u.apellido].filter(Boolean).join(' ') ||
          u.display_name ||
          friendUsername(u) || 'Amigo';
      }
      function friendAvatar(u) {
        const raw =
          u.avatar_url || u.avatar || u.foto_url || u.foto ||
          (u.perfil && (u.perfil.profile_picture_url || u.perfil.foto_url || u.perfil.profile_picture)) ||
          u.profile_image_url || u.profile_picture_url || null;
        return raw || AVATAR_FALLBACK;
      }

      function renderFriends(list) {
        friendsEl.innerHTML = '';
        if (!Array.isArray(list) || list.length === 0) {
          friendsEl.innerHTML = '<div class="p-3 text-muted">Aún no tienes amigos.</div>';
          return;
        }
        list.forEach(u => {
          const row = document.createElement('div');
          row.className = 'chat-list-item';
          row.innerHTML = `
        <img class="chat-avatar" src="${friendAvatar(u)}" alt="">
        <div class="chat-names">
          <div class="line1">${friendName(u)}</div>
          <div class="line2">@${friendUsername(u)}</div>
        </div>
        <div class="chat-time"></div>
      `;
          row.addEventListener('click', () => {
            const uname = friendUsername(u);
            if (uname && typeof window.openChatWith === 'function') {
              window.openChatWith(uname);
            }
          });
          friendsEl.appendChild(row);
        });
      }

      // ------- MODAL CREAR GRUPO -------
      function openGroupModal() {
        const gm = document.getElementById('groupModal');
        const gmName = document.getElementById('gmName');
        const gmFriends = document.getElementById('gmFriends');

        if (!gm || !gmFriends) { console.error('[modal grupos] Falta markup'); return; }

        gmFriends.innerHTML = friendsCache.map(f => `
    <label class="d-flex align-items-center gap-2">
      <input type="checkbox" value="${f.id}">
      <img src="${(f.perfil?.profile_picture_url || f.avatar_url || f.avatar || '') || AVATAR_FALLBACK}"
           class="rounded-circle" style="width:28px;height:28px;object-fit:cover"
           onerror="this.src='${AVATAR_FALLBACK}'">
      <span>${f.nombre_completo || f.display_name || f.username || f.nombre_usuario}</span>
    </label>
  `).join('');

        // 🔧 enganchamos el click AQUÍ (cuando el botón ya existe)
        const btnCreate = document.getElementById('gmCreate');
        if (btnCreate) {
          btnCreate.onclick = null;                 // evita duplicados si abres varias veces
          btnCreate.addEventListener('click', createGroup);
        }

        gm.style.display = 'block';
      }


      function closeGroupModal() {
        gm.style.display = 'none';
        gmName.value = '';
      }
      gm?.addEventListener('click', (e) => {
        if (e.target.matches('.btn-close,[data-close],.modal')) closeGroupModal();
      });

      async function loadFriendsForModal() {
        if (!friendsLoaded) await loadFriends();
        openGroupModal();
      }

      async function createGroup() {
        const gm = document.getElementById('groupModal');
        const gmName = document.getElementById('gmName');
        const gmFriends = document.getElementById('gmFriends');

        const titulo = (gmName?.value || '').trim();
        const ids = Array.from(gmFriends?.querySelectorAll('input[type=checkbox]:checked') || [])
          .map(i => Number(i.value));

        if (!titulo) { gmName?.focus(); return; }
        if (!ids.length) { alert('Selecciona al menos 1 amigo.'); return; }

        try {
          const r = await fetch(window.URLS.gruposCreate, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFTOKEN },
            body: JSON.stringify({ titulo, miembros: ids })
          });
          if (!r.ok) throw new Error('HTTP ' + r.status);
          const j = await r.json();

          // abrir el chat del grupo recién creado
          if (j && j.conversacion_id && window.openConversation) {
            window.openConversation(j.conversacion_id);
          }
          // refrescar listado de conversaciones/grupos
          if (typeof window.loadConversations === 'function') window.loadConversations();

          // cerrar modal
          if (gm) gm.style.display = 'none';
          if (gmName) gmName.value = '';
        } catch (e) {
          console.error(e);
          alert('No se pudo crear el grupo.');
        }
      }
      document.getElementById('gmCreate')?.addEventListener('click', createGroup);

      // ------- LISTAR GRUPOS -------
      async function loadGroups() {
        if (groupsLoaded) return;
        groupsEl.innerHTML = `
      <div class="d-flex justify-content-between align-items-center p-2">
        <span class="text-muted">Tus grupos</span>
        <button class="btn btn-sm btn-primary" id="btnNewGroup"><i class="bi bi-plus-lg"></i> Nuevo</button>
      </div>
      <div class="p-3 text-muted">Cargando…</div>
    `;
        try {
          const res = await fetch(window.URLS.conversaciones, { credentials: 'same-origin' });
          const data = await res.json();
          const grupos = (data || []).filter(c => c.is_group);

          const list = document.createElement('div');
          list.className = 'px-2';
          if (!grupos.length) {
            list.innerHTML = '<div class="p-3 text-muted">Aún no tienes grupos.</div>';
          } else {
            list.innerHTML = grupos.map(g => {
              const ps = (g.participantes || []).slice(0, 3);
              const imgs = ps.map(p => `<img src="${(p.avatar_url || p.avatar) || AVATAR_FALLBACK}" onerror="this.src='${AVATAR_FALLBACK}'" style="width:24px;height:24px;border-radius:50%;object-fit:cover;border:2px solid #fff;margin-left:-8px;">`).join('');
              const prev = g.ultimo_mensaje
                ? ((g.ultimo_mensaje.tipo === 'imagen' || g.ultimo_mensaje.archivo_url) ? '📷 Imagen' : String(g.ultimo_mensaje.contenido || '').slice(0, 72))
                : '';
              const when = g.ultimo_mensaje?.creado_en ? new Date(g.ultimo_mensaje.creado_en).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
              return `
            <div class="chat-list-item" data-cid="${g.conversacion_id}">
              <div class="d-flex align-items-center">
                <div class="d-flex align-items-center" style="width:50px">${imgs}</div>
                <div class="chat-names">
                  <div class="line1">${g.titulo || 'Grupo'}</div>
                  <div class="line2">${prev}</div>
                </div>
                <div class="chat-time">${when}</div>
              </div>
            </div>`;
            }).join('');
          }
          groupsEl.innerHTML = `
        <div class="d-flex justify-content-between align-items-center p-2">
          <span class="text-muted">Tus grupos</span>
          <button class="btn btn-sm btn-primary" id="btnNewGroup"><i class="bi bi-plus-lg"></i> Nuevo</button>
        </div>`;
          groupsEl.appendChild(list);
          groupsEl.querySelector('#btnNewGroup')?.addEventListener('click', loadFriendsForModal);
          groupsEl.querySelectorAll('.chat-list-item').forEach(row => {
            row.addEventListener('click', () => {
              const cid = Number(row.dataset.cid);
              if (window.openConversation) window.openConversation(cid);
            });
          });
          groupsLoaded = true;
        } catch (e) {
          console.error(e);
          groupsEl.innerHTML = '<div class="p-3 text-danger">No se pudieron cargar tus grupos.</div>';
        }
      }

      // ------- Tabs -------
      function setActiveTab(tab) {
        tabBtns.forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
        if (tab === 'amigos') {
          friendsEl.style.display = 'block';
          chatsEl.style.visibility = 'hidden';
          groupsEl.style.display = 'none';
          loadFriends();
        } else if (tab === 'chats') {
          friendsEl.style.display = 'none';
          groupsEl.style.display = 'none';
          chatsEl.style.visibility = 'visible';
          if (typeof loadConversations === 'function') loadConversations();
        } else { // grupos
          friendsEl.style.display = 'none';
          chatsEl.style.visibility = 'hidden';
          groupsEl.style.display = 'block';
          loadGroups();
        }
      }

      drawer.addEventListener('click', (e) => {
        const btn = e.target.closest('.tab-btn');
        if (!btn || !btn.dataset.tab) return;
        setActiveTab(btn.dataset.tab);
      });

      // Estado inicial
      setActiveTab('chats');
    })();
  </script>

  {% endif %}

  <script>
    // Botón de chat en perfil público (si aparece en alguna vista)
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btnChatPerfilPublico');
      btn?.addEventListener('click', (e) => {
        e.preventDefault();
        const u = btn.dataset.username;
        if (window.openChatWith) {
          window.openChatWith(u);
        } else {
          document.getElementById('chatFab')?.click();
        }
      });
    });
  </script>



  <script>
    (() => {
      const ENDPOINT = "{% url 'buscar_sugerencias' %}";

      const form = document.querySelector('.g-search');
      const box = document.getElementById('gSearchBox');
      const input = document.getElementById('gSearchInput');
      const sugs = document.getElementById('gSug');
      if (!form || !box || !input || !sugs) return;

      let active = -1, controller = null;

      const esc = s => String(s || '').replace(/[<>&]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;' }[c]));
      const tpl = (s, i) => `
      <div class="g-sug" data-i="${i}" data-url="${s.url || '#'}">
        <span class="type">${esc(s.tipo || '')}</span>
        <span class="text">${esc(s.texto || s.title || '')}</span>
        ${(s.marca || s.categoria) ? `<span class="meta">${esc([s.marca, s.categoria].filter(Boolean).join(' • '))}</span>` : ''}
      </div>`;

      /* === NUEVO: animaciones === */
      function openSugs(animate = true) {
        sugs.hidden = false;
        form.classList.add('is-open');
        if (animate) {
          sugs.classList.remove('anim-out');
          void sugs.offsetWidth;            // reflow para reiniciar anim
          sugs.classList.add('anim-in');
        }
        active = -1;
      }

      function closeSugs() {
        if (sugs.hidden) {                  // ya está cerrado
          form.classList.remove('is-open');
          active = -1;
          return;
        }
        sugs.classList.remove('anim-in');
        sugs.classList.add('anim-out');
        const onEnd = (e) => {
          if (e.target !== sugs) return;
          sugs.removeEventListener('animationend', onEnd);
          sugs.hidden = true;
          sugs.classList.remove('anim-out');
          sugs.innerHTML = '';
          form.classList.remove('is-open');
          active = -1;
        };
        sugs.addEventListener('animationend', onEnd);
      }

      function show(list) {
        if (!list?.length) return closeSugs();
        const wasHidden = sugs.hidden;      // solo animar si estaba oculto
        sugs.innerHTML = list.map(tpl).join('');
        openSugs(wasHidden);
      }

      const debounce = (fn, ms = 220) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

      const search = debounce(async q => {
        if (!q || q.trim().length < 2) return closeSugs();
        try {
          controller?.abort(); controller = new AbortController();
          const r = await fetch(`${ENDPOINT}?q=${encodeURIComponent(q)}`, { credentials: 'same-origin', signal: controller.signal });
          if (!r.ok) throw 0;
          const j = await r.json();
          show(j.sugerencias || j.hits || []);
        } catch {/* noop */ }
      }, 220);

      input.addEventListener('input', e => search(e.target.value));
      input.addEventListener('focus', () => { if (sugs.innerHTML) openSugs(true); });

      function items() { return Array.from(sugs.querySelectorAll('.g-sug')); }
      function setActive(i) {
        const els = items(); els.forEach(el => el.classList.remove('is-active'));
        if (!els.length) { active = -1; return; }
        active = (i + els.length) % els.length;
        const el = els[active]; el.classList.add('is-active');
        const r = el.getBoundingClientRect(), cr = sugs.getBoundingClientRect();
        if (r.top < cr.top) sugs.scrollTop -= (cr.top - r.top);
        if (r.bottom > cr.bottom) sugs.scrollTop += (r.bottom - cr.bottom);
      }

      input.addEventListener('keydown', e => {
        if (sugs.hidden) return;
        if (e.key === 'ArrowDown') { e.preventDefault(); setActive(active + 1); }
        else if (e.key === 'ArrowUp') { e.preventDefault(); setActive(active - 1); }
        else if (e.key === 'Enter') {
          const els = items();
          if (active >= 0 && els[active]) {
            e.preventDefault();
            window.location.href = els[active].dataset.url || (form.action + '?q=' + encodeURIComponent(input.value));
          }
        } else if (e.key === 'Escape') { closeSugs(); input.blur(); }
      });

      sugs.addEventListener('mousedown', e => {
        const el = e.target.closest('.g-sug'); if (!el) return;
        e.preventDefault();
        window.location.href = el.dataset.url || (form.action + '?q=' + encodeURIComponent(input.value));
      });

      document.addEventListener('click', e => { if (!form.contains(e.target)) closeSugs(); });
    })();
  </script>







  <!-- Modal crear grupo -->
  <div id="groupModal" class="modal" tabindex="-1" style="display:none;">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Crear grupo</h5>
          <button type="button" class="btn-close" data-close></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Nombre del grupo</label>
            <input id="gmName" class="form-control" maxlength="60" placeholder="Ej: Asado del viernes">
          </div>
          <div class="mb-2">
            <label class="form-label">Miembros</label>
            <div id="gmFriends" class="d-grid gap-2" style="max-height: 260px; overflow:auto;"></div>
            <small class="text-muted">Puedes elegir varios.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light" data-close>Cancelar</button>
          <button id="gmCreate" class="btn btn-primary">Crear</button>
        </div>
      </div>
    </div>
  </div>


  {% block extra_js %}{% endblock %}
</body>

</html>