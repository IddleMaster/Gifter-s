{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>{% block title %}Gifter’s{% endblock %}</title>

  <!-- Favicons -->
  <link rel="icon" href="{% static 'img/Gifters/favicongift.png' %}" type="image/png">
  <link rel="apple-touch-icon" href="{% static 'img/Gifters/logo-sin-letras.png' %}">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;900&display=swap" rel="stylesheet">

  <!-- Vendor CSS (via STATIC_URL=/assets/) -->
  <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/aos/aos.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/glightbox/css/glightbox.min.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/swiper/swiper-bundle.min.css' %}" rel="stylesheet">

  <!-- Main CSS -->
  <link href="{% static 'css/main.css' %}" rel="stylesheet">
  <link href="{% static 'css/gifters.css' %}" rel="stylesheet">

  <!--chat jeje-->
  <link rel="stylesheet" href="{% static 'css/chat-floating.css' %}">


  <style>
    
    /* Poppins global */
    body,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p,
    a,
    button {
      font-family: 'Poppins', sans-serif !important;
    }

    /* Igual que en tu index */
    .logo-img {
      height: 64px;
      width: auto;
      display: block;
    }

    .login-btn-standalone {
      display: inline-block;
      padding: .55rem 1rem;
      border-radius: 999px;
      background: #1970ea;
      color: #fff;
      text-decoration: none;
      font-weight: 700;
    }

    .login-btn-standalone:hover {
      filter: brightness(.92);
      color: #fff;
    }
  </style>
  <link href="{% static 'css/gifters.css' %}" rel="stylesheet">

  {% block extra_css %}{% endblock %}
</head>

<body class="{% block body_class %}{% endblock %}">

  <!-- HEADER = el mismo del index -->
  <header id="header" class="header sticky-top">



    <!-- Topbar -->
    <div class="topbar d-flex align-items-center">
      <div class="container d-flex justify-content-center justify-content-md-between">
        <div class="w-100 text-center py-1 bg-primary text-white">
          <i><span>Gifter's® 2025</span></i>
        </div>
        <div class="social-links d-none d-md-flex align-items-center">
          <a href="#" class="twitter"><i class="bi bi-twitter-x"></i></a>
          <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
          <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
          <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></a>
        </div>
      </div>
    </div>

    <!-- Barra principal -->
    <div class="branding d-flex align-items-center">
      <div class="container position-relative d-flex align-items-center" style="min-height:84px;">

        <!-- IZQUIERDA: Marca + buscador (desktop) -->
        <div class="brand-left d-flex align-items-center gap-3 flex-shrink-0">
          <a href="{% url 'home' %}" class="logo brand d-flex align-items-center" style="z-index:2;">
            <span class="brand-text">Gifter’s</span>
            <img src="{% static 'img/Gifters/favicongift.png' %}" alt="Isotipo Gifter’s" class="brand-mark">
          </a>

          <!-- Buscador solo en ≥ LG -->
          <form class="site-search d-none d-lg-block" role="search" action="{% url 'productos_list' %}" method="get">
            <div class="input-group search-pill position-relative">
              <input type="search" class="form-control search-input" name="q" id="searchInputDesktop"
                placeholder="Búsqueda: regalos, categorías, amigos..." aria-label="Buscar" value="{{ request.GET.q }}"
                autocomplete="off">
              <button class="btn btn-search" type="submit" aria-label="Buscar">
                <i class="bi bi-search"></i>
              </button>
              <!-- Contenedor de sugerencias DEBE estar dentro del input-group -->
              <div id="sugerenciasDesktop" class="sugerencias-container"></div>
            </div>
          </form>
        </div>

        <!-- CENTRO: Nav (solo desktop) -->
        <nav id="navmenu" class="navmenu d-none d-lg-block mx-auto">
          <ul>
            <!-- <li><a href="{% url 'home' %}#hero" class="active">Inicio</a></li>-->
            <li><a href="{% url 'home' %}#clients">Categorías</a></li> <!-- Ahora apunta a las categorías reales -->
            <li><a href="{% url 'home' %}#services">Amigos</a></li>
            <li><a href="{% url 'home' %}#portfolio">Regalos</a></li>
            <li><a href="{% url 'home' %}feed">Feed</a></li>
            <!-- Ahora apunta a Tendencias/Productos Destacados -->
          </ul>
          <i class="mobile-nav-toggle d-none"></i>
        </nav>

        {% if user.is_authenticated %}
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" role="button"
            data-bs-toggle="dropdown" aria-expanded="false">
            <span>Hola, {{ user.nombre }}</span>
          </a>

          <ul class="dropdown-menu dropdown-menu-end shadow">
            <li><a class="dropdown-item" href="{% url 'perfil' %}">Mi perfil</a></li>

            <li>
              <hr class="dropdown-divider">
            </li>
            <li>
              <form method="post" action="{% url 'account_logout' %}">
                {% csrf_token %}
                <button type="submit" class="dropdown-item logout-item">Cerrar sesión</button>
              </form>
            </li>
          </ul>
        </div>
        {% else %}
        <a href="{% url 'account_login' %}" class="btn btn-primary">Iniciar Sesión</a>
        {% endif %}






        <!-- Toggle buscador móvil -->
        <button id="btnMobileSearch" class="btn btn-link p-0 ms-2 d-lg-none" type="button" data-bs-toggle="collapse"
          data-bs-target="#mobileSearch" aria-expanded="false" aria-controls="mobileSearch" aria-label="Buscar">
          <i class="bi bi-search" style="font-size:1.35rem;"></i>
        </button>

        <button id="btnMobileNav" class="btn btn-link p-0 ms-2 d-lg-none" type="button" data-bs-toggle="collapse"
          data-bs-target="#mobileNav" aria-expanded="false" aria-controls="mobileNav" aria-label="Menú">
          <i class="bi bi-list" style="font-size:1.6rem;"></i>
        </button>
      </div>
    </div>
    </div>

    <!-- Agrupador de colapsables móviles -->
    <div id="mobileCollapses" class="d-lg-none">

      <!-- Menú móvil colapsable -->
      <div id="mobileNav" class="collapse border-top bg-white" data-bs-parent="#mobileCollapses">
        <div class="container py-2">
          <nav aria-label="Navegación principal móvil">
            <ul class="nav flex-column mobile-nav">
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#hero">Inicio</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#clients">Categorías</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#services">Amigos</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#portfolio">Regalos</a></li>
            </ul>
          </nav>
        </div>
      </div>

      <!-- Menú móvil colapsable -->
      <div id="mobileNav" class="collapse border-top bg-white" data-bs-parent="#mobileCollapses">
        <div class="container py-2">
          <nav aria-label="Navegación principal móvil">
            <ul class="nav flex-column mobile-nav">
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#hero">Inicio</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#clients">Categorías</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#services">Amigos</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'home' %}#portfolio">Regalos</a></li>
            </ul>
          </nav>
        </div>
      </div>

    </div>

    <!-- OPCIONAL: no se pisan buscador y menú; cerrar menú al click -->

  </header>
  {% if messages %}
  <div class="container my-2">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-2" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <main class="main">
    <!-- /HEADER -->

    {% block content %}{% endblock %}
  </main>

  <!-- FOOTER (puedes reemplazar por el tuyo si prefieres) -->
  <footer id="footer" class="footer">
    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-4 col-md-6 footer-about">
          <a href="{% url 'home' %}" class="d-flex align-items-center">
            <span class="sitename">Gifter's</span>
          </a>
          <div class="footer-contact pt-3">
            <p>Viena 998</p>
            <p>New York, NY 535022</p>
            <p class="mt-3"><strong>Teléfono:</strong> <span>+1 234 567 8900</span></p>
            <p><strong>Email:</strong> <span>info@gifters.com</span></p>
          </div>
        </div>
        <div class="col-lg-2 col-md-3 footer-links">
          <h4>Enlaces útiles</h4>
          <ul>
            <li><i class="bi bi-chevron-right"></i> <a href="{% url 'home' %}">Inicio</a></li>
            <li><i class="bi bi-chevron-right"></i> <a href="#">Acerca de</a></li>
            <li><i class="bi bi-chevron-right"></i> <a href="{% url 'ayuda' %}">Contáctanos</a></li>
          </ul>
        </div>
        <div class="col-lg-4 col-md-12">
          <h4>Síguenos</h4>
          <div class="social-links d-flex">
            <a href=""><i class="bi bi-twitter-x"></i></a>
            <a href=""><i class="bi bi-facebook"></i></a>
            <a href=""><i class="bi bi-instagram"></i></a>
            <a href=""><i class="bi bi-linkedin"></i></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center">
    <i class="bi bi-arrow-up-short"></i>
  </a>

  <!-- Vendor JS (vía STATIC_URL) -->
  <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'vendor/php-email-form/validate.js' %}"></script>
  <script src="{% static 'vendor/aos/aos.js' %}"></script>
  <script src="{% static 'vendor/glightbox/js/glightbox.min.js' %}"></script>
  <script src="{% static 'vendor/waypoints/noframework.waypoints.js' %}"></script>
  <script src="{% static 'vendor/purecounter/purecounter_vanilla.js' %}"></script>
  <script src="{% static 'vendor/swiper/swiper-bundle.min.js' %}"></script>
  <script src="{% static 'vendor/imagesloaded/imagesloaded.pkgd.min.js' %}"></script>
  <script src="{% static 'vendor/isotope-layout/isotope.pkgd.min.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Main JS -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        document.querySelectorAll('.alert').forEach(a => {
          const bsAlert = bootstrap.Alert.getOrCreateInstance(a);
          bsAlert.close();
        });
      }, 4000);
    });
  </script>

  <script src="{% static 'js/main.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Elementos
      const msEl = document.getElementById('mobileSearch');
      const mnEl = document.getElementById('mobileNav');
      const bSearch = document.getElementById('btnMobileSearch');
      const bMenu = document.getElementById('btnMobileNav');

      // Si falta algo, salimos
      if (!window.bootstrap || !msEl || !mnEl || !bSearch || !bMenu) return;

      // Instancias de Collapse sin auto-toggle
      const ms = new bootstrap.Collapse(msEl, { toggle: false });
      const mn = new bootstrap.Collapse(mnEl, { toggle: false });

      // Evitar propagación/accidentes con otros listeners
      function stop(e) { e.preventDefault(); e.stopPropagation(); }

      // Clicks controlados: al abrir uno, cerramos el otro
      bSearch.addEventListener('click', function (e) {
        stop(e);
        mn.hide();
        ms.toggle();
      });

      bMenu.addEventListener('click', function (e) {
        stop(e);
        ms.hide();
        mn.toggle();
      });

      // Redundante (pero seguro): si uno se abre por otra causa, cierra el otro
      msEl.addEventListener('show.bs.collapse', function () { mn.hide(); });
      mnEl.addEventListener('show.bs.collapse', function () { ms.hide(); });

      // Cierra el menú al elegir una opción
      document.querySelectorAll('#mobileNav .nav-link').forEach(function (a) {
        a.addEventListener('click', function () {
          mn.hide();
        });
      });
    });


  </script>
  {% if user.is_authenticated %}
  <!-- Floating launcher -->
  <button id="chatFab" class="chat-fab" title="Mensajes">💬</button>

  <!-- Drawer -->
  <div id="chatDrawer" class="chat-drawer" aria-hidden="true">
    <div class="chat-head">
      <span class="title">Mensajes</span>
      <button id="chatClose" class="btn btn-sm btn-light">✕</button>
    </div>

    <div class="chat-body">
      <!-- Lista de conversaciones -->
      <div class="chat-list" id="chatList"></div>

      <!-- Panel de mensajes -->
      <div class="chat-pane">
        <div id="chatEmpty" class="p-3 text-muted">Selecciona un chat para empezar</div>
        <div id="chatMessages" class="chat-messages" hidden></div>
        <form id="chatForm" class="chat-input" hidden>
          {% csrf_token %}
          <textarea id="chatText" rows="1" placeholder="Escribe un mensaje…"></textarea>
          <button type="submit">Enviar</button>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  {% if user.is_authenticated %}
  <script>
    (function () {
      const MEDIA_PREFIX = ("{% get_media_prefix %}" || "/media/");
      const fab = document.getElementById('chatFab');
      const drawer = document.getElementById('chatDrawer');
      const closeBtn = document.getElementById('chatClose');
      const listEl = document.getElementById('chatList');
      const msgsEl = document.getElementById('chatMessages');
      const emptyEl = document.getElementById('chatEmpty');
      const formEl = document.getElementById('chatForm');
      const textEl = document.getElementById('chatText');
      // Identidad del usuario (debe vivir dentro del mismo IIFE del chat)
      const ME = {
        id: Number('{{ user.id|default:"0"|escapejs }}'),
        username: ("{{ user.nombre_usuario|default:''|escapejs }}").trim()
      };

      let currentConvId = null;
      let pollTimer = null;

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
      }
      const CSRFTOKEN = getCookie('csrftoken');

      function openDrawer() {
        drawer.classList.add('open');
        drawer.setAttribute('aria-hidden', 'false');
        fab.style.display = 'none';           // ← OCULTA el FAB
        loadConversations();
      }

      function closeDrawer() {
        drawer.classList.remove('open');
        drawer.setAttribute('aria-hidden', 'true');
        fab.style.display = '';               // ← VUELVE A MOSTRAR el FAB
        stopPolling();
      }
      fab?.addEventListener('click', openDrawer);
      closeBtn?.addEventListener('click', closeDrawer);

      async function loadConversations() {
        listEl.innerHTML = '<div class="p-3 text-muted">Cargando…</div>';
        const apiURL = "{% url 'conversaciones_list' %}";

        try {
          const res = await fetch(apiURL, {
            credentials: 'same-origin',
            headers: { 'Accept': 'application/json' }
          });

          console.debug('[chats] status:', res.status, 'redirected:', res.redirected);

          if (!res.ok) {
            const txt = await res.text().catch(() => '');
            console.error('[chats] respuesta no OK:', res.status, txt.slice(0, 300));
            throw new Error('HTTP ' + res.status);
          }

          const ctype = res.headers.get('content-type') || '';
          if (!ctype.includes('application/json')) {
            const txt = await res.text();
            console.error('[chats] No es JSON. Primeros 300 chars:', txt.slice(0, 300));
            throw new Error('Respuesta no-JSON (¿redirigido al login?)');
          }

          const data = await res.json();
          renderConversationList(data);
        } catch (e) {
          listEl.innerHTML = '<div class="p-3 text-danger">No se pudieron cargar tus chats.</div>';
          console.error('[chats] Error cargando conversaciones:', e);
        }
      }


      const AVATAR_FALLBACK = "{% static 'img/Gifters/favicongift.png' %}";

      function toAbsoluteMedia(u) {
        // Nada útil → fallback
        if (!u || typeof u !== 'string') return AVATAR_FALLBACK;

        try {
          u = u.trim();

          // Si viene un objeto serializado raro (a veces backend manda "[object Object]")
          if (u === "[object Object]") return AVATAR_FALLBACK;

          // Absolutas (http/https) o protocolo relativo // o ya empiezan en /
          if (/^https?:\/\//i.test(u) || u.startsWith('//') || u.startsWith('/')) {
            // Evita mixed-content: si el sitio es https y la imagen es http, intenta forzar https
            if (location.protocol === 'https:' && u.startsWith('http://')) {
              return 'https://' + u.slice('http://'.length);
            }
            return u;
          }

          // Rutas comunes: "media/...", "uploads/..." → anteponer "/"
          if (/^(media|uploads|files)\//i.test(u)) {
            return '/' + u; // => /media/archivo.jpg
          }

          // Nombre de archivo suelto → usa MEDIA_PREFIX
          // (asegura no duplicar media/)
          return (MEDIA_PREFIX.replace(/\/+$/, '') + '/' + u.replace(/^\/+/, '')).replace(/\/{2,}/g, '/');
        } catch {
          return AVATAR_FALLBACK;
        }
      }

      function partnerFrom(conv) {
        const ps = Array.isArray(conv.participantes) ? conv.participantes : [];

        let other = ps.find(p => Number(p.id) && Number(p.id) !== ME.id);
        if (!other && ME.username) {
          other = ps.find(p => (p.username || p.nombre_usuario) && (p.username || p.nombre_usuario) !== ME.username);
        }
        if (!other) other = ps[0] || {};

        const username = other.username || other.nombre_usuario || '';
        const fullName =
          other.nombre_completo ||
          [other.nombre, other.apellido].filter(Boolean).join(' ') ||
          other.display_name ||
          username || 'Chat';

        const rawAvatar =
          other.avatar_url ||
          other.avatar ||
          other.foto ||
          other.foto_url ||
          other.image ||
          other.image_url ||
          other.profile_image ||
          other.profile_image_url ||
          other.photo ||
          other.photo_url ||
          other.profile_picture ||
          other.profile_picture_url ||
          (other.perfil && (
            other.perfil.avatar_url ||
            other.perfil.avatar ||
            other.perfil.foto ||
            other.perfil.foto_url ||
            other.perfil.image ||
            other.perfil.image_url ||
            other.perfil.profile_image ||
            other.perfil.profile_image_url ||
            other.perfil.profile_picture ||
            other.perfil.profile_picture_url
          )) ||
          null;

        const avatar = toAbsoluteMedia(rawAvatar);
        return { name: fullName, username, avatar };
      }

      function renderConversationList(items) {
        if (!Array.isArray(items) || !items.length) {
          listEl.innerHTML = '<div class="p-3 text-muted">Aún no tienes conversaciones.</div>';
          return;
        }
        listEl.innerHTML = '';
        items.forEach(conv => {
          const p = partnerFrom(conv);
          const last = conv.ultimo_mensaje || {};
          const el = document.createElement('div');
          el.className = 'chat-list-item' + (conv.conversacion_id === currentConvId ? ' active' : '');
          el.dataset.convId = conv.conversacion_id;
          el.innerHTML = `
        <img class="chat-avatar" src="${p.avatar}" alt=""
     onerror="this.onerror=null;this.src='{% static 'img/Gifters/favicongift.png' %}'">
        <div class="chat-names">
          <div class="line1">${p.name}</div>
          <div class="line2">${last.contenido ? (last.contenido).slice(0, 72) : 'Sin mensajes'}</div>
        </div>
        <div class="chat-time">${last.creado_en ? formatTime(last.creado_en) : ''}</div>
      `;
          el.addEventListener('click', () => openConversation(conv.conversacion_id));
          listEl.appendChild(el);
        });
      }

      function formatTime(ts) {
        try {
          const d = new Date(ts);
          return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } catch { return ''; }
      }

      async function openConversation(convId) {
        currentConvId = convId;
        Array.from(listEl.children).forEach(li => {
          li.classList.toggle('active', Number(li.dataset.convId) === Number(convId));
        });
        emptyEl.hidden = true;
        msgsEl.hidden = false;
        formEl.hidden = false;
        msgsEl.innerHTML = '<div class="p-2 text-muted">Cargando mensajes…</div>';
        await loadMessagesOnce();
        scrollToBottom();
        startPolling();
      }

      async function loadMessagesOnce() {
        if (!currentConvId) return;
        const url = "{% url 'mensajes_list_create' 0 %}".replace('/0/', `/${currentConvId}/`);
        try {
          const res = await fetch(url, { credentials: 'same-origin' });
          if (!res.ok) throw new Error('Error cargando mensajes');
          const data = await res.json();
          renderMessages(Array.isArray(data) ? data : (data.results || []));
        } catch (e) {
          msgsEl.innerHTML = '<div class="p-2 text-danger">No se pudieron cargar los mensajes.</div>';
          console.error(e);
        }
      }

      function renderMessages(msgs) {
        msgsEl.innerHTML = '';

        // Inyecta el id del usuario de forma segura y como número
        const meId = Number('{{ user.id|default:"0"|escapejs }}');

        msgs.slice().reverse().forEach(m => {
          const authorId = Number(m.remitente_id || (m.remitente && m.remitente.id));
          const isMe = authorId === meId;

          const bubble = document.createElement('div');
          bubble.className = 'msg ' + (isMe ? 'me' : 'other');

          const body = (m.contenido || '')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');

          const when = m.creado_en ? formatTime(m.creado_en) : '';

          bubble.innerHTML = `<div class="body">${body}</div><div class="meta">${when}</div>`;
          msgsEl.appendChild(bubble);
        });
      }
      function scrollToBottom() { msgsEl.scrollTop = msgsEl.scrollHeight; }

      formEl.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const text = (textEl.value || '').trim();
        if (!text || !currentConvId) return;
        const url = "{% url 'mensajes_list_create' 0 %}".replace('/0/', `/${currentConvId}/`);
        try {
          const res = await fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRFTOKEN },
            body: JSON.stringify({ contenido: text, tipo: 'texto' })
          });
          if (!res.ok) throw new Error('No se pudo enviar el mensaje');
          textEl.value = '';
          await loadMessagesOnce();
          scrollToBottom();
          loadConversations(); // refresca preview del último mensaje
        } catch (e) {
          console.error(e);
          alert('No se pudo enviar el mensaje.');
        }
      });

      textEl.addEventListener('keydown', function (e) {
        // evita interferencias con IME (teclados de composición)
        if (e.isComposing) return;

        const isEnter = e.key === 'Enter';
        const onlyEnter = isEnter && !e.shiftKey && !e.ctrlKey && !e.altKey && !e.metaKey;

        if (onlyEnter) {
          e.preventDefault(); // no insertes salto de línea
          const txt = (textEl.value || '').trim();
          if (!txt) return;   // no envíes vacío

          // reutiliza tu handler de submit existente
          if (formEl.requestSubmit) {
            formEl.requestSubmit();
          } else {
            formEl.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
          }
        }
      });

      // (opcional) pista UX
      textEl.setAttribute('title', 'Enter: enviar • Shift+Enter: salto de línea');

      function startPolling() { stopPolling(); pollTimer = setInterval(loadMessagesOnce, 3000); }
      function stopPolling() { if (pollTimer) { clearInterval(pollTimer); pollTimer = null; } }

      window.openChatWith = async function (username) {
        if (!username) return;

        // abre el cajón
        if (typeof openDrawer === 'function') {
          openDrawer();
        } else {
          document.getElementById('chatFab')?.click();
        }

        // 1) intenta encontrar una conversación ya existente con ese username
        try {
          const res = await fetch("{% url 'conversaciones_list' %}", { credentials: 'same-origin' });
          const data = await res.json();
          const conv = (data || []).find(c =>
            (c.participantes || []).some(p => p.username === username)
          );
          if (conv && typeof openConversation === 'function') {
            await openConversation(conv.conversacion_id);
            return;
          }
        } catch (e) {
          console.error('No se pudo listar conversaciones', e);
        }

        // 2) si no existe, pide al backend que la garantice usando tu vista existente
        //    chat_con_usuario (la que antes te llevaba al chat “viejo”).
        //    Esa vista suele CREAR la conversación si no existe.
        try {
          const url = "{% url 'chat_con_usuario' '___u___' %}".replace('___u___', encodeURIComponent(username));
          // Llamada “silenciosa”: no navegamos, solo disparamos la creación
          await fetch(url, { credentials: 'same-origin' });

          // recarga la lista y vuelve a buscar
          const res2 = await fetch("{% url 'conversaciones_list' %}", { credentials: 'same-origin' });
          const data2 = await res2.json();
          const conv2 = (data2 || []).find(c =>
            (c.participantes || []).some(p => p.username === username)
          );
          if (conv2 && typeof openConversation === 'function') {
            await openConversation(conv2.conversacion_id);
            return;
          }
        } catch (e) {
          console.error('No se pudo crear/garantizar la conversación', e);
        }

        // 3) si aún no se pudo, al menos deja el cajón abierto
        console.warn('No se encontró ni pudo crear conversación con', username);
      };

      window.addEventListener('beforeunload', stopPolling);
    })();

  </script>
  {% endif %}

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btnChatPerfilPublico');
      btn?.addEventListener('click', (e) => {
        e.preventDefault();
        const u = btn.dataset.username;
        if (window.openChatWith) {
          window.openChatWith(u);  // ← abre el cajón y salta a ese chat
        } else {
          document.getElementById('chatFab')?.click(); // fallback: abre el cajón
        }
      });
    });
  </script>



  {% block extra_js %}{% endblock %}


</body>

</html>