{% extends "base.html" %}
{% load static %}

{% block title %}Gifter‚Äôs{% endblock %}
{% block body_class %}index-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/perfil.css' %}">
<style>
  .events-header {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: .5rem;
    margin-bottom: .75rem;
  }

  .events-header h3 {
    grid-column: 2;
    justify-self: center;
    margin: 0;
    text-align: center;
  }

  .events-header #btn-toggle-nuevo-evento {
    grid-column: 3;
    justify-self: end;
  }

  /* Lista de eventos */
  .events-list .event-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border: 1px solid #eee;
    border-radius: 12px;
    padding: .75rem 1rem;
    margin-bottom: .5rem;
  }

  .events-list .left {
    display: flex;
    align-items: center;
    gap: .75rem;
    cursor: pointer;
  }

  .events-list .badge {
    font-size: .875rem;
    background: #eef4ff;
    padding: .25rem .5rem;
    border-radius: 8px;
  }

  .events-list .name {
    font-weight: 600;
  }

  .events-list .right {
    display: flex;
    align-items: center;
    gap: .5rem;
  }

  .inline-form {
    display: inline;
    margin: 0;
  }

  .delete-link {
    border: none;
    background: transparent;
    cursor: pointer;
    color: #dc3545;
  }

  .edit-link {
    text-decoration: none;
  }

  /* Panel colapsable */
  .collapse-panel {
    transition: max-height .25s ease;
    overflow: hidden;
    max-height: 0;
    border: 1px dashed #cfe2ff;
    border-radius: 12px;
    padding: 0 1rem;
  }

  .collapse-panel.open {
    padding: 1rem;
  }

  /* Acorde√≥n descripci√≥n */
  .event-desc {
    overflow: hidden;
    max-height: 0;
    transition: max-height .25s ease;
  }

  .event-desc.open {
    padding-top: .5rem;
  }
  /* ===== Formulario de nuevo evento ===== */
.events-form{
  display:grid;
  grid-template-columns: 160px 1fr;   /* columna de label + campo */
  gap:.75rem 1rem;
  align-items:center;
}

.events-form label{ font-weight:600; color:#333; }

.events-form input[type="text"],
.events-form input[type="date"],
.events-form textarea,
.events-form select{
  width:100%;
  box-sizing:border-box;
  padding:.5rem .65rem;
  border:1px solid #cfe2ff;
  border-radius:10px;
  background:#fff;
}

.events-form textarea{ resize:vertical; min-height:90px; }

/* Fila de acciones al final, alineada a la derecha */
.events-form .actions{
  grid-column:1 / -1;
  display:flex;
  justify-content:flex-end;
  gap:.5rem;
}

/* Evitar que los botones se estiren en alto */
.events-form .btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  height:auto;
  line-height:1.2;
  padding:.5rem .9rem;
}
/* ===== Amigos: grid uniforme ===== */
.friends-grid{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap:16px;
}

.friend-card{
  display:grid;
  grid-template-columns: 72px 1fr;
  grid-template-rows: auto auto 1fr auto; /* nombre, @, filler, acciones */
  align-items:center;
  column-gap:14px;
  row-gap:6px;

  border:1px solid #eee;
  border-radius:12px;
  padding:14px;
  background:#fff;

  min-height:140px;            /* alto consistente */
}

/* Avatar */
.friend-card .avatar{
  grid-row: 1 / span 3;        /* ocupa alto del texto */
  width:72px; height:72px; border-radius:50%; overflow:hidden;
}
.friend-card .avatar img{ width:100%; height:100%; object-fit:cover; }

/* Nombre + usuario con clamp para que todas alineen */
.friend-card .name{
  font-weight:700; font-size:1.25rem; line-height:1.1;
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
  overflow:hidden;
  margin:0;
}
.friend-card .handle{ color:#6c757d; margin:0; }

/* Acciones al fondo y a la derecha */
.friend-card .actions{
  grid-column: 2;
  align-self:end;
  display:flex; gap:.5rem; justify-content:flex-start;
}

/* Botones consistentes */
.friend-card .btn{ padding:.4rem .7rem; line-height:1.2; }

</style>
{% endblock %}

{% block content %}
<div class="profile-header">
  <div class="profile-info">

    <div class="g-avatar g-avatar--banner"
      style="background-image:url('{% if perfil.profile_picture %}{{ perfil.profile_picture.url }}{% else %}{% static 'img/Gifters/favicongift.png' %}{% endif %}');">
    </div>

    <div class="user-details">
      <h2>{{ request.user.nombre }} {{ request.user.apellido }}</h2>
      <p class="text-muted">@{{ request.user.nombre_usuario }}</p>
      <p class="description">{{ request.user.perfil.bio|default:"Sin biograf√≠a a√∫n." }}</p>
    </div>

    <div class="edit-profile">
      <a href="{% url 'perfil_editar' %}" class="btn-edit">Editar perfil ‚úé</a>
    </div>

  </div>

  <nav class="profile-nav">
    <ul>
      <li><a href="#" class="active" data-tab="wishlist">Wishlist</a></li>
      <li><a href="#" data-tab="recibidos">Regalos recibidos</a></li>
      <li><a href="#" data-tab="eventos">Eventos importantes</a></li>
      <li><a href="#" data-tab="amigos">Amigos</a></li>
    </ul>
  </nav>
</div>

<div class="profile-content">

  <!-- Wishlist -->
  <section id="wishlist" class="tab-content active">
    <h3>A ‚Äú{{ request.user.nombre_usuario }}‚Äù le encantar√≠a</h3>
    <div class="gift-grid">
      <div class="gift-card">
        <img src="{% static 'img/logo.png' %}" alt="Producto">
        <div class="gift-info">
          <h4>Nestle Trencito</h4>
          <p>Chocolate de leche</p>
        </div>
        <div class="gift-actions">
          <button title="Marcar">‚úî</button>
          <button title="Ver">üîç</button>
          <button title="Copiar enlace">üîó</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Regalos recibidos -->
  <section id="recibidos" class="tab-content">
    <h3>‚ÄúUsuario‚Äù ya recibi√≥</h3>
    <div class="gift-grid">
      <div class="gift-card">
        <img src="{% static 'img/logo.png' %}" alt="Producto recibido">
        <div class="gift-info">
          <h4>Nestle Trencito</h4>
          <p>Chocolate de leche</p>
        </div>
        <div class="gift-actions">
          <button title="Ver" alt="emoji lupa">üîç</button>
          <button title="Copiar enlace" alt="emoji link">üîó</button>
        </div>
      </div>
    </div>
  </section>

  {% load i18n %}

  <!-- Eventos importantes -->
  {% language 'es' %}
  <section id="eventos" class="tab-content">
    <div class="events-header">
      <h3>Eventos importantes de ‚Äú{{ request.user.nombre_usuario }}‚Äù</h3>
      <button id="btn-toggle-nuevo-evento" class="btn btn-primary btn-rounded-sm" type="button" aria-expanded="false"
        aria-controls="panel-nuevo-evento" title="Agregar evento">Ôºã</button>
    </div>

    <!-- Panel colapsable (contenido del formulario de nuevo evento) -->
<div id="panel-nuevo-evento" class="collapse-panel" hidden>
  <form method="post" action="" class="events-form">
    {% csrf_token %}
    <input type="hidden" name="form" value="evento">

    <label for="{{ evento_form.fecha_evento.id_for_label }}">Fecha</label>
    {{ evento_form.fecha_evento }}

    <label for="{{ evento_form.titulo.id_for_label }}">T√≠tulo</label>
    {{ evento_form.titulo }}

    <label for="{{ evento_form.descripcion.id_for_label }}">Descripci√≥n</label>
    {{ evento_form.descripcion }}

    <div class="actions">
      <button type="submit" class="btn btn-primary">Guardar</button>
      <button type="button" class="btn btn-outline-secondary"
              onclick="document.getElementById('btn-toggle-nuevo-evento').click()">Cancelar</button>
    </div>
  </form>
</div>



    <div class="events-list">
      {% for ev in eventos %}
      <div class="event-item" data-event-id="{{ ev.pk }}">
        <div class="left event-toggle" role="button" tabindex="0" aria-expanded="false"
          aria-controls="desc-{{ ev.pk }}">
          <span class="badge">
            {% language 'es' %}
            {{ ev.fecha_evento|date:"j" }} de {{ ev.fecha_evento|date:"F" }}
            {% endlanguage %}
          </span>
          <div class="name">{{ ev.titulo }}</div>
        </div>
        <div class="right">
          {% if ev.pk %}
          <a class="edit-link" title="Editar" href="{% url 'evento_editar' evento_id=ev.pk %}">‚úé</a>

          <form method="post" action="{% url 'evento_eliminar' evento_id=ev.pk %}" class="inline-form delete-form">
            {% csrf_token %}
            <button type="button" class="delete-link" title="Eliminar" data-title="{{ ev.titulo }}">Eliminar</button>
          </form>
          {% endif %}
        </div>

        {% if ev.descripcion %}
        <div id="desc-{{ ev.pk }}" class="event-desc" hidden>
          <p>{{ ev.descripcion|linebreaksbr }}</p>
        </div>
        {% endif %}
      </div>
      {% empty %}
      <p class="text-muted">A√∫n no tienes eventos. Toca el <strong>Ôºã</strong> para agregar el primero.</p>
      {% endfor %}
    </div>
  </section>
  {% endlanguage %}

<!-- Amigos -->
<section id="amigos" class="tab-content">
  <h3>Tus amigos</h3>

  {% if amigos %}
    <div class="friends-grid">
      {% for a in amigos %}
      <div class="friend-card">
        <div class="avatar">
          {% if a.perfil and a.perfil.profile_picture %}
            <img src="{{ a.perfil.profile_picture.url }}" alt="{{ a.nombre }} {{ a.apellido }}">
          {% else %}
            <img src="{% static 'img/Gifters/favicongift.png' %}" alt="{{ a.nombre }} {{ a.apellido }}">
          {% endif %}
        </div>

        <h4 class="name">{{ a.nombre }} {{ a.apellido }}</h4>
        <p class="handle">@{{ a.nombre_usuario }}</p>

        <div class="actions">
          {# Cambia 'perfil_detalle' si tu URL se llama distinto (p.ej. 'perfil_publico') #}
          <a href="{% url 'perfil_detalle' a.nombre_usuario %}" class="btn btn-outline-primary btn-sm">Ver perfil</a>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">A√∫n no tienes amigos agregados. ¬°Empieza enviando solicitudes!</p>
  {% endif %}
</section>



</div>
{% endblock %}

{% block extra_js %}

<!-- SweetAlert2 para confirmaciones -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  /* ===== Panel ‚ÄúNuevo evento‚Äù ===== */
  const btn = document.getElementById("btn-toggle-nuevo-evento");
  const panel = document.getElementById("panel-nuevo-evento");

  if (btn && panel) {
    panel.hidden = true;
    panel.style.maxHeight = "0px";
    panel.style.overflow = "hidden";
    btn.setAttribute("aria-expanded", "false");
    btn.textContent = "Ôºã";

    const setMaxPanel = (el) => el.style.maxHeight = el.scrollHeight + "px";
    const openP = () => {
      panel.hidden = false;
      panel.classList.add("open");
      setMaxPanel(panel);
      btn.setAttribute("aria-expanded", "true");
      btn.textContent = "‚Äì";
    };
    const closeP = () => {
      if (!panel.style.maxHeight || panel.style.maxHeight === "0px") {
        panel.style.maxHeight = panel.scrollHeight + "px";
      }
      requestAnimationFrame(() => {
        panel.classList.remove("open");
        panel.style.maxHeight = "0px";
      });
      btn.setAttribute("aria-expanded", "false");
      btn.textContent = "Ôºã";
    };

    btn.addEventListener("click", () =>
      btn.getAttribute("aria-expanded") === "true" ? closeP() : openP()
    );

    panel.addEventListener("transitionend", (ev) => {
      if (ev.propertyName !== "max-height") return;
      btn.getAttribute("aria-expanded") === "true"
        ? setMaxPanel(panel)
        : (panel.hidden = true);
    });

    window.addEventListener("resize", () => {
      if (btn.getAttribute("aria-expanded") === "true") setMaxPanel(panel);
    });
    panel.addEventListener("input", () => {
      if (btn.getAttribute("aria-expanded") === "true") setMaxPanel(panel);
    });
  }

  /* ===== Tabs ===== */
  const nav = document.querySelector(".profile-nav");
const sections = document.querySelectorAll(".tab-content");

function activateTab(key){
  if (!key) return;
  // desactivar todo
  nav.querySelectorAll("a[data-tab]").forEach(a => a.classList.remove("active"));
  sections.forEach(s => s.classList.remove("active"));
  // activar elegidos
  const link = nav.querySelector(`a[data-tab="${key}"]`);
  const target = document.getElementById(key);
  if (link) link.classList.add("active");
  if (target) target.classList.add("active");
}

// estado inicial seguro (por si algo llega sin .active)
let initial = nav.querySelector("a[data-tab].active");
activateTab(initial ? initial.getAttribute("data-tab") : "wishlist");

// delegaci√≥n de eventos (un solo listener)
nav.addEventListener("click", function(e){
  const a = e.target.closest("a[data-tab]");
  if (!a) return;
  e.preventDefault();
  activateTab(a.getAttribute("data-tab"));
});

  /* ===== Descripci√≥n por evento (acorde√≥n) ===== */
  const items = document.querySelectorAll(".events-list .event-item");
  const setMaxDesc = (el) => (el.style.maxHeight = el.scrollHeight + "px");

  function openDesc(descPanel, toggle) {
    descPanel.hidden = false;
    descPanel.classList.add("open");
    setMaxDesc(descPanel);
    toggle.setAttribute("aria-expanded", "true");
  }

  function closeDesc(descPanel, toggle) {
    if (!descPanel.style.maxHeight || descPanel.style.maxHeight === "0px") {
      descPanel.style.maxHeight = descPanel.scrollHeight + "px";
    }
    requestAnimationFrame(() => {
      descPanel.classList.remove("open");
      descPanel.style.maxHeight = "0px";
    });
    toggle.setAttribute("aria-expanded", "false");
  }

  function closeAllExcept(current) {
    items.forEach((it) => {
      const tg = it.querySelector(".event-toggle");
      const pn = it.querySelector(".event-desc");
      if (pn && pn !== current && tg.getAttribute("aria-expanded") === "true") {
        closeDesc(pn, tg);
      }
    });
  }

  items.forEach((item) => {
    const toggle = item.querySelector(".event-toggle");
    const descPanel = item.querySelector(".event-desc");
    if (!toggle || !descPanel) return;

    toggle.setAttribute("role", "button");
    toggle.setAttribute("tabindex", "0");
    toggle.setAttribute("aria-expanded", "false");
    toggle.setAttribute("aria-controls", descPanel.id);

    toggle.addEventListener("click", () => {
      const isOpen = toggle.getAttribute("aria-expanded") === "true";
      if (isOpen) {
        closeDesc(descPanel, toggle);
      } else {
        closeAllExcept(descPanel);
        openDesc(descPanel, toggle);
      }
    });
    toggle.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        toggle.click();
      }
    });
    descPanel.addEventListener("transitionend", (ev) => {
      if (ev.propertyName !== "max-height") return;
      toggle.getAttribute("aria-expanded") === "true"
        ? setMaxDesc(descPanel)
        : (descPanel.hidden = true);
    });
  });

  window.addEventListener("resize", () =>
    document.querySelectorAll(".event-desc.open").forEach((p) => setMaxDesc(p))
  );

  /* ===== Confirmar eliminaci√≥n (SweetAlert2 con fetch) ===== */
  document.body.addEventListener("click", function (e) {
    const btnDel = e.target.closest(".delete-form .delete-link");
    if (!btnDel) return;

    e.preventDefault();
    const form = btnDel.closest("form");
    const titulo = btnDel.getAttribute("data-title") || "este evento";

    if (btnDel.type && btnDel.type.toLowerCase() === "submit") {
      btnDel.type = "button";
    }

    Swal.fire({
      title: "¬øEst√°s seguro?",
      text: `Se eliminar√° ¬´${titulo}¬ª y no podr√°s recuperarlo.`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "S√≠, eliminar",
      cancelButtonText: "Cancelar",
    }).then((result) => {
      if (!result.isConfirmed) return;

      fetch(form.action, {
        method: "POST",
        body: new FormData(form),
        headers: { "X-Requested-With": "XMLHttpRequest" },
      }).then((r) => {
        if (r.ok) {
          Swal.fire({
            title: "¬°Eliminado!",
            text: "El evento fue eliminado con √©xito.",
            icon: "success",
            confirmButtonText: "OK",
          }).then(() => window.location.reload());
        }
      });
    });
  });
}); 



</script>
{% endblock %}
