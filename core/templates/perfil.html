{% extends "base.html" %}
{% block flash_messages %}{% endblock %}
{% load static %}

{% block title %}Gifter’s{% endblock %}
{% block body_class %}index-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/perfil.css' %}">
<style>
  .events-header {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: .5rem;
    margin-bottom: .75rem;
  }

  .events-header h3 {
    grid-column: 2;
    justify-self: center;
    margin: 0;
    text-align: center;
  }

  .events-header #btn-toggle-nuevo-evento {
    grid-column: 3;
    justify-self: end;
  }

  /* Lista de eventos */
  .events-list .event-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border: 1px solid #eee;
    border-radius: 12px;
    padding: .75rem 1rem;
    margin-bottom: .5rem;
  }

  .events-list .left {
    display: flex;
    align-items: center;
    gap: .75rem;
    cursor: pointer;
  }

  .events-list .badge {
    font-size: .875rem;
    background: #eef4ff;
    padding: .25rem .5rem;
    border-radius: 8px;
  }

  .events-list .name {
    font-weight: 600;
  }

  .events-list .right {
    display: flex;
    align-items: center;
    gap: .5rem;
  }

  .inline-form {
    display: inline;
    margin: 0;
  }

  .delete-link {
    border: none;
    background: transparent;
    cursor: pointer;
    color: #dc3545;
  }

  .edit-link {
    text-decoration: none;
  }

  /* Panel colapsable */
  .collapse-panel {
    transition: max-height .25s ease;
    overflow: hidden;
    max-height: 0;
    border: 1px dashed #cfe2ff;
    border-radius: 12px;
    padding: 0 1rem;
  }

  .collapse-panel.open {
    padding: 1rem;
  }

  /* Acordeón descripción */
  .event-desc {
    overflow: hidden;
    max-height: 0;
    transition: max-height .25s ease;
  }

  .event-desc.open {
    padding-top: .5rem;
  }

  /* ===== Formulario de nuevo evento ===== */
  .events-form {
    display: grid;
    grid-template-columns: 160px 1fr;
    /* columna de label + campo */
    gap: .75rem 1rem;
    align-items: center;
  }

  .events-form label {
    font-weight: 600;
    color: #333;
  }

  .events-form input[type="text"],
  .events-form input[type="date"],
  .events-form textarea,
  .events-form select {
    width: 100%;
    box-sizing: border-box;
    padding: .5rem .65rem;
    border: 1px solid #cfe2ff;
    border-radius: 10px;
    background: #fff;
  }

  .events-form textarea {
    resize: vertical;
    min-height: 90px;
  }

  /* Fila de acciones al final, alineada a la derecha */
  .events-form .actions {
    grid-column: 1 / -1;
    display: flex;
    justify-content: flex-end;
    gap: .5rem;
  }

  /* Evitar que los botones se estiren en alto */
  .events-form .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: auto;
    line-height: 1.2;
    padding: .5rem .9rem;
  }

  /* ===== Amigos: grid uniforme ===== */
  .friends-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
  }

  .friend-card {
    display: grid;
    grid-template-columns: 72px 1fr;
    grid-template-rows: auto auto 1fr auto;
    /* nombre, @, filler, acciones */
    align-items: center;
    column-gap: 14px;
    row-gap: 6px;

    border: 1px solid #eee;
    border-radius: 12px;
    padding: 14px;
    background: #fff;

    min-height: 140px;
    /* alto consistente */
  }

  /* Avatar */
  .friend-card .avatar {
    grid-row: 1 / span 3;
    /* ocupa alto del texto */
    width: 72px;
    height: 72px;
    border-radius: 50%;
    overflow: hidden;
  }

  .friend-card .avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Nombre + usuario con clamp para que todas alineen */
  .friend-card .name {
    font-weight: 700;
    font-size: 1.25rem;
    line-height: 1.1;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin: 0;
  }

  .friend-card .handle {
    color: #6c757d;
    margin: 0;
  }

  /* Acciones al fondo y a la derecha */
  .friend-card .actions {
    grid-column: 2;
    align-self: end;
    display: flex;
    gap: .5rem;
    justify-content: flex-start;
  }

  /* Botones consistentes */
  .friend-card .btn {
    padding: .4rem .7rem;
    line-height: 1.2;
  }
</style>
{% endblock %}

{% block content %}
<div class="profile-header">
  <div class="profile-info">

    <div class="g-avatar g-avatar--banner"
      style="background-image:url('{% if perfil.profile_picture %}{{ perfil.profile_picture.url }}{% else %}{% static 'img/Gifters/favicongift.png' %}{% endif %}');">
    </div>

    <div class="user-details">
      <h2>{{ request.user.nombre }} {{ request.user.apellido }}</h2>
      <p class="text-muted">@{{ request.user.nombre_usuario }}</p>
      <p class="description">{{ request.user.perfil.bio|default:"Sin biografía aún." }}</p>
    </div>

    <div class="edit-profile">

      <a href="{% url 'perfil_editar' %}" class="btn-edit">Editar perfil ✎</a>
    </div>

  </div>

  <nav class="profile-nav">
    <ul>
      <li><a href="#" class="active" data-tab="wishlist">Wishlist</a></li>
      <li><a href="#" data-tab="recibidos">Regalos recibidos</a></li>
      <li><a href="#" data-tab="eventos">Eventos importantes</a></li>
      <li><a href="#" data-tab="amigos">Amigos</a></li>
    </ul>
  </nav>
</div>

<div class="profile-content">

  <!-- Wishlist -->
<section id="wishlist" class="tab-content active">
  <h3>Tu WishList</h3>

  {# Placeholder de vacío (se oculta si hay items) #}
  <p id="empty-wishlist" class="text-muted" {% if wishlist_items %}hidden{% endif %}>
    Tu wishlist está vacía. Agrega productos desde el catálogo.
  </p>

  <div id="wishlist-container" class="gift-grid">
    {% if wishlist_items %}
      {% for it in wishlist_items %}
        {% with p=it.id_producto url_tienda=p.urls_tienda_activas.first %}
        <div class="gift-card"
             id="wl-item-{{ it.id_item }}"
             data-product-id="{{ p.id_producto }}"
             data-is-fav="1"
             data-shop-url="{% if url_tienda %}{{ url_tienda.url }}{% endif %}">
          <img src="{% if p.imagen and p.imagen.url %}{{ p.imagen.url }}{% else %}{% static 'img/Gifters/favicongift.png' %}{% endif %}"
               alt="{{ p.nombre_producto }}">

          <div class="gift-info">
            <h4>{{ p.nombre_producto }}</h4>
            <p>{{ p.id_marca.nombre_marca }}</p>
            {% if p.precio %}<div class="price">${{ p.precio }}</div>{% endif %}
          </div>

          <div class="gift-actions">
            <a href="#" class="wishlist-btn {% if p.id_producto in favoritos_ids %}is-fav{% endif %}"
               data-product-id="{{ p.id_producto }}"
               title="Quitar de wishlist" aria-pressed="true">
              <i class="bi {% if p.id_producto in favoritos_ids %}bi-heart-fill text-danger{% else %}bi-heart{% endif %}"></i>
            </a>

            <a href="#" class="mark-received"
               data-item-id="{{ it.id_item }}"
               data-url="{% url 'wishlist_marcar_recibido' it.id_item %}"
               title="Marcar como recibido">
              <i class="bi bi-bag-check-fill text-success"></i>
            </a>

            {% if url_tienda %}
            <a href="{{ url_tienda.url }}" target="_blank" rel="noopener" title="Ver en tienda">
              <i class="bi bi-link-45deg"></i>
            </a>
            {% endif %}
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    {% endif %}
  </div>
</section>




  <!-- Regalos recibidos -->
<section id="recibidos" class="tab-content">
  <h3>Tus Regalos Recibidos</h3>

  {# Placeholder de vacío (se oculta si hay items) #}
  <p id="empty-recibidos" class="text-muted" {% if recibidos_items %}hidden{% endif %}>
    Aún no registras regalos recibidos.
  </p>

  <div id="recibidos-container" class="gift-grid">
    {% if recibidos_items %}
      {% for it in recibidos_items %}
        {% with p=it.id_producto %}
        <div class="gift-card"
             id="wl-item-{{ it.id_item }}"
             data-product-id="{{ p.id_producto }}"
             data-is-fav="1">
          <img src="{% if p.imagen and p.imagen.url %}{{ p.imagen.url }}{% else %}{% static 'img/Gifters/favicongift.png' %}{% endif %}"
               alt="{{ p.nombre_producto }}">

          <div class="gift-info">
            <h4>{{ p.nombre_producto }}</h4>
            <p>{{ p.id_marca.nombre_marca }}</p>
            {% if p.precio %}<div class="price">${{ p.precio }}</div>{% endif %}
            <div class="text-muted" style="font-size:.85rem">
              Recibido el {{ it.fecha_comprado|date:"d/m/Y H:i" }}
            </div>
          </div>

          <div class="gift-actions">
            {# Solo basurero en Recibidos #}
            <a href="#" class="undo-received"
               data-url="{% url 'wishlist_desmarcar_recibido' it.id_item %}"
               title="Quitar de 'Recibidos' (volver a Wishlist)">
              <i class="bi bi-trash"></i>
            </a>
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    {% endif %}
  </div>
</section>




  {% load i18n %}

  <!-- Eventos importantes -->
  {% language 'es' %}
  <section id="eventos" class="tab-content">
    <div class="events-header">
      <h3>Tus eventos</h3>
      <button id="btn-toggle-nuevo-evento" class="btn btn-primary btn-rounded-sm" type="button" aria-expanded="false"
        aria-controls="panel-nuevo-evento" title="Agregar evento">＋</button>
    </div>

    <!-- Panel colapsable (contenido del formulario de nuevo evento) -->
    <div id="panel-nuevo-evento" class="collapse-panel" hidden>
      <form method="post" action="" class="events-form">
        {% csrf_token %}
        <input type="hidden" name="form" value="evento">

        <label for="{{ evento_form.fecha_evento.id_for_label }}">Fecha</label>
        {{ evento_form.fecha_evento }}

        <label for="{{ evento_form.titulo.id_for_label }}">Título</label>
        {{ evento_form.titulo }}

        <label for="{{ evento_form.descripcion.id_for_label }}">Descripción</label>
        {{ evento_form.descripcion }}

        <div class="actions">
          <button type="submit" class="btn btn-primary">Guardar</button>
          <button type="button" class="btn btn-outline-secondary"
            onclick="document.getElementById('btn-toggle-nuevo-evento').click()">Cancelar</button>
        </div>
      </form>
    </div>



    <div class="events-list">
      {% for ev in eventos %}
      <div class="event-item" data-event-id="{{ ev.pk }}">
        <div class="left event-toggle" role="button" tabindex="0" aria-expanded="false"
          aria-controls="desc-{{ ev.pk }}">
          <span class="badge">
            {% language 'es' %}
            {{ ev.fecha_evento|date:"j" }} de {{ ev.fecha_evento|date:"F" }}
            {% endlanguage %}
          </span>
          <div class="name">{{ ev.titulo }}</div>
        </div>
        <div class="right">
          {% if ev.pk %}
          <a class="edit-link" title="Editar" href="{% url 'evento_editar' evento_id=ev.pk %}">✎</a>

          <form method="post" action="{% url 'evento_eliminar' evento_id=ev.pk %}" class="inline-form delete-form">
            {% csrf_token %}
            <button type="button" class="delete-link" title="Eliminar" data-title="{{ ev.titulo }}">Eliminar</button>
          </form>
          {% endif %}
        </div>

        {% if ev.descripcion %}
        <div id="desc-{{ ev.pk }}" class="event-desc" hidden>
          <p>{{ ev.descripcion|linebreaksbr }}</p>
        </div>
        {% endif %}
      </div>
      {% empty %}
      <p class="text-muted">Aún no tienes eventos. Toca el <strong>＋</strong> para agregar el primero.</p>
      {% endfor %}
    </div>
  </section>
  {% endlanguage %}

  <!-- Amigos -->
  <section id="amigos" class="tab-content">
    <h3>Tus amigos</h3>

    {% if amigos %}
    <div class="friends-grid">
      {% for a in amigos %}
      <div class="friend-card">
        <div class="avatar">
          {% if a.perfil and a.perfil.profile_picture %}
          <img src="{{ a.perfil.profile_picture.url }}" alt="{{ a.nombre }} {{ a.apellido }}">
          {% else %}
          <img src="{% static 'img/Gifters/favicongift.png' %}" alt="{{ a.nombre }} {{ a.apellido }}">
          {% endif %}
        </div>

        <h4 class="name">{{ a.nombre }} {{ a.apellido }}</h4>
        <p class="handle">@{{ a.nombre_usuario }}</p>

        <div class="actions">
          {# Cambia 'perfil_detalle' si tu URL se llama distinto (p.ej. 'perfil_publico') #}
          <a href="{% url 'perfil_detalle' a.nombre_usuario %}" class="btn btn-outline-primary btn-sm">Ver perfil</a>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">Aún no tienes amigos agregados. ¡Empieza enviando solicitudes!</p>
    {% endif %}
  </section>



</div>
{% endblock %}

{% block extra_js %}
<style>
  /* Corazón con pequeño "pop" */
  .wishlist-btn i.heart-pop {
    animation: heart-pop 380ms ease;
  }
  @keyframes heart-pop {
    0%   { transform: scale(1); }
    40%  { transform: scale(1.25); }
    100% { transform: scale(1); }
  }

  /* opcional: resaltar el botón un instante */
  .wishlist-btn.pop-bg {
    box-shadow: 0 0 0 0 rgba(108,99,255,.35);
    animation: btn-glow 480ms ease;
  }
  @keyframes btn-glow {
    0%   { box-shadow: 0 0 0 0 rgba(108,99,255,.35); transform: translateY(-2px); }
    100% { box-shadow: 0 0 0 12px rgba(108,99,255,0); transform: translateY(0); }
  }
</style>

<style>
  /* Oculta los mensajes clásicos solo en esta página */
  #flash-messages,
  .messages,
  .django-messages,
  .alert[role="alert"][data-django-message] {
    display: none !important;
  }
</style>
<style>
  /* --- HEART ANIMS --- */
  .wishlist-btn .bi { transition: transform .18s ease; }
  .wishlist-btn.heart-pop .bi { animation: heartPop .28s ease; }
  @keyframes heartPop {
    0%   { transform: scale(1); }
    50%  { transform: scale(1.35); }
    100% { transform: scale(1); }
  }

  /* brillo sutil cuando queda en favorito */
  .wishlist-btn.is-fav .bi-heart-fill {
    filter: drop-shadow(0 0 6px rgba(220, 53, 69, .35));
  }

  /* --- CARD FADE-OUT AL QUITAR --- */
  .card-fade-out {
    animation: cardFadeOut .28s ease forwards;
    transform-origin: center center;
  }
  @keyframes cardFadeOut {
    to {
      opacity: 0;
      transform: scale(.96);
    }
  }
</style>



<!-- SweetAlert2 para confirmaciones -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Toast listo para usar
  const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 1600,
    timerProgressBar: true
  });
</script>

{% if messages %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      timer: 1800,
      timerProgressBar: true,
      showConfirmButton: false
    });

    {% for m in messages %}
      (function(){
        const tag = "{{ m.tags|default:'info' }}";
        const icon = tag.includes('success') ? 'success'
                    : tag.includes('error') ? 'error'
                    : tag.includes('warning') ? 'warning'
                    : 'info';
        Toast.fire({ icon, title: "{{ m|escapejs }}" });
      })();
    {% endfor %}
  });
</script>
{% endif %}


<script>
  document.addEventListener("DOMContentLoaded", function () {
    /* ===== Helpers: placeholders vacíos ===== */
    const emptyWishlist  = document.getElementById("empty-wishlist");
    const emptyRecibidos = document.getElementById("empty-recibidos");
    const wlContainer    = document.getElementById("wishlist-container");
    const rcContainer    = document.getElementById("recibidos-container");

    function updateEmptyStates() {
      if (emptyWishlist && wlContainer) {
        const hasWL = wlContainer.querySelector(".gift-card");
        emptyWishlist.hidden = !!hasWL;
      }
      if (emptyRecibidos && rcContainer) {
        const hasRC = rcContainer.querySelector(".gift-card");
        emptyRecibidos.hidden = !!hasRC;
      }
    }

    /* estado inicial de placeholders */
    updateEmptyStates();

    /* ===== Panel “Nuevo evento” ===== */
    const btn = document.getElementById("btn-toggle-nuevo-evento");
    const panel = document.getElementById("panel-nuevo-evento");

    if (btn && panel) {
      panel.hidden = true;
      panel.style.maxHeight = "0px";
      panel.style.overflow = "hidden";
      btn.setAttribute("aria-expanded", "false");
      btn.textContent = "＋";

      const setMaxPanel = (el) => el.style.maxHeight = el.scrollHeight + "px";
      const openP = () => {
        panel.hidden = false;
        panel.classList.add("open");
        setMaxPanel(panel);
        btn.setAttribute("aria-expanded", "true");
        btn.textContent = "–";
      };
      const closeP = () => {
        if (!panel.style.maxHeight || panel.style.maxHeight === "0px") {
          panel.style.maxHeight = panel.scrollHeight + "px";
        }
        requestAnimationFrame(() => {
          panel.classList.remove("open");
          panel.style.maxHeight = "0px";
        });
        btn.setAttribute("aria-expanded", "false");
        btn.textContent = "＋";
      };

      btn.addEventListener("click", () =>
        btn.getAttribute("aria-expanded") === "true" ? closeP() : openP()
      );

      panel.addEventListener("transitionend", (ev) => {
        if (ev.propertyName !== "max-height") return;
        btn.getAttribute("aria-expanded") === "true"
          ? setMaxPanel(panel)
          : (panel.hidden = true);
      });

      window.addEventListener("resize", () => {
        if (btn.getAttribute("aria-expanded") === "true") setMaxPanel(panel);
      });
      panel.addEventListener("input", () => {
        if (btn.getAttribute("aria-expanded") === "true") setMaxPanel(panel);
      });
    }

    /* ===== Tabs ===== */
    const nav = document.querySelector(".profile-nav");
    const sections = document.querySelectorAll(".tab-content");

    function activateTab(key) {
      if (!key) return;
      nav.querySelectorAll("a[data-tab]").forEach(a => a.classList.remove("active"));
      sections.forEach(s => s.classList.remove("active"));
      const link = nav.querySelector(`a[data-tab="${key}"]`);
      const target = document.getElementById(key);
      if (link) link.classList.add("active");
      if (target) target.classList.add("active");
    }

    let initial = nav.querySelector("a[data-tab].active");
    activateTab(initial ? initial.getAttribute("data-tab") : "wishlist");

    nav.addEventListener("click", function (e) {
      const a = e.target.closest("a[data-tab]");
      if (!a) return;
      e.preventDefault();
      activateTab(a.getAttribute("data-tab"));
    });

    /* ===== Acordeón eventos ===== */
    const items = document.querySelectorAll(".events-list .event-item");
    const setMaxDesc = (el) => (el.style.maxHeight = el.scrollHeight + "px");

    function openDesc(descPanel, toggle) {
      descPanel.hidden = false;
      descPanel.classList.add("open");
      setMaxDesc(descPanel);
      toggle.setAttribute("aria-expanded", "true");
    }
    function closeDesc(descPanel, toggle) {
      if (!descPanel.style.maxHeight || descPanel.style.maxHeight === "0px") {
        descPanel.style.maxHeight = descPanel.scrollHeight + "px";
      }
      requestAnimationFrame(() => {
        descPanel.classList.remove("open");
        descPanel.style.maxHeight = "0px";
      });
      toggle.setAttribute("aria-expanded", "false");
    }
    function closeAllExcept(current) {
      items.forEach((it) => {
        const tg = it.querySelector(".event-toggle");
        const pn = it.querySelector(".event-desc");
        if (pn && pn !== current && tg.getAttribute("aria-expanded") === "true") {
          closeDesc(pn, tg);
        }
      });
    }
    items.forEach((item) => {
      const toggle = item.querySelector(".event-toggle");
      const descPanel = item.querySelector(".event-desc");
      if (!toggle || !descPanel) return;

      toggle.setAttribute("role", "button");
      toggle.setAttribute("tabindex", "0");
      toggle.setAttribute("aria-expanded", "false");
      toggle.setAttribute("aria-controls", descPanel.id);

      toggle.addEventListener("click", () => {
        const isOpen = toggle.getAttribute("aria-expanded") === "true";
        if (isOpen) { closeDesc(descPanel, toggle); }
        else { closeAllExcept(descPanel); openDesc(descPanel, toggle); }
      });
      toggle.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          toggle.click();
        }
      });
      descPanel.addEventListener("transitionend", (ev) => {
        if (ev.propertyName !== "max-height") return;
        toggle.getAttribute("aria-expanded") === "true"
          ? setMaxDesc(descPanel)
          : (descPanel.hidden = true);
      });
    });
    window.addEventListener("resize", () =>
      document.querySelectorAll(".event-desc.open").forEach((p) => setMaxDesc(p))
    );

    /* ===== Confirmar eliminación (SweetAlert2 con fetch) ===== */
    document.body.addEventListener("click", function (e) {
      const btnDel = e.target.closest(".delete-form .delete-link");
      if (!btnDel) return;

      e.preventDefault();
      const form = btnDel.closest("form");
      const titulo = btnDel.getAttribute("data-title") || "este evento";

      if (btnDel.type && btnDel.type.toLowerCase() === "submit") {
        btnDel.type = "button";
      }

      Swal.fire({
        title: "¿Estás seguro?",
        text: `Se eliminará «${titulo}» y no podrás recuperarlo.`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Sí, eliminar",
        cancelButtonText: "Cancelar",
      }).then((result) => {
        if (!result.isConfirmed) return;

        fetch(form.action, {
          method: "POST",
          body: new FormData(form),
          headers: { "X-Requested-With": "XMLHttpRequest" },
        }).then((r) => {
          if (r.ok) {
            Swal.fire({
              title: "¡Eliminado!",
              text: "El evento fue eliminado con éxito.",
              icon: "success",
              confirmButtonText: "OK",
            }).then(() => window.location.reload());
          }
        });
      });
    });

    /* ===== Wishlist (toggle desde el perfil) ===== */
    function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  document.addEventListener('click', async function (e) {
  const btn = e.target.closest('.wishlist-btn');
  if (!btn) return;

  e.preventDefault();
  const id   = btn.getAttribute('data-product-id');
  const icon = btn.querySelector('i');
  const wasFav    = btn.classList.contains('is-fav');
  const prevTitle = btn.title;

  // animación corta
  if (icon) icon.classList.add('heart-pop');
  btn.classList.add('pop-bg');
  setTimeout(() => { icon && icon.classList.remove('heart-pop'); btn.classList.remove('pop-bg'); }, 420);

  try {
    const url = `{% url 'favoritos_toggle' 0 %}`.replace('/0/', `/${id}/`);
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
    });

    if (resp.redirected || resp.url.includes('{% url "login" %}')) {
      window.location.href = "{% url 'login' %}?next={{ request.get_full_path|urlencode }}";
      return;
    }
    if (!resp.ok) throw new Error('HTTP ' + resp.status);

    const data = await resp.json();
    const isFav = data.state === 'added';

    // 1) Actualiza icono/estado del botón
    btn.classList.toggle('is-fav', isFav);
    btn.setAttribute('aria-pressed', isFav ? 'true' : 'false');
    btn.title = isFav ? 'Quitar de wishlist' : 'Agregar a wishlist';
    if (icon) icon.className = isFav ? 'bi bi-heart-fill text-danger' : 'bi bi-heart';

    // 2) Si fue REMOVED y estamos en el grid de wishlist del perfil → quitar tarjeta
    const wlGrid = document.getElementById('wishlist-container');
    const card   = btn.closest('.gift-card, .product-card');
    if (!isFav && wlGrid && card && wlGrid.contains(card)) {
      card.classList.add('card-fade-out');      // tienes la animación en tu CSS
      setTimeout(() => {
        card.remove();
        updateEmptyStates();                     // ya definida arriba
      }, 280);
    }

    // 3) Toast
    Toast.fire({ icon: isFav ? 'success' : 'info', title: isFav ? 'Agregado a tu wishlist' : 'Quitado de tu wishlist' });

  } catch (err) {
    console.error(err);
    // revertir UI si falla
    btn.classList.toggle('is-fav', wasFav);
    btn.setAttribute('aria-pressed', wasFav ? 'true' : 'false');
    btn.title = prevTitle;
    if (icon) icon.className = wasFav ? 'bi bi-heart-fill text-danger' : 'bi bi-heart';
    Toast.fire({ icon: 'error', title: 'Ups, no pudimos actualizar' });
  }
});

    /* ===== Marcar como recibido ===== */
    document.body.addEventListener("click", async function (e) {
      const btnMark = e.target.closest(".mark-received");
      if (!btnMark) return;

      e.preventDefault();

      const url = btnMark.getAttribute("data-url");
      const card = btnMark.closest(".gift-card, .product-card");

      const confirm = await Swal.fire({
        title: "¿Marcar como recibido?",
        text: "Este producto saldrá de tu wishlist.",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Sí, marcar",
        cancelButtonText: "Cancelar"
      });
      if (!confirm.isConfirmed) return;

      try {
        const resp = await fetch(url, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest"
          }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error("Respuesta inesperada");

        const recibidos = document.getElementById("recibidos-container");
        if (recibidos && card) {
          const info = card.querySelector(".gift-info");
          if (info) {
            let lbl = info.querySelector(".js-recibido-label");
            if (!lbl) {
              lbl = document.createElement("div");
              lbl.className = "text-muted js-recibido-label";
              lbl.style.fontSize = ".85rem";
              info.appendChild(lbl);
            }
            lbl.textContent = "Recibido el " + (data.fecha || "");
          }

          const actions = card.querySelector(".gift-actions");
          if (actions) {
            const oldBtn = actions.querySelector(".mark-received");
            if (oldBtn) oldBtn.remove();
            actions.querySelectorAll(".wishlist-btn, .bi-link-45deg").forEach(el => {
              const a = el.closest("a") || el;
              a.remove();
            });

            const undo = document.createElement("a");
            undo.href = "#";
            undo.className = "undo-received";
            undo.setAttribute("data-url","{% url 'wishlist_desmarcar_recibido' 0 %}".replace("/0/", `/${data.item_id}/`));
            undo.title = "Quitar de 'Recibidos' (volver a Wishlist)";
            undo.innerHTML = '<i class="bi bi-trash"></i>';
            actions.prepend(undo);
          }

          recibidos.prepend(card);
          updateEmptyStates();   // <— actualizar placeholders
        }

        Swal.fire({
          title: "¡Listo!",
          text: "El regalo se marcó como recibido.",
          icon: "success",
          timer: 1600,
          showConfirmButton: false
        });
      } catch (err) {
        console.error(err);
        Swal.fire("Ups…", "No pudimos marcarlo como recibido.", "error");
      }
    });

    /* ===== Deshacer recibido (volver a Wishlist) ===== */
    document.body.addEventListener("click", async function (e) {
      const btnUndo = e.target.closest(".undo-received");
      if (!btnUndo) return;

      e.preventDefault();

      const url = btnUndo.getAttribute("data-url");
      const card = btnUndo.closest(".gift-card, .product-card");

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

      try {
        const resp = await fetch(url, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest"
          }
        });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data.ok) throw new Error("Respuesta inesperada");

        const lbl = card.querySelector(".js-recibido-label");
        if (lbl) lbl.remove();

        const actions = card.querySelector(".gift-actions");
        if (actions) {
          actions.innerHTML = "";

          const pid = card.dataset.productId;
          const isFav = card.dataset.isFav === "1";
          const heart = document.createElement("a");
          heart.href = "#";
          heart.className = `wishlist-btn ${isFav ? "is-fav" : ""}`;
          heart.setAttribute("data-product-id", pid);
          heart.title = isFav ? "Quitar de wishlist" : "Agregar a wishlist";
          heart.setAttribute("aria-pressed", isFav ? "true" : "false");
          heart.innerHTML = `<i class="bi ${isFav ? "bi-heart-fill text-danger" : "bi-heart"}"></i>`;
          actions.appendChild(heart);

          const mark = document.createElement("a");
          mark.href = "#";
          mark.className = "mark-received";
          mark.setAttribute("data-item-id", data.item_id);
          mark.setAttribute("data-url", "{% url 'wishlist_marcar_recibido' 0 %}".replace("/0/", `/${data.item_id}/`));
          mark.title = "Marcar como recibido";
          mark.innerHTML = '<i class="bi bi-bag-check-fill text-success"></i>';
          actions.appendChild(mark);

          const shopUrl = (card.dataset.shopUrl || "").trim();
          if (shopUrl) {
            const shop = document.createElement("a");
            shop.href = shopUrl;
            shop.target = "_blank";
            shop.rel = "noopener";
            shop.title = "Ver en tienda";
            shop.innerHTML = '<i class="bi bi-link-45deg"></i>';
            actions.appendChild(shop);
          }
        }

        const wl = document.getElementById("wishlist-container");
        if (wl && card) wl.prepend(card);

        const goWishlist = document.querySelector('.profile-nav a[data-tab="wishlist"]');
        if (goWishlist) goWishlist.click();

        updateEmptyStates();    // <— actualizar placeholders

        Swal.fire({
          title: "Deshecho",
          text: "Volvió a tu Wishlist.",
          icon: "success",
          timer: 1400,
          showConfirmButton: false
        });
      } catch (err) {
        console.error(err);
        Swal.fire("Ups…", "No pudimos deshacerlo.", "error");
      }
    });

    /* ===== /NUEVO ===== */
  });
</script>


{% endblock %}