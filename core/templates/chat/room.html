{% extends "base.html" %}
{% load static %}

{% block title %}Chat: {{ room_name }}{% endblock %}

{% block content %}
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Chat {{ conversacion_id }}</title>
  <style>
    body{font-family:system-ui;margin:20px;}
    #log{border:1px solid #ddd;height:300px;overflow:auto;padding:10px;margin-bottom:10px;}
    .msg{margin:6px 0;}
    .me{font-weight:600;}
  </style>
</head>
<body>
  <h2>Conversaci√≥n #{{ conversacion_id }}</h2>
  <div id="log"></div>
  <input id="chat-message-input" placeholder="Escribe un mensaje..." autofocus />
  <button id="send">Enviar</button>

  <script>
    const convId = "{{ conversacion_id }}";
    const scheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = `${scheme}://${window.location.host}/ws/chat/${convId}/`;
    const log = document.getElementById("log");
    const input = document.getElementById("chat-message-input");
    const btn = document.getElementById("send");

    function addLine(text){
      const p = document.createElement("div");
      p.className = "msg";
      p.textContent = text;
      log.appendChild(p);
      log.scrollTop = log.scrollHeight;
    }

    const socket = new WebSocket(wsUrl);

    socket.onopen = () => addLine("üü¢ Conectado.");
    socket.onclose = (e) => addLine(`üî¥ Desconectado (code: ${e.code}).`);
    socket.onerror = (e) => addLine("‚ö†Ô∏è Error de socket.");

    socket.onmessage = (e) => {
      const data = JSON.parse(e.data);
      // payload broadcast del consumer
      if (data.contenido) {
        addLine(`${data.remitente_id}: ${data.contenido}`);
      } else if (data.message) {
        // fallback si alg√∫n otro handler env√≠a "message"
        addLine(data.user ? `${data.user}: ${data.message}` : data.message);
      }
    };

    function send(){
      const texto = (input.value || "").trim();
      if(!texto) return;
      socket.send(JSON.stringify({ action:"send_message", contenido: texto, tipo: "texto" }));
      addLine(`Yo: ${texto}`);
      input.value = "";
      input.focus();
    }

    btn.onclick = send;
    input.addEventListener("keydown", (e)=>{ if(e.key === "Enter") send(); });
  </script>
</body>
</html>

{% endblock %}
